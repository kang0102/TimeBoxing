<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç–Šæ§‹åœ–ç”¢ç”Ÿå™¨ (Cloud Ultimate Full)</title>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        /* =========================================
           CSS æ¨£å¼å€ (å®Œå…¨å±•é–‹ç‰ˆ)
           ========================================= */
        
        /* åŸºç¤å…¨è¢å¹•ä½ˆå±€ */
        body {
            font-family: "Microsoft JhengHei", "Segoe UI", Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            user-select: none; /* ç¦æ­¢é¸å–æ–‡å­—ï¼Œæå‡æ‹–æ›³é«”é©— */
        }

        /* --- å·¦å´æ§åˆ¶é¢æ¿ --- */
        #sidebar {
            width: 420px;
            min-width: 320px;
            max-width: 800px;
            background-color: #1e1e1e;
            padding: 15px;
            padding-top: 60px; /* é ç•™çµ¦å›é¦–é æŒ‰éˆ• */
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
            overflow-y: auto;
            flex-shrink: 0;
            box-sizing: border-box;
            border-right: 1px solid #333;
        }

        /* --- å·¦å³æ‹–æ›³èª¿æ•´æ¡¿ (Resizer) --- */
        #resizer {
            width: 8px;
            background-color: #121212;
            cursor: col-resize;
            z-index: 20;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.2s;
        }
        #resizer::after {
            content: "";
            width: 2px;
            height: 30px;
            background-color: #444;
            border-radius: 2px;
        }
        #resizer:hover, #resizer.active {
            background-color: #1976D2;
        }
        #resizer:hover::after {
            background-color: #fff;
        }

        /* --- å³å´ç•«å¸ƒå€ --- */
        #main-area {
            flex-grow: 1;
            background-color: #222;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            padding: 40px;
            cursor: default;
        }

        /* --- UI å…ƒä»¶é€šç”¨æ¨£å¼ --- */
        h2 {
            margin: 0 0 5px 0;
            color: #4FC3F7;
            font-size: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        h3 {
            margin: 15px 0 5px 0;
            color: #bbb;
            font-size: 14px;
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group {
            background: #252525;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #aaa;
        }

        input[type="text"], 
        input[type="number"], 
        select {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            font-size: 13px;
            outline: none;
        }
        input:focus, select:focus {
            border-color: #4FC3F7;
            background: #444;
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        button {
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            background-color: #444;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            width: 100%;
            transition: all 0.2s;
            margin-top: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        button:hover {
            background-color: #666;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }

        /* ç‰¹æ®ŠæŒ‰éˆ•é¡è‰² */
        .btn-ppt { background-color: #E65100; border-color: #EF6C00; font-weight: bold; }
        .btn-ppt:hover { background-color: #F57C00; }
        
        .btn-img { background-color: #1565C0; border-color: #0D47A1; }
        .btn-img:hover { background-color: #1976D2; }
        
        .btn-add { background-color: #2E7D32; border-color: #1B5E20; }
        .btn-add:hover { background-color: #43A047; }

        /* é›²ç«¯å°ˆæ¡ˆæŒ‰éˆ• */
        .btn-save-cloud { background-color: #00695C; border-color: #004D40; width: auto; flex: 0.4; }
        .btn-save-cloud:hover { background-color: #00897B; }
        
        .btn-del-cloud { background-color: #B71C1C; border-color: #B71C1C; width: auto; flex: 0.2; }
        .btn-del-cloud:hover { background-color: #D32F2F; }

        /* å‚™ä»½æŒ‰éˆ•ç¾¤çµ„ */
        .project-btns { display: flex; gap: 5px; margin-bottom: 10px; }
        .btn-proj { background-color: #455A64; border-color: #37474F; flex: 1; font-size: 12px; }
        .btn-proj:hover { background-color: #546E7A; }
        .btn-clear { background-color: #C62828; border-color: #B71C1C; flex: 0.8; }
        
        /* å›é¦–é æŒ‰éˆ• */
        .home-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            text-decoration: none;
            background: #333;
            padding: 8px 16px;
            border-radius: 20px;
            color: #fff;
            font-size: 13px;
            border: 1px solid #555;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: 0.2s;
        }
        .home-btn:hover { background: #555; }

        /* --- å±¤æ¬¡åˆ—è¡¨æ¨£å¼ --- */
        #layer-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .layer-item {
            background: #2a2a2a;
            border-radius: 6px;
            padding: 8px;
            border-left: 6px solid #666; /* é¡¯ç¤ºé¡è‰²çš„é‚Šæ¡† */
            font-size: 13px;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .layer-item:hover { background: #333; }
        .layer-item.dragging {
            opacity: 0.5;
            border: 2px dashed #888;
            background: #222;
        }

        .layer-main-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .drag-handle {
            cursor: grab;
            color: #666;
            font-size: 18px;
            padding: 0 4px;
        }
        .drag-handle:hover { color: #fff; }

        .layer-inputs {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1.5fr 0.8fr; /* åç¨± : åšåº¦ */
            gap: 5px;
        }

        /* éš±è—çš„é€²éšè¨­å®šå€ */
        .layer-details {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #444;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            align-items: end;
            background: #252525;
            padding: 8px;
            border-radius: 4px;
        }
        .layer-item.open .layer-details {
            display: grid;
        }

        .btn-toggle-details {
            cursor: pointer;
            color: #888;
            font-size: 14px;
            padding: 6px;
            border-radius: 4px;
            background: #333;
            border: 1px solid #444;
        }
        .btn-toggle-details:hover { background: #555; color: white; }
        .btn-toggle-details.active { background: #1565C0; color: white; border-color: #1565C0; }

        input[type="color"] {
            border: none;
            width: 28px;
            height: 28px;
            cursor: pointer;
            background: none;
            padding: 0;
        }

        .btn-del {
            cursor: pointer;
            color: #888;
            font-size: 18px;
            padding: 2px 6px;
        }
        .btn-del:hover { color: #ff5252; }

        /* --- æ¨™è¨»åˆ—è¡¨æ¨£å¼ --- */
        #dim-list {
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .dim-item {
            background: #2a2a2a;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #bbb;
        }
        .dim-item:hover { background: #333; }

        /* æª”æ¡ˆä¸Šå‚³æ¡†éš±è— */
        #fileInput { display: none; }

        /* Canvas é™°å½± */
        canvas {
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            background-color: white;
        }

        /* è¼‰å…¥é®ç½© */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); color: white; display: none;
            justify-content: center; align-items: center; z-index: 9999; flex-direction: column;
        }
        .spinner {
            border: 4px solid #333; border-top: 4px solid #4FC3F7; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-size: 18px;">â˜ï¸ æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</div>
    </div>

    <a href="index.html" class="home-btn">ğŸ  å›é¦–é </a>

    <div id="sidebar">
        <h2>ğŸ“š ç–Šæ§‹è³‡æ–™åº« (Cloud Ultimate)</h2>

        <div class="control-group" style="border-left: 4px solid #00897B;">
            <label style="color:#80CBC4; font-weight:bold;">â˜ï¸ é›²ç«¯å°ˆæ¡ˆå­˜å– (Firebase)</label>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="projName" placeholder="è¼¸å…¥å°ˆæ¡ˆåç¨± (ä¾‹: 5å±¤æ¿-ç‰ˆæœ¬A)" style="flex:1">
                <button class="btn-save-cloud" onclick="window.saveToCloud()">å„²å­˜</button>
            </div>
            <div style="display:flex; gap:5px;">
                <select id="savedProjects" onchange="window.loadFromCloud()" style="flex:1">
                    <option value="">-- è³‡æ–™åº«é€£ç·šä¸­ --</option>
                </select>
                <button class="btn-del-cloud" onclick="window.deleteFromCloud()" title="åˆªé™¤é¸å®šå°ˆæ¡ˆ">ğŸ—‘ï¸</button>
            </div>
        </div>
        
        <div class="project-btns">
            <button class="btn-clear" onclick="window.newProject()">ğŸ“„ æ¸…ç©ºç•«å¸ƒ</button>
            <button class="btn-proj" onclick="window.exportJSON()">ğŸ“¤ åŒ¯å‡º JSON</button>
            <button class="btn-proj" onclick="document.getElementById('fileInput').click()">ğŸ“¥ åŒ¯å…¥ JSON</button>
            <input type="file" id="fileInput" accept=".json" onchange="window.importJSON(this)">
        </div>

        <div class="control-group">
            <label>å…¨åŸŸé¡¯ç¤ºè¨­å®š</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="unitInput" value="um" placeholder="å–®ä½" oninput="window.draw()" style="flex:1" title="å–®ä½ (um, mm...)">
                <input type="number" id="canvasWidth" value="450" placeholder="å¯¬åº¦" oninput="window.resizeCanvas()" style="flex:1" title="ç•«å¸ƒå¯¬åº¦">
                <input type="number" id="globalFontSize" value="14" placeholder="å­—é«”" oninput="window.draw()" style="flex:1" title="é è¨­å­—é«”å¤§å°">
            </div>
        </div>

        <h3>1. å±¤æ¬¡çµæ§‹ (å¯æ‹–æ›³æ’åº)</h3>
        <button class="btn-add" onclick="window.addLayer()">â• æ–°å¢ä¸€å±¤ (Top)</button>
        
        <div id="layer-list" style="margin-top:5px;">
            </div>

        <h3>2. å°ºå¯¸æ¨™è¨» (æ‹–æ›³ç´…ç·šèª¿æ•´)</h3>
        <div class="control-group">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <select id="dimStart" title="èµ·å§‹å±¤"></select> 
                <span style="align-self:center; font-size:12px;">è‡³</span> 
                <select id="dimEnd" title="çµæŸå±¤"></select>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="dimLabel" placeholder="è‡ªè¨‚æ–‡å­— (é¸å¡«)" style="flex:2">
                <input type="number" id="dimOffset" value="50" placeholder="åç§»é‡" style="flex:1">
            </div>
            <button onclick="window.addDimension()">â• æ–°å¢æ¨™è¨»ç·š</button>
        </div>
        <div id="dim-list"></div>

        <div style="margin-top: auto;"></div>
        
        <h3>3. è¼¸å‡ºèˆ‡ä¸‹è¼‰</h3>
        <button class="btn-img" onclick="window.downloadImage()">ğŸ’¾ ä¸‹è¼‰åœ–ç‰‡ (PNG)</button>
        <button class="btn-ppt" onclick="window.downloadPPT()">ğŸ“Š ä¸‹è¼‰ PPT (å¯ç·¨è¼¯åœ–å½¢)</button>
    </div>

    <div id="resizer"></div>

    <div id="main-area">
        <canvas id="stackCanvas"></canvas>
    </div>

    <script type="module">
        // ---------------------------------------------------------
        // 1. Firebase è¨­å®šèˆ‡åˆå§‹åŒ–
        // ---------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        // è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Firebase Config
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSy...", // è«‹æ›¿æ›æˆæ‚¨çš„ API Key
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_ID",
            appId: "YOUR_APP_ID"
        };

        // åˆå§‹åŒ–è®Šæ•¸
        let db = null;
        let COLLECTION_NAME = "projects";
        let isFirebaseReady = false;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            isFirebaseReady = true;
            console.log("Firebase initialized successfully");
        } catch(e) {
            console.error("Firebase initialization failed:", e);
            alert("Firebase é€£ç·šè¨­å®šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­çš„ Configï¼\n(ç›®å‰åƒ…èƒ½ä½¿ç”¨æœ¬æ©ŸåŠŸèƒ½)");
        }

        // ---------------------------------------------------------
        // 2. æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒé‚è¼¯èˆ‡è®Šæ•¸
        // ---------------------------------------------------------
        const canvas = document.getElementById('stackCanvas');
        const ctx = canvas.getContext('2d');
        const listEl = document.getElementById('layer-list');
        const dimListEl = document.getElementById('dim-list');

        // å…¨åŸŸç‹€æ…‹ (æ›è¼‰åˆ° window ä»¥ä¾¿å­˜å–)
        window.layers = [];
        window.dimensions = [];

        // äº’å‹•ç‹€æ…‹
        let dragTargetType = null;
        let dragIndex = -1;
        let isDraggingCanvas = false;
        let lastMouseY = 0; 
        let lastMouseX = 0;
        let hitRegions = { layers: [], dims: [] }; // ç”¨æ–¼åˆ¤å®šæ»‘é¼ é»æ“Šä½ç½®

        // UI èª¿æ•´
        const sidebar = document.getElementById('sidebar');
        const resizer = document.getElementById('resizer');
        let isResizingSidebar = false;

        // ---------------------------------------------------------
        // 3. é›²ç«¯å­˜å–åŠŸèƒ½ (Cloud Functions)
        // ---------------------------------------------------------
        
        window.refreshProjectList = async function() {
            if(!isFirebaseReady) return;
            const select = document.getElementById('savedProjects');
            const currentVal = select.value;
            select.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';

            try {
                // å¾ Firestore å–å¾—æ‰€æœ‰å°ˆæ¡ˆæ–‡ä»¶
                const querySnapshot = await getDocs(collection(db, COLLECTION_NAME));
                select.innerHTML = '<option value="">-- é¸æ“‡é›²ç«¯å°ˆæ¡ˆ --</option>';
                
                if (querySnapshot.empty) {
                    // å¦‚æœè³‡æ–™åº«æ˜¯ç©ºçš„
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.innerText = doc.id;
                    select.appendChild(opt);
                });

                // å˜—è©¦ä¿æŒåŸæœ¬çš„é¸æ“‡
                if (currentVal) {
                    // æª¢æŸ¥ currentVal æ˜¯å¦é‚„åœ¨æ¸…å–®ä¸­
                    let exists = false;
                    for(let i=0; i<select.options.length; i++){
                        if(select.options[i].value === currentVal) exists = true;
                    }
                    if(exists) select.value = currentVal;
                }
            } catch (e) {
                console.error("Firebase List Error:", e);
                select.innerHTML = '<option value="">è®€å–å¤±æ•— (Check Console)</option>';
            }
        };

        window.saveToCloud = async function() {
            if(!isFirebaseReady) { alert("å°šæœªé€£ç·šè‡³ Firebase"); return; }
            const name = document.getElementById('projName').value.trim();
            if (!name) { alert("è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±ï¼"); return; }
            
            const config = {
                layers: window.layers,
                dimensions: window.dimensions,
                settings: {
                    unit: document.getElementById('unitInput').value,
                    width: document.getElementById('canvasWidth').value,
                    fontSize: document.getElementById('globalFontSize').value
                },
                timestamp: Date.now()
            };

            if(!confirm(`ç¢ºå®šè¦å°‡ "${name}" å„²å­˜åˆ°é›²ç«¯è³‡æ–™åº«å—ï¼Ÿ\n(é€™æœƒè¦†è“‹åŒåå°ˆæ¡ˆ)`)) return;

            showLoading(true);
            try {
                // å¯«å…¥ Firestore (ä½¿ç”¨æ–‡ä»¶ ID = å°ˆæ¡ˆåç¨±)
                await setDoc(doc(db, COLLECTION_NAME, name), config);
                alert("âœ… é›²ç«¯å„²å­˜æˆåŠŸï¼");
                await window.refreshProjectList();
                document.getElementById('savedProjects').value = name;
            } catch (e) {
                console.error(e);
                alert("å„²å­˜å¤±æ•—ï¼š" + e.message);
            }
            showLoading(false);
        };

        window.loadFromCloud = async function() {
            if(!isFirebaseReady) return;
            const name = document.getElementById('savedProjects').value;
            if (!name) return;

            showLoading(true);
            try {
                const docSnap = await getDoc(doc(db, COLLECTION_NAME, name));
                if (docSnap.exists()) {
                    window.applyConfig(docSnap.data());
                    document.getElementById('projName').value = name;
                } else {
                    alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²å°ˆæ¡ˆè³‡æ–™");
                }
            } catch (e) {
                console.error(e);
                alert("è¼‰å…¥å¤±æ•—ï¼š" + e.message);
            }
            showLoading(false);
        };

        window.deleteFromCloud = async function() {
            if(!isFirebaseReady) return;
            const name = document.getElementById('savedProjects').value;
            if (!name) { alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„å°ˆæ¡ˆ"); return; }
            if(!confirm(`âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é›²ç«¯ä¸Šçš„ "${name}" å—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) return;

            showLoading(true);
            try {
                await deleteDoc(doc(db, COLLECTION_NAME, name));
                document.getElementById('projName').value = "";
                await window.refreshProjectList();
                alert("å·²åˆªé™¤å°ˆæ¡ˆ");
            } catch (e) {
                console.error(e);
                alert("åˆªé™¤å¤±æ•—ï¼š" + e.message);
            }
            showLoading(false);
        };

        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // ---------------------------------------------------------
        // 4. ä¸€èˆ¬æ“ä½œèˆ‡ç¹ªåœ–é‚è¼¯
        // ---------------------------------------------------------

        // å¥—ç”¨è¨­å®šæª”
        window.applyConfig = function(config) {
            window.layers = config.layers || [];
            window.dimensions = config.dimensions || [];
            if(config.settings) {
                document.getElementById('unitInput').value = config.settings.unit || "um";
                document.getElementById('canvasWidth').value = config.settings.width || 450;
                document.getElementById('globalFontSize').value = config.settings.fontSize || 14;
            }
            window.resizeCanvas(); window.renderList(); window.draw();
        };

        // åŒ¯å‡º/åŒ¯å…¥ JSON (æœ¬åœ°å‚™ä»½)
        window.exportJSON = function() {
            const config = {
                layers: window.layers, dimensions: window.dimensions,
                settings: {
                    unit: document.getElementById('unitInput').value,
                    width: document.getElementById('canvasWidth').value,
                    fontSize: document.getElementById('globalFontSize').value
                }
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config));
            const link = document.createElement('a'); 
            link.href = dataStr; 
            link.download = `stack_backup_${Date.now()}.json`; 
            link.click();
        };
        
        window.importJSON = function(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    window.applyConfig(config);
                    alert("æª”æ¡ˆåŒ¯å…¥æˆåŠŸï¼");
                } catch(err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
                input.value = '';
            };
            reader.readAsText(file);
        };

        window.newProject = function() {
            if(!confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰ç•«é¢å—ï¼Ÿ")) return;
            window.layers = []; window.dimensions = [];
            document.getElementById('projName').value = "";
            document.getElementById('savedProjects').value = "";
            window.renderList(); window.draw();
        };

        // ---------------------------------------------------------
        // 5. æ¸²æŸ“ UI (å·¦å´åˆ—è¡¨)
        // ---------------------------------------------------------
        window.renderList = function() {
            listEl.innerHTML = ''; 
            window.updateDimSelects(); // åŒæ­¥æ¨™è¨»é¸é …

            window.layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                if(layer.showDetails) item.classList.add('open');
                item.draggable = true; 
                item.style.borderLeftColor = layer.color;
                
                const txtColorVal = layer.textColor || "#000000";
                
                item.innerHTML = `
                    <div class="layer-main-row">
                        <div class="drag-handle">â˜°</div>
                        <div class="layer-inputs">
                            <input type="text" value="${layer.name}" oninput="window.updateLayer(${index}, 'name', this.value)" placeholder="å±¤æ¬¡åç¨±">
                            <input type="number" value="${layer.thickness}" oninput="window.updateLayer(${index}, 'thickness', this.value)" placeholder="åšåº¦">
                        </div>
                        <input type="color" value="${layer.color}" oninput="window.updateLayer(${index}, 'color', this.value)" title="å±¤æ¬¡é¡è‰²">
                        <div class="btn-toggle-details ${layer.showDetails?'active':''}" onclick="window.toggleDetails(${index})" title="é€²éšæ–‡å­—è¨­å®š">âš™ï¸</div>
                        <div class="btn-icon btn-del" onclick="window.deleteLayer(${index})" title="åˆªé™¤æ­¤å±¤">Ã—</div>
                    </div>
                    <div class="layer-details">
                        <div><label>æ–‡å­—é¡è‰²</label><input type="color" value="${txtColorVal}" oninput="window.updateLayer(${index}, 'textColor', this.value)" style="width:100%"></div>
                        <div><label>å­—é«”å¤§å°</label><input type="number" value="${layer.fontSize || ''}" placeholder="é è¨­" oninput="window.updateLayer(${index}, 'fontSize', this.value)"></div>
                        <div><label>å­—é«”æ¨£å¼</label><select onchange="window.updateLayer(${index}, 'fontStyle', this.value)" style="padding:2px;"><option value="normal" ${layer.fontStyle==='normal'?'selected':''}>ä¸€èˆ¬</option><option value="bold" ${layer.fontStyle==='bold'?'selected':''}>ç²—é«”</option></select></div>
                    </div>
                `;

                // ç¶å®šå·¦å´åˆ—è¡¨æ‹–æ›³äº‹ä»¶
                item.addEventListener('dragstart', e => { 
                    e.dataTransfer.setData('text/plain', index); 
                    item.classList.add('dragging'); 
                });
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
                item.addEventListener('dragover', e => e.preventDefault());
                item.addEventListener('drop', e => {
                    e.preventDefault(); 
                    const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                    if (fromIdx !== index) {
                        // äº¤æ›é™£åˆ—ä½ç½®
                        const moved = window.layers.splice(fromIdx, 1)[0]; 
                        window.layers.splice(index, 0, moved);
                        window.renderList(); window.draw();
                    }
                });
                listEl.appendChild(item);
            });
        };

        // æ›´æ–°å±¤æ¬¡è³‡æ–™
        window.updateLayer = function(index, key, value) {
            if (key === 'thickness' || key === 'fontSize') value = parseFloat(value) || 0;
            window.layers[index][key] = value;
            if(key === 'color') window.renderList(); // æ›´æ–°é‚Šæ¡†é¡è‰²
            window.draw();
        };
        window.toggleDetails = function(index) { window.layers[index].showDetails = !window.layers[index].showDetails; window.renderList(); };
        window.addLayer = function() { window.layers.unshift({ id: Date.now(), name: "New Layer", thickness: 20, color: "#cccccc", fontSize: 0, fontStyle: 'bold' }); window.renderList(); window.draw(); };
        window.deleteLayer = function(index) { window.layers.splice(index, 1); window.renderList(); window.draw(); };
        
        // è¼‰å…¥é è¨­ç¯„ä¾‹
        function loadExample(silent = false) {
            if(!silent && !confirm("ç¢ºå®šè¦è¼‰å…¥ç¯„ä¾‹ä¸¦è¦†è“‹ç›®å‰è¨­å®šå—ï¼Ÿ")) return;
            window.layers = [
                { name: "CL2", thickness: 20, color: "#001f5c", fontSize: 0, fontStyle:'bold', textColor:'#ffffff' },
                { name: "WCR", thickness: 9, color: "#ffc107", fontSize: 0, fontStyle:'bold', textColor:'#000000' },
                { name: "CL1", thickness: 60, color: "#001f5c", fontSize: 0, fontStyle:'bold', textColor:'#ffffff' },
                { name: "Ad", thickness: 25, color: "#eeeeee", fontSize: 0, fontStyle:'normal', textColor:'#000000' },
                { name: "PI", thickness: 100, color: "#a8a8a8", fontSize: 28, fontStyle:'bold', textColor:'#ffffff' },
                { name: "Ad", thickness: 25, color: "#dbeeff", fontSize: 0, fontStyle:'normal', textColor:'#000000' },
                { name: "Tape", thickness: 110, color: "#90caf9", fontSize: 0, fontStyle:'bold', textColor:'#000000' }
            ];
            window.dimensions = []; 
            window.addDimensionByLogic(0, window.layers.length-1, "", 80); 
            window.renderList(); 
            window.draw();
        }

        // æ›´æ–°ä¸‹æ‹‰é¸å–® (ä¾›æ¨™è¨»é¸æ“‡)
        window.updateDimSelects = function() {
            const s1 = document.getElementById('dimStart'); const s2 = document.getElementById('dimEnd');
            const v1 = s1.value; const v2 = s2.value;
            s1.innerHTML = ''; s2.innerHTML = '';
            window.layers.forEach((l, i) => {
                const opt = `<option value="${i}">${i+1}. ${l.name}</option>`;
                s1.innerHTML += opt; s2.innerHTML += opt;
            });
            // å˜—è©¦æ¢å¾©é¸æ“‡
            if(v1) s1.value = v1; 
            if(v2) s2.value = v2; else if(window.layers.length>0) s2.value = window.layers.length-1;
        };

        window.addDimension = function() {
            const s = parseInt(document.getElementById('dimStart').value); 
            const e = parseInt(document.getElementById('dimEnd').value);
            const txt = document.getElementById('dimLabel').value; 
            const off = parseInt(document.getElementById('dimOffset').value) || 50;
            window.addDimensionByLogic(s, e, txt, off);
        };
        window.addDimensionByLogic = function(s, e, l, o) { 
            window.dimensions.push({ start: Math.min(s,e), end: Math.max(s,e), label: l, offset: o }); 
            renderDims(); window.draw(); 
        };
        
        function renderDims() {
            dimListEl.innerHTML = '';
            window.dimensions.forEach((d, i) => {
                const sName = window.layers[d.start]?.name||'?'; 
                const eName = window.layers[d.end]?.name||'?';
                const div = document.createElement('div'); div.className = 'dim-item';
                div.innerHTML = `<span>${sName}~${eName} (å${d.offset})</span><span class="btn-icon btn-del" onclick="window.deleteDim(${i})">Ã—</span>`;
                dimListEl.appendChild(div);
            });
        }
        window.deleteDim = function(i) { window.dimensions.splice(i, 1); renderDims(); window.draw(); };

        // ---------------------------------------------------------
        // 6. ç•«å¸ƒäº’å‹•é‚è¼¯ (æ‹–æ›³ç´…ç·šèˆ‡å±¤æ¬¡)
        // ---------------------------------------------------------
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left; const y = e.clientY - rect.top;
            
            // å„ªå…ˆæª¢æŸ¥æ¨™è¨»ç·š (å› ç‚ºç·šæ¯”è¼ƒç´°)
            for (let i = 0; i < hitRegions.dims.length; i++) {
                const d = hitRegions.dims[i];
                if (Math.abs(x - d.x) < 15 && y >= d.yStart && y <= d.yEnd) {
                    dragTargetType = 'dimension'; dragIndex = d.index; 
                    isDraggingCanvas = true; lastMouseX = x;
                    document.body.style.cursor = 'ew-resize'; return;
                }
            }
            // æª¢æŸ¥å±¤æ¬¡å€å¡Š
            for (let i = 0; i < hitRegions.layers.length; i++) {
                const l = hitRegions.layers[i];
                if (y >= l.y && y <= l.y + l.h && x > 50) {
                    dragTargetType = 'layer'; dragIndex = l.index; 
                    isDraggingCanvas = true; lastMouseY = y;
                    document.body.style.cursor = 'ns-resize'; return;
                }
            }
        });

        window.addEventListener('mousemove', e => {
            if (!isDraggingCanvas) {
                // æ»‘é¼ æ‡¸åœæ•ˆæœ
                const rect = canvas.getBoundingClientRect(); 
                const x = e.clientX - rect.left; const y = e.clientY - rect.top;
                let hover = false;
                for(let d of hitRegions.dims) if (Math.abs(x - d.x) < 15 && y >= d.yStart && y <= d.yEnd) { canvas.style.cursor = 'ew-resize'; hover=true; break; }
                if(!hover) for(let l of hitRegions.layers) if (y >= l.y && y <= l.y + l.h && x > 50) { canvas.style.cursor = 'ns-resize'; hover=true; break; }
                if(!hover) canvas.style.cursor = 'default'; 
                return;
            }

            // æ‹–æ›³ä¸­
            const rect = canvas.getBoundingClientRect(); 
            const x = e.clientX - rect.left; const y = e.clientY - rect.top;
            
            if (dragTargetType === 'dimension') {
                const dx = lastMouseX - x; 
                window.dimensions[dragIndex].offset += dx; 
                if(window.dimensions[dragIndex].offset < 20) window.dimensions[dragIndex].offset = 20;
                lastMouseX = x; 
                window.draw(); renderDims();
            } else if (dragTargetType === 'layer') {
                let hoveredIndex = -1;
                for (let l of hitRegions.layers) if (y >= l.y && y <= l.y + l.h) { hoveredIndex = l.index; break; }
                if (hoveredIndex !== -1 && hoveredIndex !== dragIndex) {
                    // äº¤æ›
                    const temp = window.layers[dragIndex]; window.layers[dragIndex] = window.layers[hoveredIndex]; window.layers[hoveredIndex] = temp;
                    dragIndex = hoveredIndex; 
                    window.renderList(); window.draw();
                }
                lastMouseY = y;
            }
        });
        window.addEventListener('mouseup', () => { isDraggingCanvas = false; dragTargetType = null; document.body.style.cursor = 'default'; canvas.style.cursor = 'default'; });

        // ---------------------------------------------------------
        // 7. ç¹ªåœ–æ ¸å¿ƒ
        // ---------------------------------------------------------
        window.resizeCanvas = function() { const w = parseInt(document.getElementById('canvasWidth').value) || 450; canvas.width = w; window.draw(); };
        
        window.draw = function() {
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value) || 14;
            const totalThickness = window.layers.reduce((sum, l) => sum + l.thickness, 0);
            if (totalThickness === 0) return;

            // è¨ˆç®—é‚Šè· (æ ¹æ“šæ¨™è¨»ç·šæœ€é è·é›¢)
            let maxOffset = 20; 
            window.dimensions.forEach(d => { if(d.offset > maxOffset) maxOffset = d.offset; });
            const padding = { top: 40, bottom: 40, left: maxOffset + 40, right: 20 };

            const drawWidth = canvas.width - padding.left - padding.right;
            const availableHeight = Math.max(500, window.layers.length * 40);
            canvas.height = availableHeight + padding.top + padding.bottom;
            const scale = availableHeight / totalThickness;

            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            ctx.textAlign = "center"; ctx.textBaseline = "middle";

            hitRegions.layers = []; hitRegions.dims = []; 
            let currentY = padding.top; 
            let yPositions = [];

            // A. ç•«å±¤æ¬¡
            window.layers.forEach((layer, idx) => {
                const h = layer.thickness * scale;
                hitRegions.layers.push({ index: idx, y: currentY, h: h }); 
                yPositions.push({ top: currentY, bottom: currentY + h });

                ctx.fillStyle = layer.color; ctx.fillRect(padding.left, currentY, drawWidth, h);
                ctx.strokeStyle = "#333"; ctx.lineWidth = 1; ctx.strokeRect(padding.left, currentY, drawWidth, h);
                
                if (h > 12) {
                    if (layer.textColor && layer.textColor !== '#000000') ctx.fillStyle = layer.textColor;
                    else ctx.fillStyle = isColorDark(layer.color) ? "white" : "black";
                    
                    const fs = layer.fontSize > 0 ? layer.fontSize : globalFS;
                    const style = layer.fontStyle === 'bold' ? 'bold' : '';
                    ctx.font = `${style} ${fs}px "Microsoft JhengHei", Arial`;
                    ctx.fillText(`${layer.name} ${layer.thickness}${unit}`, padding.left + drawWidth / 2, currentY + h / 2);
                }
                currentY += h;
            });

            // B. ç•«æ¨™è¨»
            window.dimensions.forEach((dim, idx) => {
                if (!yPositions[dim.start] || !yPositions[dim.end]) return;
                const y1 = yPositions[dim.start].top; const y2 = yPositions[dim.end].bottom; const h = y2 - y1;
                let val = 0; for(let k=dim.start; k<=dim.end; k++) val += window.layers[k].thickness;
                const txt = dim.label ? dim.label : `${val}${unit}`;
                const x = padding.left - dim.offset;
                
                hitRegions.dims.push({ index: idx, x: x, yStart: y1, yEnd: y2 });
                drawDimensionLine(x, y1, h, txt);
            });
        };
        
        function drawDimensionLine(x, yStart, height, text) {
            ctx.strokeStyle = "#D32F2F"; ctx.fillStyle = "#D32F2F"; ctx.lineWidth = 2; ctx.font = "bold 14px Arial";
            // ç›´ç·š
            ctx.beginPath(); ctx.moveTo(x, yStart); ctx.lineTo(x, yStart + height); ctx.stroke();
            // æ©«å‘å¼•å°ç·š
            ctx.strokeStyle = "#ccc"; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(x, yStart); ctx.lineTo(x + 10, yStart); ctx.moveTo(x, yStart + height); ctx.lineTo(x + 10, yStart + height); ctx.stroke();
            // ç®­é ­
            ctx.fillStyle = "#D32F2F"; drawArrow(x, yStart, "up"); drawArrow(x, yStart + height, "down");
            // æ–‡å­—
            ctx.textAlign = "right"; ctx.textBaseline = "middle"; ctx.fillText(text, x - 5, yStart + height / 2);
        }
        
        function drawArrow(x, y, dir) {
            ctx.beginPath(); const s = 5;
            if(dir==="up") { ctx.moveTo(x,y); ctx.lineTo(x-s,y+s); ctx.lineTo(x+s,y+s); } else { ctx.moveTo(x,y); ctx.lineTo(x-s,y-s); ctx.lineTo(x+s,y-s); }
            ctx.fill();
        }
        function isColorDark(hex) {
            const r = parseInt(hex.substr(1, 2), 16); const g = parseInt(hex.substr(3, 2), 16); const b = parseInt(hex.substr(5, 2), 16);
            return ((r*299 + g*587 + b*114)/1000) < 128;
        }
        function cleanHex(hex) { if(!hex) return "FFFFFF"; return hex.replace('#', '').toUpperCase(); }
        
        // --- èª¿æ•´æ¬„å¯¬ ---
        resizer.addEventListener('mousedown', () => { isResizingSidebar = true; resizer.classList.add('active'); document.body.style.cursor = 'col-resize'; });
        window.addEventListener('mousemove', (e) => { if (!isResizingSidebar) return; let w = e.clientX; if (w < 320) w = 320; if (w > 800) w = 800; sidebar.style.width = w + 'px'; });
        window.addEventListener('mouseup', () => { isResizingSidebar = false; resizer.classList.remove('active'); document.body.style.cursor = 'default'; });

        // --- åŒ¯å‡ºåŠŸèƒ½ ---
        window.downloadImage = function() { const link = document.createElement('a'); link.download = 'stack_diagram.png'; link.href = canvas.toDataURL(); link.click(); };

        // PPT è¼¸å‡º (åœ–æ–‡åˆ†é›¢ä¿®å¾©ç‰ˆ)
        window.downloadPPT = function() {
            let pres = new PptxGenJS();
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value) || 14;
            const totalThickness = window.layers.reduce((sum, l) => sum + l.thickness, 0);
            if (totalThickness === 0) { alert("æ²’æœ‰å±¤æ¬¡å¯è¼¸å‡º"); return; }
            
            let maxOffset = 20; window.dimensions.forEach(d => { if(d.offset > maxOffset) maxOffset = d.offset; });
            const pptPaddingLeft = maxOffset + 150; const pptPaddingTop = 50;
            const scaleFactor = 100; const contentWidth = canvas.width - (maxOffset + 40) - 20; 
            const slideW = (pptPaddingLeft + contentWidth + 50) / scaleFactor;
            const availableHeightPx = Math.max(500, window.layers.length * 40);
            const slideH = (availableHeightPx + 100) / scaleFactor;
            const pxToThickScale = availableHeightPx / totalThickness;
            
            pres.defineLayout({ name:'CUST', width: slideW, height: slideH }); pres.layout = 'CUST';
            let slide = pres.addSlide();
            let currentYPx = pptPaddingTop; let yPositions = [];
            
            // ç•«å±¤æ¬¡
            window.layers.forEach(layer => {
                const hPx = layer.thickness * pxToThickScale;
                const x = pptPaddingLeft / scaleFactor; const y = currentYPx / scaleFactor; const w = contentWidth / scaleFactor; const h = hPx / scaleFactor;
                yPositions.push({ top: y, bottom: y + h });
                
                const safeFillColor = cleanHex(layer.color);
                let txtColor = "000000"; if (layer.textColor && layer.textColor !== '#000000') txtColor = cleanHex(layer.textColor); else txtColor = isColorDark(layer.color) ? "FFFFFF" : "000000";
                const fs = layer.fontSize > 0 ? layer.fontSize : globalFS; const isBold = layer.fontStyle === 'bold';
                const textContent = `${layer.name} ${layer.thickness}${unit}`;
                
                // ç´”è‰²å¡Š
                slide.addShape(pres.ShapeType.rect, { x: x, y: y, w: w, h: h, fill: { color: safeFillColor }, line: { color: "333333", width: 1 } });
                // ç¨ç«‹æ–‡å­—
                slide.addText(textContent, { x: x, y: y, w: w, h: h, color: txtColor, fontSize: fs, align: 'center', valign: 'middle', bold: isBold });
                currentYPx += hPx;
            });
            
            // ç•«æ¨™è¨»
            window.dimensions.forEach(dim => {
                if (!yPositions[dim.start] || !yPositions[dim.end]) return;
                const y1 = yPositions[dim.start].top; const y2 = yPositions[dim.end].bottom;
                const xLine = (pptPaddingLeft - dim.offset) / scaleFactor;
                let val = 0; for(let k=dim.start; k<=dim.end; k++) val += window.layers[k].thickness;
                const txt = dim.label ? dim.label : `${val}${unit}`;
                
                // ç´…ç·š
                slide.addShape(pres.ShapeType.line, { x: xLine, y: y1, w: 0, h: y2 - y1, line: { color: "D32F2F", width: 2, beginArrowType:'triangle', endArrowType:'triangle' } });
                // å¼•å°ç·š
                const connectorLen = 0.15;
                slide.addShape(pres.ShapeType.line, { x: xLine, y: y1, w: connectorLen, h: 0, line: { color: "CCCCCC", width: 1 } });
                slide.addShape(pres.ShapeType.line, { x: xLine, y: y2, w: connectorLen, h: 0, line: { color: "CCCCCC", width: 1 } });
                // æ–‡å­—
                const textWidth = 2.0; 
                slide.addText(txt, { x: xLine - textWidth - 0.1, y: (y1 + y2)/2 - 0.3, w: textWidth, h: 0.6, color: "D32F2F", fontSize: 12, align: 'right', valign: 'middle' });
            });
            pres.writeFile({ fileName: "Stack_Diagram.pptx" });
        };

        // åˆå§‹åŒ–ï¼šå˜—è©¦é€£ç·š Firebase
        if(isFirebaseReady) {
            window.refreshProjectList();
        } else {
            // å¦‚æœé€£ç·šå¤±æ•—ï¼Œè¼‰å…¥ç¯„ä¾‹è®“ä½¿ç”¨è€…è‡³å°‘èƒ½è©¦ç”¨åŸºæœ¬åŠŸèƒ½
            loadExample(true);
        }
    </script>
</body>
</html>
