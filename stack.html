<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§ç–Šæ§‹åœ–ç”¢ç”Ÿå™¨</title>
    <style>
        /* --- åŸºç¤ä½ˆå±€ (ç¶­æŒèˆ‡å…¶ä»–å·¥å…·ä¸€è‡´çš„æ·±è‰²é¢¨æ ¼) --- */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #121212;
            color: #ddd;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* å·¦å´æ§åˆ¶é¢æ¿ */
        #sidebar {
            width: 350px;
            background-color: #1e1e1e;
            padding: 15px;
            padding-top: 60px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
            z-index: 10;
            overflow-y: auto;
        }

        /* å³å´ç•«å¸ƒå€ */
        #main-area {
            flex-grow: 1;
            background-color: #222; /* æ·±ç°èƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        h2 { margin: 0 0 10px 0; color: #4FC3F7; font-size: 18px; }
        
        .control-group {
            background: #252525;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #333;
        }

        label { display: block; margin-bottom: 5px; font-size: 13px; color: #bbb; }
        input[type="text"], input[type="number"] {
            background: #333; border: 1px solid #555; color: white;
            padding: 5px; border-radius: 4px; width: 100%; box-sizing: border-box;
        }
        
        /* å±¤æ¬¡åˆ—è¡¨æ¨£å¼ */
        #layer-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .layer-item {
            background: #333;
            border-radius: 4px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 4px solid #666;
        }

        .layer-inputs {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1.5fr 1fr; /* åç¨±å¯¬ : åšåº¦å¯¬ */
            gap: 5px;
        }

        input[type="color"] {
            border: none; width: 30px; height: 30px; cursor: pointer; background: none; padding: 0;
        }

        .btn-icon {
            cursor: pointer; color: #aaa; font-size: 16px; padding: 2px;
        }
        .btn-icon:hover { color: white; }
        .btn-del:hover { color: #ff5252; }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            background-color: #444;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            width: 100%;
            transition: 0.2s;
            margin-bottom: 5px;
        }
        button:hover { background-color: #666; }
        .btn-primary { background-color: #1976D2; border-color: #1565C0; font-weight: bold; }
        .btn-add { background-color: #43A047; border-color: #2E7D32; font-weight: bold; }

        /* å›é¦–é æŒ‰éˆ• */
        .home-btn {
            position: absolute;
            top: 15px; left: 15px;
            text-decoration: none; background: #444; padding: 6px 12px;
            border-radius: 20px; color: #fff; font-size: 12px;
            border: 1px solid #666; z-index: 100;
        }

        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-color: white; /* ç–Šæ§‹åœ–èƒŒæ™¯é€šå¸¸æ˜¯ç™½åº•æ¯”è¼ƒæ¸…æ¥š */
        }
    </style>
</head>
<body>

    <a href="index.html" class="home-btn">ğŸ  å›é¦–é </a>

    <div id="sidebar">
        <h2>ğŸ“š ç–Šæ§‹åœ–è¨­å®š</h2>

        <div class="control-group">
            <label>åŸºæœ¬è¨­å®š</label>
            <div style="display:flex; gap:10px;">
                <div>
                    <span style="font-size:12px; color:#aaa;">å–®ä½</span>
                    <input type="text" id="unitInput" value="um" oninput="draw()" style="text-align:center;">
                </div>
                <div>
                    <span style="font-size:12px; color:#aaa;">ç•«å¸ƒå¯¬åº¦</span>
                    <input type="number" id="canvasWidth" value="400" oninput="resizeCanvas()">
                </div>
            </div>
        </div>

        <button class="btn-add" onclick="addLayer()">â• æ–°å¢ä¸€å±¤ (Top)</button>
        <button onclick="loadExample()">ğŸ“‚ è¼‰å…¥ç¯„ä¾‹ (åƒè€ƒåœ–)</button>

        <div id="layer-list">
            </div>

        <div style="margin-top: auto;"></div>
        <button class="btn-primary" onclick="downloadImage()">ğŸ’¾ ä¸‹è¼‰ç–Šæ§‹åœ–</button>
    </div>

    <div id="main-area">
        <canvas id="stackCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('stackCanvas');
        const ctx = canvas.getContext('2d');
        const listEl = document.getElementById('layer-list');

        // è³‡æ–™çµæ§‹ï¼šè¶Šä¸Šé¢çš„ index ä»£è¡¨è¶Šä¸Šå±¤ (Top)
        let layers = [
            { name: "CL2", thickness: 20, color: "#0d2b6b" },
            { name: "WCR", thickness: 9, color: "#fcba03" },
            { name: "CL1", thickness: 60, color: "#0d2b6b" },
            { name: "Ad", thickness: 25, color: "#f0f0f0" },
            { name: "PI", thickness: 100, color: "#9e9e9e" }
        ];

        // åˆå§‹åŒ–
        resizeCanvas();

        // --- æ ¸å¿ƒé‚è¼¯ ---

        function resizeCanvas() {
            const w = parseInt(document.getElementById('canvasWidth').value) || 400;
            // é«˜åº¦è‡ªå‹•è¨ˆç®—ï¼Œä½†å…ˆçµ¦å€‹é è¨­
            canvas.width = w;
            canvas.height = 600; 
            renderList();
            draw();
        }

        function renderList() {
            listEl.innerHTML = '';
            layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                item.style.borderLeftColor = layer.color; // å·¦å´é‚Šæ¡†é¡¯ç¤ºè©²å±¤é¡è‰²

                item.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <div class="btn-icon" onclick="moveLayer(${index}, -1)">â–²</div>
                        <div class="btn-icon" onclick="moveLayer(${index}, 1)">â–¼</div>
                    </div>
                    <div class="layer-inputs">
                        <input type="text" value="${layer.name}" placeholder="åç¨±" oninput="updateLayer(${index}, 'name', this.value)">
                        <input type="number" value="${layer.thickness}" placeholder="åšåº¦" oninput="updateLayer(${index}, 'thickness', this.value)">
                    </div>
                    <input type="color" value="${layer.color}" oninput="updateLayer(${index}, 'color', this.value)">
                    <div class="btn-icon btn-del" onclick="deleteLayer(${index})">Ã—</div>
                `;
                listEl.appendChild(item);
            });
        }

        function updateLayer(index, key, value) {
            if (key === 'thickness') value = parseFloat(value) || 0;
            layers[index][key] = value;
            
            // å¦‚æœæ”¹é¡è‰²ï¼Œå³æ™‚æ›´æ–°åˆ—è¡¨é‚Šæ¡†
            if(key === 'color') renderList(); 
            
            draw();
        }

        function addLayer() {
            layers.unshift({ name: "New Layer", thickness: 10, color: "#cccccc" });
            renderList();
            draw();
        }

        function deleteLayer(index) {
            layers.splice(index, 1);
            renderList();
            draw();
        }

        function moveLayer(index, direction) {
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= layers.length) return;
            
            // äº¤æ›
            const temp = layers[index];
            layers[index] = layers[targetIndex];
            layers[targetIndex] = temp;
            
            renderList();
            draw();
        }

        function loadExample() {
            if(!confirm("é€™æœƒè¦†è“‹ç›®å‰çš„è¨­å®šï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            // æ¨¡æ“¬ä½ æä¾›çš„ reference image
            layers = [
                { name: "CL2", thickness: 20, color: "#001f5c" }, // æ·±è—
                { name: "WCR", thickness: 9, color: "#ffc107" }, // é‡‘é»ƒ
                { name: "CL1", thickness: 60, color: "#001f5c" }, // æ·±è—
                { name: "Ad", thickness: 25, color: "#eeeeee" }, // æ·ºç°
                { name: "PI", thickness: 100, color: "#a8a8a8" }, // ç°
                { name: "Ad", thickness: 25, color: "#dbeeff" }, // æ·¡è—
                { name: "Tape", thickness: 110, color: "#90caf9" } // è—
            ];
            renderList();
            draw();
        }

        // --- ç¹ªåœ–æ ¸å¿ƒ ---
        function draw() {
            const unit = document.getElementById('unitInput').value;
            
            // 1. è¨ˆç®—ç¸½åšåº¦
            const totalThickness = layers.reduce((sum, l) => sum + l.thickness, 0);
            if (totalThickness === 0) return;

            // 2. è¨­å®šé‚Šè·èˆ‡ç¹ªåœ–å€
            const padding = { top: 40, bottom: 40, left: 80, right: 20 };
            const drawWidth = canvas.width - padding.left - padding.right;
            // è®“ç•«å¸ƒé«˜åº¦è‡ªå‹•é©æ‡‰ (æœ€å°‘ 400pxï¼Œå¤ªé•·å‰‡å»¶ä¼¸)
            // è¨­å®šä¸€å€‹æ¯”ä¾‹ï¼šä¾‹å¦‚ 1 unit = ? pixels
            // ç‚ºäº†è®“åœ–å¥½çœ‹ï¼Œæˆ‘å€‘å›ºå®šç¸½é«˜åº¦ä½”ç•«å¸ƒçš„ 80% å·¦å³ï¼Œæˆ–è€…å‹•æ…‹èª¿æ•´
            const availableHeight = Math.max(500, layers.length * 30); // ç¢ºä¿æ¯ä¸€å±¤è‡³å°‘æœ‰é»ç©ºé–“é¡¯ç¤ºæ–‡å­—
            canvas.height = availableHeight + padding.top + padding.bottom;

            const drawHeight = availableHeight;
            const scale = drawHeight / totalThickness; // æ¯ä¸€å–®ä½åšåº¦ = å¤šå°‘åƒç´ 

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = "bold 14px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            // 3. é€å±¤ç¹ªè£½
            let currentY = padding.top;
            
            layers.forEach(layer => {
                const h = layer.thickness * scale;
                
                // ç•«çŸ©å½¢
                ctx.fillStyle = layer.color;
                ctx.fillRect(padding.left, currentY, drawWidth, h);
                ctx.strokeStyle = "#333";
                ctx.lineWidth = 1;
                ctx.strokeRect(padding.left, currentY, drawWidth, h);

                // ç•«æ–‡å­— (å¦‚æœé«˜åº¦å¤ªå°ï¼Œå°±ä¸ç•«æˆ–ç¸®å°å­—)
                if (h > 14) {
                    // è‡ªå‹•åˆ¤æ–·æ–‡å­—é¡è‰² (æ·±è‰²åº•é…ç™½å­—ï¼Œæ·ºè‰²åº•é…é»‘å­—)
                    ctx.fillStyle = isColorDark(layer.color) ? "white" : "black";
                    const text = `${layer.name} ${layer.thickness}${unit}`;
                    
                    // å¦‚æœæ˜¯æ¯”è¼ƒåšçš„ä¸€å±¤ï¼Œå­—é«”æ”¾å¤§ä¸€é»
                    if (h > 40) ctx.font = "bold 16px Arial";
                    else ctx.font = "12px Arial";
                    
                    ctx.fillText(text, padding.left + drawWidth / 2, currentY + h / 2);
                }

                currentY += h;
            });

            // 4. ç¹ªè£½å·¦å´å°ºå¯¸æ¨™è¨» (Dimension Line)
            drawDimensionLine(padding.left - 15, padding.top, availableHeight, `${totalThickness}${unit}`);

        }

        // ç¹ªè£½å°ºå¯¸ç·šçš„è¼”åŠ©å‡½å¼
        function drawDimensionLine(x, yStart, height, text) {
            ctx.strokeStyle = "#ff0000"; // ç´…è‰²æ¨™ç¤º
            ctx.fillStyle = "#ff0000";
            ctx.lineWidth = 2;
            ctx.font = "bold 16px Arial";
            
            // å‚ç›´ç·š
            ctx.beginPath();
            ctx.moveTo(x, yStart);
            ctx.lineTo(x, yStart + height);
            ctx.stroke();

            // ä¸Šä¸‹ç®­é ­/æ¨™è¨˜
            drawArrow(x, yStart, "up");
            drawArrow(x, yStart + height, "down");

            // æ¨™ç¤ºæ–‡å­— (è½‰å‘æˆ–ç›´æ¥å¯«åœ¨æ—é‚Š)
            ctx.textAlign = "right";
            ctx.textBaseline = "middle";
            ctx.fillText(text, x - 10, yStart + height / 2);
        }

        function drawArrow(x, y, direction) {
            ctx.beginPath();
            const size = 6;
            if (direction === "up") {
                ctx.moveTo(x, y);
                ctx.lineTo(x - size, y + size);
                ctx.lineTo(x + size, y + size);
            } else {
                ctx.moveTo(x, y);
                ctx.lineTo(x - size, y - size);
                ctx.lineTo(x + size, y - size);
            }
            ctx.fill();
        }

        // è¼”åŠ©ï¼šåˆ¤æ–·é¡è‰²æ·±æ·ºä»¥æ±ºå®šæ–‡å­—é¡è‰²
        function isColorDark(hex) {
            // ç°¡å–®çš„è½‰æ›
            const r = parseInt(hex.substr(1, 2), 16);
            const g = parseInt(hex.substr(3, 2), 16);
            const b = parseInt(hex.substr(5, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness < 128;
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'stack_diagram.png';
            link.href = canvas.toDataURL();
            link.click();
        }

    </script>
</body>
</html>
