<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç–Šæ§‹åœ–ç”¢ç”Ÿå™¨ (Pro)</title>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        /* --- åŸºç¤ä½ˆå±€ --- */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #121212;
            color: #ddd;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* å·¦å´æ§åˆ¶é¢æ¿ */
        #sidebar {
            width: 380px;
            min-width: 300px;
            max-width: 800px;
            background-color: #1e1e1e;
            padding: 15px;
            padding-top: 60px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 10;
            overflow-y: auto;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        /* æ‹–æ›³èª¿æ•´æ¡¿ */
        #resizer {
            width: 8px;
            background-color: #121212;
            cursor: col-resize;
            z-index: 20;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #resizer::after {
            content: ""; width: 2px; height: 30px; background: #444;
        }
        #resizer:hover, #resizer.active { background: #1976D2; }

        /* å³å´ç•«å¸ƒå€ */
        #main-area {
            flex-grow: 1;
            background-color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            padding: 20px;
        }

        h2 { margin: 0 0 5px 0; color: #4FC3F7; font-size: 18px; }
        h3 { margin: 10px 0 5px 0; color: #bbb; font-size: 14px; border-bottom: 1px solid #444; padding-bottom: 2px;}
        
        .control-group {
            background: #252525; padding: 10px;
            border-radius: 6px; border: 1px solid #333;
        }

        label { display: block; margin-bottom: 3px; font-size: 12px; color: #aaa; }
        
        input[type="text"], input[type="number"], select {
            background: #333; border: 1px solid #555; color: white;
            padding: 5px; border-radius: 4px; width: 100%; box-sizing: border-box;
            font-size: 13px;
        }
        
        /* å±¤æ¬¡åˆ—è¡¨ */
        #layer-list { display: flex; flex-direction: column; gap: 6px; }
        
        .layer-item {
            background: #333; border-radius: 4px; padding: 6px;
            display: flex; align-items: center; gap: 6px;
            border-left: 4px solid #666;
            font-size: 13px;
        }
        
        /* ç·Šæ¹Šå‹è¼¸å…¥æ¡†ä½ˆå±€ */
        .layer-inputs {
            flex-grow: 1; display: grid;
            grid-template-columns: 1.2fr 0.8fr 0.6fr; /* åç¨± åšåº¦ å­—ç´š */
            gap: 4px;
        }

        input[type="color"] {
            border: none; width: 24px; height: 24px; cursor: pointer; background: none; padding: 0;
        }

        .btn-icon { cursor: pointer; color: #888; font-size: 14px; padding: 2px; }
        .btn-icon:hover { color: white; }
        .btn-del:hover { color: #ff5252; }

        /* æ¨™è¨»æ¸…å–® */
        .dim-item {
            background: #2a2a2a; border: 1px solid #444;
            padding: 5px; margin-bottom: 4px; border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 12px; color: #bbb;
        }

        button {
            padding: 8px; font-size: 13px; cursor: pointer;
            background-color: #444; color: white;
            border: 1px solid #555; border-radius: 4px;
            width: 100%; transition: 0.2s; margin-top: 5px;
        }
        button:hover { background-color: #666; }
        
        .btn-ppt { background-color: #E65100; border-color: #EF6C00; font-weight: bold; }
        .btn-img { background-color: #1976D2; border-color: #1565C0; }
        .btn-add { background-color: #43A047; border-color: #2E7D32; }

        .home-btn {
            position: absolute; top: 15px; left: 15px;
            text-decoration: none; background: #444; padding: 6px 12px;
            border-radius: 20px; color: #fff; font-size: 12px;
            border: 1px solid #666; z-index: 100;
        }

        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); background-color: white; }
    </style>
</head>
<body>

    <a href="index.html" class="home-btn">ğŸ  å›é¦–é </a>

    <div id="sidebar">
        <h2>ğŸ“š ç–Šæ§‹åœ–è¨­å®š (Pro)</h2>

        <div class="control-group">
            <label>å…¨åŸŸè¨­å®š (å–®ä½ / å¯¬åº¦ / å­—é«”å¤§å°)</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="unitInput" value="um" placeholder="å–®ä½" oninput="draw()">
                <input type="number" id="canvasWidth" value="400" placeholder="å¯¬" oninput="resizeCanvas()">
                <input type="number" id="globalFontSize" value="14" placeholder="å­—é«”" oninput="draw()">
            </div>
        </div>

        <h3>1. å±¤æ¬¡çµæ§‹ç®¡ç†</h3>
        <button class="btn-add" onclick="addLayer()">â• æ–°å¢ä¸€å±¤ (Top)</button>
        <button onclick="loadExample()" style="margin-bottom:10px;">ğŸ“‚ è¼‰å…¥ç¯„ä¾‹</button>
        
        <div style="display:grid; grid-template-columns: 20px 1.2fr 0.8fr 0.6fr 24px 20px; font-size:10px; color:#888; padding:0 6px; margin-bottom:2px;">
            <span>ç§»</span><span>åç¨±</span><span>åšåº¦</span><span>å­—ç´š</span><span>è‰²</span><span>åˆª</span>
        </div>
        <div id="layer-list"></div>

        <h3>2. è‡ªç”±æ¨™è¨» (Dimensions)</h3>
        <div class="control-group">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <select id="dimStart"></select>
                <span style="align-self:center">è‡³</span>
                <select id="dimEnd"></select>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="dimLabel" placeholder="æ¨™ç¤ºæ–‡å­— (é¸å¡«)" style="flex:2">
                <input type="number" id="dimOffset" value="50" placeholder="åç§»" style="flex:1" title="ç·šæ¢å‘å·¦åç§»è·é›¢">
            </div>
            <button onclick="addDimension()">â• æ–°å¢æ¨™è¨»ç·š</button>
        </div>
        <div id="dim-list" style="margin-top:5px;"></div>

        <div style="margin-top: auto;"></div>
        
        <h3>3. è¼¸å‡º</h3>
        <button class="btn-img" onclick="downloadImage()">ğŸ’¾ ä¸‹è¼‰ç‚ºåœ–ç‰‡ (PNG)</button>
        <button class="btn-ppt" onclick="downloadPPT()">ğŸ“Š ä¸‹è¼‰ç‚º PPT (å¯ç·¨è¼¯åœ–å½¢)</button>
    </div>

    <div id="resizer"></div>

    <div id="main-area">
        <canvas id="stackCanvas"></canvas>
    </div>

    <script>
        // --- è®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        const canvas = document.getElementById('stackCanvas');
        const ctx = canvas.getContext('2d');
        const listEl = document.getElementById('layer-list');
        const dimListEl = document.getElementById('dim-list');

        // è³‡æ–™ï¼šå±¤æ¬¡
        // fontSize: 0 ä»£è¡¨ä½¿ç”¨å…¨åŸŸè¨­å®šï¼Œå¦å‰‡ä½¿ç”¨å€‹åˆ¥è¨­å®š
        let layers = [
            { id: 'l1', name: "CL2", thickness: 20, color: "#0d2b6b", fontSize: 0 },
            { id: 'l2', name: "WCR", thickness: 9, color: "#fcba03", fontSize: 0 },
            { id: 'l3', name: "CL1", thickness: 60, color: "#0d2b6b", fontSize: 0 },
            { id: 'l4', name: "Ad", thickness: 25, color: "#f0f0f0", fontSize: 0 },
            { id: 'l5', name: "PI", thickness: 100, color: "#9e9e9e", fontSize: 24 } // ç¯„ä¾‹ï¼šPI å­—ç‰¹åˆ¥å¤§
        ];

        // è³‡æ–™ï¼šè‡ªè¨‚æ¨™è¨»
        let dimensions = [];

        // UI èª¿æ•´
        const sidebar = document.getElementById('sidebar');
        const resizer = document.getElementById('resizer');
        let isResizing = false;

        resizeCanvas();

        // --- Sidebar æ‹–æ›³é‚è¼¯ ---
        resizer.addEventListener('mousedown', () => { isResizing = true; resizer.classList.add('active'); document.body.style.cursor = 'col-resize'; });
        window.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            let w = e.clientX;
            if (w < 300) w = 300; if (w > 800) w = 800;
            sidebar.style.width = w + 'px';
        });
        window.addEventListener('mouseup', () => { isResizing = false; resizer.classList.remove('active'); document.body.style.cursor = 'default'; });


        // --- å±¤æ¬¡ç®¡ç† ---
        function renderList() {
            listEl.innerHTML = '';
            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            updateDimSelects();

            layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                item.style.borderLeftColor = layer.color;

                const globalSize = document.getElementById('globalFontSize').value;
                const fsPlaceholder = `å…¨åŸŸ(${globalSize})`;

                item.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:0px;">
                        <div class="btn-icon" onclick="moveLayer(${index}, -1)">â–²</div>
                        <div class="btn-icon" onclick="moveLayer(${index}, 1)">â–¼</div>
                    </div>
                    <div class="layer-inputs">
                        <input type="text" value="${layer.name}" oninput="updateLayer(${index}, 'name', this.value)">
                        <input type="number" value="${layer.thickness}" oninput="updateLayer(${index}, 'thickness', this.value)">
                        <input type="number" value="${layer.fontSize || ''}" placeholder="${fsPlaceholder}" oninput="updateLayer(${index}, 'fontSize', this.value)" title="ç•™ç©ºå‰‡ä½¿ç”¨å…¨åŸŸè¨­å®š">
                    </div>
                    <input type="color" value="${layer.color}" oninput="updateLayer(${index}, 'color', this.value)">
                    <div class="btn-icon btn-del" onclick="deleteLayer(${index})">Ã—</div>
                `;
                listEl.appendChild(item);
            });
        }

        function updateLayer(index, key, value) {
            if (key === 'thickness') value = parseFloat(value) || 0;
            if (key === 'fontSize') value = parseInt(value) || 0; // 0 ä»£è¡¨ unset
            layers[index][key] = value;
            if(key === 'color') renderList();
            draw();
        }

        function addLayer() {
            layers.unshift({ id: Date.now().toString(), name: "New", thickness: 10, color: "#cccccc", fontSize: 0 });
            renderList(); draw();
        }

        function deleteLayer(index) {
            layers.splice(index, 1);
            renderList(); draw();
        }

        function moveLayer(index, dir) {
            const target = index + dir;
            if (target < 0 || target >= layers.length) return;
            [layers[index], layers[target]] = [layers[target], layers[index]];
            renderList(); draw();
        }

        function loadExample() {
            if(!confirm("ç¢ºå®šè¦†è“‹è¨­å®šï¼Ÿ")) return;
            layers = [
                { id:'e1', name: "CL2", thickness: 20, color: "#001f5c", fontSize: 0 },
                { id:'e2', name: "WCR", thickness: 9, color: "#ffc107", fontSize: 0 },
                { id:'e3', name: "CL1", thickness: 60, color: "#001f5c", fontSize: 0 },
                { id:'e4', name: "Ad", thickness: 25, color: "#eeeeee", fontSize: 0 },
                { id:'e5', name: "PI", thickness: 100, color: "#a8a8a8", fontSize: 30 },
                { id:'e6', name: "Ad", thickness: 25, color: "#dbeeff", fontSize: 0 },
                { id:'e7', name: "Tape", thickness: 110, color: "#90caf9", fontSize: 0 }
            ];
            dimensions = []; // æ¸…ç©ºæ¨™è¨»
            // è‡ªå‹•åŠ ä¸€å€‹ç¸½åšåº¦æ¨™è¨»
            addDimensionByLogic(0, layers.length-1, "", 80);
            renderList(); draw();
        }

        // --- æ¨™è¨»ç®¡ç† ---
        function updateDimSelects() {
            const s1 = document.getElementById('dimStart');
            const s2 = document.getElementById('dimEnd');
            // ä¿å­˜ç›®å‰é¸é …
            const v1 = s1.value; const v2 = s2.value;
            
            s1.innerHTML = ''; s2.innerHTML = '';
            layers.forEach((l, i) => {
                const opt = `<option value="${i}">${i+1}. ${l.name}</option>`;
                s1.innerHTML += opt;
                s2.innerHTML += opt;
            });

            // å˜—è©¦æ¢å¾©
            if(v1) s1.value = v1; 
            if(v2) s2.value = v2; else if(layers.length > 0) s2.value = layers.length - 1;
        }

        function addDimension() {
            const s = parseInt(document.getElementById('dimStart').value);
            const e = parseInt(document.getElementById('dimEnd').value);
            const txt = document.getElementById('dimLabel').value;
            const off = parseInt(document.getElementById('dimOffset').value) || 50;
            addDimensionByLogic(s, e, txt, off);
        }

        function addDimensionByLogic(sIdx, eIdx, label, offset) {
            // ç¢ºä¿ s å°æ–¼ e (ç”±ä¸Šåˆ°ä¸‹)
            const start = Math.min(sIdx, eIdx);
            const end = Math.max(sIdx, eIdx);
            
            dimensions.push({ start, end, label, offset });
            renderDims();
            draw();
        }

        function renderDims() {
            dimListEl.innerHTML = '';
            dimensions.forEach((d, i) => {
                const sName = layers[d.start] ? layers[d.start].name : '?';
                const eName = layers[d.end] ? layers[d.end].name : '?';
                const div = document.createElement('div');
                div.className = 'dim-item';
                div.innerHTML = `
                    <span>${sName} ~ ${eName} (å${d.offset})</span>
                    <span class="btn-icon btn-del" onclick="deleteDim(${i})">Ã—</span>
                `;
                dimListEl.appendChild(div);
            });
        }

        function deleteDim(i) {
            dimensions.splice(i, 1);
            renderDims(); draw();
        }


        // --- ç¹ªåœ–æ ¸å¿ƒ ---
        function resizeCanvas() {
            const w = parseInt(document.getElementById('canvasWidth').value) || 400;
            canvas.width = w;
            draw();
        }

        function draw() {
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value) || 14;
            
            const totalThickness = layers.reduce((sum, l) => sum + l.thickness, 0);
            if (totalThickness === 0) return;

            // æ‰¾å‡ºæœ€å¤§çš„ offset ä»¥æ±ºå®šå·¦é‚Šè·
            let maxOffset = 20;
            dimensions.forEach(d => { if(d.offset > maxOffset) maxOffset = d.offset; });
            const padding = { top: 40, bottom: 40, left: maxOffset + 40, right: 20 };

            const drawWidth = canvas.width - padding.left - padding.right;
            const availableHeight = Math.max(500, layers.length * 30);
            canvas.height = availableHeight + padding.top + padding.bottom;
            
            const scale = availableHeight / totalThickness;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            // 1. ç•«å±¤æ¬¡
            let currentY = padding.top;
            let yPositions = []; // ç´€éŒ„æ¯ä¸€å±¤çš„ Top Y å’Œ Bottom Y

            layers.forEach(layer => {
                const h = layer.thickness * scale;
                const yStart = currentY;
                const yEnd = currentY + h;
                yPositions.push({ top: yStart, bottom: yEnd });

                ctx.fillStyle = layer.color;
                ctx.fillRect(padding.left, currentY, drawWidth, h);
                ctx.strokeStyle = "#333";
                ctx.lineWidth = 1;
                ctx.strokeRect(padding.left, currentY, drawWidth, h);

                // æ–‡å­—
                if (h > 10) {
                    ctx.fillStyle = isColorDark(layer.color) ? "white" : "black";
                    const fs = layer.fontSize > 0 ? layer.fontSize : globalFS;
                    ctx.font = `bold ${fs}px Arial`;
                    
                    const text = `${layer.name} ${layer.thickness}${unit}`;
                    ctx.fillText(text, padding.left + drawWidth / 2, currentY + h / 2);
                }
                currentY += h;
            });

            // 2. ç•«æ¨™è¨»ç·š
            dimensions.forEach(dim => {
                if (!yPositions[dim.start] || !yPositions[dim.end]) return;
                
                const y1 = yPositions[dim.start].top;
                const y2 = yPositions[dim.end].bottom;
                const h = y2 - y1;
                
                // è¨ˆç®—æ•¸å€¼
                let val = 0;
                for(let k=dim.start; k<=dim.end; k++) val += layers[k].thickness;
                
                // è‹¥ä½¿ç”¨è€…æ²’å¡« labelï¼Œè‡ªå‹•å¡«æ•¸å€¼
                const txt = dim.label ? dim.label : `${val}${unit}`;
                
                // ç•«ç·šä½ç½® X
                const x = padding.left - dim.offset;
                
                drawDimensionLine(x, y1, h, txt);
            });
        }

        function drawDimensionLine(x, yStart, height, text) {
            ctx.strokeStyle = "#D32F2F"; ctx.fillStyle = "#D32F2F";
            ctx.lineWidth = 2; ctx.font = "bold 14px Arial";
            
            // ä¸»ç·š
            ctx.beginPath(); ctx.moveTo(x, yStart); ctx.lineTo(x, yStart + height); ctx.stroke();
            
            // æ©«å‘é€£æ¥ç·š (é€£åˆ°ä¸»åœ–)
            ctx.strokeStyle = "#ccc"; ctx.lineWidth = 1;
            ctx.beginPath(); 
            ctx.moveTo(x, yStart); ctx.lineTo(x + 10, yStart);
            ctx.moveTo(x, yStart + height); ctx.lineTo(x + 10, yStart + height);
            ctx.stroke();

            // ç®­é ­
            ctx.fillStyle = "#D32F2F";
            drawArrow(x, yStart, "up");
            drawArrow(x, yStart + height, "down");

            // æ–‡å­— (è½‰ 90åº¦ æˆ–æ˜¯ å¯«åœ¨æ—é‚Š) -> é€™è£¡å¯«åœ¨å·¦é‚Š
            ctx.textAlign = "right";
            ctx.textBaseline = "middle";
            ctx.fillText(text, x - 5, yStart + height / 2);
        }

        function drawArrow(x, y, dir) {
            ctx.beginPath(); const s = 5;
            if(dir==="up") { ctx.moveTo(x,y); ctx.lineTo(x-s,y+s); ctx.lineTo(x+s,y+s); }
            else { ctx.moveTo(x,y); ctx.lineTo(x-s,y-s); ctx.lineTo(x+s,y-s); }
            ctx.fill();
        }

        function isColorDark(hex) {
            const r = parseInt(hex.substr(1, 2), 16);
            const g = parseInt(hex.substr(3, 2), 16);
            const b = parseInt(hex.substr(5, 2), 16);
            return ((r*299 + g*587 + b*114)/1000) < 128;
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'stack_diagram.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // --- PPT è¼¸å‡ºåŠŸèƒ½ (ä½¿ç”¨ PptxGenJS) ---
        function downloadPPT() {
            let pres = new PptxGenJS();
            
            // è¨­å®š Slide å¤§å° (å¯¬åº¦ä¾æ“šç•«å¸ƒï¼Œä½†é«˜åº¦å¯èƒ½å¾ˆé•·ï¼Œè¨­å¤§ä¸€é»)
            // PPT å–®ä½æ˜¯ inches. 1 inch = 96 px (approx)
            // ç‚ºäº†æ–¹ä¾¿ï¼Œæˆ‘å€‘å‡è¨­ç•«å¸ƒ 100px = 1 inch
            const scaleFactor = 100; 
            const slideW = canvas.width / scaleFactor + 2; // åŠ å¯¬çµ¦æ¨™è¨»
            const slideH = canvas.height / scaleFactor + 1;
            
            pres.defineLayout({ name:'CUSTOM', width: slideW, height: slideH });
            pres.layout = 'CUSTOM';

            let slide = pres.addSlide();
            
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value) || 14;

            // è¨ˆç®—ç¹ªåœ–åƒæ•¸ (éœ€èˆ‡ draw é‚è¼¯ä¸€è‡´)
            const totalThickness = layers.reduce((sum, l) => sum + l.thickness, 0);
            
            let maxOffset = 20;
            dimensions.forEach(d => { if(d.offset > maxOffset) maxOffset = d.offset; });
            const paddingLeftPx = maxOffset + 40;
            const paddingTopPx = 40;
            const drawWidthPx = canvas.width - paddingLeftPx - 20;
            const availableHeightPx = Math.max(500, layers.length * 30);
            const pxToThickScale = availableHeightPx / totalThickness;

            // 1. ç•«å±¤æ¬¡ (Rectangles)
            let currentYPx = paddingTopPx;
            let yPositions = [];

            layers.forEach(layer => {
                const hPx = layer.thickness * pxToThickScale;
                
                // è½‰æ›ç‚º PPT åº§æ¨™ (Inches)
                const x = paddingLeftPx / scaleFactor;
                const y = currentYPx / scaleFactor;
                const w = drawWidthPx / scaleFactor;
                const h = hPx / scaleFactor;
                
                yPositions.push({ top: y, bottom: y + h });

                // æ–‡å­—é¡è‰²
                const textColor = isColorDark(layer.color) ? "FFFFFF" : "000000";
                const fs = layer.fontSize > 0 ? layer.fontSize : globalFS;

                // å»ºç«‹çŸ©å½¢
                slide.addShape(pres.ShapeType.rect, {
                    x: x, y: y, w: w, h: h,
                    fill: { color: layer.color.replace('#', '') },
                    line: { color: "333333", width: 1 },
                    text: {
                        text: `${layer.name} ${layer.thickness}${unit}`,
                        options: { color: textColor, fontSize: fs, align: 'center' }
                    }
                });

                currentYPx += hPx;
            });

            // 2. ç•«æ¨™è¨» (Lines & Text)
            dimensions.forEach(dim => {
                if (!yPositions[dim.start] || !yPositions[dim.end]) return;
                const y1 = yPositions[dim.start].top;
                const y2 = yPositions[dim.end].bottom;
                const xBase = paddingLeftPx / scaleFactor;
                const xLine = (paddingLeftPx - dim.offset) / scaleFactor;
                
                // è¨ˆç®—æ•¸å€¼æ–‡å­—
                let val = 0;
                for(let k=dim.start; k<=dim.end; k++) val += layers[k].thickness;
                const txt = dim.label ? dim.label : `${val}${unit}`;

                // å‚ç›´ç´…ç·š
                slide.addShape(pres.ShapeType.line, {
                    x: xLine, y: y1, w: 0, h: y2 - y1,
                    line: { color: "D32F2F", width: 2, beginArrowType:'triangle', endArrowType:'triangle' }
                });

                // æ¨™è¨»æ–‡å­—
                slide.addText(txt, {
                    x: xLine - 1.5, y: (y1 + y2)/2 - 0.2, w: 1.4, h: 0.4,
                    color: "D32F2F", fontSize: 12, align: 'right'
                });
            });

            pres.writeFile({ fileName: "Stack_Diagram.pptx" });
        }
    </script>
</body>
</html>
