<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ç¨‹ç–Šæ§‹åœ–ç”¢ç”Ÿå™¨ (Pro V3)</title>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #121212; color: #ddd; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }

        /* --- å´é‚Šæ¬„ --- */
        #sidebar { 
            width: 400px; min-width: 320px; max-width: 800px; 
            background-color: #1e1e1e; padding: 15px; padding-top: 50px; 
            display: flex; flex-direction: column; gap: 10px; z-index: 10; 
            overflow-y: auto; flex-shrink: 0; border-right: 1px solid #333;
        }

        /* --- ä¸»ç•«å¸ƒå€ --- */
        #main-area { 
            flex-grow: 1; background-color: #222; 
            display: flex; justify-content: center; align-items: start;
            overflow: auto; padding: 20px; position: relative;
        }

        /* --- æ‰‹æ©Ÿç‰ˆ --- */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            #sidebar { width: 100% !important; max-width: 100%; height: auto; max-height: none; border-right: none; border-bottom: 2px solid #444; }
            #main-area { width: 100%; height: 600px; padding: 10px; display: block; text-align: center; }
            .home-btn { top: 10px; left: 10px; padding: 4px 8px; font-size: 11px; }
        }

        /* --- å…ƒä»¶æ¨£å¼ --- */
        h2 { margin: 0 0 5px 0; color: #4FC3F7; font-size: 18px; }
        h3 { margin: 10px 0 5px 0; color: #bbb; font-size: 14px; border-bottom: 1px solid #444; padding-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
        
        .control-group { background: #252525; padding: 10px; border-radius: 6px; border: 1px solid #333; display: flex; flex-direction: column; gap: 5px; }
        .sub-group { background: #2f2f2f; padding: 8px; border-radius: 4px; border: 1px dashed #555; margin-bottom: 8px; }
        
        label { display: block; margin-bottom: 2px; font-size: 12px; color: #aaa; }
        input[type="text"], input[type="number"], select, textarea { background: #333; border: 1px solid #555; color: white; padding: 6px; border-radius: 4px; width: 100%; font-size: 13px; }
        textarea { resize: vertical; min-height: 40px; }

        /* å±¤æ¬¡åˆ—è¡¨ */
        #layer-list { display: flex; flex-direction: column; gap: 6px; }
        .layer-item { background: #333; border-radius: 4px; padding: 6px; border-left: 4px solid #666; font-size: 13px; transition: 0.2s; }
        .layer-item.dragging { opacity: 0.5; border: 2px dashed #4FC3F7; background: #2a2a2a; }
        .layer-main-row { display: flex; align-items: center; gap: 4px; }
        .layer-inputs { flex-grow: 1; display: grid; grid-template-columns: 1fr 0.6fr; gap: 4px; }
        .layer-details { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #555; grid-template-columns: 1fr 1fr 1fr; gap: 5px; align-items: end; }
        .layer-item.open .layer-details { display: grid; }
        
        .btn-toggle-details { cursor: pointer; color: #888; font-size: 14px; padding: 4px; border-radius: 4px; background: #2a2a2a; text-align: center; width: 20px;}
        .btn-toggle-details.active { background: #1976D2; color: white; }
        input[type="color"] { border: none; width: 24px; height: 24px; cursor: pointer; background: none; padding: 0; }
        .btn-icon { cursor: pointer; color: #888; font-size: 16px; padding: 2px; }
        .btn-del:hover { color: #ff5252; }
        .layer-check { width: 18px; height: 18px; cursor: pointer; margin-right: 2px; accent-color: #4CAF50; }
        .move-btns { display: flex; flex-direction: column; gap: 1px; margin-right: 2px; }
        .btn-tiny { padding: 0px 4px; font-size: 10px; height: 14px; line-height: 12px; background: #444; color: #fff; border: 1px solid #555; cursor: pointer; }
        .dim-item { background: #2a2a2a; border: 1px solid #444; padding: 5px; margin-bottom: 4px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #bbb; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        button { padding: 8px; font-size: 13px; cursor: pointer; background-color: #444; color: white; border: 1px solid #555; border-radius: 4px; width: 100%; transition: 0.2s; margin-top: 5px; }
        button:hover { background-color: #666; }
        
        .btn-row { display: flex; gap: 5px; }
        .btn-save { background-color: #00897B; border-color: #00695C; flex: 1; }
        .btn-cloud-mgr { background-color: #0277BD; border-color: #01579B; flex: 1; }
        .btn-unit-save { background-color: #7B1FA2; border-color: #4A148C; width: auto; padding: 5px 10px; margin-top:0;}
        .btn-unit-add { background-color: #5E35B1; border-color: #4527A0; width: auto; padding: 5px 10px; margin-top:0;}
        .btn-ppt { background-color: #E65100; border-color: #EF6C00; }
        .btn-img { background-color: #1565C0; border-color: #0D47A1; }
        .btn-add { background-color: #2E7D32; border-color: #1B5E20; }
        .btn-backup { background-color: #455A64; border-color: #37474F; flex:1;}
        .btn-restore { background-color: #D84315; border-color: #BF360C; flex:1;}

        .home-btn { position: absolute; top: 15px; left: 15px; text-decoration: none; background: #444; padding: 6px 12px; border-radius: 20px; color: #fff; font-size: 12px; border: 1px solid #666; z-index: 100; }
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); background-color: white; max-width: 100%; }

        /* --- é›²ç«¯ç®¡ç† / é è¦½ Modal (å¤§æ”¹ç‰ˆ) --- */
        .modal-backdrop { position: fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000; display:none;}
        .modal { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #252525; border: 1px solid #4FC3F7; border-radius: 8px;
            padding: 20px; z-index: 2001; display: none;
            width: 900px; max-width: 95%; height: 85vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.9);
            flex-direction: column;
        }
        .modal-body { display: flex; flex: 1; gap: 15px; overflow: hidden; margin-top: 10px;}
        
        .modal-left { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding-right: 5px; border-right: 1px solid #444; }
        .modal-right { width: 320px; display: flex; flex-direction: column; align-items: center; padding-left: 10px; background: #1e1e1e; border-radius: 4px; }
        
        .cloud-list { list-style: none; padding: 0; margin: 0; }
        .cloud-item { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #333; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 4px solid #555; cursor: pointer;
        }
        .cloud-item.selected { border-left-color: #4FC3F7; background: #3e3e3e; }
        .cloud-info { flex: 1; margin-left: 8px;}
        .cloud-name { font-weight: bold; font-size: 14px; color: #fff; }
        .cloud-meta { font-size: 11px; color: #aaa; }
        .cloud-note { font-size: 11px; color: #81C784; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;}
        
        /* Checkbox for batch select */
        .batch-check { width: 18px; height: 18px; accent-color: #0277BD; cursor: pointer; }

        #preview-canvas { max-width: 100%; max-height: 300px; border: 1px solid #555; background: white; margin-bottom: 10px;}
        
        /* Loading */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); color: white; display: none;
            justify-content: center; align-items: center; z-index: 9999; flex-direction: column;
        }
        .spinner { border: 4px solid #333; border-top: 4px solid #4FC3F7; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="font-size: 18px;">é€£ç·šä¸­...</div>
    </div>

    <div class="modal-backdrop" id="mgrBackdrop" onclick="window.closeCloudManager()"></div>
    <div class="modal" id="mgrModal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; border:none; color:#4FC3F7;">â˜ï¸ é›²ç«¯æª”æ¡ˆç¸½ç®¡</h3>
            <button onclick="window.closeCloudManager()" style="width:auto; margin:0; background:#c62828;">é—œé–‰</button>
        </div>
        
        <div style="margin-top: 10px; display: flex; gap: 10px; align-items:center;">
             <input type="text" id="searchCloud" placeholder="æœå°‹å°ˆæ¡ˆ..." oninput="window.renderCloudList()" style="flex:1">
             <button class="btn-small" onclick="window.refreshCloudList()" style="width:auto; margin:0;">ğŸ”„ åˆ·æ–°</button>
             <button class="btn-small" onclick="window.batchExportExcel()" style="width:auto; margin:0; background:#2E7D32;">ğŸ“‹ åŒ¯å‡ºé¸å– Excel</button>
        </div>
        <div style="font-size:12px; color:#aaa; margin-top:5px;">ğŸ’¡ æç¤ºï¼šå‹¾é¸å·¦å´æ¡†æ¡†å¯å¤šé¸åŒ¯å‡ºï¼Œé»æ“Šé …ç›®å¯é è¦½ã€‚</div>

        <div class="modal-body">
            <div class="modal-left">
                <ul class="cloud-list" id="cloudListEl"></ul>
            </div>
            <div class="modal-right">
                <h4 style="color:#fff; margin:10px 0;">é è¦½è¦–çª—</h4>
                <canvas id="previewCanvas"></canvas>
                <div id="preview-details" style="width:100%; text-align:left; color:#ccc; font-size:12px; padding:10px;">
                    è«‹é¸æ“‡å·¦å´å°ˆæ¡ˆ...
                </div>
                <button id="btn-load-preview" style="background:#EF6C00; display:none;" onclick="window.loadSelectedToWorkspace()">ğŸ“‚ è®€å–è‡³ç•«å¸ƒ</button>
                <button id="btn-del-preview" style="background:#c62828; display:none;" onclick="window.deleteSelectedCloud()">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>
        </div>
    </div>

    <a href="index.html" class="home-btn">ğŸ </a>

    <div id="sidebar">
        <h2>ğŸ“š ç–Šæ§‹è³‡æ–™åº« (Pro V3)</h2>

        <div class="control-group" style="border-left: 4px solid #00897B;">
            <label style="color:#80CBC4">â˜ï¸ å°ˆæ¡ˆå­˜å– (Project)</label>
            <input type="text" id="projName" placeholder="å°ˆæ¡ˆåç¨±..." style="margin-bottom: 5px;">
            <textarea id="projNote" placeholder="åœ¨æ­¤è¼¸å…¥å‚™è¨» (Note)... ä¾‹å¦‚: å®¢æˆ¶éœ€æ±‚ã€ç‰¹æ®Šè† æèªªæ˜"></textarea>
            
            <div class="btn-row">
                <button class="btn-save" onclick="window.saveToCloud()">ğŸ’¾ å„²å­˜</button>
                <button class="btn-cloud-mgr" onclick="window.openCloudManager()">â˜ï¸ é›²ç«¯ç®¡ç† / é è¦½</button>
            </div>
            
            <div class="sub-group" style="margin-top:5px; border-color:#555;">
                <label>ğŸ“¦ è³‡æ–™åº«å®Œæ•´å‚™ä»½/é‚„åŸ</label>
                <div class="btn-row">
                    <button class="btn-backup" onclick="window.backupAllCloudData()">â¬‡ï¸ å®Œæ•´å‚™ä»½</button>
                    <button class="btn-restore" onclick="document.getElementById('restoreInput').click()">â¬†ï¸ å®Œæ•´é‚„åŸ</button>
                    <input type="file" id="restoreInput" accept=".json" onchange="window.restoreAllCloudData(this)" style="display:none">
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>å…¨åŸŸè¨­å®š</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="unitInput" value="um" placeholder="å–®ä½" oninput="window.draw()" style="flex:0.5">
                <input type="number" id="canvasWidth" value="450" placeholder="å¯¬" oninput="window.resizeCanvas()" style="flex:1">
                <input type="number" id="globalFontSize" value="14" placeholder="å­—é«”" oninput="window.draw()" style="flex:0.5">
            </div>
        </div>

        <div class="control-group" style="border-left: 4px solid #7B1FA2;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; border:none; color:#E1BEE7;">1. å±¤æ¬¡ & æ¨¡çµ„</h3>
                <label style="cursor:pointer; display:flex; align-items:center; gap:5px; margin:0;">
                    <input type="checkbox" id="selectAllBox" checked onchange="window.toggleAllLayers(this)"> å…¨é¸
                </label>
            </div>

            <div class="sub-group">
                <label style="color:#CE93D8">ğŸ§© æ¨¡çµ„å–®å…ƒ (Unit)</label>
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                    <input type="text" id="unitName" placeholder="æ¨¡çµ„åç¨±..." style="flex:1">
                    <button class="btn-unit-save" onclick="window.saveUnitToCloud()">å­˜æ¨¡çµ„</button>
                </div>
                <div style="display:flex; gap:5px;">
                    <select id="savedUnits" style="flex:1">
                        <option value="">-- é¸æ“‡æ¨¡çµ„ --</option>
                    </select>
                    <button class="btn-unit-add" onclick="window.insertUnit()">â• æ’å…¥</button>
                    <button class="btn-tiny" onclick="window.deleteUnitFromCloud()" style="background:#c62828; width:30px;">ğŸ—‘ï¸</button>
                </div>
            </div>

            <button class="btn-add" onclick="window.addLayer()">â• æ–°å¢ä¸€å±¤ (Top)</button>
            <div id="layer-list"></div>
        </div>

        <div class="control-group">
            <label>2. å°ºå¯¸æ¨™è¨» (Dimension)</label>
            <div style="display:flex; gap:5px;">
                <select id="dimStart"></select> <span>è‡³</span> <select id="dimEnd"></select>
            </div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="text" id="dimLabel" placeholder="æ–‡å­—(é¸å¡«)">
                <input type="number" id="dimOffset" value="50" placeholder="åç§»">
                <button onclick="window.addDimension()" style="margin:0; width:auto;">â•</button>
            </div>
            <div id="dim-list" style="margin-top:5px;"></div>
        </div>

        <div style="margin-top: 10px; display:flex; gap:5px;">
            <button class="btn-img" onclick="window.downloadImage()">ğŸ’¾ å­˜åœ–</button>
            <button class="btn-ppt" onclick="window.downloadPPT()">ğŸ“Š å­˜ PPT</button>
            <button style="background-color: #2E7D32;" onclick="window.exportCurrentToCSV()">ğŸ“‹ å­˜ Excel</button>
        </div>
    </div>

    <div id="resizer"></div>
    <div id="main-area"><canvas id="stackCanvas"></canvas></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc, writeBatch } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyCnHhksuhJs9RdrL7DPnsAvR21ZND7kIOI",
          authDomain: "stack-diagram-db.firebaseapp.com",
          projectId: "stack-diagram-db",
          storageBucket: "stack-diagram-db.firebasestorage.app",
          messagingSenderId: "67240747982",
          appId: "1:67240747982:web:1fb065e40e936a7485419f",
          measurementId: "G-QJNE60W8BB"
        };

        let db = null;
        let isFirebaseReady = false;
        const COL_PROJ = "projects";
        const COL_UNITS = "units";
        let cloudProjectsCache = []; 
        let currentPreviewId = null;

        if (!firebaseConfig.apiKey.includes("ä½ çš„API_KEY")) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isFirebaseReady = true;
            } catch(e) { console.error("Firebase init error", e); }
        }

        const canvas = document.getElementById('stackCanvas');
        const ctx = canvas.getContext('2d');
        const listEl = document.getElementById('layer-list');

        window.layers = [];
        window.dimensions = [];
        let dragSrcEl = null;

        // ---------------------------------------------
        // Core: Render & Drag
        // ---------------------------------------------
        window.renderList = function() {
            listEl.innerHTML = ''; window.updateDimSelects();
            const allChecked = window.layers.every(l => l.checked !== false);
            if(document.getElementById('selectAllBox')) document.getElementById('selectAllBox').checked = allChecked;

            window.layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                item.setAttribute('draggable', 'true');
                item.setAttribute('data-index', index);
                if(layer.showDetails) item.classList.add('open');
                item.style.borderLeftColor = layer.color;
                const isChecked = layer.checked !== false ? 'checked' : '';

                item.innerHTML = `
                    <div class="layer-main-row">
                        <input type="checkbox" class="layer-check" ${isChecked} onchange="window.toggleLayerCheck(${index})">
                        <div class="move-btns">
                            <button class="btn-tiny" onclick="window.moveLayer(${index}, -1)">â–²</button>
                            <button class="btn-tiny" onclick="window.moveLayer(${index}, 1)">â–¼</button>
                        </div>
                        <div class="layer-inputs">
                            <input type="text" value="${layer.name}" oninput="window.updateLayer(${index}, 'name', this.value)" placeholder="åç¨±">
                            <input type="number" value="${layer.thickness}" oninput="window.updateLayer(${index}, 'thickness', this.value)" placeholder="åšåº¦">
                        </div>
                        <input type="color" value="${layer.color}" oninput="window.updateLayer(${index}, 'color', this.value)">
                        <div class="btn-toggle-details ${layer.showDetails?'active':''}" onclick="window.toggleDetails(${index})">âš™ï¸</div>
                        <div class="btn-icon btn-del" onclick="window.deleteLayer(${index})">Ã—</div>
                    </div>
                    <div class="layer-details">
                        <div><label>é¡è‰²</label><input type="color" value="${layer.textColor||'#000000'}" oninput="window.updateLayer(${index}, 'textColor', this.value)" style="width:100%"></div>
                        <div><label>å­—é«”</label><input type="number" value="${layer.fontSize || ''}" placeholder="å…¨åŸŸ" oninput="window.updateLayer(${index}, 'fontSize', this.value)"></div>
                        <div><label>æ¨£å¼</label><select onchange="window.updateLayer(${index}, 'fontStyle', this.value)" style="padding:2px;"><option value="normal" ${layer.fontStyle==='normal'?'selected':''}>ä¸€èˆ¬</option><option value="bold" ${layer.fontStyle==='bold'?'selected':''}>ç²—é«”</option></select></div>
                    </div>
                `;
                
                item.addEventListener('dragstart', function(e) { this.style.opacity='0.4'; dragSrcEl=this; e.dataTransfer.effectAllowed='move'; this.classList.add('dragging'); });
                item.addEventListener('dragover', function(e) { if(e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect='move'; return false; });
                item.addEventListener('drop', function(e) { 
                    if(e.stopPropagation) e.stopPropagation();
                    if(dragSrcEl !== this) {
                        const oldIdx = parseInt(dragSrcEl.getAttribute('data-index'));
                        const newIdx = parseInt(this.getAttribute('data-index'));
                        const moved = window.layers.splice(oldIdx, 1)[0];
                        window.layers.splice(newIdx, 0, moved);
                        window.renderList(); window.draw();
                    }
                    return false;
                });
                item.addEventListener('dragend', function() { this.style.opacity='1'; this.classList.remove('dragging'); });
                listEl.appendChild(item);
            });
        };

        window.moveLayer = (i, d) => { const n = i+d; if(n<0||n>=window.layers.length)return; const t=window.layers[i]; window.layers[i]=window.layers[n]; window.layers[n]=t; window.renderList(); window.draw(); };
        window.toggleLayerCheck = (i) => { window.layers[i].checked = !window.layers[i].checked; window.renderList(); };
        window.toggleAllLayers = (cb) => { window.layers.forEach(l => l.checked = cb.checked); window.renderList(); };
        window.updateLayer = (i, k, v) => { if(k==='thickness'||k==='fontSize') v=parseFloat(v)||0; window.layers[i][k]=v; if(k==='color') window.renderList(); window.draw(); };
        window.toggleDetails = (i) => { window.layers[i].showDetails = !window.layers[i].showDetails; window.renderList(); };
        window.addLayer = () => { window.layers.unshift({ id: Date.now(), name: "New", thickness: 20, color: "#cccccc", fontSize: 0, fontStyle: 'bold', checked: true }); window.renderList(); window.draw(); };
        window.deleteLayer = (i) => { window.layers.splice(i, 1); window.renderList(); window.draw(); };

        window.updateDimSelects = () => {
            const s1=document.getElementById('dimStart'), s2=document.getElementById('dimEnd');
            const v1=s1.value, v2=s2.value; s1.innerHTML=''; s2.innerHTML='';
            window.layers.forEach((l,i) => { const o = `<option value="${i}">${i+1}. ${l.name}</option>`; s1.innerHTML+=o; s2.innerHTML+=o; });
            if(v1) s1.value=v1; if(v2) s2.value=v2; else if(window.layers.length>0) s2.value=window.layers.length-1;
        };
        window.addDimension = () => { 
            const s=parseInt(document.getElementById('dimStart').value), e=parseInt(document.getElementById('dimEnd').value);
            window.dimensions.push({ start: Math.min(s,e), end: Math.max(s,e), label: document.getElementById('dimLabel').value, offset: parseInt(document.getElementById('dimOffset').value)||50 });
            renderDims(); window.draw();
        };
        function renderDims() { 
            const dimListEl = document.getElementById('dim-list');
            dimListEl.innerHTML=''; window.dimensions.forEach((d,i) => { 
            const n1=window.layers[d.start]?.name, n2=window.layers[d.end]?.name; 
            dimListEl.innerHTML += `<div class="dim-item"><span>${n1}~${n2} (å${d.offset})</span><span class="btn-icon btn-del" onclick="window.deleteDim(${i})">Ã—</span></div>`; 
        }); }
        window.deleteDim = (i) => { window.dimensions.splice(i,1); renderDims(); window.draw(); };

        // ---------------------------------------------
        // â˜… é›²ç«¯ç®¡ç† Manager (New Logic)
        // ---------------------------------------------
        window.openCloudManager = function() {
            if(!isFirebaseReady) { alert("å°šæœªé€£ç·š"); return; }
            document.getElementById('mgrModal').style.display = 'flex'; // flex for layout
            document.getElementById('mgrBackdrop').style.display = 'block';
            window.refreshCloudList();
        };
        window.closeCloudManager = function() {
            document.getElementById('mgrModal').style.display = 'none';
            document.getElementById('mgrBackdrop').style.display = 'none';
        };

        window.refreshCloudList = async function() {
            showLoading(true, "è®€å–é›²ç«¯è³‡æ–™...");
            try {
                const q = await getDocs(collection(db, COL_PROJ));
                cloudProjectsCache = [];
                q.forEach(doc => cloudProjectsCache.push({ id: doc.id, ...doc.data() }));
                window.renderCloudList();
            } catch(e) { console.error(e); }
            showLoading(false);
        };

        window.renderCloudList = function() {
            const listEl = document.getElementById('cloudListEl');
            const search = document.getElementById('searchCloud').value.toLowerCase();
            listEl.innerHTML = '';

            cloudProjectsCache.forEach(p => {
                if(search && !p.id.toLowerCase().includes(search)) return;
                
                const note = p.note ? p.note : 'ç„¡å‚™è¨»';
                const date = new Date(p.timestamp || 0).toLocaleDateString();
                
                const li = document.createElement('li');
                li.className = 'cloud-item';
                li.onclick = (e) => { 
                    if(e.target.type !== 'checkbox') window.selectCloudItem(p.id); 
                };
                li.innerHTML = `
                    <input type="checkbox" class="batch-check" value="${p.id}">
                    <div class="cloud-info">
                        <div class="cloud-name">${p.id}</div>
                        <div class="cloud-meta">${date}</div>
                        <div class="cloud-note">${note}</div>
                    </div>
                `;
                listEl.appendChild(li);
            });
        };

        window.selectCloudItem = function(id) {
            currentPreviewId = id;
            document.querySelectorAll('.cloud-item').forEach(el => el.classList.remove('selected'));
            // Find checkbox to highlight row
            const inputs = document.querySelectorAll('.batch-check');
            inputs.forEach(inp => {
                if(inp.value === id) inp.closest('.cloud-item').classList.add('selected');
            });
            
            // Render Preview
            const p = cloudProjectsCache.find(x => x.id === id);
            const detailEl = document.getElementById('preview-details');
            if(p) {
                detailEl.innerHTML = `
                    <strong>å°ˆæ¡ˆ:</strong> ${p.id}<br>
                    <strong>å‚™è¨»:</strong> ${p.note || ''}<br>
                    <strong>å±¤æ•¸:</strong> ${p.layers?.length || 0}<br>
                    <strong>æœ€å¾Œä¿®æ”¹:</strong> ${new Date(p.timestamp).toLocaleString()}
                `;
                window.drawPreviewCanvas(p.layers);
                document.getElementById('btn-load-preview').style.display = 'inline-block';
                document.getElementById('btn-del-preview').style.display = 'inline-block';
            }
        };

        window.drawPreviewCanvas = function(layers) {
            const cvs = document.getElementById('previewCanvas');
            const ctx = cvs.getContext('2d');
            cvs.width = 300; cvs.height = 300;
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,300,300);

            if(!layers || layers.length === 0) return;

            const totalThick = layers.reduce((s,l) => s+(parseFloat(l.thickness)||0),0) || 1;
            const scale = 260 / totalThick;
            const cx = 150; const rw = 120; let cy = 20;

            layers.forEach(l => {
                const h = (parseFloat(l.thickness)||0) * scale;
                ctx.fillStyle = l.color || "#ccc"; ctx.fillRect(cx - rw/2, cy, rw, h);
                ctx.strokeStyle = "#333"; ctx.strokeRect(cx - rw/2, cy, rw, h);
                if(h > 8) { ctx.fillStyle = "#000"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(l.name, cx, cy+h/2); }
                cy += h;
            });
        };

        // åŒ¯å‡ºå¤šé¸ Excel
        window.batchExportExcel = function() {
            const checks = document.querySelectorAll('.batch-check:checked');
            if(checks.length === 0) { alert("è«‹å…ˆå‹¾é¸å·¦å´å°ˆæ¡ˆ"); return; }
            
            let csv = "\uFEFF"; // BOM
            
            checks.forEach(chk => {
                const id = chk.value;
                const p = cloudProjectsCache.find(x => x.id === id);
                if(p) {
                    csv += `å°ˆæ¡ˆåç¨±: ${p.id}\n`;
                    csv += `å‚™è¨»: ${(p.note||"").replace(/\n/g," ")}\n`;
                    csv += `å±¤åº,åç¨±,åšåº¦,å–®ä½\n`;
                    let t = 0;
                    const unit = p.settings?.unit || 'um';
                    const layers = p.layers || [];
                    layers.forEach((l,i) => {
                         if(l.checked === false) return; // ç•¥éæœªå‹¾é¸å±¤(å¦‚æœæœ‰çš„è©±)
                         t += (parseFloat(l.thickness)||0);
                         csv += `${i+1},${(l.name||"").replace(/,/g," ")},${l.thickness},${unit}\n`;
                    });
                    csv += `,,${t},${unit},ç¸½åšåº¦\n\n`; // ç©ºè¡Œåˆ†éš”
                }
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Batch_Stackups_${Date.now()}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        window.loadSelectedToWorkspace = function() {
            if(!currentPreviewId) return;
            const p = cloudProjectsCache.find(x => x.id === currentPreviewId);
            if(p) {
                window.applyConfig(p);
                document.getElementById('projName').value = p.id;
                document.getElementById('projNote').value = p.note || "";
                window.closeCloudManager();
            }
        };

        window.deleteSelectedCloud = async function() {
            if(!currentPreviewId) return;
            if(!confirm(`ç¢ºå®šåˆªé™¤ ${currentPreviewId}?`)) return;
            showLoading(true);
            try { await deleteDoc(doc(db, COL_PROJ, currentPreviewId)); await window.refreshCloudList(); currentPreviewId=null;} catch(e) {}
            showLoading(false);
        };

        // ---------------------------------------------
        // â˜… Full Backup & Restore
        // ---------------------------------------------
        window.backupAllCloudData = async function() {
            if(!isFirebaseReady) { alert("å°šæœªé€£ç·š"); return; }
            showLoading(true, "æ‰“åŒ…æ‰€æœ‰è³‡æ–™ä¸­...");
            try {
                // Get Projects
                const projSnap = await getDocs(collection(db, COL_PROJ));
                const projects = {};
                projSnap.forEach(d => projects[d.id] = d.data());

                // Get Units
                const unitSnap = await getDocs(collection(db, COL_UNITS));
                const units = {};
                unitSnap.forEach(d => units[d.id] = d.data());

                const backupData = {
                    version: "V3",
                    timestamp: Date.now(),
                    projects: projects,
                    units: units
                };

                const str = JSON.stringify(backupData, null, 2);
                const blob = new Blob([str], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `FULL_BACKUP_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            } catch(e) { console.error(e); alert("å‚™ä»½å¤±æ•—"); }
            showLoading(false);
        };

        window.restoreAllCloudData = function(input) {
            const file = input.files[0]; if(!file) return;
            if(!confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒæŠŠå‚™ä»½æª”ä¸­çš„è³‡æ–™å¯«å…¥é›²ç«¯è³‡æ–™åº«ã€‚\nè‹¥æœ‰åŒåæª”æ¡ˆå°‡è¢«è¦†è“‹ã€‚\nç¢ºå®šåŸ·è¡Œï¼Ÿ")) { input.value = ''; return; }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                showLoading(true, "æ­£åœ¨é‚„åŸè‡³é›²ç«¯...");
                try {
                    const data = JSON.parse(e.target.result);
                    const batch = writeBatch(db);
                    let count = 0;

                    // Restore Projects
                    if(data.projects) {
                        for (const [id, val] of Object.entries(data.projects)) {
                            const ref = doc(db, COL_PROJ, id);
                            batch.set(ref, val);
                            count++;
                        }
                    }
                    // Restore Units
                    if(data.units) {
                        for (const [id, val] of Object.entries(data.units)) {
                            const ref = doc(db, COL_UNITS, id);
                            batch.set(ref, val);
                            count++;
                        }
                    }

                    // Commit (Firestore batch limit is 500, simple logic here assumes <500 for demo)
                    // For robust production, need to chunk batches.
                    await batch.commit();
                    alert(`é‚„åŸæˆåŠŸï¼å…±å¯«å…¥ ${count} ç­†è³‡æ–™ã€‚`);
                    window.refreshUnitList();
                } catch(err) { console.error(err); alert("é‚„åŸå¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼"); }
                showLoading(false);
                input.value = '';
            };
            reader.readAsText(file);
        };

        // ---------------------------------------------
        // Main Functions
        // ---------------------------------------------
        function showLoading(show, text="è™•ç†ä¸­") {
            const ov = document.getElementById('loading-overlay');
            if(show) { document.getElementById('loading-text').innerText=text; ov.style.display='flex'; } else ov.style.display='none';
        }

        window.saveToCloud = async function() {
            if(!isFirebaseReady) return alert("æœªé€£ç·š");
            const name = document.getElementById('projName').value.trim();
            if(!name) return alert("è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±");
            
            const data = {
                layers: window.layers,
                dimensions: window.dimensions,
                settings: { unit: document.getElementById('unitInput').value, width: document.getElementById('canvasWidth').value },
                note: document.getElementById('projNote').value,
                timestamp: Date.now()
            };
            
            if(!confirm(`å„²å­˜å°ˆæ¡ˆ: ${name}?`)) return;
            showLoading(true);
            try { await setDoc(doc(db, COL_PROJ, name), data); alert("å„²å­˜æˆåŠŸ"); } catch(e) { alert("Error"); }
            showLoading(false);
        };

        window.saveUnitToCloud = async function() {
            const name = document.getElementById('unitName').value.trim();
            const sel = window.layers.filter(l => l.checked!==false);
            if(!name || sel.length===0) return alert("è«‹è¼¸å…¥åç¨±ä¸¦å‹¾é¸å±¤æ¬¡");
            
            if(!confirm(`å­˜æ¨¡çµ„: ${name}?`)) return;
            showLoading(true);
            try { 
                await setDoc(doc(db, COL_UNITS, name), { layers: sel, timestamp: Date.now() }); 
                alert("æ¨¡çµ„å·²å­˜"); window.refreshUnitList(); document.getElementById('unitName').value='';
            } catch(e) { alert("Error"); }
            showLoading(false);
        };

        window.refreshUnitList = async function() {
            if(!isFirebaseReady) return;
            const s = document.getElementById('savedUnits');
            try {
                const q = await getDocs(collection(db, COL_UNITS));
                s.innerHTML = '<option value="">-- é¸æ“‡æ¨¡çµ„ --</option>';
                q.forEach(d => {
                    const opt = document.createElement('option'); opt.value=d.id; opt.innerText=d.id; s.appendChild(opt);
                });
            } catch(e) {}
        };

        window.insertUnit = async function() {
            const n = document.getElementById('savedUnits').value;
            if(!n) return;
            showLoading(true);
            try {
                const d = await getDoc(doc(db, COL_UNITS, n));
                if(d.exists()) {
                    const ul = d.data().layers.map(l => ({...l, id:Date.now()+Math.random(), checked:true}));
                    window.layers = [...ul, ...window.layers];
                    window.renderList(); window.draw();
                }
            } catch(e) {}
            showLoading(false);
        };
        
        window.deleteUnitFromCloud = async function() {
            const n = document.getElementById('savedUnits').value;
            if(n && confirm(`åˆªé™¤æ¨¡çµ„ ${n}?`)) {
                await deleteDoc(doc(db, COL_UNITS, n)); window.refreshUnitList();
            }
        };

        window.exportCurrentToCSV = function() {
            const sel = window.layers.filter(l => l.checked!==false);
            if(sel.length===0) return alert("ç„¡é¸å–å±¤");
            const name = document.getElementById('projName').value || "Stackup";
            const note = document.getElementById('projNote').value;
            const unit = document.getElementById('unitInput').value;
            
            let csv = "\uFEFF";
            if(note) csv += `å‚™è¨»: ${note.replace(/\n/g," ")}\n\n`;
            csv += "å±¤åº,åç¨±,åšåº¦,å–®ä½\n";
            let t=0;
            sel.forEach((l,i) => {
                t += (parseFloat(l.thickness)||0);
                csv += `${i+1},${(l.name||"").replace(/,/g," ")},${l.thickness},${unit}\n`;
            });
            csv += `,,${t},${unit},é¸å–ç¸½åšåº¦\n`;
            const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
            const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`${name}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        // Standard Helpers
        window.applyConfig = (c) => { 
            window.layers=c.layers||[]; window.dimensions=c.dimensions||[]; 
            if(c.settings) { document.getElementById('unitInput').value=c.settings.unit||"um"; document.getElementById('canvasWidth').value=c.settings.width||450; }
            window.renderList(); window.draw();
        };
        window.downloadImage = () => { const a=document.createElement('a'); a.download='stack.png'; a.href=canvas.toDataURL(); a.click(); };
        window.downloadPPT = () => {
             let pres = new PptxGenJS();
             const unit = document.getElementById('unitInput').value;
             const totalThick = window.layers.reduce((s,l)=>s+(parseFloat(l.thickness)||0),0);
             if(totalThick===0) return alert("ç„¡è³‡æ–™");
             
             let maxOff=20; window.dimensions.forEach(d=> {if(d.offset>maxOff)maxOff=d.offset;});
             const pl=maxOff+150, pt=50, sf=100, cw=canvas.width-(maxOff+40)-20;
             const ah = Math.max(500, window.layers.length*40);
             const sc = ah/totalThick;
             pres.defineLayout({name:'C',width:(pl+cw+50)/sf,height:(ah+100)/sf}); pres.layout='C';
             
             let s = pres.addSlide(); let cy=pt;
             window.layers.forEach(l => {
                 const h = l.thickness*sc;
                 const fs = l.fontSize||14;
                 const fc = l.color.replace('#','');
                 const tc = isColorDark(l.color)?'FFFFFF':'000000';
                 s.addShape(pres.ShapeType.rect, {x:pl/sf, y:cy/sf, w:cw/sf, h:h/sf, fill:fc, line:'333333'});
                 s.addText(`${l.name} ${l.thickness}${unit}`, {x:pl/sf, y:cy/sf, w:cw/sf, h:h/sf, color:tc, fontSize:fs, align:'center', valign:'middle'});
                 cy+=h;
             });
             pres.writeFile({fileName:"Stack.pptx"});
        };
        
        function isColorDark(hex) { const r=parseInt(hex.substr(1,2),16),g=parseInt(hex.substr(3,2),16),b=parseInt(hex.substr(5,2),16); return ((r*299+g*587+b*114)/1000)<128; }
        window.resizeCanvas = () => { canvas.width=parseInt(document.getElementById('canvasWidth').value)||450; window.draw(); };
        window.draw = () => {
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value)||14;
            const totalThick = window.layers.reduce((s,l)=>s+(parseFloat(l.thickness)||0),0);
            if(totalThick===0 && window.layers.length===0) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
            let maxOff = 20; window.dimensions.forEach(d => { if(d.offset>maxOff) maxOff=d.offset; });
            const pad = { t:40, b:40, l: maxOff+80, r:20 };
            const dw = canvas.width - pad.l - pad.r;
            const ah = Math.max(500, window.layers.length*40);
            canvas.height = ah + pad.t + pad.b;
            const scale = ah / (totalThick||1);
            
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.textAlign="center"; ctx.textBaseline="middle";
            let cy = pad.t;
            let yPos = [];

            window.layers.forEach(l => {
                const h = (parseFloat(l.thickness)||0)*scale;
                yPos.push({t:cy, b:cy+h});
                ctx.fillStyle = l.color; ctx.fillRect(pad.l, cy, dw, h);
                ctx.strokeStyle="#333"; ctx.strokeRect(pad.l, cy, dw, h);
                if(h>12) {
                     ctx.fillStyle = isColorDark(l.color)?"white":"black"; if(l.textColor) ctx.fillStyle=l.textColor;
                     const fs = l.fontSize||globalFS; const st = l.fontStyle==='bold'?'bold':'';
                     ctx.font = `${st} ${fs}px Arial`; ctx.fillText(`${l.name} ${l.thickness}${unit}`, pad.l+dw/2, cy+h/2);
                }
                cy += h;
            });
            window.dimensions.forEach(d => {
                if(!yPos[d.start] || !yPos[d.end]) return;
                const y1=yPos[d.start].t, y2=yPos[d.end].b, h=y2-y1, x=pad.l-d.offset;
                ctx.strokeStyle="#D32F2F"; ctx.fillStyle="#D32F2F"; ctx.lineWidth=2; ctx.font="bold 14px Arial";
                ctx.beginPath(); ctx.moveTo(x,y1); ctx.lineTo(x,y1+h); ctx.stroke();
                ctx.strokeStyle="#ccc"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x,y1); ctx.lineTo(x+10,y1); ctx.moveTo(x,y1+h); ctx.lineTo(x+10,y1+h); ctx.stroke();
                drawArrow(ctx,x,y1,1); drawArrow(ctx,x,y1+h,0);
                const txt = d.label || `${window.layers.slice(d.start,d.end+1).reduce((s,l)=>s+(parseFloat(l.thickness)||0),0)}${unit}`;
                ctx.textAlign="right"; ctx.fillText(txt, x-5, y1+h/2);
            });
        };
        function drawArrow(ctx,x,y,u) { ctx.beginPath(); const s=5; if(u){ctx.moveTo(x,y);ctx.lineTo(x-s,y+s);ctx.lineTo(x+s,y+s);}else{ctx.moveTo(x,y);ctx.lineTo(x-s,y-s);ctx.lineTo(x+s,y-s);} ctx.fill(); }

        // Start
        if(isFirebaseReady) window.refreshUnitList();
        window.renderList(); window.draw();

    </script>
</body>
</html>
