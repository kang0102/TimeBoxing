<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç–Šæ§‹åœ–ç”¢ç”Ÿå™¨ (Project DB)</title>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        /* --- åŸºç¤ä½ˆå±€ --- */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #121212;
            color: #ddd;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* å·¦å´æ§åˆ¶é¢æ¿ */
        #sidebar {
            width: 400px;
            min-width: 320px;
            max-width: 800px;
            background-color: #1e1e1e;
            padding: 15px;
            padding-top: 60px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 10;
            overflow-y: auto;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        /* æ‹–æ›³èª¿æ•´æ¡¿ */
        #resizer {
            width: 8px; background-color: #121212; cursor: col-resize; z-index: 20; flex-shrink: 0;
            display: flex; justify-content: center; align-items: center;
        }
        #resizer::after { content: ""; width: 2px; height: 30px; background: #444; }
        #resizer:hover, #resizer.active { background: #1976D2; }

        /* å³å´ç•«å¸ƒå€ */
        #main-area {
            flex-grow: 1; background-color: #222;
            display: flex; justify-content: center; align-items: center;
            overflow: auto; padding: 20px; cursor: default;
        }

        /* æ–‡å­—èˆ‡è¼¸å…¥æ¡†æ¨£å¼ */
        h2 { margin: 0 0 5px 0; color: #4FC3F7; font-size: 18px; }
        h3 { margin: 15px 0 5px 0; color: #bbb; font-size: 14px; border-bottom: 1px solid #444; padding-bottom: 2px;}
        
        .control-group { background: #252525; padding: 10px; border-radius: 6px; border: 1px solid #333; }
        label { display: block; margin-bottom: 3px; font-size: 12px; color: #aaa; }
        
        input[type="text"], input[type="number"], select {
            background: #333; border: 1px solid #555; color: white;
            padding: 5px; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 13px;
        }

        /* --- å±¤æ¬¡åˆ—è¡¨ --- */
        #layer-list { display: flex; flex-direction: column; gap: 6px; }
        
        .layer-item {
            background: #333; border-radius: 4px; padding: 6px;
            border-left: 4px solid #666; font-size: 13px;
            cursor: grab; transition: transform 0.2s, box-shadow 0.2s;
        }
        .layer-item.dragging { opacity: 0.5; border: 2px dashed #888; }
        
        .layer-main-row { display: flex; align-items: center; gap: 6px; }
        .drag-handle { cursor: grab; color: #666; font-size: 16px; padding: 0 4px; }
        .drag-handle:hover { color: #fff; }

        .layer-inputs { flex-grow: 1; display: grid; grid-template-columns: 1fr 0.6fr; gap: 4px; }

        .layer-details {
            display: none; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #555;
            grid-template-columns: 1fr 1fr 1fr; gap: 5px; align-items: end;
        }
        .layer-item.open .layer-details { display: grid; }
        
        .btn-toggle-details {
            cursor: pointer; color: #888; font-size: 14px; padding: 4px; border-radius: 4px; background: #2a2a2a;
        }
        .btn-toggle-details:hover { background: #444; color: white; }
        .btn-toggle-details.active { background: #1976D2; color: white; }

        input[type="color"] { border: none; width: 24px; height: 24px; cursor: pointer; background: none; padding: 0; }
        .btn-icon { cursor: pointer; color: #888; font-size: 16px; padding: 2px; }
        .btn-del:hover { color: #ff5252; }

        /* æ¨™è¨»æ¸…å–® */
        .dim-item {
            background: #2a2a2a; border: 1px solid #444; padding: 5px; margin-bottom: 4px;
            border-radius: 4px; display: flex; justify-content: space-between; align-items: center;
            font-size: 12px; color: #bbb;
        }

        button {
            padding: 8px; font-size: 13px; cursor: pointer;
            background-color: #444; color: white;
            border: 1px solid #555; border-radius: 4px; width: 100%;
            transition: 0.2s; margin-top: 5px;
        }
        button:hover { background-color: #666; }
        .btn-ppt { background-color: #E65100; border-color: #EF6C00; font-weight: bold; }
        .btn-img { background-color: #1976D2; border-color: #1565C0; }
        .btn-add { background-color: #43A047; border-color: #2E7D32; }
        .btn-save-local { background-color: #00897B; border-color: #00695C; width: auto; flex:0.4; }
        .btn-del-local { background-color: #c62828; border-color: #b71c1c; width: auto; flex:0.2;}

        .home-btn {
            position: absolute; top: 15px; left: 15px;
            text-decoration: none; background: #444; padding: 6px 12px;
            border-radius: 20px; color: #fff; font-size: 12px;
            border: 1px solid #666; z-index: 100;
        }

        /* éš±è—çš„æª”æ¡ˆä¸Šå‚³è¼¸å…¥æ¡† */
        #fileInput { display: none; }

        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); background-color: white; }
    </style>
</head>
<body>

    <a href="index.html" class="home-btn">ğŸ  å›é¦–é </a>

    <div id="sidebar">
        <h2>ğŸ“š ç–Šæ§‹è³‡æ–™åº«</h2>

        <div class="control-group" style="border-color: #00897B;">
            <label style="color:#80CBC4">ğŸ’¾ å°ˆæ¡ˆå­˜å– (ä¸‹æ‹‰é¸å–®)</label>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="projName" placeholder="è¼¸å…¥åç¨± (ä¾‹: 5å±¤æ¿Aæ¬¾)" style="flex:1">
                <button class="btn-save-local" onclick="saveToLocal()">å„²å­˜</button>
            </div>
            <div style="display:flex; gap:5px;">
                <select id="savedProjects" onchange="loadFromLocal()" style="flex:1">
                    <option value="">-- é¸æ“‡å·²å­˜å°ˆæ¡ˆ --</option>
                </select>
                <button class="btn-del-local" onclick="deleteFromLocal()" title="åˆªé™¤é¸å®šå°ˆæ¡ˆ">ğŸ—‘ï¸</button>
            </div>
        </div>
        
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <button onclick="newProject()" style="background:#555">ğŸ“„ æ¸…ç©º</button>
            <button onclick="exportJSON()" style="background:#555">ğŸ“¤ å‚™ä»½æª”æ¡ˆ</button>
            <button onclick="document.getElementById('fileInput').click()" style="background:#555">ğŸ“¥ è®€å–æª”æ¡ˆ</button>
            <input type="file" id="fileInput" accept=".json" onchange="importJSON(this)">
        </div>

        <div class="control-group">
            <label>å…¨åŸŸè¨­å®š</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="unitInput" value="um" placeholder="å–®ä½" oninput="draw()" style="flex:1">
                <input type="number" id="canvasWidth" value="450" placeholder="ç•«å¸ƒå¯¬" oninput="resizeCanvas()" style="flex:1">
                <input type="number" id="globalFontSize" value="14" placeholder="å­—é«”" oninput="draw()" style="flex:1">
            </div>
        </div>

        <h3>1. å±¤æ¬¡ (å¯æ‹–æ›³æ’åº)</h3>
        <button class="btn-add" onclick="addLayer()">â• æ–°å¢ä¸€å±¤ (Top)</button>
        
        <div id="layer-list" style="margin-top:5px;"></div>

        <h3>2. æ¨™è¨» (æ‹–æ›³ç´…ç·šèª¿æ•´)</h3>
        <div class="control-group">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <select id="dimStart"></select> <span>è‡³</span> <select id="dimEnd"></select>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="dimLabel" placeholder="æ–‡å­— (é¸å¡«)">
                <input type="number" id="dimOffset" value="50" placeholder="åç§»">
            </div>
            <button onclick="addDimension()">â• æ–°å¢æ¨™è¨»</button>
        </div>
        <div id="dim-list" style="margin-top:5px;"></div>

        <div style="margin-top: auto;"></div>
        
        <h3>3. è¼¸å‡º</h3>
        <button class="btn-img" onclick="downloadImage()">ğŸ’¾ ä¸‹è¼‰åœ–ç‰‡ (PNG)</button>
        <button class="btn-ppt" onclick="downloadPPT()">ğŸ“Š ä¸‹è¼‰ PPT (åœ–æ–‡åˆ†é›¢ç‰ˆ)</button>
    </div>

    <div id="resizer"></div>

    <div id="main-area">
        <canvas id="stackCanvas"></canvas>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const canvas = document.getElementById('stackCanvas');
        const ctx = canvas.getContext('2d');
        const listEl = document.getElementById('layer-list');
        const dimListEl = document.getElementById('dim-list');
        const STORAGE_KEY = 'stack_diagram_projects'; // LocalStorage Key

        // è³‡æ–™çµæ§‹
        let layers = [];
        let dimensions = [];

        // äº’å‹•ç‹€æ…‹
        let dragTargetType = null; 
        let dragIndex = -1;
        let isDraggingCanvas = false;
        let lastMouseY = 0; let lastMouseX = 0;
        let hitRegions = { layers: [], dims: [] };

        // UI èª¿æ•´
        const sidebar = document.getElementById('sidebar');
        const resizer = document.getElementById('resizer');
        let isResizingSidebar = false;

        // åˆå§‹åŒ–
        refreshProjectList(); // è¼‰å…¥å„²å­˜çš„å°ˆæ¡ˆåˆ—è¡¨
        // å¦‚æœæ²’æœ‰ä»»ä½•å°ˆæ¡ˆï¼Œè¼‰å…¥é è¨­ç¯„ä¾‹
        if (Object.keys(getStoredProjects()).length === 0) {
            loadExample(true);
        } else {
            // å˜—è©¦è¼‰å…¥æœ€å¾Œä¸€å€‹å°ˆæ¡ˆï¼Œæˆ–è€…ä¿æŒç©ºç™½
            loadExample(true); 
        }
        
        // --- 0. æœ¬æ©Ÿå°ˆæ¡ˆè³‡æ–™åº« (LocalStorage) ---
        function getStoredProjects() {
            const str = localStorage.getItem(STORAGE_KEY);
            return str ? JSON.parse(str) : {};
        }

        function refreshProjectList() {
            const projects = getStoredProjects();
            const select = document.getElementById('savedProjects');
            // ä¿ç•™ç¬¬ä¸€é …æç¤º
            select.innerHTML = '<option value="">-- é¸æ“‡å·²å­˜å°ˆæ¡ˆ --</option>';
            
            Object.keys(projects).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.innerText = name;
                select.appendChild(opt);
            });
        }

        function saveToLocal() {
            const name = document.getElementById('projName').value.trim();
            if (!name) { alert("è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±ï¼"); return; }
            
            const config = {
                layers: layers,
                dimensions: dimensions,
                settings: {
                    unit: document.getElementById('unitInput').value,
                    width: document.getElementById('canvasWidth').value,
                    fontSize: document.getElementById('globalFontSize').value
                },
                timestamp: Date.now()
            };

            const projects = getStoredProjects();
            if(projects[name] && !confirm(`å°ˆæ¡ˆ "${name}" å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;

            projects[name] = config;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
            
            refreshProjectList();
            // è‡ªå‹•é¸å–å‰›å­˜çš„
            document.getElementById('savedProjects').value = name;
            alert(`å°ˆæ¡ˆ "${name}" å„²å­˜æˆåŠŸï¼`);
        }

        function loadFromLocal() {
            const name = document.getElementById('savedProjects').value;
            if (!name) return;

            const projects = getStoredProjects();
            const config = projects[name];
            if (config) {
                applyConfig(config);
                document.getElementById('projName').value = name; // åŒæ­¥åç¨±æ¡†
            }
        }

        function deleteFromLocal() {
            const name = document.getElementById('savedProjects').value;
            if (!name) { alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„å°ˆæ¡ˆ"); return; }
            if (!confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ "${name}" å—ï¼Ÿ`)) return;

            const projects = getStoredProjects();
            delete projects[name];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
            
            refreshProjectList();
            document.getElementById('projName').value = "";
        }

        // é€šç”¨ï¼šå¥—ç”¨è¨­å®šæª”
        function applyConfig(config) {
            layers = config.layers || [];
            dimensions = config.dimensions || [];
            if(config.settings) {
                document.getElementById('unitInput').value = config.settings.unit || "um";
                document.getElementById('canvasWidth').value = config.settings.width || 450;
                document.getElementById('globalFontSize').value = config.settings.fontSize || 14;
            }
            resizeCanvas(); renderList(); draw();
        }

        // é€šç”¨ï¼šåŒ¯å‡º JSON (å‚™ä»½ç”¨)
        function exportJSON() {
            const config = {
                layers: layers,
                dimensions: dimensions,
                settings: {
                    unit: document.getElementById('unitInput').value,
                    width: document.getElementById('canvasWidth').value,
                    fontSize: document.getElementById('globalFontSize').value
                }
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config));
            const link = document.createElement('a');
            link.href = dataStr;
            link.download = "stack_backup.json";
            link.click();
        }
        
        function importJSON(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    applyConfig(config);
                    alert("æª”æ¡ˆè®€å–æˆåŠŸï¼");
                } catch(err) {
                    console.error(err);
                    alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        function newProject() {
            if(!confirm("ç¢ºå®šæ¸…ç©ºç•«é¢ï¼Ÿ")) return;
            layers = []; dimensions = [];
            document.getElementById('projName').value = "";
            document.getElementById('savedProjects').value = "";
            renderList(); draw();
        }

        // --- 1. å·¦å´åˆ—è¡¨é‚è¼¯ ---

        function renderList() {
            listEl.innerHTML = '';
            updateDimSelects();

            layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                if(layer.showDetails) item.classList.add('open');
                item.draggable = true;
                item.style.borderLeftColor = layer.color;

                const txtColorVal = layer.textColor || "#000000";
                
                item.innerHTML = `
                    <div class="layer-main-row">
                        <div class="drag-handle">â˜°</div>
                        <div class="layer-inputs">
                            <input type="text" value="${layer.name}" oninput="updateLayer(${index}, 'name', this.value)" placeholder="åç¨±">
                            <input type="number" value="${layer.thickness}" oninput="updateLayer(${index}, 'thickness', this.value)" placeholder="åšåº¦">
                        </div>
                        <input type="color" value="${layer.color}" oninput="updateLayer(${index}, 'color', this.value)">
                        <div class="btn-toggle-details ${layer.showDetails?'active':''}" onclick="toggleDetails(${index})">âš™ï¸</div>
                        <div class="btn-icon btn-del" onclick="deleteLayer(${index})">Ã—</div>
                    </div>
                    <div class="layer-details">
                        <div><label>é¡è‰²</label><input type="color" value="${txtColorVal}" oninput="updateLayer(${index}, 'textColor', this.value)" style="width:100%"></div>
                        <div><label>å­—é«”</label><input type="number" value="${layer.fontSize || ''}" placeholder="å…¨åŸŸ" oninput="updateLayer(${index}, 'fontSize', this.value)"></div>
                        <div><label>æ¨£å¼</label><select onchange="updateLayer(${index}, 'fontStyle', this.value)" style="padding:2px;"><option value="normal" ${layer.fontStyle==='normal'?'selected':''}>ä¸€èˆ¬</option><option value="bold" ${layer.fontStyle==='bold'?'selected':''}>ç²—é«”</option></select></div>
                    </div>
                `;

                item.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', index); item.classList.add('dragging'); });
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
                item.addEventListener('dragover', e => e.preventDefault());
                item.addEventListener('drop', e => {
                    e.preventDefault();
                    const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                    if (fromIdx !== index) {
                        const moved = layers.splice(fromIdx, 1)[0];
                        layers.splice(index, 0, moved);
                        renderList(); draw();
                    }
                });

                listEl.appendChild(item);
            });
        }

        function updateLayer(index, key, value) {
            if (key === 'thickness' || key === 'fontSize') value = parseFloat(value) || 0;
            layers[index][key] = value;
            if(key === 'color') renderList();
            draw();
        }

        function toggleDetails(index) {
            layers[index].showDetails = !layers[index].showDetails; renderList();
        }

        function addLayer() {
            layers.unshift({ id: Date.now(), name: "New", thickness: 20, color: "#cccccc", fontSize: 0, fontStyle: 'bold', showDetails: false });
            renderList(); draw();
        }

        function deleteLayer(index) { layers.splice(index, 1); renderList(); draw(); }

        function loadExample(silent = false) {
            if(!silent && !confirm("ç¢ºå®šè¦†è“‹è¨­å®šï¼Ÿ")) return;
            layers = [
                { name: "CL2", thickness: 20, color: "#001f5c", fontSize: 0, fontStyle:'bold', textColor:'#ffffff' },
                { name: "WCR", thickness: 9, color: "#ffc107", fontSize: 0, fontStyle:'bold', textColor:'#000000' },
                { name: "CL1", thickness: 60, color: "#001f5c", fontSize: 0, fontStyle:'bold', textColor:'#ffffff' },
                { name: "Ad", thickness: 25, color: "#eeeeee", fontSize: 0, fontStyle:'normal', textColor:'#000000' },
                { name: "PI", thickness: 100, color: "#a8a8a8", fontSize: 28, fontStyle:'bold', textColor:'#ffffff' },
                { name: "Ad", thickness: 25, color: "#dbeeff", fontSize: 0, fontStyle:'normal', textColor:'#000000' },
                { name: "Tape", thickness: 110, color: "#90caf9", fontSize: 0, fontStyle:'bold', textColor:'#000000' }
            ];
            dimensions = [];
            addDimensionByLogic(0, layers.length-1, "", 80);
            renderList(); draw();
        }

        // --- æ¨™è¨»é‚è¼¯ ---
        function updateDimSelects() {
            const s1 = document.getElementById('dimStart');
            const s2 = document.getElementById('dimEnd');
            const v1 = s1.value; const v2 = s2.value;
            s1.innerHTML = ''; s2.innerHTML = '';
            layers.forEach((l, i) => {
                const opt = `<option value="${i}">${i+1}. ${l.name}</option>`;
                s1.innerHTML += opt; s2.innerHTML += opt;
            });
            if(v1) s1.value = v1; if(v2) s2.value = v2; else if(layers.length>0) s2.value = layers.length-1;
        }

        function addDimension() {
            const s = parseInt(document.getElementById('dimStart').value);
            const e = parseInt(document.getElementById('dimEnd').value);
            const txt = document.getElementById('dimLabel').value;
            const off = parseInt(document.getElementById('dimOffset').value) || 50;
            addDimensionByLogic(s, e, txt, off);
        }

        function addDimensionByLogic(s, e, l, o) {
            dimensions.push({ start: Math.min(s,e), end: Math.max(s,e), label: l, offset: o });
            renderDims(); draw();
        }

        function renderDims() {
            dimListEl.innerHTML = '';
            dimensions.forEach((d, i) => {
                const sName = layers[d.start]?.name || '?';
                const eName = layers[d.end]?.name || '?';
                const div = document.createElement('div');
                div.className = 'dim-item';
                div.innerHTML = `<span>${sName}~${eName} (å${d.offset})</span><span class="btn-icon btn-del" onclick="deleteDim(${i})">Ã—</span>`;
                dimListEl.appendChild(div);
            });
        }
        function deleteDim(i) { dimensions.splice(i, 1); renderDims(); draw(); }


        // --- 2. ç•«å¸ƒäº’å‹•é‚è¼¯ ---
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            for (let i = 0; i < hitRegions.dims.length; i++) {
                const d = hitRegions.dims[i];
                if (Math.abs(x - d.x) < 15 && y >= d.yStart && y <= d.yEnd) {
                    dragTargetType = 'dimension'; dragIndex = d.index;
                    isDraggingCanvas = true; lastMouseX = x;
                    document.body.style.cursor = 'ew-resize'; return;
                }
            }

            for (let i = 0; i < hitRegions.layers.length; i++) {
                const l = hitRegions.layers[i];
                if (y >= l.y && y <= l.y + l.h && x > 50) {
                    dragTargetType = 'layer'; dragIndex = l.index;
                    isDraggingCanvas = true; lastMouseY = y;
                    document.body.style.cursor = 'ns-resize'; return;
                }
            }
        });

        window.addEventListener('mousemove', e => {
            if (!isDraggingCanvas) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                let hover = false;
                for(let d of hitRegions.dims) {
                    if (Math.abs(x - d.x) < 15 && y >= d.yStart && y <= d.yEnd) { canvas.style.cursor = 'ew-resize'; hover=true; break; }
                }
                if(!hover) {
                     for(let l of hitRegions.layers) {
                        if (y >= l.y && y <= l.y + l.h && x > 50) { canvas.style.cursor = 'ns-resize'; hover=true; break; }
                    }
                }
                if(!hover) canvas.style.cursor = 'default';
                return;
            }

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (dragTargetType === 'dimension') {
                const dx = lastMouseX - x;
                dimensions[dragIndex].offset += dx;
                if(dimensions[dragIndex].offset < 20) dimensions[dragIndex].offset = 20;
                lastMouseX = x;
                draw(); renderDims();
            } else if (dragTargetType === 'layer') {
                let hoveredIndex = -1;
                for (let l of hitRegions.layers) {
                    if (y >= l.y && y <= l.y + l.h) { hoveredIndex = l.index; break; }
                }
                if (hoveredIndex !== -1 && hoveredIndex !== dragIndex) {
                    const temp = layers[dragIndex];
                    layers[dragIndex] = layers[hoveredIndex];
                    layers[hoveredIndex] = temp;
                    dragIndex = hoveredIndex; 
                    renderList(); draw();
                }
                lastMouseY = y;
            }
        });

        window.addEventListener('mouseup', () => {
            if (isDraggingCanvas) {
                isDraggingCanvas = false; dragTargetType = null;
                document.body.style.cursor = 'default'; canvas.style.cursor = 'default';
            }
        });

        // --- ç¹ªåœ–æ ¸å¿ƒ ---
        function resizeCanvas() {
            const w = parseInt(document.getElementById('canvasWidth').value) || 450;
            canvas.width = w; draw();
        }

        function draw() {
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value) || 14;
            const totalThickness = layers.reduce((sum, l) => sum + l.thickness, 0);
            if (totalThickness === 0) return;

            let maxOffset = 20;
            dimensions.forEach(d => { if(d.offset > maxOffset) maxOffset = d.offset; });
            const padding = { top: 40, bottom: 40, left: maxOffset + 40, right: 20 };

            const drawWidth = canvas.width - padding.left - padding.right;
            const availableHeight = Math.max(500, layers.length * 40);
            canvas.height = availableHeight + padding.top + padding.bottom;
            const scale = availableHeight / totalThickness;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.textAlign = "center"; ctx.textBaseline = "middle";

            hitRegions.layers = []; hitRegions.dims = [];
            let currentY = padding.top;
            let yPositions = [];

            // 1. ç•«å±¤æ¬¡
            layers.forEach((layer, idx) => {
                const h = layer.thickness * scale;
                hitRegions.layers.push({ index: idx, y: currentY, h: h });
                yPositions.push({ top: currentY, bottom: currentY + h });

                ctx.fillStyle = layer.color; ctx.fillRect(padding.left, currentY, drawWidth, h);
                ctx.strokeStyle = "#333"; ctx.lineWidth = 1; ctx.strokeRect(padding.left, currentY, drawWidth, h);

                if (h > 12) {
                    if (layer.textColor && layer.textColor !== '#000000') ctx.fillStyle = layer.textColor;
                    else ctx.fillStyle = isColorDark(layer.color) ? "white" : "black";

                    const fs = layer.fontSize > 0 ? layer.fontSize : globalFS;
                    const style = layer.fontStyle === 'bold' ? 'bold' : '';
                    ctx.font = `${style} ${fs}px "Microsoft JhengHei", Arial`;
                    ctx.fillText(`${layer.name} ${layer.thickness}${unit}`, padding.left + drawWidth / 2, currentY + h / 2);
                }
                currentY += h;
            });

            // 2. ç•«æ¨™è¨»
            dimensions.forEach((dim, idx) => {
                if (!yPositions[dim.start] || !yPositions[dim.end]) return;
                const y1 = yPositions[dim.start].top;
                const y2 = yPositions[dim.end].bottom;
                const h = y2 - y1;
                
                let val = 0;
                for(let k=dim.start; k<=dim.end; k++) val += layers[k].thickness;
                const txt = dim.label ? dim.label : `${val}${unit}`;
                
                const x = padding.left - dim.offset;
                hitRegions.dims.push({ index: idx, x: x, yStart: y1, yEnd: y2 });
                drawDimensionLine(x, y1, h, txt);
            });
        }

        function drawDimensionLine(x, yStart, height, text) {
            ctx.strokeStyle = "#D32F2F"; ctx.fillStyle = "#D32F2F";
            ctx.lineWidth = 2; ctx.font = "bold 14px Arial";
            ctx.beginPath(); ctx.moveTo(x, yStart); ctx.lineTo(x, yStart + height); ctx.stroke();
            
            ctx.strokeStyle = "#ccc"; ctx.lineWidth = 1;
            ctx.beginPath(); 
            ctx.moveTo(x, yStart); ctx.lineTo(x + 10, yStart);
            ctx.moveTo(x, yStart + height); ctx.lineTo(x + 10, yStart + height);
            ctx.stroke();

            ctx.fillStyle = "#D32F2F";
            drawArrow(x, yStart, "up"); drawArrow(x, yStart + height, "down");

            ctx.textAlign = "right"; ctx.textBaseline = "middle";
            ctx.fillText(text, x - 5, yStart + height / 2);
        }

        function drawArrow(x, y, dir) {
            ctx.beginPath(); const s = 5;
            if(dir==="up") { ctx.moveTo(x,y); ctx.lineTo(x-s,y+s); ctx.lineTo(x+s,y+s); }
            else { ctx.moveTo(x,y); ctx.lineTo(x-s,y-s); ctx.lineTo(x+s,y-s); }
            ctx.fill();
        }

        function isColorDark(hex) {
            const r = parseInt(hex.substr(1, 2), 16);
            const g = parseInt(hex.substr(3, 2), 16);
            const b = parseInt(hex.substr(5, 2), 16);
            return ((r*299 + g*587 + b*114)/1000) < 128;
        }

        function cleanHex(hex) {
            if(!hex) return "FFFFFF";
            return hex.replace('#', '').toUpperCase();
        }

        // --- Sidebar Resize ---
        resizer.addEventListener('mousedown', () => { isResizingSidebar = true; resizer.classList.add('active'); document.body.style.cursor = 'col-resize'; });
        window.addEventListener('mousemove', (e) => {
            if (!isResizingSidebar) return;
            let w = e.clientX;
            if (w < 320) w = 320; if (w > 800) w = 800;
            sidebar.style.width = w + 'px';
        });
        window.addEventListener('mouseup', () => { isResizingSidebar = false; resizer.classList.remove('active'); document.body.style.cursor = 'default'; });

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'stack_diagram.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // --- PPT è¼¸å‡ºåŠŸèƒ½ (åœ–æ–‡åˆ†é›¢ä¿éšªç‰ˆ) ---
        function downloadPPT() {
            let pres = new PptxGenJS();
            
            // 1. æº–å‚™æ•¸æ“š
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value) || 14;
            const totalThickness = layers.reduce((sum, l) => sum + l.thickness, 0);
            if (totalThickness === 0) { alert("æ²’æœ‰å±¤æ¬¡å¯è¼¸å‡º"); return; }

            // 2. è¨ˆç®—ç‰ˆé¢
            let maxOffset = 20;
            dimensions.forEach(d => { if(d.offset > maxOffset) maxOffset = d.offset; });

            // èª¿æ•´é‚Šè·èˆ‡æ¯”ä¾‹
            const pptPaddingLeft = maxOffset + 150; 
            const pptPaddingTop = 50;
            const scaleFactor = 100; 
            const contentWidth = canvas.width - (maxOffset + 40) - 20; 
            
            // è¨ˆç®—æŠ•å½±ç‰‡ç¸½å¯¬é«˜
            const slideW = (pptPaddingLeft + contentWidth + 50) / scaleFactor;
            const availableHeightPx = Math.max(500, layers.length * 40);
            const slideH = (availableHeightPx + 100) / scaleFactor;
            const pxToThickScale = availableHeightPx / totalThickness;

            // è¨­å®šæŠ•å½±ç‰‡
            pres.defineLayout({ name:'CUST', width: slideW, height: slideH });
            pres.layout = 'CUST';
            let slide = pres.addSlide();

            // 3. ç¹ªè£½å±¤æ¬¡ (æ”¹ç‚ºï¼šå…ˆç•«æ¡†ï¼Œå†ç•«å­—)
            let currentYPx = pptPaddingTop;
            let yPositions = [];

            layers.forEach(layer => {
                const hPx = layer.thickness * pxToThickScale;
                
                // åº§æ¨™æ›ç®—
                const x = pptPaddingLeft / scaleFactor;
                const y = currentYPx / scaleFactor;
                const w = contentWidth / scaleFactor;
                const h = hPx / scaleFactor;
                
                yPositions.push({ top: y, bottom: y + h });

                // é¡è‰²è™•ç†
                const safeFillColor = cleanHex(layer.color);
                
                // æ–‡å­—é¡è‰²
                let txtColor = "000000";
                if (layer.textColor && layer.textColor !== '#000000') {
                     txtColor = cleanHex(layer.textColor);
                } else {
                     txtColor = isColorDark(layer.color) ? "FFFFFF" : "000000";
                }
                
                const fs = layer.fontSize > 0 ? layer.fontSize : globalFS;
                const isBold = layer.fontStyle === 'bold';
                const textContent = `${layer.name} ${layer.thickness}${unit}`;

                // ã€æ­¥é©ŸAã€‘ç•«ç´”è‰²å¡Š (ä¸å«æ–‡å­—)
                slide.addShape(pres.ShapeType.rect, {
                    x: x, y: y, w: w, h: h,
                    fill: { color: safeFillColor },
                    line: { color: "333333", width: 1 }
                });

                // ã€æ­¥é©ŸBã€‘ç•«ç¨ç«‹æ–‡å­—æ¡† (ç–Šåœ¨ä¸Šé¢)
                // ä½¿ç”¨ addText ç¢ºä¿æ–‡å­—çµ•å°é¡¯ç¤ºï¼Œä¸å—åœ–å½¢é‚Šè·å½±éŸ¿
                slide.addText(textContent, {
                    x: x, y: y, w: w, h: h,
                    color: txtColor,
                    fontSize: fs,
                    align: 'center',
                    valign: 'middle',
                    bold: isBold
                });

                currentYPx += hPx;
            });

            // 4. ç¹ªè£½æ¨™è¨»
            dimensions.forEach(dim => {
                if (!yPositions[dim.start] || !yPositions[dim.end]) return;
                
                const y1 = yPositions[dim.start].top;
                const y2 = yPositions[dim.end].bottom;
                const xLine = (pptPaddingLeft - dim.offset) / scaleFactor;
                
                let val = 0;
                for(let k=dim.start; k<=dim.end; k++) val += layers[k].thickness;
                const txt = dim.label ? dim.label : `${val}${unit}`;

                // ç•«ç´…ç·š
                slide.addShape(pres.ShapeType.line, {
                    x: xLine, y: y1, w: 0, h: y2 - y1,
                    line: { color: "D32F2F", width: 2, beginArrowType:'triangle', endArrowType:'triangle' }
                });

                // ç•«å…©æ¢æ°´å¹³å¼•å°ç·š (è®“æ¨™è¨»æ›´æ¸…æ¥š)
                const connectorLen = 0.15; // å¼•å°ç·šé•·åº¦
                slide.addShape(pres.ShapeType.line, { 
                    x: xLine, y: y1, w: connectorLen, h: 0, 
                    line: { color: "CCCCCC", width: 1 } 
                });
                slide.addShape(pres.ShapeType.line, { 
                    x: xLine, y: y2, w: connectorLen, h: 0, 
                    line: { color: "CCCCCC", width: 1 } 
                });

                // ç•«æ¨™è¨»æ–‡å­— (ä½¿ç”¨ addText)
                const textWidth = 2.0; 
                slide.addText(txt, {
                    x: xLine - textWidth - 0.1, // æ–‡å­—æ”¾åœ¨ç·šçš„å·¦é‚Š
                    y: (y1 + y2)/2 - 0.3,       // å‚ç›´ç½®ä¸­
                    w: textWidth, 
                    h: 0.6,
                    color: "D32F2F", 
                    fontSize: 12, 
                    align: 'right',             // é å³å°é½Š (é è¿‘ç·šæ¢)
                    valign: 'middle'
                });
            });

            pres.writeFile({ fileName: "Stack_Diagram.pptx" });
        }
    </script>
</body>
</html>
