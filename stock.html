<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡å¸‚å°‹å¯¶ - ä½ä¼°è‚¡ç¥¨åˆ†æ</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 30px;
            font-size: 1rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.2rem;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #picks {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            color: white;
            display: none;
        }

        #picks h2 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .pick-item {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
        }

        .pick-item:last-child {
            margin-bottom: 0;
        }

        #chart {
            width: 100%;
            height: 600px;
            margin-bottom: 30px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            color: #667eea;
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .container { padding: 20px; }
            #chart { height: 400px; }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">â† è¿”å›é¦–é </a>

    <div class="container">
        <header>
            <h1>ğŸ“ˆ è‚¡å¸‚å°‹å¯¶</h1>
            <p class="subtitle">æ‰¾å‡ºè¢«ä½ä¼°çš„æ½›åŠ›è‚¡ç¥¨</p>
        </header>

        <div class="controls">
            <button class="btn-primary" onclick="loadStockData()" id="loadBtn">
                ğŸ”„ è¼‰å…¥è‚¡ç¥¨æ•¸æ“š
            </button>
        </div>

        <div id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨ç²å–è‚¡ç¥¨æ•¸æ“šï¼Œè«‹ç¨å€™...</p>
        </div>

        <div id="picks"></div>

        <div id="chart"></div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #00CC96;"></div>
                <span>ğŸ’ é»ƒé‡‘å€ (è¶…è·Œ+è¶…è³£)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #AB63FA;"></div>
                <span>ğŸŸ¢ åå½ˆå€ (RSIä½)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #636EFA;"></div>
                <span>ğŸ“‰ ä¾¿å®œå€ (è·Œæ·±)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #EF553B;"></div>
                <span>ğŸ”´ éç†±å€</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #B6E880;"></div>
                <span>âšª ä¸€èˆ¬è§€å¯Ÿ</span>
            </div>
        </div>
    </div>

    <script>
        const stocksMap = {
            "0050.TW": "å…ƒå¤§å°ç£50", "00657.TW": "åœ‹æ³°æ—¥ç¶“225", "2330.TW": "å°ç©é›»",
            "2454.TW": "è¯ç™¼ç§‘", "3481.TW": "ç¾¤å‰µ", "2408.TW": "å—äºç§‘",
            "6269.TW": "å°éƒ¡", "2059.TW": "å·æ¹–", "2301.TW": "å…‰å¯¶ç§‘",
            "2308.TW": "å°é”é›»", "1301.TW": "å°å¡‘", "2354.TW": "é´»æº–",
            "2404.TW": "æ¼¢å”", "00940.TW": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯", "1210.TW": "å¤§æˆ",
            "2618.TW": "é•·æ¦®èˆª", "2002.TW": "ä¸­é‹¼", "2412.TW": "ä¸­è¯é›»",
            "6196.TW": "å¸†å®£", "2303.TW": "è¯é›»", "4931.TWO": "æ–°ç››åŠ›",
            "00632R.TW": "å°ç£50å1", "00675L.TW": "åŠ æ¬Šæ­£2", "2887.TW": "å°æ–°é‡‘",
            "3711.TW": "æ—¥æœˆå…‰", "2885.TW": "å…ƒå¤§é‡‘", "6446.TWO": "è—¥è¯è—¥",
            "3231.TW": "ç·¯å‰µ", "2498.TW": "å®é”é›»"
        };

        // è¨ˆç®— RSI
        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return null;
            
            let gains = 0, losses = 0;
            
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            
            if (avgLoss === 0) return 100;
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        // ç”Ÿæˆæ¨¡æ“¬è‚¡ç¥¨æ•¸æ“šï¼ˆç”¨æ–¼å±•ç¤ºåŠŸèƒ½ï¼‰
        function generateMockStockData(basePrice, volatility = 0.02) {
            const days = 365;
            const prices = [basePrice];
            const highs = [basePrice * 1.05];
            
            for (let i = 1; i < days; i++) {
                const change = (Math.random() - 0.5) * 2 * volatility;
                const newPrice = prices[i - 1] * (1 + change);
                prices.push(newPrice);
                highs.push(newPrice * (1 + Math.random() * 0.03));
            }
            
            return { prices, highs };
        }

        // ç²å–è‚¡ç¥¨æ•¸æ“šï¼ˆå…ˆå˜—è©¦çœŸå¯¦ APIï¼Œå¤±æ•—å‰‡ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šï¼‰
        async function fetchStockData(symbol, basePrice) {
            try {
                // å˜—è©¦ä½¿ç”¨ Yahoo Finance API
                const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=1y&interval=1d`, {
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('API è«‹æ±‚å¤±æ•—');
                
                const data = await response.json();
                
                if (!data.chart.result || data.chart.result.length === 0) {
                    throw new Error('ç„¡æ•¸æ“š');
                }
                
                const result = data.chart.result[0];
                const quotes = result.indicators.quote[0];
                
                return {
                    prices: quotes.close.filter(p => p !== null),
                    highs: quotes.high.filter(h => h !== null),
                    isReal: true
                };
            } catch (error) {
                console.log(`ä½¿ç”¨æ¨¡æ“¬æ•¸æ“š: ${symbol}`);
                // ä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
                return {
                    ...generateMockStockData(basePrice),
                    isReal: false
                };
            }
        }

        async function loadStockData() {
            const loadBtn = document.getElementById('loadBtn');
            const loading = document.getElementById('loading');
            const picksDiv = document.getElementById('picks');
            
            loadBtn.disabled = true;
            loading.style.display = 'block';
            picksDiv.style.display = 'none';
            
            const stockData = [];
            
            // è‚¡ç¥¨åŸºæº–åƒ¹æ ¼ï¼ˆç”¨æ–¼æ¨¡æ“¬æ•¸æ“šï¼‰
            const basePrices = {
                "0050.TW": 150, "00657.TW": 18, "2330.TW": 580,
                "2454.TW": 950, "3481.TW": 15, "2408.TW": 65,
                "6269.TW": 85, "2059.TW": 45, "2301.TW": 75,
                "2308.TW": 320, "1301.TW": 95, "2354.TW": 110,
                "2404.TW": 180, "00940.TW": 18, "1210.TW": 55,
                "2618.TW": 35, "2002.TW": 28, "2412.TW": 125,
                "6196.TW": 140, "2303.TW": 48, "4931.TWO": 25,
                "00632R.TW": 5, "00675L.TW": 35, "2887.TW": 18,
                "3711.TW": 125, "2885.TW": 28, "6446.TWO": 450,
                "3231.TW": 95, "2498.TW": 45
            };
            
            let realDataCount = 0;
            
            for (const [code, name] of Object.entries(stocksMap)) {
                const data = await fetchStockData(code, basePrices[code] || 100);
                
                if (data && data.prices.length > 14) {
                    if (data.isReal) realDataCount++;
                    
                    const currentPrice = data.prices[data.prices.length - 1];
                    const allTimeHigh = Math.max(...data.highs);
                    const drawdown = ((currentPrice - allTimeHigh) / allTimeHigh) * 100;
                    const rsi = calculateRSI(data.prices);
                    
                    let status = "ä¸€èˆ¬è§€å¯Ÿ";
                    let priority = 0;
                    
                    if (rsi < 30 && drawdown < -20) {
                        status = "ğŸ’ é»ƒé‡‘å€ (è¶…è·Œ+è¶…è³£)";
                        priority = 3;
                    } else if (rsi < 30) {
                        status = "ğŸŸ¢ åå½ˆå€ (RSIä½)";
                        priority = 2;
                    } else if (drawdown < -30) {
                        status = "ğŸ“‰ ä¾¿å®œå€ (è·Œæ·±)";
                        priority = 1;
                    } else if (rsi > 70) {
                        status = "ğŸ”´ éç†±å€";
                        priority = 0;
                    }
                    
                    stockData.push({
                        code: code.replace(".TW", "").replace(".TWO", ""),
                        name: name,
                        price: currentPrice.toFixed(2),
                        drawdown: Math.abs(drawdown).toFixed(2),
                        rsi: rsi.toFixed(1),
                        status: status,
                        priority: priority
                    });
                }
                
                // æ¸›å°‘å»¶é²ï¼ŒåŠ å¿«è¼‰å…¥é€Ÿåº¦
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            loading.style.display = 'none';
            loadBtn.disabled = false;
            
            if (stockData.length > 0) {
                displayChart(stockData);
                displayTopPicks(stockData);
                
                // é¡¯ç¤ºæ•¸æ“šä¾†æºæç¤º
                if (realDataCount === 0) {
                    alert('âš ï¸ ç›®å‰ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šå±•ç¤ºåŠŸèƒ½\n\nè‹¥è¦ä½¿ç”¨çœŸå¯¦æ•¸æ“šï¼Œè«‹å°‡æ­¤ç¶²ç«™éƒ¨ç½²åˆ°ä¼ºæœå™¨ä¸Šã€‚');
                }
            } else {
                alert('ç„¡æ³•ç”Ÿæˆè‚¡ç¥¨æ•¸æ“šï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        }

        function displayChart(data) {
            const trace = {
                x: data.map(d => parseFloat(d.drawdown)),
                y: data.map(d => parseFloat(d.rsi)),
                mode: 'markers',
                type: 'scatter',
                text: data.map(d => d.name),
                hovertemplate: '<b>%{text}</b><br>' +
                              'ç¾åƒ¹: $' + data.map(d => d.price) + '<br>' +
                              'è·Œå¹…: %{x}%<br>' +
                              'RSI: %{y}<br>' +
                              '<extra></extra>',
                marker: {
                    size: data.map(d => Math.max(parseFloat(d.price) / 10, 8)),
                    color: data.map(d => {
                        if (d.status.includes('é»ƒé‡‘å€')) return '#00CC96';
                        if (d.status.includes('åå½ˆå€')) return '#AB63FA';
                        if (d.status.includes('ä¾¿å®œå€')) return '#636EFA';
                        if (d.status.includes('éç†±å€')) return '#EF553B';
                        return '#B6E880';
                    }),
                    line: { width: 1, color: 'white' }
                }
            };

            // æ·»åŠ é»ƒé‡‘å€è‚¡ç¥¨çš„æ¨™ç±¤
            const annotations = data
                .filter(d => d.priority >= 3)
                .map(d => ({
                    x: parseFloat(d.drawdown),
                    y: parseFloat(d.rsi),
                    text: d.name,
                    showarrow: true,
                    arrowhead: 1,
                    ax: 0,
                    ay: -30,
                    font: { size: 12, color: 'white' },
                    bgcolor: 'rgba(0,0,0,0.6)',
                    borderpad: 4
                }));

            const layout = {
                title: {
                    text: '<b>è‚¡å¸‚å°‹å¯¶åœ–</b>',
                    font: { size: 24 }
                },
                xaxis: {
                    title: 'è·é›¢é«˜é»è·Œå¹… (%)',
                    gridcolor: '#e0e0e0'
                },
                yaxis: {
                    title: 'RSI å¼·å¼±æŒ‡æ¨™',
                    gridcolor: '#e0e0e0'
                },
                plot_bgcolor: '#f8f9fa',
                paper_bgcolor: 'white',
                hovermode: 'closest',
                annotations: annotations
            };

            Plotly.newPlot('chart', [trace], layout, { responsive: true });
        }

        function displayTopPicks(data) {
            const topPicks = data
                .sort((a, b) => {
                    if (b.priority !== a.priority) return b.priority - a.priority;
                    return parseFloat(a.rsi) - parseFloat(b.rsi);
                })
                .slice(0, 3);

            const picksDiv = document.getElementById('picks');
            
            if (topPicks.length > 0) {
                let html = '<h2>ğŸ”¥ ç³»çµ±ç²¾é¸æ¨è–¦</h2>';
                topPicks.forEach(stock => {
                    html += `
                        <div class="pick-item">
                            <strong>${stock.name}</strong> (${stock.code})<br>
                            ç¾åƒ¹: $${stock.price} | RSI: ${stock.rsi} | è·Œå¹…: ${stock.drawdown}%<br>
                            ç‹€æ…‹: ${stock.status}
                        </div>
                    `;
                });
                picksDiv.innerHTML = html;
                picksDiv.style.display = 'block';
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ
        window.addEventListener('load', () => {
            setTimeout(loadStockData, 500);
        });
    </script>
</body>
</html>
