import gradio as gr
import plotly.graph_objects as go
import pandas as pd
import yfinance as yf
import numpy as np

# å®šç¾©æˆ‘å€‘è¦è¿½è¹¤çš„ AI é ­éƒ¨å…¬å¸
TICKERS = {
    'NVDA': 'è¼é” (ç®—åŠ›æ ¸å¿ƒ)',
    'TSM': 'å°ç©é›» (è£½é€ æ ¸å¿ƒ)',
    'GOOGL': 'Google (æ‡‰ç”¨èˆ‡æ¨¡å‹)',
    'MSFT': 'å¾®è»Ÿ (æ‡‰ç”¨èˆ‡æŠ•è³‡)'
}

def fetch_real_market_data():
    data = []
    
    for symbol, name in TICKERS.items():
        stock = yf.Ticker(symbol)
        
        # æŠ“å–åŸºæœ¬é¢è³‡è¨Š
        try:
            info = stock.info
            # ç‡Ÿæ”¶æˆé•·ç‡ (è½‰æˆç™¾åˆ†æ¯”)
            rev_growth = info.get('revenueGrowth', 0) * 100 
            # åˆ©æ½¤ç‡ (ç”¨ä¾†æ¨ç®—è‡ªç”±ç¾é‡‘æµå¥åº·åº¦)
            profit_margin = info.get('profitMargins', 0) * 100
        except:
            rev_growth, profit_margin = 0, 0
            
        # æŠ“å–éå»ä¸€å¹´çš„æ­·å²è‚¡åƒ¹ (ç”¨ä¾†ç®—å¸‚å€¼å¢é•·èˆ‡æ³¢å‹•ç‡)
        hist = stock.history(period="1y")
        if not hist.empty:
            start_price = hist['Close'].iloc[0]
            end_price = hist['Close'].iloc[-1]
            # éå»ä¸€å¹´è‚¡åƒ¹æ¼²å¹… (ä½œç‚ºå¸‚å€¼å¢é•·ç‡çš„ä»£ç†æŒ‡æ¨™)
            mcap_growth = ((end_price - start_price) / start_price) * 100
            
            # è¨ˆç®—å¹´åŒ–æ³¢å‹•ç‡ (è¡¡é‡å¸‚å ´æƒ…ç·’)
            daily_returns = hist['Close'].pct_change().dropna()
            volatility = daily_returns.std() * np.sqrt(252) * 100
        else:
            mcap_growth, volatility = 0, 0

        data.append({
            'å…¬å¸åç¨±': name,
            'ä»£è™Ÿ': symbol,
            'æœ€æ–°ç‡Ÿæ”¶æˆé•·ç‡ (%)': round(rev_growth, 2),
            'è¿‘ä¸€å¹´å¸‚å€¼å¢é•· (%)': round(mcap_growth, 2),
            'æ·¨åˆ©ç‡ (%)': round(profit_margin, 2),
            'è‚¡åƒ¹æ³¢å‹•ç‡ (%)': round(volatility, 2)
        })
        
    df = pd.DataFrame(data)
    
    # --- é–‹å§‹å°‡çœŸå¯¦æ•¸æ“šè½‰æ›ç‚ºä½ çš„ 1-10 åˆ†è©•ä¼°æŒ‡æ¨™ ---
    
    # 1. è²¡å‹™æŒ‡æ¨™é‹ç®— (å–å››å®¶å…¬å¸çš„å¹³å‡å€¼)
    avg_rev_growth = df['æœ€æ–°ç‡Ÿæ”¶æˆé•·ç‡ (%)'].mean()
    avg_mcap_growth = df['è¿‘ä¸€å¹´å¸‚å€¼å¢é•· (%)'].mean()
    
    # è²¡å‹™å¥åº·åº¦: å¸‚å€¼å¢é•·é è¶…ç‡Ÿæ”¶å¢é•·å‰‡æ‰£åˆ†
    financial_health = 10 - max(0, (avg_mcap_growth - avg_rev_growth) / 15) 
    # ç¾é‡‘æµåˆ†æ•¸: æ·¨åˆ©ç‡è¶…é 25% çµ¦æ»¿åˆ† 10
    fcf_score = min(10, max(1, df['æ·¨åˆ©ç‡ (%)'].mean() / 2.5)) 
    
    final_finance_score = (financial_health + fcf_score) / 2
    
    # 2. å¸‚å ´æƒ…ç·’æŒ‡æ¨™ (åˆ©ç”¨çœŸå¯¦æ³¢å‹•ç‡æ¨ç®—)
    # æ³¢å‹•ç‡è¶Šé«˜ï¼Œåˆ†æ•¸è¶Šä½(ä»£è¡¨é¢¨éšªé«˜)
    avg_volatility = df['è‚¡åƒ¹æ³¢å‹•ç‡ (%)'].mean()
    volatility_score = 10 - min(10, avg_volatility / 8) 
    # æ•£æˆ¶ç‹‚ç†±èˆ‡åª’é«”å ±å°è¼ƒé›£é‡åŒ–ï¼Œå…ˆçµ¦äºˆå¸‚å ´å…±è­˜é è¨­å€¼ 7 èˆ‡ 8
    sentiment_score = (volatility_score + (10-7) + (10-8)) / 3 
    
    # 3. å¯¦éš›æ‡‰ç”¨èˆ‡æŠ€è¡“ç™¼å±• (ç›®å‰ä»åå‘è³ªæ€§æŒ‡æ¨™ï¼Œçµ¦äºˆåˆç†çš„å¸‚å ´ç¾æ³é è¨­å€¼)
    # æ¡ç”¨ç‡èˆ‡ç‡Ÿæ”¶è²¢ç»
    application_score = (6 + 4) / 2  
    # æ¨¡å‹æ€§èƒ½èˆ‡è¨ˆç®—æˆæœ¬
    tech_score = (8 + (10 - 7)) / 2 

    # ç¢ºä¿åˆ†æ•¸åœ¨ 1-10 ä¹‹é–“
    scores = [max(1, min(10, s)) for s in [final_finance_score, application_score, sentiment_score, tech_score]]
    categories = ['è²¡å‹™å¥åº·åº¦ (çœŸå¯¦è²¡å ±)', 'å¯¦éš›æ‡‰ç”¨è½åœ° (é ä¼°)', 'å¸‚å ´å†·éœåº¦ (çœŸå¯¦æ³¢å‹•)', 'æŠ€è¡“ç™¼å±•æ½›åŠ› (é ä¼°)']

    # å»ºç«‹ Plotly é›·é”åœ–
    fig = go.Figure()
    fig.add_trace(go.Scatterpolar(
        r=scores + [scores[0]], 
        theta=categories + [categories[0]],
        fill='toself',
        name='AI ç”¢æ¥­ç¾æ³è©•ä¼°',
        line_color='teal'
    ))

    fig.update_layout(
        polar=dict(radialaxis=dict(visible=True, range=[0, 10])),
        showlegend=False,
        title="è‡ªå‹•åŒ– AI å·¨é ­æŒ‡æ¨™åˆ†æé›·é”åœ– (åˆ†æ•¸è¶Šé«˜è¶Šå¥åº·)"
    )
    
    return df, fig

# å»ºç«‹ Gradio ç¶²é ä»‹é¢
with gr.Blocks(theme=gr.themes.Soft()) as demo:
    gr.Markdown("## ğŸ¤– AI ç¶“æ¿ŸæŒ‡æ¨™è‡ªå‹•è¿½è¹¤å™¨ (çµåˆ Yahoo Finance çœŸå¯¦æ•¸æ“š)")
    gr.Markdown("é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œç³»çµ±å°‡è‡ªå‹•é€£ç·šæŠ“å– **è¼é”ã€å°ç©é›»ã€Googleã€å¾®è»Ÿ** çš„æœ€æ–°è²¡å ±èˆ‡è‚¡å¸‚æ•¸æ“šï¼Œä¸¦å¥—ç”¨æ‚¨çš„è©•ä¼°æ¨¡å‹ï¼")
    
    fetch_btn = gr.Button("ğŸ”„ æŠ“å–æœ€æ–°çœŸå¯¦æ•¸æ“šä¸¦åˆ†æ", variant="primary")
    
    with gr.Row():
        with gr.Column():
            gr.Markdown("### ğŸ“Š AI å·¨é ­çœŸå¯¦æ•¸æ“šæ± ")
            data_table = gr.Dataframe() # ç”¨ä¾†é¡¯ç¤ºæŠ“åˆ°çš„çœŸå¯¦æ•¸æ“š
        
        with gr.Column():
            gr.Markdown("### ğŸ¯ ç¶œåˆå¥åº·åº¦é›·é”åœ–")
            radar_plot = gr.Plot()

    # ç¶å®šæŒ‰éˆ•èˆ‡å‡½æ•¸
    fetch_btn.click(
        fn=fetch_real_market_data,
        inputs=[],
        outputs=[data_table, radar_plot]
    )

# å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
demo.launch()
