<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠè‡ªå‹•ç²¾æº–æ‹¼æ¥å·¥å…· (å¯èª¿å¯¬åº¦ç‰ˆ)</title>
    <script async src="https://docs.opencv.org/4.5.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #1e1e1e;
            color: #ddd;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            /* é¿å…æ‹–æ›³æ™‚é¸å–åˆ°æ–‡å­— */
            user-select: none; 
        }

        /* --- å·¦å´å·¥å…·åˆ— --- */
        #sidebar {
            width: 320px; /* é è¨­å¯¬åº¦ */
            min-width: 250px; /* æœ€å°å¯¬åº¦ */
            max-width: 600px; /* æœ€å¤§å¯¬åº¦ */
            background-color: #2b2b2b;
            padding: 15px;
            padding-top: 60px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-sizing: border-box; /* åŒ…å« padding åœ¨å¯¬åº¦å…§ */
            z-index: 10;
            overflow-y: auto;
            flex-shrink: 0; /* ç¦æ­¢è¢«å£“ç¸® */
        }

        /* --- æ–°å¢ï¼šæ‹–æ›³èª¿æ•´æ¡¿ (Resizer) --- */
        #resizer {
            width: 8px;
            background-color: #1e1e1e;
            cursor: col-resize;
            z-index: 20;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        /* è£é£¾ï¼šåœ¨èª¿æ•´æ¡¿ä¸­é–“åŠ ä¸€æ¢ç´°ç·š */
        #resizer::after {
            content: "";
            width: 2px;
            height: 40px;
            background-color: #444;
            border-radius: 1px;
        }
        #resizer:hover, #resizer.active {
            background-color: #007bff; /* æ‹–æ›³æ™‚è®Šè‰² */
        }
        #resizer:hover::after, #resizer.active::after {
            background-color: white;
        }

        /* --- å³å´ç•«å¸ƒå€ --- */
        #main-area {
            flex-grow: 1;
            background-color: #333;
            background-image: linear-gradient(#444 1px, transparent 1px), linear-gradient(90deg, #444 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        h2 { margin: 0 0 5px 0; color: #FFB74D; font-size: 18px; }

        .control-group {
            background: #222;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            position: relative;
        }
        
        .step-tag {
            position: absolute;
            top: -8px;
            left: 10px;
            background: #FFB74D;
            color: #222;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        label { display: block; margin-bottom: 5px; font-size: 13px; color: #bbb; }
        
        button {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            background-color: #444;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            width: 100%;
            transition: 0.2s;
            margin-bottom: 5px;
        }
        button:hover { background-color: #666; }
        button:disabled { background-color: #333; color: #666; cursor: not-allowed; }

        .btn-auto { background-color: #7B1FA2; border-color: #4A148C; color: white; font-weight: bold;}
        .btn-auto:hover { background-color: #9C27B0; }

        .btn-save { background-color: #43A047; border-color: #2E7D32; font-weight: bold; margin-top: 10px;}

        input[type="range"] { width: 100%; margin: 5px 0; }

        .home-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            text-decoration: none;
            background: #444;
            padding: 8px 15px;
            border-radius: 20px;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid #666;
            z-index: 100;
        }

        #analysis-report {
            font-size: 12px;
            color: #81D4FA;
            background: #1a1a1a;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #0288D1;
            display: none;
            line-height: 1.5;
            margin-top: 8px;
            word-break: break-all; /* é˜²æ­¢é•·æ–‡å­—æ’ç ´ */
        }

        canvas {
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            cursor: grab;
        }
        canvas:active { cursor: grabbing; }
        
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.7);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 24px;">ğŸ”§ åˆå§‹åŒ–å½±åƒå¼•æ“...</div>
        <div style="font-size: 14px; color: #aaa; margin-top: 10px;">é¦–æ¬¡è¼‰å…¥å¯èƒ½éœ€è¦å¹¾ç§’é˜</div>
    </div>

    <a href="index.html" class="home-btn">ğŸ  å›é¦–é </a>

    <div id="sidebar">
        <h2>ğŸ§© åŠè‡ªå‹•ç²¾æº–æ‹¼æ¥</h2>
        <div id="cv-status" style="font-size:10px; color:#666; margin-bottom:10px;">OpenCV ç‹€æ…‹: è¼‰å…¥ä¸­...</div>

        <div class="control-group">
            <span class="step-tag">Step 1</span>
            <label>åœ–ç‰‡ä¾†æº</label>
            <button onclick="document.getElementById('file1').click()">ğŸ“‚ è¼‰å…¥åº•åœ– (Image 1)</button>
            <input type="file" id="file1" accept="image/*" style="display:none" onchange="loadImg(1, this)">
            
            <button onclick="document.getElementById('file2').click()">ğŸ“‚ è¼‰å…¥ä¸Šå±¤åœ– (Image 2)</button>
            <input type="file" id="file2" accept="image/*" style="display:none" onchange="loadImg(2, this)">
        </div>

        <div class="control-group">
            <span class="step-tag">Step 2</span>
            <label>ç²—ç•¥å°é½Š (æ‹–æ›³ç•«å¸ƒ)</label>
            <div style="font-size: 11px; color: #aaa; margin-bottom: 5px;">
                è«‹å…ˆæ‹–æ›³è‡³<b>å¤§è‡´é‡ç–Š</b>ï¼Œå†ä½¿ç”¨ AI å¸é™„ã€‚
            </div>
            <input type="range" id="alphaSlider" min="0" max="1" step="0.05" value="0.6" oninput="draw()" title="é€æ˜åº¦">
            <div style="font-size: 12px; margin-top: 2px; color: #888;">
                ä½ç½®: X=<span id="valX">0</span>, Y=<span id="valY">0</span>
            </div>
        </div>

        <div class="control-group" style="border-color: #7B1FA2;">
            <span class="step-tag" style="background: #7B1FA2; color:white;">Step 3</span>
            <label style="color: #E1BEE7;">AI ç²¾æº–å¸é™„</label>
            <button id="btnAuto" class="btn-auto" onclick="runAutoStitch()" disabled>ğŸª„ ä»¥ç›®å‰ä½ç½®è‡ªå‹•å°é½Š</button>
            
            <div id="analysis-report"></div>
        </div>

        <div class="control-group">
            <label>éµç›¤å¾®èª¿</label>
            <div style="display: flex; gap: 5px;">
                <button onclick="nudge(-1, 0)">â¬…ï¸</button>
                <button onclick="nudge(0, -1)">â¬†ï¸</button>
                <button onclick="nudge(0, 1)">â¬‡ï¸</button>
                <button onclick="nudge(1, 0)">â¡ï¸</button>
            </div>
        </div>

        <button class="btn-save" onclick="saveResult()">ğŸ’¾ ä¸‹è¼‰åˆæˆåœ–</button>
    </div>

    <div id="resizer"></div>

    <div id="main-area">
        <canvas id="stitchCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('stitchCanvas');
        const ctx = canvas.getContext('2d');
        
        let img1 = new Image();
        let img2 = new Image();
        let loaded1 = false;
        let loaded2 = false;
        let cvReady = false;

        let offsetX = 0;
        let offsetY = 0;
        
        let isDragging = false;
        let lastMouseX, lastMouseY;

        canvas.width = 800;
        canvas.height = 600;
        ctx.fillStyle = "#aaa";
        ctx.font = "20px Microsoft JhengHei";
        ctx.textAlign = "center";
        ctx.fillText("ç³»çµ±æº–å‚™ä¸­...", 400, 300);

        function onOpenCvReady() {
            cvReady = true;
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('cv-status').innerText = "OpenCV ç‹€æ…‹: âœ… å·²å°±ç·’";
            document.getElementById('cv-status').style.color = "#4CAF50";
            checkButtons();
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.fillText("è«‹ä¾åºè¼‰å…¥å…©å¼µåœ–ç‰‡", 400, 300);
        }

        // --- æ‹–æ›³èª¿æ•´ Sidebar å¯¬åº¦é‚è¼¯ ---
        const sidebar = document.getElementById('sidebar');
        const resizer = document.getElementById('resizer');
        let isResizingSidebar = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizingSidebar = true;
            resizer.classList.add('active');
            document.body.style.cursor = 'col-resize'; // å¼·åˆ¶æ»‘é¼ æ¨£å¼
        });

        window.addEventListener('mousemove', (e) => {
            if (!isResizingSidebar) return;
            
            // è¨ˆç®—æ–°å¯¬åº¦ (é™åˆ¶åœ¨ 250px ~ 600px ä¹‹é–“)
            let newWidth = e.clientX;
            if (newWidth < 250) newWidth = 250;
            if (newWidth > 600) newWidth = 600;

            sidebar.style.width = newWidth + 'px';
        });

        window.addEventListener('mouseup', () => {
            if(isResizingSidebar) {
                isResizingSidebar = false;
                resizer.classList.remove('active');
                document.body.style.cursor = 'default';
            }
        });
        // --------------------------------

        function loadImg(idx, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        if (idx === 1) { 
                            img1 = tempImg; loaded1 = true; 
                        } else { 
                            img2 = tempImg; loaded2 = true; 
                        }
                        checkInit();
                    };
                    tempImg.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function checkInit() {
            if (loaded1) {
                if (!loaded2) {
                    canvas.width = img1.width + 400;
                    canvas.height = img1.height + 400;
                }
                draw();
            }
            checkButtons();
        }

        function checkButtons() {
            const btn = document.getElementById('btnAuto');
            if(cvReady && loaded1 && loaded2) {
                btn.disabled = false;
                btn.innerText = "ğŸª„ ä»¥ç›®å‰ä½ç½®è‡ªå‹•å°é½Š";
            } else {
                btn.disabled = true;
                if(!cvReady) btn.innerText = "ç­‰å¾…å¼•æ“...";
                else btn.innerText = "éœ€è¼‰å…¥å…©å¼µåœ–";
            }
        }

        function runAutoStitch() {
            if (!cvReady || !loaded1 || !loaded2) return;
            
            const report = document.getElementById('analysis-report');
            report.style.display = 'block';
            report.innerHTML = "â³ æ­£åœ¨æœå°‹ç›®å‰ä½ç½®é™„è¿‘çš„ç‰¹å¾µé»...";

            setTimeout(() => {
                try {
                    let mat1 = cv.imread(img1);
                    let mat2 = cv.imread(img2);
                    
                    let gray1 = new cv.Mat();
                    let gray2 = new cv.Mat();
                    cv.cvtColor(mat1, gray1, cv.COLOR_RGBA2GRAY);
                    cv.cvtColor(mat2, gray2, cv.COLOR_RGBA2GRAY);

                    let orb = new cv.ORB(1000); 
                    let keypoints1 = new cv.KeyPointVector();
                    let keypoints2 = new cv.KeyPointVector();
                    let descriptors1 = new cv.Mat();
                    let descriptors2 = new cv.Mat();

                    orb.detectAndCompute(gray1, new cv.Mat(), keypoints1, descriptors1);
                    orb.detectAndCompute(gray2, new cv.Mat(), keypoints2, descriptors2);

                    let bf = new cv.BFMatcher(cv.NORM_HAMMING, true);
                    let matches = new cv.DMatchVector();
                    bf.match(descriptors1, descriptors2, matches);

                    let goodMatches = [];
                    let sumDX = 0;
                    let sumDY = 0;
                    
                    const searchRadius = 200; 

                    for (let i = 0; i < matches.size(); i++) {
                        let m = matches.get(i);
                        let pt1 = keypoints1.get(m.queryIdx).pt; 
                        let pt2 = keypoints2.get(m.trainIdx).pt; 
                        
                        let proposedDX = pt1.x - pt2.x;
                        let proposedDY = pt1.y - pt2.y;
                        let distFromCurrent = Math.sqrt(Math.pow(proposedDX - offsetX, 2) + Math.pow(proposedDY - offsetY, 2));

                        if (distFromCurrent < searchRadius) {
                            goodMatches.push(m);
                            sumDX += proposedDX;
                            sumDY += proposedDY;
                        }
                    }

                    let count = goodMatches.length;
                    
                    if (count < 3) {
                        report.innerHTML = 
                            `<span style="color:#FF5252">âŒ ç„¡æ³•å°é½Š</span><br>` +
                            `åœ¨æ‚¨æŒ‡å®šçš„ä½ç½®é™„è¿‘æ‰¾ä¸åˆ°è¶³å¤ ç‰¹å¾µé»ã€‚<br>` +
                            `è«‹å…ˆæ‰‹å‹•æ‹–æ›³å¾—æ›´é è¿‘ä¸€é»ã€‚`;
                        report.style.borderLeftColor = "#FF5252";
                    } else {
                        let avgX = sumDX / count;
                        let avgY = sumDY / count;
                        let moveDist = Math.sqrt(Math.pow(avgX - offsetX, 2) + Math.pow(avgY - offsetY, 2));

                        offsetX = Math.round(avgX);
                        offsetY = Math.round(avgY);
                        draw();

                        let qualityText = "é«˜";
                        let qualityColor = "#00E676";
                        if(count < 10) { qualityText = "ä¸­"; qualityColor = "yellow"; }

                        report.innerHTML = 
                            `<span style="color:#00E676">âœ… å·²ç²¾æº–å¸é™„</span><br>` +
                            `æ¡ç´ç‰¹å¾µé»: <b>${count}</b> å€‹<br>` +
                            `æœç´¢åŠå¾‘: ${searchRadius}px<br>` +
                            `è‡ªå‹•å¾®èª¿: ${moveDist.toFixed(1)} px<br>` +
                            `å»åˆåº¦: <span style="color:${qualityColor}">${qualityText}</span>`;
                        report.style.borderLeftColor = "#00E676";
                    }

                    mat1.delete(); mat2.delete(); gray1.delete(); gray2.delete();
                    keypoints1.delete(); keypoints2.delete();
                    descriptors1.delete(); descriptors2.delete();
                    bf.delete(); matches.delete(); orb.delete();

                } catch (err) {
                    console.error(err);
                    report.innerHTML = `<span style="color:red">âŒ éŒ¯èª¤</span>: è«‹ç¢ºä¿åœ–ç‰‡å·²æ­£ç¢ºè¼‰å…¥ã€‚`;
                }
            }, 100);
        }

        // --- ç¹ªåœ–èˆ‡æ‰‹å‹•æ“ä½œ ---
        function draw(forSave = false) {
            if (!loaded1) return;

            let minX = Math.min(0, offsetX);
            let minY = Math.min(0, offsetY);
            let maxX = Math.max(img1.width, offsetX + (loaded2 ? img2.width : 0));
            let maxY = Math.max(img1.height, offsetY + (loaded2 ? img2.height : 0));

            canvas.width = maxX - minX;
            canvas.height = maxY - minY;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-minX, -minY);

            ctx.globalAlpha = 1.0;
            ctx.drawImage(img1, 0, 0);

            if (loaded2) {
                ctx.globalAlpha = forSave ? 1.0 : parseFloat(document.getElementById('alphaSlider').value);
                ctx.drawImage(img2, offsetX, offsetY);
            }
            ctx.restore();

            document.getElementById('valX').innerText = parseInt(offsetX);
            document.getElementById('valY').innerText = parseInt(offsetY);
        }

        canvas.addEventListener('mousedown', e => {
            if (isResizingSidebar) return; // å¦‚æœæ­£åœ¨èª¿æ•´å¯¬åº¦ï¼Œä¸è¦è§¸ç™¼ç•«å¸ƒæ‹–æ›³
            if (!loaded2) return;
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });

        window.addEventListener('mousemove', e => {
            if (isDragging) {
                const dx = e.clientX - lastMouseX;
                const dy = e.clientY - lastMouseY;
                offsetX += dx;
                offsetY += dy;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                draw();
            }
        });

        window.addEventListener('mouseup', () => isDragging = false);

        function nudge(dx, dy) {
            offsetX += dx;
            offsetY += dy;
            draw();
        }

        function saveResult() {
            if (!loaded1) return;
            draw(true);
            const link = document.createElement('a');
            link.download = 'stitched_result.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
            draw(false);
        }
    </script>
</body>
</html>
