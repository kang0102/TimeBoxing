<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡æ‹¼æ¥å·¥å…·</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #1e1e1e;
            color: #ddd;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦å´æ§åˆ¶é¢æ¿ */
        #sidebar {
            width: 280px;
            background-color: #2b2b2b;
            padding: 15px;
            padding-top: 60px; /* ç•™çµ¦å›é¦–é æŒ‰éˆ•çš„ç©ºé–“ */
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            z-index: 10;
        }

        /* å³å´ç•«å¸ƒå€ */
        #main-area {
            flex-grow: 1;
            background-color: #333;
            /* ç¹ªè£½ç¶²æ ¼èƒŒæ™¯æ–¹ä¾¿å°é½Š */
            background-image: linear-gradient(#444 1px, transparent 1px), linear-gradient(90deg, #444 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        h2 { margin: 0 0 10px 0; color: #FFB74D; font-size: 18px; }

        .control-group {
            background: #222;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
        }

        label { display: block; margin-bottom: 5px; font-size: 13px; color: #bbb; }
        
        button {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            background-color: #444;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            width: 100%;
            transition: 0.2s;
        }
        button:hover { background-color: #666; }
        
        /* ç‰¹åˆ¥å¼·èª¿çš„æŒ‰éˆ• */
        .btn-primary { background-color: #43A047; border-color: #2E7D32; font-weight: bold; }
        .btn-blue { background-color: #1976D2; border-color: #1565C0; }

        input[type="range"] { width: 100%; margin: 5px 0; }

        .home-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            text-decoration: none;
            background: #444;
            padding: 8px 15px;
            border-radius: 20px;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid #666;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .home-btn:hover { background: #666; }

        canvas {
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            cursor: grab; /* æ¸¸æ¨™é¡¯ç¤ºç‚ºæ‰‹å‹ */
        }
        canvas:active { cursor: grabbing; }
    </style>
</head>
<body>

    <a href="index.html" class="home-btn">ğŸ  å›é¦–é </a>

    <div id="sidebar">
        <h2>ğŸ§© æ‰‹å‹•æ‹¼æ¥åˆæˆ</h2>
        
        <div class="control-group">
            <label>1. è¼‰å…¥åº•åœ– (å›ºå®š)</label>
            <button onclick="document.getElementById('file1').click()">ğŸ“‚ é¸æ“‡åº•åœ– (Image 1)</button>
            <input type="file" id="file1" accept="image/*" style="display:none" onchange="loadImg(1, this)">
        </div>

        <div class="control-group">
            <label>2. è¼‰å…¥ä¸Šå±¤åœ– (å¯æ‹–æ›³)</label>
            <button onclick="document.getElementById('file2').click()">ğŸ“‚ é¸æ“‡ä¸Šå±¤åœ– (Image 2)</button>
            <input type="file" id="file2" accept="image/*" style="display:none" onchange="loadImg(2, this)">
        </div>

        <div class="control-group">
            <label>é€æ˜åº¦ (ç”¨æ–¼æª¢æŸ¥å°é½Š)</label>
            <input type="range" id="alphaSlider" min="0" max="1" step="0.05" value="0.6" oninput="draw()">
            <div style="font-size:12px; color:#888; text-align:right;">æ‹–æ›³æ»‘æ¡¿èª¿æ•´é€æ˜åº¦</div>
        </div>

        <div class="control-group">
            <label>éµç›¤å¾®èª¿ (X / Y)</label>
            <div style="display: flex; gap: 5px;">
                <button onclick="nudge(-1, 0)">â¬…ï¸</button>
                <button onclick="nudge(0, -1)">â¬†ï¸</button>
                <button onclick="nudge(0, 1)">â¬‡ï¸</button>
                <button onclick="nudge(1, 0)">â¡ï¸</button>
            </div>
            <div style="font-size: 12px; margin-top: 5px; color: #888;">
                ä½ç½®: <span id="valX">0</span>, <span id="valY">0</span>
            </div>
        </div>

        <button class="btn-primary" onclick="saveResult()">ğŸ’¾ ä¸‹è¼‰åˆæˆåœ–</button>
        <div style="font-size: 12px; color: #aaa; margin-top: 5px;">
            *å­˜æª”æ™‚æœƒè‡ªå‹•è¨­ç‚ºä¸é€æ˜
        </div>
    </div>

    <div id="main-area">
        <canvas id="stitchCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('stitchCanvas');
        const ctx = canvas.getContext('2d');
        
        // åœ–ç‰‡ç‰©ä»¶
        let img1 = new Image();
        let img2 = new Image();
        let loaded1 = false;
        let loaded2 = false;

        // ä½ç½®ç‹€æ…‹
        let offsetX = 0;
        let offsetY = 0;
        
        // æ‹–æ›³ç‹€æ…‹
        let isDragging = false;
        let lastMouseX, lastMouseY;

        // åˆå§‹åŒ–æ–‡å­—
        canvas.width = 800;
        canvas.height = 600;
        ctx.fillStyle = "#aaa";
        ctx.font = "20px Microsoft JhengHei";
        ctx.textAlign = "center";
        ctx.fillText("è«‹å…ˆè¼‰å…¥åº•åœ–ï¼Œå†è¼‰å…¥ä¸Šå±¤åœ–é€²è¡Œæ‹¼æ¥", 400, 300);

        // è¼‰å…¥åœ–ç‰‡é‚è¼¯
        function loadImg(idx, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (idx === 1) {
                        img1.onload = () => { loaded1 = true; checkInit(); };
                        img1.src = e.target.result;
                    } else {
                        img2.onload = () => { loaded2 = true; checkInit(); };
                        img2.src = e.target.result;
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function checkInit() {
            if (loaded1) {
                // å¦‚æœåªè¼‰å…¥ç¬¬ä¸€å¼µï¼Œåˆå§‹åŒ–ç•«å¸ƒ
                if (!loaded2) {
                    canvas.width = img1.width + 400; // é ç•™ä¸€äº›æ“ä½œç©ºé–“
                    canvas.height = img1.height + 400;
                }
                draw();
            }
        }

        // æ ¸å¿ƒç¹ªåœ–å‡½æ•¸
        function draw(forSave = false) {
            if (!loaded1) return;

            // 1. è‡ªå‹•è¨ˆç®—éœ€è¦çš„ç•«å¸ƒå¤§å° (åŒ…åœç›’)
            // ä»¥ img1 ç‚º (0,0)ï¼Œimg2 ç‚º (offsetX, offsetY)
            let minX = Math.min(0, offsetX);
            let minY = Math.min(0, offsetY);
            let maxX = Math.max(img1.width, offsetX + (loaded2 ? img2.width : 0));
            let maxY = Math.max(img1.height, offsetY + (loaded2 ? img2.height : 0));

            // è¨­å®šç•«å¸ƒå°ºå¯¸
            canvas.width = maxX - minX;
            canvas.height = maxY - minY;

            // æ¸…ç©ºç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // å¹³ç§»åº§æ¨™ç³» (è™•ç†è² åº§æ¨™ï¼Œç¢ºä¿åœ–éƒ½åœ¨ç•«å¸ƒå…§)
            ctx.save();
            ctx.translate(-minX, -minY);

            // 2. ç•«åº•åœ– (img1)
            ctx.globalAlpha = 1.0;
            ctx.drawImage(img1, 0, 0);

            // 3. ç•«ä¸Šå±¤åœ– (img2)
            if (loaded2) {
                // å¦‚æœæ˜¯å­˜æª”æ¨¡å¼ï¼Œå¼·åˆ¶ä¸é€æ˜ï¼›å¦å‰‡ä½¿ç”¨æ»‘æ¡¿æ•¸å€¼
                ctx.globalAlpha = forSave ? 1.0 : parseFloat(document.getElementById('alphaSlider').value);
                ctx.drawImage(img2, offsetX, offsetY);
            }

            ctx.restore();

            // æ›´æ–°ä»‹é¢æ•¸å€¼
            document.getElementById('valX').innerText = parseInt(offsetX);
            document.getElementById('valY').innerText = parseInt(offsetY);
        }

        // --- æ»‘é¼ æ‹–æ›³åŠŸèƒ½ ---
        canvas.addEventListener('mousedown', e => {
            if (!loaded2) return;
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });

        window.addEventListener('mousemove', e => {
            if (isDragging) {
                const dx = e.clientX - lastMouseX;
                const dy = e.clientY - lastMouseY;
                offsetX += dx;
                offsetY += dy;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                draw();
            }
        });

        window.addEventListener('mouseup', () => isDragging = false);

        // --- æŒ‰éˆ•å¾®èª¿ ---
        function nudge(dx, dy) {
            offsetX += dx;
            offsetY += dy;
            draw();
        }

        // --- å­˜æª”åŠŸèƒ½ ---
        function saveResult() {
            if (!loaded1) return;
            // 1. é‡ç•«ä¸€æ¬¡ (å®Œå…¨ä¸é€æ˜)
            draw(true);
            // 2. å»ºç«‹ä¸‹è¼‰é€£çµ
            const link = document.createElement('a');
            link.download = 'stitched_result.jpg'; // é è¨­æª”å
            link.href = canvas.toDataURL('image/jpeg', 0.9); // 0.9 å“è³ª
            link.click();
            // 3. ç•«å›åŸæœ¬ç‹€æ…‹ (æ¢å¾©åŠé€æ˜) ä»¥ä¾¿ç¹¼çºŒç·¨è¼¯
            draw(false);
        }
    </script>
</body>
</html>
