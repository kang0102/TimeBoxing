<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ç¨‹ç–Šæ§‹åœ–ç”¢ç”Ÿå™¨ (Pro V2)</title>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #121212; color: #ddd; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }

        /* --- å´é‚Šæ¬„ --- */
        #sidebar { 
            width: 400px; min-width: 320px; max-width: 800px; 
            background-color: #1e1e1e; padding: 15px; padding-top: 50px; 
            display: flex; flex-direction: column; gap: 10px; z-index: 10; 
            overflow-y: auto; flex-shrink: 0; border-right: 1px solid #333;
        }

        /* --- ä¸»ç•«å¸ƒå€ --- */
        #main-area { 
            flex-grow: 1; background-color: #222; 
            display: flex; justify-content: center; align-items: start;
            overflow: auto; padding: 20px; position: relative;
        }

        /* --- æ‰‹æ©Ÿç‰ˆ --- */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            #sidebar { width: 100% !important; max-width: 100%; height: auto; max-height: none; border-right: none; border-bottom: 2px solid #444; }
            #main-area { width: 100%; height: 600px; padding: 10px; display: block; text-align: center; }
            .home-btn { top: 10px; left: 10px; padding: 4px 8px; font-size: 11px; }
        }

        /* --- å…ƒä»¶æ¨£å¼ --- */
        h2 { margin: 0 0 5px 0; color: #4FC3F7; font-size: 18px; }
        h3 { margin: 10px 0 5px 0; color: #bbb; font-size: 14px; border-bottom: 1px solid #444; padding-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
        
        .control-group { background: #252525; padding: 10px; border-radius: 6px; border: 1px solid #333; display: flex; flex-direction: column; gap: 5px; }
        .sub-group { background: #2f2f2f; padding: 5px; border-radius: 4px; border: 1px dashed #444; margin-bottom: 5px; }
        
        label { display: block; margin-bottom: 2px; font-size: 12px; color: #aaa; }
        input[type="text"], input[type="number"], select, textarea { background: #333; border: 1px solid #555; color: white; padding: 6px; border-radius: 4px; width: 100%; font-size: 13px; }
        textarea { resize: vertical; min-height: 40px; }

        /* å±¤æ¬¡åˆ—è¡¨ */
        #layer-list { display: flex; flex-direction: column; gap: 6px; }
        .layer-item { background: #333; border-radius: 4px; padding: 6px; border-left: 4px solid #666; font-size: 13px; transition: 0.2s; }
        .layer-item.dragging { opacity: 0.5; border: 2px dashed #4FC3F7; background: #2a2a2a; }
        .layer-main-row { display: flex; align-items: center; gap: 4px; }
        
        .layer-inputs { flex-grow: 1; display: grid; grid-template-columns: 1fr 0.6fr; gap: 4px; }
        .layer-details { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #555; grid-template-columns: 1fr 1fr 1fr; gap: 5px; align-items: end; }
        .layer-item.open .layer-details { display: grid; }
        
        .btn-toggle-details { cursor: pointer; color: #888; font-size: 14px; padding: 4px; border-radius: 4px; background: #2a2a2a; text-align: center; width: 20px;}
        .btn-toggle-details.active { background: #1976D2; color: white; }
        input[type="color"] { border: none; width: 24px; height: 24px; cursor: pointer; background: none; padding: 0; }
        .btn-icon { cursor: pointer; color: #888; font-size: 16px; padding: 2px; }
        .btn-del:hover { color: #ff5252; }
        .layer-check { width: 18px; height: 18px; cursor: pointer; margin-right: 2px; accent-color: #4CAF50; }
        .move-btns { display: flex; flex-direction: column; gap: 1px; margin-right: 2px; }
        .btn-tiny { padding: 0px 4px; font-size: 10px; height: 14px; line-height: 12px; background: #444; color: #fff; border: 1px solid #555; cursor: pointer; }

        .dim-item { background: #2a2a2a; border: 1px solid #444; padding: 5px; margin-bottom: 4px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #bbb; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        button { padding: 8px; font-size: 13px; cursor: pointer; background-color: #444; color: white; border: 1px solid #555; border-radius: 4px; width: 100%; transition: 0.2s; margin-top: 5px; }
        button:hover { background-color: #666; }
        
        .btn-row { display: flex; gap: 5px; }
        .btn-save { background-color: #00897B; border-color: #00695C; flex: 1; }
        .btn-cloud-mgr { background-color: #0277BD; border-color: #01579B; flex: 1; }
        .btn-unit-save { background-color: #7B1FA2; border-color: #4A148C; width: auto; padding: 5px 10px; margin-top:0;}
        .btn-unit-add { background-color: #5E35B1; border-color: #4527A0; width: auto; padding: 5px 10px; margin-top:0;}
        .btn-ppt { background-color: #E65100; border-color: #EF6C00; }
        .btn-img { background-color: #1565C0; border-color: #0D47A1; }
        .btn-add { background-color: #2E7D32; border-color: #1B5E20; }
        .btn-clear { background-color: #c62828; border-color: #b71c1c; }
        
        .home-btn { position: absolute; top: 15px; left: 15px; text-decoration: none; background: #444; padding: 6px 12px; border-radius: 20px; color: #fff; font-size: 12px; border: 1px solid #666; z-index: 100; }
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); background-color: white; max-width: 100%; }

        /* --- é›²ç«¯ç®¡ç† / é è¦½ Modal --- */
        .modal-backdrop { position: fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000; display:none;}
        .modal { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #252525; border: 1px solid #4FC3F7; border-radius: 8px;
            padding: 20px; z-index: 2001; display: none;
            width: 800px; max-width: 95%; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 0 30px rgba(0,0,0,0.9);
        }
        .modal h3 { margin-top: 0; color: #4FC3F7; border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        /* é›²ç«¯æª”æ¡ˆåˆ—è¡¨ */
        .cloud-list { list-style: none; padding: 0; margin: 0; }
        .cloud-item { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #333; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 4px solid #555; 
        }
        .cloud-item:hover { background: #3a3a3a; border-left-color: #4FC3F7; }
        .cloud-info { flex: 1; }
        .cloud-name { font-weight: bold; font-size: 14px; color: #fff; }
        .cloud-meta { font-size: 12px; color: #aaa; margin-top: 3px; }
        .cloud-note { font-size: 12px; color: #81C784; margin-top: 3px; font-style: italic; }
        .cloud-actions { display: flex; gap: 5px; }
        .btn-small { padding: 4px 8px; font-size: 11px; margin: 0; width: auto; }

        /* é è¦½ç•«å¸ƒå®¹å™¨ */
        #preview-container { 
            display: none; background: #fff; padding: 10px; border-radius: 4px; text-align: center; margin-bottom: 15px; 
            border: 2px solid #0277BD; position: relative;
        }
        #close-preview-btn { position: absolute; top:5px; right:5px; background:red; color:white; border:none; width:24px; height:24px; border-radius:50%; cursor:pointer;}

        /* Loading */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); color: white; display: none;
            justify-content: center; align-items: center; z-index: 9999; flex-direction: column;
        }
        .spinner { border: 4px solid #333; border-top: 4px solid #4FC3F7; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="font-size: 18px;">é€£ç·šä¸­...</div>
    </div>

    <div class="modal-backdrop" id="mgrBackdrop" onclick="window.closeCloudManager()"></div>
    <div class="modal" id="mgrModal">
        <h3>â˜ï¸ é›²ç«¯æª”æ¡ˆç®¡ç†èˆ‡é è¦½</h3>
        
        <div id="preview-container">
            <button id="close-preview-btn" onclick="document.getElementById('preview-container').style.display='none'">Ã—</button>
            <h4 id="preview-title" style="margin:0 0 5px 0; color:#333;"></h4>
            <canvas id="previewCanvas"></canvas>
            <div style="margin-top:5px; font-size:12px; color:#555;">(æ­¤ç‚ºé è¦½åœ–ï¼Œä¸å½±éŸ¿ä¸»ç•«é¢)</div>
        </div>

        <div style="margin-bottom: 10px; display: flex; gap: 10px;">
             <input type="text" id="searchCloud" placeholder="æœå°‹å°ˆæ¡ˆåç¨±..." oninput="window.renderCloudList()" style="flex:1">
             <button class="btn-small" onclick="window.refreshCloudList()">ğŸ”„ åˆ·æ–°</button>
        </div>
        
        <div style="max-height: 400px; overflow-y: auto;">
            <ul class="cloud-list" id="cloudListEl">
                </ul>
        </div>
        <button onclick="window.closeCloudManager()" style="margin-top:15px; background:#555;">é—œé–‰</button>
    </div>

    <a href="index.html" class="home-btn">ğŸ </a>

    <div id="sidebar">
        <h2>ğŸ“š ç–Šæ§‹è³‡æ–™åº« (Pro V2)</h2>

        <div class="control-group" style="border-left: 4px solid #00897B;">
            <label style="color:#80CBC4">â˜ï¸ å°ˆæ¡ˆå­˜å– (Project)</label>
            <input type="text" id="projName" placeholder="è¼¸å…¥å°ˆæ¡ˆåç¨±..." style="margin-bottom: 5px;">
            <textarea id="projNote" placeholder="åœ¨æ­¤è¼¸å…¥å‚™è¨» (Note)... ä¾‹å¦‚: å®¢æˆ¶éœ€æ±‚ã€ç‰¹æ®Šè† æèªªæ˜"></textarea>
            
            <div class="btn-row">
                <button class="btn-save" onclick="window.saveToCloud()">ğŸ’¾ å„²å­˜å°ˆæ¡ˆ</button>
                <button class="btn-cloud-mgr" onclick="window.openCloudManager()">â˜ï¸ é›²ç«¯ç®¡ç† / é è¦½</button>
            </div>
            
            <div style="display:flex; gap:5px; margin-top:5px;">
                <button class="btn-small" onclick="window.newProject()" style="background:#555;">æ¸…ç©º</button>
                <button class="btn-small" onclick="window.exportJSON()" style="background:#546E7A;">ä¸‹è¼‰å‚™ä»½</button>
                <button class="btn-small" onclick="document.getElementById('fileInput').click()" style="background:#546E7A;">è®€å–å‚™ä»½</button>
                <input type="file" id="fileInput" accept=".json" onchange="window.importJSON(this)" style="display:none">
            </div>
        </div>

        <div class="control-group">
            <label>å…¨åŸŸè¨­å®š</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="unitInput" value="um" placeholder="å–®ä½" oninput="window.draw()" style="flex:0.5">
                <input type="number" id="canvasWidth" value="450" placeholder="å¯¬" oninput="window.resizeCanvas()" style="flex:1">
                <input type="number" id="globalFontSize" value="14" placeholder="å­—é«”" oninput="window.draw()" style="flex:0.5">
            </div>
        </div>

        <div class="control-group" style="border-left: 4px solid #7B1FA2;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; border:none; color:#E1BEE7;">ğŸ§© æ¨¡çµ„ & å±¤æ¬¡</h3>
                <label style="cursor:pointer; display:flex; align-items:center; gap:5px; margin:0;">
                    <input type="checkbox" id="selectAllBox" checked onchange="window.toggleAllLayers(this)"> å…¨é¸
                </label>
            </div>

            <div class="sub-group">
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                    <span style="font-size:12px; color:#aaa; flex:1;">é¸å–ä¸‹æ–¹å±¤æ¬¡:</span>
                    <input type="text" id="unitName" placeholder="æ¨¡çµ„åç¨±..." style="flex:2">
                    <button class="btn-unit-save" onclick="window.saveUnitToCloud()">å­˜æ¨¡çµ„</button>
                </div>
                <div style="display:flex; gap:5px;">
                    <select id="savedUnits" style="flex:1">
                        <option value="">-- é¸æ“‡æ¨¡çµ„ --</option>
                    </select>
                    <button class="btn-unit-add" onclick="window.insertUnit()">â• æ’å…¥</button>
                    <button class="btn-small" onclick="window.deleteUnitFromCloud()" style="background:#c62828;">ğŸ—‘ï¸</button>
                </div>
            </div>

            <button class="btn-add" onclick="window.addLayer()">â• æ–°å¢ä¸€å±¤ (Top)</button>
            <div id="layer-list"></div>
        </div>

        <div class="control-group">
            <label>å°ºå¯¸æ¨™è¨» (Dimension)</label>
            <div style="display:flex; gap:5px;">
                <select id="dimStart"></select> <span>è‡³</span> <select id="dimEnd"></select>
            </div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="text" id="dimLabel" placeholder="æ–‡å­—(é¸å¡«)">
                <input type="number" id="dimOffset" value="50" placeholder="åç§»">
                <button onclick="window.addDimension()" style="margin:0; width:auto;">â•</button>
            </div>
            <div id="dim-list" style="margin-top:5px;"></div>
        </div>

        <div style="margin-top: 10px; display:flex; gap:5px;">
            <button class="btn-img" onclick="window.downloadImage()">ğŸ’¾ å­˜åœ–</button>
            <button class="btn-ppt" onclick="window.downloadPPT()">ğŸ“Š å­˜ PPT</button>
            <button style="background-color: #2E7D32;" onclick="window.exportCurrentToCSV()">ğŸ“‹ å­˜ Excel</button>
        </div>
    </div>

    <div id="resizer"></div>
    <div id="main-area"><canvas id="stackCanvas"></canvas></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Config
        const firebaseConfig = {
          apiKey: "AIzaSyCnHhksuhJs9RdrL7DPnsAvR21ZND7kIOI",
          authDomain: "stack-diagram-db.firebaseapp.com",
          projectId: "stack-diagram-db",
          storageBucket: "stack-diagram-db.firebasestorage.app",
          messagingSenderId: "67240747982",
          appId: "1:67240747982:web:1fb065e40e936a7485419f",
          measurementId: "G-QJNE60W8BB"
        };

        let db = null;
        let isFirebaseReady = false;
        const COL_PROJ = "projects";
        const COL_UNITS = "units";
        let cloudProjectsCache = []; // å¿«å–é›²ç«¯åˆ—è¡¨

        if (!firebaseConfig.apiKey.includes("ä½ çš„API_KEY")) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isFirebaseReady = true;
            } catch(e) { console.error("Firebase init error", e); }
        }

        const canvas = document.getElementById('stackCanvas');
        const ctx = canvas.getContext('2d');
        const listEl = document.getElementById('layer-list');
        const dimListEl = document.getElementById('dim-list');

        window.layers = [];
        window.dimensions = [];
        
        // ---------------------------------------------
        // æ ¸å¿ƒåŠŸèƒ½: ç¹ªåœ– & åˆ—è¡¨
        // ---------------------------------------------
        let dragSrcEl = null;

        window.renderList = function() {
            listEl.innerHTML = ''; window.updateDimSelects();
            const allChecked = window.layers.every(l => l.checked !== false);
            const selectAllBox = document.getElementById('selectAllBox');
            if(selectAllBox) selectAllBox.checked = allChecked;

            window.layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                item.setAttribute('draggable', 'true');
                item.setAttribute('data-index', index);
                if(layer.showDetails) item.classList.add('open');
                item.style.borderLeftColor = layer.color;
                const isChecked = layer.checked !== false ? 'checked' : '';

                item.innerHTML = `
                    <div class="layer-main-row">
                        <input type="checkbox" class="layer-check" ${isChecked} onchange="window.toggleLayerCheck(${index})">
                        <div class="move-btns">
                            <button class="btn-tiny" onclick="window.moveLayer(${index}, -1)">â–²</button>
                            <button class="btn-tiny" onclick="window.moveLayer(${index}, 1)">â–¼</button>
                        </div>
                        <div class="layer-inputs">
                            <input type="text" value="${layer.name}" oninput="window.updateLayer(${index}, 'name', this.value)" placeholder="åç¨±">
                            <input type="number" value="${layer.thickness}" oninput="window.updateLayer(${index}, 'thickness', this.value)" placeholder="åšåº¦">
                        </div>
                        <input type="color" value="${layer.color}" oninput="window.updateLayer(${index}, 'color', this.value)">
                        <div class="btn-toggle-details ${layer.showDetails?'active':''}" onclick="window.toggleDetails(${index})">âš™ï¸</div>
                        <div class="btn-icon btn-del" onclick="window.deleteLayer(${index})">Ã—</div>
                    </div>
                    <div class="layer-details">
                        <div><label>é¡è‰²</label><input type="color" value="${layer.textColor||'#000000'}" oninput="window.updateLayer(${index}, 'textColor', this.value)" style="width:100%"></div>
                        <div><label>å­—é«”</label><input type="number" value="${layer.fontSize || ''}" placeholder="å…¨åŸŸ" oninput="window.updateLayer(${index}, 'fontSize', this.value)"></div>
                        <div><label>æ¨£å¼</label><select onchange="window.updateLayer(${index}, 'fontStyle', this.value)" style="padding:2px;"><option value="normal" ${layer.fontStyle==='normal'?'selected':''}>ä¸€èˆ¬</option><option value="bold" ${layer.fontStyle==='bold'?'selected':''}>ç²—é«”</option></select></div>
                    </div>
                `;
                
                // Drag Events
                item.addEventListener('dragstart', function(e) { this.style.opacity='0.4'; dragSrcEl=this; e.dataTransfer.effectAllowed='move'; this.classList.add('dragging'); });
                item.addEventListener('dragover', function(e) { if(e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect='move'; return false; });
                item.addEventListener('drop', function(e) { 
                    if(e.stopPropagation) e.stopPropagation();
                    if(dragSrcEl !== this) {
                        const oldIdx = parseInt(dragSrcEl.getAttribute('data-index'));
                        const newIdx = parseInt(this.getAttribute('data-index'));
                        const moved = window.layers.splice(oldIdx, 1)[0];
                        window.layers.splice(newIdx, 0, moved);
                        window.renderList(); window.draw();
                    }
                    return false;
                });
                item.addEventListener('dragend', function() { this.style.opacity='1'; this.classList.remove('dragging'); });

                listEl.appendChild(item);
            });
        };

        window.moveLayer = (i, d) => { const n = i+d; if(n<0||n>=window.layers.length)return; const t=window.layers[i]; window.layers[i]=window.layers[n]; window.layers[n]=t; window.renderList(); window.draw(); };
        window.toggleLayerCheck = (i) => { window.layers[i].checked = !window.layers[i].checked; window.renderList(); };
        window.toggleAllLayers = (cb) => { window.layers.forEach(l => l.checked = cb.checked); window.renderList(); };
        window.updateLayer = (i, k, v) => { if(k==='thickness'||k==='fontSize') v=parseFloat(v)||0; window.layers[i][k]=v; if(k==='color') window.renderList(); window.draw(); };
        window.toggleDetails = (i) => { window.layers[i].showDetails = !window.layers[i].showDetails; window.renderList(); };
        window.addLayer = () => { window.layers.unshift({ id: Date.now(), name: "New", thickness: 20, color: "#cccccc", fontSize: 0, fontStyle: 'bold', checked: true }); window.renderList(); window.draw(); };
        window.deleteLayer = (i) => { window.layers.splice(i, 1); window.renderList(); window.draw(); };

        window.updateDimSelects = () => {
            const s1=document.getElementById('dimStart'), s2=document.getElementById('dimEnd');
            const v1=s1.value, v2=s2.value; s1.innerHTML=''; s2.innerHTML='';
            window.layers.forEach((l,i) => { const o = `<option value="${i}">${i+1}. ${l.name}</option>`; s1.innerHTML+=o; s2.innerHTML+=o; });
            if(v1) s1.value=v1; if(v2) s2.value=v2; else if(window.layers.length>0) s2.value=window.layers.length-1;
        };
        window.addDimension = () => { 
            const s=parseInt(document.getElementById('dimStart').value), e=parseInt(document.getElementById('dimEnd').value);
            window.dimensions.push({ start: Math.min(s,e), end: Math.max(s,e), label: document.getElementById('dimLabel').value, offset: parseInt(document.getElementById('dimOffset').value)||50 });
            renderDims(); window.draw();
        };
        function renderDims() { dimListEl.innerHTML=''; window.dimensions.forEach((d,i) => { 
            const n1=window.layers[d.start]?.name, n2=window.layers[d.end]?.name; 
            dimListEl.innerHTML += `<div class="dim-item"><span>${n1}~${n2} (å${d.offset})</span><span class="btn-icon btn-del" onclick="window.deleteDim(${i})">Ã—</span></div>`; 
        }); }
        window.deleteDim = (i) => { window.dimensions.splice(i,1); renderDims(); window.draw(); };

        // ---------------------------------------------
        // â˜… é›²ç«¯æª”æ¡ˆç®¡ç†èˆ‡é è¦½ (Manager)
        // ---------------------------------------------
        window.openCloudManager = async function() {
            if(!isFirebaseReady) { alert("å°šæœªé€£ç·š"); return; }
            document.getElementById('mgrModal').style.display = 'block';
            document.getElementById('mgrBackdrop').style.display = 'block';
            window.refreshCloudList();
        };

        window.closeCloudManager = function() {
            document.getElementById('mgrModal').style.display = 'none';
            document.getElementById('mgrBackdrop').style.display = 'none';
            document.getElementById('preview-container').style.display = 'none';
        };

        window.refreshCloudList = async function() {
            showLoading(true, "è®€å–é›²ç«¯æª”æ¡ˆ...");
            try {
                const q = await getDocs(collection(db, COL_PROJ));
                cloudProjectsCache = [];
                q.forEach(doc => {
                    const d = doc.data();
                    cloudProjectsCache.push({ id: doc.id, ...d });
                });
                window.renderCloudList();
            } catch(e) { console.error(e); alert("è®€å–å¤±æ•—"); }
            showLoading(false);
        };

        window.renderCloudList = function() {
            const listEl = document.getElementById('cloudListEl');
            const search = document.getElementById('searchCloud').value.toLowerCase();
            listEl.innerHTML = '';

            cloudProjectsCache.forEach(p => {
                if(search && !p.id.toLowerCase().includes(search)) return;
                
                const note = p.note ? `ğŸ“ ${p.note}` : '';
                const date = new Date(p.timestamp || 0).toLocaleString();
                
                const li = document.createElement('li');
                li.className = 'cloud-item';
                li.innerHTML = `
                    <div class="cloud-info">
                        <div class="cloud-name">${p.id}</div>
                        <div class="cloud-meta">ğŸ•’ ${date}</div>
                        ${note ? `<div class="cloud-note">${note}</div>` : ''}
                    </div>
                    <div class="cloud-actions">
                        <button class="btn-small" style="background:#0288D1;" onclick="window.previewCloudFile('${p.id}')">ğŸ‘ï¸ é è¦½</button>
                        <button class="btn-small" style="background:#2E7D32;" onclick="window.downloadCloudExcel('${p.id}')">ğŸ“Š Excel</button>
                        <button class="btn-small" style="background:#EF6C00;" onclick="window.loadCloudFile('${p.id}')">ğŸ“‚ è®€å–</button>
                        <button class="btn-small" style="background:#c62828;" onclick="window.deleteCloudFile('${p.id}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        };

        // â˜… é›²ç«¯é è¦½åŠŸèƒ½
        window.previewCloudFile = function(id) {
            const p = cloudProjectsCache.find(x => x.id === id);
            if(!p) return;
            
            const container = document.getElementById('preview-container');
            const cvs = document.getElementById('previewCanvas');
            const title = document.getElementById('preview-title');
            
            container.style.display = 'block';
            title.innerText = `é è¦½: ${id}`;
            
            // ç¹ªè£½é è¦½åœ–
            const ctx = cvs.getContext('2d');
            cvs.width = 400; 
            cvs.height = 400; // å›ºå®šé«˜åº¦
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,400,400);

            const layers = p.layers || [];
            const totalThick = layers.reduce((s,l) => s+(parseFloat(l.thickness)||0),0) || 1;
            const scale = 350 / totalThick;
            const cx = 200;
            const rw = 160;
            let cy = 25;

            layers.forEach(l => {
                const h = (parseFloat(l.thickness)||0) * scale;
                ctx.fillStyle = l.color || "#ccc";
                ctx.fillRect(cx - rw/2, cy, rw, h);
                ctx.strokeStyle = "#333";
                ctx.strokeRect(cx - rw/2, cy, rw, h);
                if(h > 10) {
                     ctx.fillStyle = "#000"; ctx.textAlign="center"; ctx.textBaseline="middle"; 
                     ctx.fillText(l.name, cx, cy+h/2);
                }
                cy += h;
            });
        };

        // â˜… ç›´æ¥ä¸‹è¼‰é›²ç«¯æª”æ¡ˆçš„ Excel
        window.downloadCloudExcel = function(id) {
            const p = cloudProjectsCache.find(x => x.id === id);
            if(!p) return;
            
            // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦åªåŒ¯å‡º checked çš„å±¤ï¼Œå‡è¨­å…¨éƒ¨åŒ¯å‡º
            // å¦‚æœè¦åƒä¸»ç•«é¢ä¸€æ¨£åªåŒ¯å‡º checkedï¼Œéœ€è¦æª¢æŸ¥ p.layers[i].checked
            // é€™è£¡åšé€šç”¨è™•ç†ï¼šæœ‰ checked å±¬æ€§ä¸”ç‚º false æ‰æ’é™¤ï¼Œå¦å‰‡å…¨åŒ¯å‡º
            const layers = p.layers || [];
            const validLayers = layers.filter(l => l.checked !== false);
            
            if(validLayers.length === 0) { alert("æ­¤æª”æ¡ˆæ²’æœ‰å¯åŒ¯å‡ºçš„å±¤"); return; }

            const unit = p.settings?.unit || 'um';
            const note = p.note || '';
            
            let csv = "\uFEFF"; // BOM
            if(note) csv += `å‚™è¨»: ${note.replace(/,/g, " ")}\n\n`;
            csv += "å±¤åº,åç¨±,åšåº¦,å–®ä½\n";
            
            let total = 0;
            validLayers.forEach((l, i) => {
                const safeName = (l.name || "").replace(/,/g, " ");
                const th = parseFloat(l.thickness) || 0;
                total += th;
                csv += `${i+1},${safeName},${th},${unit}\n`;
            });
            csv += `,,${total},${unit},ç¸½åšåº¦\n`;

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${id}_stackup.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // è®€å–é€²ä¸»ç•«é¢
        window.loadCloudFile = function(id) {
            const p = cloudProjectsCache.find(x => x.id === id);
            if(!p) return;
            window.applyConfig(p);
            document.getElementById('projName').value = id;
            document.getElementById('projNote').value = p.note || "";
            window.closeCloudManager();
        };
        
        // åˆªé™¤
        window.deleteCloudFile = async function(id) {
            if(!confirm(`ç¢ºå®šåˆªé™¤ ${id}?`)) return;
            showLoading(true);
            try { await deleteDoc(doc(db, COL_PROJ, id)); await window.refreshCloudList(); } catch(e) { alert("Error"); }
            showLoading(false);
        };

        // ---------------------------------------------
        // ä¸»ç•«é¢å°ˆæ¡ˆå„²å­˜
        // ---------------------------------------------
        window.saveToCloud = async function() {
            if(!isFirebaseReady) { alert("å°šæœªé€£ç·š"); return; }
            const name = document.getElementById('projName').value.trim();
            const note = document.getElementById('projNote').value;
            if (!name) { alert("è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±"); return; }
            
            const config = { 
                layers: window.layers, 
                dimensions: window.dimensions, 
                settings: { 
                    unit: document.getElementById('unitInput').value, 
                    width: document.getElementById('canvasWidth').value, 
                    fontSize: document.getElementById('globalFontSize').value 
                },
                note: note, // â˜… å„²å­˜å‚™è¨»
                timestamp: Date.now() 
            };
            
            if(!confirm(`å­˜æª”: ${name}?`)) return;
            showLoading(true, "å„²å­˜ä¸­...");
            try { await setDoc(doc(db, COL_PROJ, name), config); alert("å„²å­˜æˆåŠŸ"); } catch (e) { alert("å„²å­˜å¤±æ•—"); console.error(e); }
            showLoading(false);
        };

        // ---------------------------------------------
        // â˜… æ¨¡çµ„ (Unit) åŠŸèƒ½
        // ---------------------------------------------
        window.saveUnitToCloud = async function() {
            if(!isFirebaseReady) { alert("å°šæœªé€£ç·š"); return; }
            const name = document.getElementById('unitName').value.trim();
            if(!name) { alert("è«‹è¼¸å…¥æ¨¡çµ„åç¨±"); return; }
            const selected = window.layers.filter(l => l.checked !== false);
            if(selected.length === 0) { alert("è«‹å‹¾é¸è¦å­˜ç‚ºæ¨¡çµ„çš„å±¤"); return; }
            
            if(!confirm(`å»ºç«‹æ¨¡çµ„: ${name} (å«${selected.length}å±¤)?`)) return;
            showLoading(true);
            try { 
                await setDoc(doc(db, COL_UNITS, name), { layers: selected, timestamp: Date.now() }); 
                alert("æ¨¡çµ„å·²å»ºç«‹"); 
                document.getElementById('unitName').value = "";
                await window.refreshUnitList();
            } catch(e) { alert("Error"); }
            showLoading(false);
        };

        window.refreshUnitList = async function() {
            if(!isFirebaseReady) return;
            const sel = document.getElementById('savedUnits');
            try {
                const q = await getDocs(collection(db, COL_UNITS));
                sel.innerHTML = '<option value="">-- é¸æ“‡æ¨¡çµ„ --</option>';
                q.forEach(doc => {
                    const opt = document.createElement('option'); opt.value = doc.id; opt.innerText = doc.id; sel.appendChild(opt);
                });
            } catch(e) {}
        };

        window.insertUnit = async function() {
            const name = document.getElementById('savedUnits').value;
            if(!name) return;
            showLoading(true);
            try {
                const d = await getDoc(doc(db, COL_UNITS, name));
                if(d.exists()) {
                    const uLayers = d.data().layers || [];
                    // çµ¦æ–°IDä¸¦è¨­ç‚ºchecked
                    const newL = uLayers.map(l => ({ ...l, id: Date.now()+Math.random(), checked: true }));
                    window.layers = [...newL, ...window.layers];
                    window.renderList(); window.draw();
                }
            } catch(e) { alert("Error"); }
            showLoading(false);
        };
        
        window.deleteUnitFromCloud = async function() {
            const name = document.getElementById('savedUnits').value;
            if(!name) return;
            if(confirm(`åˆªé™¤æ¨¡çµ„: ${name}?`)) {
                showLoading(true);
                await deleteDoc(doc(db, COL_UNITS, name));
                await window.refreshUnitList();
                showLoading(false);
            }
        };

        // ---------------------------------------------
        // é€šç”¨åŠŸèƒ½
        // ---------------------------------------------
        window.applyConfig = function(config) {
            window.layers = config.layers || [];
            window.layers.forEach(l => { if(l.checked === undefined) l.checked = true; });
            window.dimensions = config.dimensions || [];
            if(config.settings) {
                document.getElementById('unitInput').value = config.settings.unit||"um";
                document.getElementById('canvasWidth').value = config.settings.width||450;
                document.getElementById('globalFontSize').value = config.settings.fontSize||14;
            }
            window.resizeCanvas(); window.renderList(); window.draw();
        };

        window.exportCurrentToCSV = function() {
            const selected = window.layers.filter(l => l.checked !== false);
            if(selected.length === 0) { alert("è«‹å‹¾é¸å±¤æ¬¡"); return; }
            const name = document.getElementById('projName').value || "Stackup";
            const note = document.getElementById('projNote').value;
            const unit = document.getElementById('unitInput').value;
            
            let csv = "\uFEFF";
            if(note) csv += `å‚™è¨»: ${note.replace(/,/g, " ")}\n\n`;
            csv += "å±¤åº,åç¨±,åšåº¦,å–®ä½\n";
            let t=0;
            selected.forEach((l,i) => {
                t += (parseFloat(l.thickness)||0);
                csv += `${i+1},${(l.name||"").replace(/,/g," ")},${l.thickness},${unit}\n`;
            });
            csv += `,,${t},${unit},é¸å–ç¸½åšåº¦\n`;
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `${name}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        window.downloadImage = () => { const a=document.createElement('a'); a.download='stack.png'; a.href=canvas.toDataURL(); a.click(); };
        window.newProject = () => { if(confirm("æ¸…ç©º?")) { window.layers=[]; window.dimensions=[]; window.renderList(); window.draw(); document.getElementById('projName').value=""; document.getElementById('projNote').value=""; } };

        // ç¹ªåœ–
        window.resizeCanvas = () => { canvas.width = parseInt(document.getElementById('canvasWidth').value)||450; window.draw(); };
        window.draw = () => {
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value)||14;
            const totalThick = window.layers.reduce((s,l)=>s+(parseFloat(l.thickness)||0),0);
            
            if(totalThick===0 && window.layers.length===0) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }

            let maxOff = 20; window.dimensions.forEach(d => { if(d.offset>maxOff) maxOff=d.offset; });
            const pad = { t:40, b:40, l: maxOff+80, r:20 };
            const dw = canvas.width - pad.l - pad.r;
            const ah = Math.max(500, window.layers.length*40);
            canvas.height = ah + pad.t + pad.b;
            const scale = ah / (totalThick||1);
            
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.textAlign="center"; ctx.textBaseline="middle";
            let cy = pad.t;
            let yPos = [];

            window.layers.forEach(l => {
                const h = (parseFloat(l.thickness)||0)*scale;
                yPos.push({t:cy, b:cy+h});
                ctx.fillStyle = l.color; ctx.fillRect(pad.l, cy, dw, h);
                ctx.strokeStyle="#333"; ctx.strokeRect(pad.l, cy, dw, h);
                if(h>12) {
                     ctx.fillStyle = isColorDark(l.color)?"white":"black"; if(l.textColor) ctx.fillStyle=l.textColor;
                     const fs = l.fontSize||globalFS; const st = l.fontStyle==='bold'?'bold':'';
                     ctx.font = `${st} ${fs}px Arial`; ctx.fillText(`${l.name} ${l.thickness}${unit}`, pad.l+dw/2, cy+h/2);
                }
                cy += h;
            });
            // Dims
            window.dimensions.forEach(d => {
                if(!yPos[d.start] || !yPos[d.end]) return;
                const y1=yPos[d.start].t, y2=yPos[d.end].b, h=y2-y1, x=pad.l-d.offset;
                ctx.strokeStyle="#D32F2F"; ctx.fillStyle="#D32F2F"; ctx.lineWidth=2; ctx.font="bold 14px Arial";
                ctx.beginPath(); ctx.moveTo(x,y1); ctx.lineTo(x,y1+h); ctx.stroke();
                ctx.strokeStyle="#ccc"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x,y1); ctx.lineTo(x+10,y1); ctx.moveTo(x,y1+h); ctx.lineTo(x+10,y1+h); ctx.stroke();
                drawArrow(ctx,x,y1,1); drawArrow(ctx,x,y1+h,0);
                const txt = d.label || `${window.layers.slice(d.start,d.end+1).reduce((s,l)=>s+(parseFloat(l.thickness)||0),0)}${unit}`;
                ctx.textAlign="right"; ctx.fillText(txt, x-5, y1+h/2);
            });
        };
        function drawArrow(ctx,x,y,u) { ctx.beginPath(); const s=5; if(u){ctx.moveTo(x,y);ctx.lineTo(x-s,y+s);ctx.lineTo(x+s,y+s);}else{ctx.moveTo(x,y);ctx.lineTo(x-s,y-s);ctx.lineTo(x+s,y-s);} ctx.fill(); }
        function isColorDark(hex) { const r=parseInt(hex.substr(1,2),16),g=parseInt(hex.substr(3,2),16),b=parseInt(hex.substr(5,2),16); return ((r*299+g*587+b*114)/1000)<128; }
        
        // Init
        if(isFirebaseReady) { window.refreshUnitList(); }
        window.layers = [{name:"Demo",thickness:100,color:"#90CAF9",checked:true}];
        window.renderList(); window.draw();

    </script>
</body>
</html>
