<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ç¨‹ç–Šæ§‹åœ–ç”¢ç”Ÿå™¨ (Pro)</title>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        /* --- åŸºç¤ä½ˆå±€ --- */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #121212; color: #ddd; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { 
            width: 400px; min-width: 320px; max-width: 800px; 
            background-color: #1e1e1e; padding: 15px; padding-top: 60px; 
            display: flex; flex-direction: column; gap: 12px; z-index: 10; 
            overflow-y: auto; flex-shrink: 0; box-sizing: border-box; 
            border-right: 1px solid #333;
        }

        #resizer { width: 8px; background-color: #121212; cursor: col-resize; z-index: 20; flex-shrink: 0; display: flex; justify-content: center; align-items: center; }
        #resizer::after { content: ""; width: 2px; height: 30px; background: #444; }
        
        #main-area { 
            flex-grow: 1; background-color: #222; 
            display: flex; justify-content: center; align-items: start;
            overflow: auto; padding: 20px; cursor: default; 
            position: relative;
        }
        
        /* æ‰‹æ©Ÿç‰ˆ */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            #sidebar { width: 100% !important; max-width: 100%; height: auto; max-height: 50vh; border-right: none; border-bottom: 2px solid #444; }
            #resizer { display: none; }
            #main-area { width: 100%; height: 600px; padding: 10px; display: block; text-align: center; }
            .home-btn { top: 10px; left: 10px; padding: 4px 8px; font-size: 11px; }
        }

        /* å…ƒä»¶æ¨£å¼ */
        h2 { margin: 0 0 5px 0; color: #4FC3F7; font-size: 18px; }
        h3 { margin: 15px 0 5px 0; color: #bbb; font-size: 14px; border-bottom: 1px solid #444; padding-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
        .control-group { background: #252525; padding: 10px; border-radius: 6px; border: 1px solid #333; }
        label { display: block; margin-bottom: 3px; font-size: 12px; color: #aaa; }
        input[type="text"], input[type="number"], select { background: #333; border: 1px solid #555; color: white; padding: 5px; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 13px; }
        
        /* åˆ—è¡¨èˆ‡æ‹–æ›³æ¨£å¼ */
        #layer-list { display: flex; flex-direction: column; gap: 6px; }
        .layer-item { background: #333; border-radius: 4px; padding: 6px; border-left: 4px solid #666; font-size: 13px; transition: transform 0.2s, background 0.2s; }
        /* æ‹–æ›³ä¸­çš„æ¨£å¼ */
        .layer-item.dragging { opacity: 0.5; border: 2px dashed #4FC3F7; background: #2a2a2a; }
        .layer-item:hover { background-color: #3a3a3a; }

        .layer-main-row { display: flex; align-items: center; gap: 4px; }
        .move-btns { display: flex; flex-direction: column; gap: 1px; margin-right: 2px; }
        .btn-tiny { padding: 0px 4px; font-size: 10px; height: 14px; line-height: 12px; background: #444; color: #fff; border: 1px solid #555; cursor: pointer; }
        
        .layer-inputs { flex-grow: 1; display: grid; grid-template-columns: 1fr 0.6fr; gap: 4px; }
        .layer-details { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #555; grid-template-columns: 1fr 1fr 1fr; gap: 5px; align-items: end; }
        .layer-item.open .layer-details { display: grid; }
        
        .btn-toggle-details { cursor: pointer; color: #888; font-size: 14px; padding: 4px; border-radius: 4px; background: #2a2a2a; text-align: center; width: 20px;}
        .btn-toggle-details.active { background: #1976D2; color: white; }
        input[type="color"] { border: none; width: 24px; height: 24px; cursor: pointer; background: none; padding: 0; }
        .btn-icon { cursor: pointer; color: #888; font-size: 16px; padding: 2px; }
        .btn-del:hover { color: #ff5252; }
        .layer-check { width: 20px; height: 20px; cursor: pointer; margin-right: 2px; accent-color: #4CAF50; }
        
        /* æŒ‰éˆ•ç¾¤çµ„ */
        button { padding: 8px; font-size: 13px; cursor: pointer; background-color: #444; color: white; border: 1px solid #555; border-radius: 4px; width: 100%; transition: 0.2s; margin-top: 5px; }
        button:hover { background-color: #666; }
        .btn-ppt { background-color: #E65100; border-color: #EF6C00; font-weight: bold; }
        .btn-img { background-color: #1976D2; border-color: #1565C0; }
        .btn-add { background-color: #43A047; border-color: #2E7D32; }
        
        .btn-save-cloud { background-color: #00897B; border-color: #00695C; flex:1; }
        .btn-del-cloud { background-color: #c62828; border-color: #b71c1c; width: auto; flex:0.2;}
        .btn-unit { background-color: #7B1FA2; border-color: #4A148C; flex:1; } /* ç´«è‰² Unit æŒ‰éˆ• */
        
        .project-btns { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn-proj { background-color: #546E7A; border-color: #455A64; flex: 1; min-width: 50px;}
        .btn-csv { background-color: #2E7D32; border-color: #1B5E20; flex: 1; min-width: 60px; } 
        .btn-clear { background-color: #D32F2F; border-color: #C62828; flex: 0.8; }

        .home-btn { position: absolute; top: 15px; left: 15px; text-decoration: none; background: #444; padding: 6px 12px; border-radius: 20px; color: #fff; font-size: 12px; border: 1px solid #666; z-index: 100; }
        #fileInput { display: none; }
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); background-color: white; max-width: 100%; }
        
        /* æ¨¡æ…‹è¦–çª— (Preview Modal) */
        #preview-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #252525; border: 1px solid #4FC3F7; border-radius: 8px;
            padding: 15px; z-index: 2000; display: none;
            box-shadow: 0 0 30px rgba(0,0,0,0.8); width: 320px; max-width: 90%;
        }
        #preview-canvas-container { text-align: center; margin: 10px 0; background: white; padding: 5px; border-radius: 4px;}
        #preview-canvas { max-width: 100%; height: auto; }
        .modal-backdrop { position: fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1999; display:none;}

        /* Loading */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); color: white; display: none;
            justify-content: center; align-items: center; z-index: 9999; flex-direction: column;
        }
        .spinner {
            border: 4px solid #333; border-top: 4px solid #4FC3F7; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="font-size: 18px;">â˜ï¸ é€£ç·šä¸­...</div>
    </div>

    <div class="modal-backdrop" id="modalBackdrop" onclick="window.closePreview()"></div>
    <div id="preview-modal">
        <h3 style="margin-top:0; color:#fff">æ¨¡çµ„é è¦½</h3>
        <div id="preview-info" style="font-size:12px; color:#aaa; margin-bottom:5px;"></div>
        <div id="preview-canvas-container">
            <canvas id="previewCanvas"></canvas>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-clear" onclick="window.closePreview()">å–æ¶ˆ</button>
            <button class="btn-add" onclick="window.confirmInsertUnit()">â• æ’å…¥æ¨¡çµ„</button>
        </div>
    </div>

    <a href="index.html" class="home-btn">ğŸ </a>

    <div id="sidebar">
        <h2>ğŸ“š ç–Šæ§‹è³‡æ–™åº« (Pro)</h2>

        <div class="control-group" style="border-left: 4px solid #00897B;">
            <label style="color:#80CBC4">â˜ï¸ å°ˆæ¡ˆå­˜å– (Project)</label>
            <input type="text" id="projName" placeholder="è¼¸å…¥å°ˆæ¡ˆåç¨±..." style="width:100%; margin-bottom:6px;">
            <div style="display:flex; gap:5px;">
                <button class="btn-save-cloud" onclick="window.saveToCloud()">ğŸ’¾ å„²å­˜å°ˆæ¡ˆ</button>
                <select id="savedProjects" onchange="window.loadFromCloud()" style="flex:1.5">
                    <option value="">-- è®€å– --</option>
                </select>
                <button class="btn-del-cloud" onclick="window.deleteFromCloud()">ğŸ—‘ï¸</button>
            </div>
        </div>

        <div class="control-group" style="border-left: 4px solid #7B1FA2;">
            <label style="color:#CE93D8">ğŸ§© æ¨¡çµ„å–®å…ƒ (Unit)</label>
            <div style="font-size:11px; color:#aaa; margin-bottom:4px;">å‹¾é¸ä¸‹æ–¹å±¤æ¬¡å¾Œå³å¯å„²å­˜ç‚ºæ¨¡çµ„</div>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="unitName" placeholder="æ¨¡çµ„åç¨± (ä¾‹: Coreçµæ§‹)" style="flex:1">
                <button class="btn-unit" onclick="window.saveUnitToCloud()">å­˜æ¨¡çµ„</button>
            </div>
            <div style="display:flex; gap:5px;">
                <select id="savedUnits" onchange="window.previewUnit()" style="flex:1">
                    <option value="">-- é¸æ“‡æ¨¡çµ„æ’å…¥ --</option>
                </select>
                <button class="btn-del-cloud" onclick="window.deleteUnitFromCloud()">ğŸ—‘ï¸</button>
            </div>
        </div>
        
        <div class="project-btns">
            <button class="btn-clear" onclick="window.newProject()">æ¸…ç©º</button>
            <button class="btn-proj" onclick="window.exportJSON()">å‚™ä»½</button>
            <button class="btn-proj" onclick="document.getElementById('fileInput').click()">è®€å–</button>
            <button class="btn-csv" onclick="window.exportCSV()">ğŸ“Š å­˜ Excel</button>
            <input type="file" id="fileInput" accept=".json" onchange="window.importJSON(this)">
        </div>

        <div class="control-group">
            <label>å…¨åŸŸè¨­å®š</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="unitInput" value="um" placeholder="å–®ä½" oninput="window.draw()" style="flex:0.5">
                <input type="number" id="canvasWidth" value="450" placeholder="å¯¬" oninput="window.resizeCanvas()" style="flex:1">
                <input type="number" id="globalFontSize" value="14" placeholder="å­—é«”" oninput="window.draw()" style="flex:0.5">
            </div>
        </div>

        <h3>
            1. å±¤æ¬¡ 
            <label style="font-size:12px; cursor:pointer; display:flex; align-items:center; gap:5px;">
                <input type="checkbox" id="selectAllBox" checked onchange="window.toggleAllLayers(this)"> å…¨é¸
            </label>
        </h3>
        <button class="btn-add" onclick="window.addLayer()">â• æ–°å¢ä¸€å±¤ (Top)</button>
        
        <div id="layer-list" style="margin-top:5px;"></div>

        <h3>2. æ¨™è¨»</h3>
        <div class="control-group">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <select id="dimStart"></select> <span>è‡³</span> <select id="dimEnd"></select>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="dimLabel" placeholder="æ–‡å­—(é¸å¡«)">
                <input type="number" id="dimOffset" value="50" placeholder="åç§»">
            </div>
            <button onclick="window.addDimension()">â• æ–°å¢æ¨™è¨»</button>
        </div>
        <div id="dim-list" style="margin-top:5px;"></div>

        <div style="margin-top: 10px;"></div>
        <button class="btn-img" onclick="window.downloadImage()">ğŸ’¾ å­˜åœ–</button>
        <button class="btn-ppt" onclick="window.downloadPPT()">ğŸ“Š å­˜ PPT</button>
    </div>

    <div id="resizer"></div>
    <div id="main-area"><canvas id="stackCanvas"></canvas></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyCnHhksuhJs9RdrL7DPnsAvR21ZND7kIOI",
          authDomain: "stack-diagram-db.firebaseapp.com",
          projectId: "stack-diagram-db",
          storageBucket: "stack-diagram-db.firebasestorage.app",
          messagingSenderId: "67240747982",
          appId: "1:67240747982:web:1fb065e40e936a7485419f",
          measurementId: "G-QJNE60W8BB"
        };

        let db = null;
        let COLLECTION_NAME = "projects";
        let COLLECTION_UNITS = "units"; // æ–°å¢ Units é›†åˆ
        let isFirebaseReady = false;

        function checkConfig() {
            if (firebaseConfig.apiKey.includes("ä½ çš„API_KEY")) return false;
            return true;
        }

        if (checkConfig()) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isFirebaseReady = true;
            } catch(e) { console.error("Firebase init error", e); }
        }

        const canvas = document.getElementById('stackCanvas');
        const ctx = canvas.getContext('2d');
        const listEl = document.getElementById('layer-list');
        const dimListEl = document.getElementById('dim-list');

        window.layers = [];
        window.dimensions = [];
        let tempUnitLayers = []; // æš«å­˜è®€å–çš„ Unit

        // ---------------------------------------------
        // â˜… æ‹–æ›³åŠŸèƒ½ (Drag & Drop)
        // ---------------------------------------------
        let dragSrcEl = null;

        function handleDragStart(e) {
            this.style.opacity = '0.4';
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('over');
        }

        function handleDragLeave(e) {
            this.classList.remove('over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                // å–å¾—ç´¢å¼•
                const oldIndex = parseInt(dragSrcEl.getAttribute('data-index'));
                const newIndex = parseInt(this.getAttribute('data-index'));
                
                // ç§»å‹•é™£åˆ—å…ƒç´ 
                const movedItem = window.layers.splice(oldIndex, 1)[0];
                window.layers.splice(newIndex, 0, movedItem);
                
                // é‡æ–°æ¸²æŸ“
                window.renderList();
                window.draw();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            this.classList.remove('dragging');
            let items = listEl.querySelectorAll('.layer-item');
            items.forEach(function (item) {
                item.classList.remove('over');
            });
        }

        // ---------------------------------------------
        // UI Render
        // ---------------------------------------------
        window.renderList = function() {
            listEl.innerHTML = ''; window.updateDimSelects();
            const allChecked = window.layers.every(l => l.checked !== false);
            const selectAllBox = document.getElementById('selectAllBox');
            if(selectAllBox) selectAllBox.checked = allChecked;

            window.layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                // â˜… è¨­å®šæ‹–æ›³å±¬æ€§
                item.setAttribute('draggable', 'true');
                item.setAttribute('data-index', index);
                
                if(layer.showDetails) item.classList.add('open');
                item.style.borderLeftColor = layer.color;
                const isChecked = layer.checked !== false ? 'checked' : '';

                item.innerHTML = `
                    <div class="layer-main-row">
                        <input type="checkbox" class="layer-check" ${isChecked} onchange="window.toggleLayerCheck(${index})">
                        <div class="move-btns">
                            <button class="btn-tiny" onclick="window.moveLayer(${index}, -1)">â–²</button>
                            <button class="btn-tiny" onclick="window.moveLayer(${index}, 1)">â–¼</button>
                        </div>
                        <div class="layer-inputs">
                            <input type="text" value="${layer.name}" oninput="window.updateLayer(${index}, 'name', this.value)" placeholder="åç¨±">
                            <input type="number" value="${layer.thickness}" oninput="window.updateLayer(${index}, 'thickness', this.value)" placeholder="åšåº¦">
                        </div>
                        <input type="color" value="${layer.color}" oninput="window.updateLayer(${index}, 'color', this.value)">
                        <div class="btn-toggle-details ${layer.showDetails?'active':''}" onclick="window.toggleDetails(${index})">âš™ï¸</div>
                        <div class="btn-icon btn-del" onclick="window.deleteLayer(${index})">Ã—</div>
                    </div>
                    <div class="layer-details">
                        <div><label>é¡è‰²</label><input type="color" value="${layer.textColor||'#000000'}" oninput="window.updateLayer(${index}, 'textColor', this.value)" style="width:100%"></div>
                        <div><label>å­—é«”</label><input type="number" value="${layer.fontSize || ''}" placeholder="å…¨åŸŸ" oninput="window.updateLayer(${index}, 'fontSize', this.value)"></div>
                        <div><label>æ¨£å¼</label><select onchange="window.updateLayer(${index}, 'fontStyle', this.value)" style="padding:2px;"><option value="normal" ${layer.fontStyle==='normal'?'selected':''}>ä¸€èˆ¬</option><option value="bold" ${layer.fontStyle==='bold'?'selected':''}>ç²—é«”</option></select></div>
                    </div>
                `;
                
                // ç¶å®šæ‹–æ›³äº‹ä»¶
                item.addEventListener('dragstart', handleDragStart, false);
                item.addEventListener('dragenter', handleDragEnter, false);
                item.addEventListener('dragover', handleDragOver, false);
                item.addEventListener('dragleave', handleDragLeave, false);
                item.addEventListener('drop', handleDrop, false);
                item.addEventListener('dragend', handleDragEnd, false);

                listEl.appendChild(item);
            });
        };

        window.moveLayer = function(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= window.layers.length) return;
            const temp = window.layers[index];
            window.layers[index] = window.layers[newIndex];
            window.layers[newIndex] = temp;
            window.renderList(); window.draw();
        };

        window.toggleLayerCheck = function(index) {
            if(window.layers[index].checked === undefined) window.layers[index].checked = true;
            window.layers[index].checked = !window.layers[index].checked;
            const allChecked = window.layers.every(l => l.checked !== false);
            document.getElementById('selectAllBox').checked = allChecked;
        };
        window.toggleAllLayers = function(checkbox) {
            const isChecked = checkbox.checked;
            window.layers.forEach(l => l.checked = isChecked);
            window.renderList();
        };

        window.updateLayer = function(index, key, value) { if (key === 'thickness' || key === 'fontSize') value = parseFloat(value) || 0; window.layers[index][key] = value; if(key === 'color') window.renderList(); window.draw(); };
        window.toggleDetails = function(index) { window.layers[index].showDetails = !window.layers[index].showDetails; window.renderList(); };
        window.addLayer = function() { window.layers.unshift({ id: Date.now(), name: "New", thickness: 20, color: "#cccccc", fontSize: 0, fontStyle: 'bold', checked: true }); window.renderList(); window.draw(); };
        window.deleteLayer = function(index) { window.layers.splice(index, 1); window.renderList(); window.draw(); };
        
        // æ¨™è¨»ç›¸é—œ
        window.updateDimSelects = function() {
            const s1 = document.getElementById('dimStart'); const s2 = document.getElementById('dimEnd');
            const v1 = s1.value; const v2 = s2.value; s1.innerHTML = ''; s2.innerHTML = '';
            window.layers.forEach((l, i) => { const opt = `<option value="${i}">${i+1}. ${l.name}</option>`; s1.innerHTML += opt; s2.innerHTML += opt; });
            if(v1) s1.value = v1; if(v2) s2.value = v2; else if(window.layers.length>0) s2.value = window.layers.length-1;
        };
        window.addDimension = function() { const s = parseInt(document.getElementById('dimStart').value); const e = parseInt(document.getElementById('dimEnd').value); const txt = document.getElementById('dimLabel').value; const off = parseInt(document.getElementById('dimOffset').value) || 50; window.addDimensionByLogic(s, e, txt, off); };
        window.addDimensionByLogic = function(s, e, l, o) { window.dimensions.push({ start: Math.min(s,e), end: Math.max(s,e), label: l, offset: o }); renderDims(); window.draw(); };
        function renderDims() { dimListEl.innerHTML = ''; window.dimensions.forEach((d, i) => { const sName = window.layers[d.start]?.name||'?'; const eName = window.layers[d.end]?.name||'?'; const div = document.createElement('div'); div.className = 'dim-item'; div.innerHTML = `<span>${sName}~${eName} (å${d.offset})</span><span class="btn-icon btn-del" onclick="window.deleteDim(${i})">Ã—</span>`; dimListEl.appendChild(div); }); }
        window.deleteDim = function(i) { window.dimensions.splice(i, 1); renderDims(); window.draw(); };

        // ---------------------------------------------
        // â˜… Unit (æ¨¡çµ„) åŠŸèƒ½ 
        // ---------------------------------------------
        window.saveUnitToCloud = async function() {
            if(!isFirebaseReady) { alert("å°šæœªé€£ç·š"); return; }
            const name = document.getElementById('unitName').value.trim();
            if(!name) { alert("è«‹è¼¸å…¥æ¨¡çµ„åç¨±"); return; }
            
            // æŠ“å‡ºå‹¾é¸çš„ layers
            const selectedLayers = window.layers.filter(l => l.checked !== false);
            if(selectedLayers.length === 0) { alert("è«‹è‡³å°‘å‹¾é¸ä¸€å±¤ä¾†è£½ä½œæ¨¡çµ„"); return; }

            const unitData = { layers: selectedLayers, timestamp: Date.now() };

            if(!confirm(`ç¢ºå®šå„²å­˜æ¨¡çµ„: ${name} (å…±${selectedLayers.length}å±¤)?`)) return;
            
            showLoading(true, "å„²å­˜æ¨¡çµ„...");
            try {
                await setDoc(doc(db, COLLECTION_UNITS, name), unitData);
                alert("æ¨¡çµ„å·²å„²å­˜ï¼");
                await window.refreshUnitList();
                document.getElementById('unitName').value = "";
            } catch(e) { console.error(e); alert("å„²å­˜å¤±æ•—"); }
            showLoading(false);
        };

        window.refreshUnitList = async function() {
            if(!isFirebaseReady) return;
            const select = document.getElementById('savedUnits');
            try {
                const q = await getDocs(collection(db, COLLECTION_UNITS));
                select.innerHTML = '<option value="">-- é¸æ“‡æ¨¡çµ„æ’å…¥ --</option>';
                q.forEach((doc) => {
                    const opt = document.createElement('option'); opt.value = doc.id; opt.innerText = doc.id; select.appendChild(opt);
                });
            } catch(e) { console.error(e); }
        };

        window.deleteUnitFromCloud = async function() {
            const name = document.getElementById('savedUnits').value;
            if(!name) return;
            if(!confirm(`åˆªé™¤æ¨¡çµ„: ${name}?`)) return;
            showLoading(true);
            try { await deleteDoc(doc(db, COLLECTION_UNITS, name)); await window.refreshUnitList(); alert("å·²åˆªé™¤"); } catch(e) { alert("Error"); }
            showLoading(false);
        };

        // é è¦½ Unit
        window.previewUnit = async function() {
            const name = document.getElementById('savedUnits').value;
            if(!name) return;
            
            showLoading(true, "è®€å–æ¨¡çµ„...");
            try {
                const docSnap = await getDoc(doc(db, COLLECTION_UNITS, name));
                if(docSnap.exists()) {
                    tempUnitLayers = docSnap.data().layers || [];
                    showPreviewModal(name, tempUnitLayers);
                }
            } catch(e) { console.error(e); alert("è®€å–å¤±æ•—"); }
            showLoading(false);
        };

        function showPreviewModal(name, layers) {
            const modal = document.getElementById('preview-modal');
            const backdrop = document.getElementById('modalBackdrop');
            const info = document.getElementById('preview-info');
            const pCanvas = document.getElementById('previewCanvas');
            const pCtx = pCanvas.getContext('2d');

            info.innerText = `åç¨±: ${name} / å±¤æ•¸: ${layers.length}`;
            
            // ç¹ªè£½é è¦½åœ–
            pCanvas.width = 300;
            pCanvas.height = 300;
            pCtx.fillStyle = "#fff"; pCtx.fillRect(0,0,300,300);
            
            const totalThick = layers.reduce((s,l) => s + (parseFloat(l.thickness)||0), 0) || 1;
            const scale = 260 / totalThick;
            let cy = 20;
            const cx = 150;
            const rw = 120;

            layers.forEach(l => {
                const h = (parseFloat(l.thickness)||0) * scale;
                pCtx.fillStyle = l.color;
                pCtx.fillRect(cx - rw/2, cy, rw, h);
                pCtx.strokeStyle = "#333";
                pCtx.strokeRect(cx - rw/2, cy, rw, h);
                // ç°¡åŒ–æ–‡å­—
                if(h > 10) {
                    pCtx.fillStyle = "#000"; pCtx.font = "10px Arial"; pCtx.textAlign = "center"; pCtx.textBaseline="middle";
                    pCtx.fillText(l.name, cx, cy + h/2);
                }
                cy += h;
            });

            modal.style.display = 'block';
            backdrop.style.display = 'block';
        }

        window.closePreview = function() {
            document.getElementById('preview-modal').style.display = 'none';
            document.getElementById('modalBackdrop').style.display = 'none';
            document.getElementById('savedUnits').value = ""; // é‡ç½®é¸å–®
        };

        window.confirmInsertUnit = function() {
            // æ’å…¥åˆ°æœ€ä¸Šæ–¹ (æˆ–å¯æ”¹ç‚ºæ’å…¥åˆ°é¸å–ä½ç½®ï¼Œé€™è£¡é è¨­æœ€ä¸Š)
            // çµ¦æ–° ID é¿å…è¡çª
            const newLayers = tempUnitLayers.map(l => ({ ...l, id: Date.now() + Math.random() }));
            window.layers = [...newLayers, ...window.layers];
            window.renderList();
            window.draw();
            window.closePreview();
        };

        // ---------------------------------------------
        // Project Cloud
        // ---------------------------------------------
        function showLoading(show, text = "è™•ç†ä¸­...") {
            const overlay = document.getElementById('loading-overlay');
            const txt = document.getElementById('loading-text');
            if(show) { txt.innerText = text; overlay.style.display = 'flex'; }
            else { overlay.style.display = 'none'; }
        }

        window.refreshProjectList = async function() {
            if(!isFirebaseReady) return;
            const select = document.getElementById('savedProjects');
            try {
                const querySnapshot = await getDocs(collection(db, COLLECTION_NAME));
                select.innerHTML = '<option value="">-- è®€å–å°ˆæ¡ˆ --</option>';
                querySnapshot.forEach((doc) => {
                    const opt = document.createElement('option'); opt.value = doc.id; opt.innerText = doc.id; select.appendChild(opt);
                });
            } catch (e) { }
        };

        window.saveToCloud = async function() {
            if(!isFirebaseReady) { alert("å°šæœªé€£ç·š"); return; }
            const name = document.getElementById('projName').value.trim();
            if (!name) { alert("è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±"); return; }
            const config = { layers: window.layers, dimensions: window.dimensions, settings: { unit: document.getElementById('unitInput').value, width: document.getElementById('canvasWidth').value, fontSize: document.getElementById('globalFontSize').value }, timestamp: Date.now() };
            if(!confirm(`å­˜æª”: ${name}?`)) return;
            showLoading(true);
            try { await setDoc(doc(db, COLLECTION_NAME, name), config); alert("OK"); await window.refreshProjectList(); } catch (e) { alert("Error"); }
            showLoading(false);
        };

        window.loadFromCloud = async function() {
            if(!isFirebaseReady) return;
            const name = document.getElementById('savedProjects').value;
            if (!name) return;
            showLoading(true);
            try { const docSnap = await getDoc(doc(db, COLLECTION_NAME, name)); if (docSnap.exists()) { window.applyConfig(docSnap.data()); document.getElementById('projName').value = name; } } catch (e) { alert("Error"); }
            showLoading(false);
        };

        window.deleteFromCloud = async function() {
            const name = document.getElementById('savedProjects').value;
            if (!name) return;
            if(!confirm(`åˆªé™¤: ${name}?`)) return;
            showLoading(true);
            try { await deleteDoc(doc(db, COLLECTION_NAME, name)); document.getElementById('projName').value = ""; await window.refreshProjectList(); alert("å·²åˆªé™¤"); } catch(e) { alert("Error"); }
            showLoading(false);
        };

        window.applyConfig = function(config) {
            window.layers = config.layers || [];
            window.layers.forEach(l => { if(l.checked === undefined) l.checked = true; });
            window.dimensions = config.dimensions || [];
            if(config.settings) { document.getElementById('unitInput').value = config.settings.unit || "um"; document.getElementById('canvasWidth').value = config.settings.width || 450; document.getElementById('globalFontSize').value = config.settings.fontSize || 14; }
            window.resizeCanvas(); window.renderList(); window.draw();
        };

        window.exportCSV = function() {
            const selectedLayers = window.layers.filter(l => l.checked !== false);
            if (selectedLayers.length === 0) { alert("è«‹è‡³å°‘å‹¾é¸ä¸€å±¤ï¼"); return; }
            const unit = document.getElementById('unitInput').value || 'um';
            const name = document.getElementById('projName').value || "Stackup";
            let csv = "\uFEFFå±¤åº,åç¨±,åšåº¦,å–®ä½\n";
            let total = 0;
            selectedLayers.forEach((l, i) => {
                const safeName = (l.name || "").replace(/,/g, " ");
                const th = parseFloat(l.thickness) || 0;
                total += th;
                csv += `${i+1},${safeName},${th},${unit}\n`;
            });
            csv += `,,${total},${unit},é¸å–ç¸½åšåº¦\n`; 
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `${name}_selected.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        window.exportJSON = function() {
            const config = { layers: window.layers, dimensions: window.dimensions, settings: { unit: document.getElementById('unitInput').value, width: document.getElementById('canvasWidth').value } };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config));
            const link = document.createElement('a'); link.href = dataStr; link.download = "stack_backup.json"; link.click();
        };
        
        window.importJSON = function(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { try { const config = JSON.parse(e.target.result); window.applyConfig(config); } catch(err) { alert("æ ¼å¼éŒ¯èª¤"); } input.value = ''; };
            reader.readAsText(file);
        };

        window.newProject = function() {
            if(!confirm("æ¸…ç©ºï¼Ÿ")) return;
            window.layers = []; window.dimensions = []; window.renderList(); window.draw(); document.getElementById('projName').value = "";
        };

        // ç¹ªåœ–æ ¸å¿ƒ
        window.resizeCanvas = function() { const w = parseInt(document.getElementById('canvasWidth').value) || 450; canvas.width = w; window.draw(); };
        window.draw = function() {
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value) || 14;
            const totalThickness = window.layers.reduce((sum, l) => sum + l.thickness, 0);
            
            if (totalThickness === 0 && window.layers.length === 0) { ctx.clearRect(0, 0, canvas.width, canvas.height); return; }

            let maxOffset = 20; window.dimensions.forEach(d => { if(d.offset > maxOffset) maxOffset = d.offset; });
            const padding = { top: 40, bottom: 40, left: maxOffset + 80, right: 20 }; 
            const drawWidth = canvas.width - padding.left - padding.right;
            const availableHeight = Math.max(500, window.layers.length * 40);
            canvas.height = availableHeight + padding.top + padding.bottom;
            const scale = availableHeight / (totalThickness || 1); 
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.textAlign = "center"; ctx.textBaseline = "middle";
            let currentY = padding.top; let yPositions = [];

            window.layers.forEach((layer, idx) => {
                const h = layer.thickness * scale; 
                yPositions.push({ top: currentY, bottom: currentY + h });
                ctx.fillStyle = layer.color; ctx.fillRect(padding.left, currentY, drawWidth, h); ctx.strokeStyle = "#333"; ctx.lineWidth = 1; ctx.strokeRect(padding.left, currentY, drawWidth, h);
                if (h > 12) {
                    if (layer.textColor && layer.textColor !== '#000000') ctx.fillStyle = layer.textColor; else ctx.fillStyle = isColorDark(layer.color) ? "white" : "black";
                    const fs = layer.fontSize > 0 ? layer.fontSize : globalFS; const style = layer.fontStyle === 'bold' ? 'bold' : '';
                    ctx.font = `${style} ${fs}px "Microsoft JhengHei", Arial`; ctx.fillText(`${layer.name} ${layer.thickness}${unit}`, padding.left + drawWidth / 2, currentY + h / 2);
                }
                currentY += h;
            });
            window.dimensions.forEach((dim, idx) => {
                if (!yPositions[dim.start] || !yPositions[dim.end]) return;
                const y1 = yPositions[dim.start].top; const y2 = yPositions[dim.end].bottom; const h = y2 - y1;
                let val = 0; for(let k=dim.start; k<=dim.end; k++) val += window.layers[k].thickness;
                const txt = dim.label ? dim.label : `${val}${unit}`; const x = padding.left - dim.offset;
                ctx.strokeStyle = "#D32F2F"; ctx.fillStyle = "#D32F2F"; ctx.lineWidth = 2; ctx.font = "bold 14px Arial";
                ctx.beginPath(); ctx.moveTo(x, y1); ctx.lineTo(x, y1 + h); ctx.stroke();
                ctx.strokeStyle = "#ccc"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(x, y1); ctx.lineTo(x + 10, y1); ctx.moveTo(x, y1 + h); ctx.lineTo(x + 10, y1 + h); ctx.stroke();
                drawArrow(x, y1, "up"); drawArrow(x, y1 + h, "down");
                ctx.textAlign = "right"; ctx.fillText(txt, x - 5, y1 + h / 2);
            });
        };
        function drawArrow(x, y, dir) { ctx.beginPath(); const s = 5; if(dir==="up") { ctx.moveTo(x,y); ctx.lineTo(x-s,y+s); ctx.lineTo(x+s,y+s); } else { ctx.moveTo(x,y); ctx.lineTo(x-s,y-s); ctx.lineTo(x+s,y-s); } ctx.fill(); }
        function isColorDark(hex) { const r = parseInt(hex.substr(1, 2), 16); const g = parseInt(hex.substr(3, 2), 16); const b = parseInt(hex.substr(5, 2), 16); return ((r*299 + g*587 + b*114)/1000) < 128; }
        function cleanHex(hex) { if(!hex) return "FFFFFF"; return hex.replace('#', '').toUpperCase(); }

        window.downloadImage = function() { const link = document.createElement('a'); link.download = 'stack_diagram.png'; link.href = canvas.toDataURL(); link.click(); };
        window.downloadPPT = function() {
            let pres = new PptxGenJS();
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value) || 14;
            const totalThickness = window.layers.reduce((sum, l) => sum + l.thickness, 0);
            if (totalThickness === 0) { alert("ç„¡è³‡æ–™"); return; }
            let maxOffset = 20; window.dimensions.forEach(d => { if(d.offset > maxOffset) maxOffset = d.offset; });
            const pptPaddingLeft = maxOffset + 150; const pptPaddingTop = 50; const scaleFactor = 100; const contentWidth = canvas.width - (maxOffset + 40) - 20; 
            const availableHeightPx = Math.max(500, window.layers.length * 40); const pxToThickScale = availableHeightPx / totalThickness;
            pres.defineLayout({ name:'CUST', width: (pptPaddingLeft+contentWidth+50)/scaleFactor, height: (availableHeightPx+100)/scaleFactor }); pres.layout = 'CUST';
            let slide = pres.addSlide(); let currentYPx = pptPaddingTop;
            window.layers.forEach(layer => {
                const hPx = layer.thickness * pxToThickScale;
                const x = pptPaddingLeft / scaleFactor; const y = currentYPx / scaleFactor; const w = contentWidth / scaleFactor; const h = hPx / scaleFactor;
                const safeFillColor = cleanHex(layer.color);
                let txtColor = "000000"; if (layer.textColor && layer.textColor !== '#000000') txtColor = cleanHex(layer.textColor); else txtColor = isColorDark(layer.color) ? "FFFFFF" : "000000";
                const fs = layer.fontSize > 0 ? layer.fontSize : globalFS; const isBold = layer.fontStyle === 'bold';
                slide.addShape(pres.ShapeType.rect, { x: x, y: y, w: w, h: h, fill: { color: safeFillColor }, line: { color: "333333", width: 1 } });
                slide.addText(`${layer.name} ${layer.thickness}${unit}`, { x: x, y: y, w: w, h: h, color: txtColor, fontSize: fs, align: 'center', valign: 'middle', bold: isBold });
                currentYPx += hPx;
            });
            pres.writeFile({ fileName: "Stack_Diagram.pptx" });
        };

        window.layers = [{ name: "Demo Layer", thickness: 50, color: "#4FC3F7", checked: true }];
        if(isFirebaseReady) { window.refreshProjectList(); window.refreshUnitList(); }
        window.renderList(); window.draw();
    </script>
</body>
</html>
