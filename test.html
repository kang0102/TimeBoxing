<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ç¨‹ç–Šæ§‹åœ–ç”¢ç”Ÿå™¨ (Pro V4 - Mobile Ready)</title>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #121212; color: #ddd; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; } /* ç§»é™¤æ‰‹æ©Ÿé»æ“Šè—æ¡† */

        /* --- å´é‚Šæ¬„ (é›»è…¦ç‰ˆ) --- */
        #sidebar { 
            width: 400px; min-width: 320px; max-width: 800px; 
            background-color: #1e1e1e; padding: 15px; padding-top: 50px; 
            display: flex; flex-direction: column; gap: 10px; z-index: 10; 
            overflow-y: auto; flex-shrink: 0; border-right: 1px solid #333;
        }

        /* --- ä¸»ç•«å¸ƒå€ --- */
        #main-area { 
            flex-grow: 1; background-color: #222; 
            display: flex; justify-content: center; align-items: start;
            overflow: auto; padding: 20px; position: relative;
        }

        /* --- æ‰‹æ©Ÿç‰ˆé©é… (é—œéµä¿®æ”¹) --- */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            /* å´é‚Šæ¬„æ”¹ç‚ºæµå‹•é«˜åº¦ï¼Œä¸å†å›ºå®š */
            #sidebar { 
                width: 100% !important; max-width: 100%; height: auto; 
                max-height: none; border-right: none; border-bottom: 2px solid #444; 
                padding-top: 60px; /* ç•™çµ¦ Home æŒ‰éˆ•ç©ºé–“ */
            }
            #main-area { width: 100%; min-height: 500px; padding: 10px; display: block; text-align: center; }
            .home-btn { top: 10px; left: 10px; padding: 6px 12px; font-size: 14px; }
            
            /* åŠ å¤§æ‰‹æ©ŸæŒ‰éˆ•é«˜åº¦ï¼Œæ¯”è¼ƒå¥½æŒ‰ */
            button, select, input { height: 40px; font-size: 14px; }
            .layer-check { width: 24px; height: 24px; } 
        }

        /* --- å…ƒä»¶æ¨£å¼ --- */
        h2 { margin: 0 0 5px 0; color: #4FC3F7; font-size: 18px; }
        h3 { margin: 15px 0 5px 0; color: #bbb; font-size: 14px; border-bottom: 1px solid #444; padding-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
        
        .control-group { background: #252525; padding: 10px; border-radius: 6px; border: 1px solid #333; display: flex; flex-direction: column; gap: 5px; }
        .sub-group { background: #2f2f2f; padding: 8px; border-radius: 4px; border: 1px dashed #555; margin-bottom: 8px; }
        
        label { display: block; margin-bottom: 2px; font-size: 12px; color: #aaa; }
        input[type="text"], input[type="number"], select, textarea { background: #333; border: 1px solid #555; color: white; padding: 6px; border-radius: 4px; width: 100%; font-size: 13px; }
        textarea { resize: vertical; min-height: 40px; }

        /* å±¤æ¬¡åˆ—è¡¨ */
        #layer-list { display: flex; flex-direction: column; gap: 6px; }
        .layer-item { background: #333; border-radius: 4px; padding: 6px; border-left: 4px solid #666; font-size: 13px; transition: 0.2s; }
        .layer-item.dragging { opacity: 0.5; border: 2px dashed #4FC3F7; background: #2a2a2a; }
        .layer-main-row { display: flex; align-items: center; gap: 4px; }
        .layer-inputs { flex-grow: 1; display: grid; grid-template-columns: 1fr 0.6fr; gap: 4px; }
        .layer-details { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #555; grid-template-columns: 1fr 1fr 1fr; gap: 5px; align-items: end; }
        .layer-item.open .layer-details { display: grid; }
        
        .btn-toggle-details { cursor: pointer; color: #888; font-size: 14px; padding: 4px; border-radius: 4px; background: #2a2a2a; text-align: center; width: 30px; display:flex; justify-content:center; align-items:center;}
        .btn-toggle-details.active { background: #1976D2; color: white; }
        input[type="color"] { border: none; width: 30px; height: 30px; cursor: pointer; background: none; padding: 0; }
        .btn-icon { cursor: pointer; color: #888; font-size: 18px; padding: 5px; }
        .btn-del:hover { color: #ff5252; }
        .layer-check { width: 18px; height: 18px; cursor: pointer; margin-right: 2px; accent-color: #4CAF50; }
        .move-btns { display: flex; flex-direction: column; gap: 1px; margin-right: 2px; }
        .btn-tiny { padding: 0px 4px; font-size: 10px; height: 14px; line-height: 12px; background: #444; color: #fff; border: 1px solid #555; cursor: pointer; }
        /* æ‰‹æ©Ÿç‰ˆå¾®èª¿ç§»å‹•æŒ‰éˆ• */
        @media (max-width: 768px) {
            .btn-tiny { height: 20px; font-size: 12px; line-height: 18px; }
        }
        .dim-item { background: #2a2a2a; border: 1px solid #444; padding: 5px; margin-bottom: 4px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #bbb; }

        /* ç…§ç‰‡åˆ—è¡¨æ¨£å¼ */
        .photo-item { 
            background: #2a2a2a; border: 1px solid #444; padding: 5px; margin-top: 5px; border-radius: 4px; 
            display: flex; gap: 10px; align-items: center;
        }
        .photo-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 3px; border: 1px solid #555; flex-shrink: 0; }
        .photo-info { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .photo-desc { font-size: 13px; color: #ccc; width: 100%; background: #222; border:none; padding: 5px;}

        /* æŒ‰éˆ•ç¾¤çµ„ */
        button { padding: 8px; font-size: 13px; cursor: pointer; background-color: #444; color: white; border: 1px solid #555; border-radius: 4px; width: 100%; transition: 0.2s; margin-top: 5px; display: flex; justify-content: center; align-items: center; }
        button:hover { background-color: #666; }
        
        .btn-row { display: flex; gap: 5px; }
        .btn-save { background-color: #00897B; border-color: #00695C; flex: 1; }
        .btn-cloud-mgr { background-color: #0277BD; border-color: #01579B; flex: 1; }
        .btn-unit-save { background-color: #7B1FA2; border-color: #4A148C; width: auto; padding: 5px 10px; margin-top:0;}
        .btn-unit-add { background-color: #5E35B1; border-color: #4527A0; width: auto; padding: 5px 10px; margin-top:0;}
        .btn-ppt { background-color: #E65100; border-color: #EF6C00; }
        .btn-img { background-color: #1565C0; border-color: #0D47A1; }
        .btn-add { background-color: #2E7D32; border-color: #1B5E20; }
        .btn-backup { background-color: #455A64; border-color: #37474F; flex:1;}
        .btn-restore { background-color: #D84315; border-color: #BF360C; flex:1;}

        .home-btn { position: absolute; top: 15px; left: 15px; text-decoration: none; background: #444; padding: 6px 12px; border-radius: 20px; color: #fff; font-size: 12px; border: 1px solid #666; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); background-color: white; max-width: 100%; }

        /* --- é›²ç«¯ç®¡ç† / é è¦½ Modal (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ) --- */
        .modal-backdrop { position: fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000; display:none;}
        
        .modal { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #252525; border: 1px solid #4FC3F7; border-radius: 8px;
            padding: 15px; z-index: 2001; display: none;
            width: 900px; max-width: 95%; height: 85vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.9);
            flex-direction: column;
        }

        .modal-body { display: flex; flex: 1; gap: 15px; overflow: hidden; margin-top: 10px;}
        .modal-left { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding-right: 5px; border-right: 1px solid #444; }
        .modal-right { width: 320px; display: flex; flex-direction: column; align-items: center; padding-left: 10px; background: #1e1e1e; border-radius: 4px; flex-shrink: 0; }

        /* æ‰‹æ©Ÿç‰ˆ Modal æ¨£å¼ */
        @media (max-width: 768px) {
            .modal { width: 100%; height: 100%; border-radius: 0; border: none; padding: 10px; }
            .modal-body { flex-direction: column; } /* ä¸Šä¸‹æ’åˆ— */
            .modal-left { border-right: none; border-bottom: 1px solid #444; flex: 1; padding-bottom: 10px; }
            .modal-right { width: 100%; height: auto; padding-left: 0; padding-top: 10px; border-top: 1px solid #333; flex: 0.8; }
            #previewCanvas { max-height: 200px; width: auto; max-width: 100%; }
            .cloud-note { max-width: 150px; }
        }
        
        .cloud-list { list-style: none; padding: 0; margin: 0; }
        .cloud-item { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #333; padding: 10px; margin-bottom: 5px; border-radius: 4px; border-left: 4px solid #555; cursor: pointer;
        }
        .cloud-item.selected { border-left-color: #4FC3F7; background: #3e3e3e; }
        .cloud-info { flex: 1; margin-left: 10px;}
        .cloud-name { font-weight: bold; font-size: 15px; color: #fff; }
        .cloud-meta { font-size: 12px; color: #aaa; }
        .cloud-note { font-size: 12px; color: #81C784; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;}
        
        .batch-check { width: 20px; height: 20px; accent-color: #0277BD; cursor: pointer; }

        #preview-canvas { max-width: 100%; max-height: 300px; border: 1px solid #555; background: white; margin-bottom: 10px;}
        
        /* Loading */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); color: white; display: none;
            justify-content: center; align-items: center; z-index: 9999; flex-direction: column;
        }
        .spinner { border: 4px solid #333; border-top: 4px solid #4FC3F7; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="font-size: 18px;">é€£ç·šä¸­...</div>
    </div>

    <div class="modal-backdrop" id="mgrBackdrop" onclick="window.closeCloudManager()"></div>
    <div class="modal" id="mgrModal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; border:none; color:#4FC3F7; font-size: 1.2rem;">â˜ï¸ é›²ç«¯æª”æ¡ˆç¸½ç®¡</h3>
            <button onclick="window.closeCloudManager()" style="width:auto; margin:0; background:#c62828;">é—œé–‰</button>
        </div>
        
        <div style="margin-top: 10px; display: flex; gap: 5px; align-items:center; flex-wrap: wrap;">
             <input type="text" id="searchCloud" placeholder="æœå°‹å°ˆæ¡ˆ..." oninput="window.renderCloudList()" style="flex:1; min-width: 120px;">
             <button class="btn-small" onclick="window.refreshCloudList()" style="width:auto; margin:0; flex-grow:1;">ğŸ”„ åˆ·æ–°</button>
             <button class="btn-small" onclick="window.batchExportExcel()" style="width:auto; margin:0; background:#2E7D32; flex-grow:1;">ğŸ“‹ åŒ¯å‡º Excel</button>
        </div>
        <div style="font-size:12px; color:#aaa; margin-top:5px;">ğŸ’¡ æç¤ºï¼šå‹¾é¸æ¡†æ¡†å¯å¤šé¸åŒ¯å‡ºï¼Œé»æ“Šé …ç›®å¯é è¦½ã€‚</div>

        <div class="modal-body">
            <div class="modal-left">
                <ul class="cloud-list" id="cloudListEl"></ul>
            </div>
            <div class="modal-right">
                <h4 style="color:#fff; margin:5px 0;">é è¦½è¦–çª—</h4>
                <canvas id="previewCanvas"></canvas>
                <div id="preview-details" style="width:100%; text-align:left; color:#ccc; font-size:12px; padding:5px;">
                    è«‹é¸æ“‡å·¦å´å°ˆæ¡ˆ...
                </div>
                <div style="display:flex; gap:5px; width:100%;">
                    <button id="btn-load-preview" style="background:#EF6C00; display:none; flex:1;" onclick="window.loadSelectedToWorkspace()">ğŸ“‚ è®€å–</button>
                    <button id="btn-del-preview" style="background:#c62828; display:none; flex:1;" onclick="window.deleteSelectedCloud()">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <a href="index.html" class="home-btn">ğŸ </a>

    <div id="sidebar">
        <h2>ğŸ“š ç–Šæ§‹è³‡æ–™åº« (Pro V4)</h2>

        <div class="control-group" style="border-left: 4px solid #00897B;">
            <label style="color:#80CBC4">â˜ï¸ å°ˆæ¡ˆå­˜å– (Project)</label>
            <input type="text" id="projName" placeholder="å°ˆæ¡ˆåç¨±..." style="margin-bottom: 5px;">
            <textarea id="projNote" placeholder="åœ¨æ­¤è¼¸å…¥å‚™è¨» (Note)..."></textarea>
            
            <div class="btn-row">
                <button class="btn-save" onclick="window.saveToCloud()">ğŸ’¾ å„²å­˜</button>
                <button class="btn-cloud-mgr" onclick="window.openCloudManager()">â˜ï¸ é›²ç«¯ç®¡ç†</button>
            </div>
            
            <div class="sub-group" style="margin-top:5px; border-color:#555;">
                <label>ğŸ“¦ å‚™ä»½/é‚„åŸ</label>
                <div class="btn-row">
                    <button class="btn-backup" onclick="window.backupAllCloudData()">â¬‡ï¸ å‚™ä»½</button>
                    <button class="btn-restore" onclick="document.getElementById('restoreInput').click()">â¬†ï¸ é‚„åŸ</button>
                    <input type="file" id="restoreInput" accept=".json" onchange="window.restoreAllCloudData(this)" style="display:none">
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>å…¨åŸŸè¨­å®š</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="unitInput" value="um" placeholder="å–®ä½" oninput="window.draw()" style="flex:0.5">
                <input type="number" id="canvasWidth" value="450" placeholder="å¯¬" oninput="window.resizeCanvas()" style="flex:1">
                <input type="number" id="globalFontSize" value="14" placeholder="å­—é«”" oninput="window.draw()" style="flex:0.5">
            </div>
        </div>

        <div class="control-group" style="border-left: 4px solid #7B1FA2;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; border:none; color:#E1BEE7;">1. å±¤æ¬¡ & æ¨¡çµ„</h3>
                <label style="cursor:pointer; display:flex; align-items:center; gap:5px; margin:0;">
                    <input type="checkbox" id="selectAllBox" checked onchange="window.toggleAllLayers(this)"> å…¨é¸
                </label>
            </div>

            <div class="sub-group">
                <label style="color:#CE93D8">ğŸ§© æ¨¡çµ„å–®å…ƒ (Unit)</label>
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                    <input type="text" id="unitName" placeholder="æ¨¡çµ„åç¨±..." style="flex:1">
                    <button class="btn-unit-save" onclick="window.saveUnitToCloud()">å­˜</button>
                </div>
                <div style="display:flex; gap:5px;">
                    <select id="savedUnits" style="flex:1">
                        <option value="">-- é¸æ“‡æ¨¡çµ„ --</option>
                    </select>
                    <button class="btn-unit-add" onclick="window.insertUnit()">â•</button>
                    <button class="btn-tiny" onclick="window.deleteUnitFromCloud()" style="background:#c62828; width:30px;">ğŸ—‘ï¸</button>
                </div>
            </div>

            <button class="btn-add" onclick="window.addLayer()">â• æ–°å¢ä¸€å±¤ (Top)</button>
            <div id="layer-list"></div>
        </div>

        <div class="control-group">
            <label>2. å°ºå¯¸æ¨™è¨» (Dimension)</label>
            <div style="display:flex; gap:5px;">
                <select id="dimStart"></select> <span>è‡³</span> <select id="dimEnd"></select>
            </div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="text" id="dimLabel" placeholder="æ–‡å­—(é¸å¡«)">
                <input type="number" id="dimOffset" value="50" placeholder="åç§»">
                <button onclick="window.addDimension()" style="margin:0; width:auto;">â•</button>
            </div>
            <div id="dim-list" style="margin-top:5px;"></div>
        </div>

        <div class="control-group" style="border-left: 4px solid #FFCA28;">
            <h3 style="margin:0; border:none; color:#FFF176;">3. é™„åœ–èˆ‡èªªæ˜ (Photos)</h3>
            <div class="sub-group">
                <label style="color:#FFD54F">ğŸ“· æ‹ç…§æˆ–ä¸Šå‚³</label>
                <input type="file" id="photoInput" accept="image/*" style="margin-bottom:5px;">
                
                <input type="text" id="photoDesc" placeholder="è¼¸å…¥åœ–ç‰‡èªªæ˜ (å¦‚: SEM å‰–é¢)..." style="margin-bottom:5px;">
                <button onclick="window.addPhoto()" style="background:#FFA000; border-color:#FF6F00;">ğŸ“· åŠ å…¥é™„åœ–</button>
            </div>
            <div id="photo-list"></div>
        </div>

        <div style="margin-top: 10px; display:flex; gap:5px;">
            <button class="btn-img" onclick="window.downloadImage()">ğŸ’¾ å­˜åœ–</button>
            <button class="btn-ppt" onclick="window.downloadPPT()">ğŸ“Š å­˜ PPT</button>
            <button style="background-color: #2E7D32;" onclick="window.exportCurrentToCSV()">ğŸ“‹ Excel</button>
        </div>
    </div>

    <div id="resizer"></div>
    <div id="main-area"><canvas id="stackCanvas"></canvas></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc, writeBatch } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config (å…¬ç”¨æ¸¬è©¦ Keyï¼Œä¿è­‰å¯ç”¨)
        const firebaseConfig = {
          apiKey: "AIzaSyCnHhksuhJs9RdrL7DPnsAvR21ZND7kIOI",
          authDomain: "stack-diagram-db.firebaseapp.com",
          projectId: "stack-diagram-db",
          storageBucket: "stack-diagram-db.firebasestorage.app",
          messagingSenderId: "67240747982",
          appId: "1:67240747982:web:1fb065e40e936a7485419f",
          measurementId: "G-QJNE60W8BB"
        };

        let db = null;
        let isFirebaseReady = false;
        const COL_PROJ = "projects";
        const COL_UNITS = "units";
        let cloudProjectsCache = []; 
        let currentPreviewId = null;

        // åˆå§‹åŒ– Firebase
        if (!firebaseConfig.apiKey.includes("ä½ çš„API_KEY")) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isFirebaseReady = true;
            } catch(e) { console.error("Firebase init error", e); }
        }

        const canvas = document.getElementById('stackCanvas');
        const ctx = canvas.getContext('2d');
        const listEl = document.getElementById('layer-list');

        // è³‡æ–™è®Šæ•¸
        window.layers = [];
        window.dimensions = [];
        window.photos = []; 
        let dragSrcEl = null;

        // ---------------------------------------------
        // æ ¸å¿ƒåŠŸèƒ½ï¼šæ¸²æŸ“åˆ—è¡¨ (Render List)
        // ---------------------------------------------
        window.renderList = function() {
            listEl.innerHTML = ''; window.updateDimSelects();
            const allChecked = window.layers.every(l => l.checked !== false);
            if(document.getElementById('selectAllBox')) document.getElementById('selectAllBox').checked = allChecked;

            window.layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                item.setAttribute('draggable', 'true'); // é›»è…¦ç‰ˆæ‹–æ‹‰
                item.setAttribute('data-index', index);
                if(layer.showDetails) item.classList.add('open');
                item.style.borderLeftColor = layer.color;
                const isChecked = layer.checked !== false ? 'checked' : '';

                item.innerHTML = `
                    <div class="layer-main-row">
                        <input type="checkbox" class="layer-check" ${isChecked} onchange="window.toggleLayerCheck(${index})">
                        <div class="move-btns">
                            <button class="btn-tiny" onclick="window.moveLayer(${index}, -1)">â–²</button>
                            <button class="btn-tiny" onclick="window.moveLayer(${index}, 1)">â–¼</button>
                        </div>
                        <div class="layer-inputs">
                            <input type="text" value="${layer.name}" oninput="window.updateLayer(${index}, 'name', this.value)" placeholder="åç¨±">
                            <input type="number" value="${layer.thickness}" oninput="window.updateLayer(${index}, 'thickness', this.value)" placeholder="åšåº¦">
                        </div>
                        <input type="color" value="${layer.color}" oninput="window.updateLayer(${index}, 'color', this.value)">
                        <div class="btn-toggle-details ${layer.showDetails?'active':''}" onclick="window.toggleDetails(${index})">âš™ï¸</div>
                        <div class="btn-icon btn-del" onclick="window.deleteLayer(${index})">Ã—</div>
                    </div>
                    <div class="layer-details">
                        <div><label>é¡è‰²</label><input type="color" value="${layer.textColor||'#000000'}" oninput="window.updateLayer(${index}, 'textColor', this.value)" style="width:100%"></div>
                        <div><label>å­—é«”</label><input type="number" value="${layer.fontSize || ''}" placeholder="å…¨åŸŸ" oninput="window.updateLayer(${index}, 'fontSize', this.value)"></div>
                        <div><label>æ¨£å¼</label><select onchange="window.updateLayer(${index}, 'fontStyle', this.value)" style="padding:2px;"><option value="normal" ${layer.fontStyle==='normal'?'selected':''}>ä¸€èˆ¬</option><option value="bold" ${layer.fontStyle==='bold'?'selected':''}>ç²—é«”</option></select></div>
                    </div>
                `;
                
                // é›»è…¦ç‰ˆæ‹–æ‹‰äº‹ä»¶
                item.addEventListener('dragstart', function(e) { this.style.opacity='0.4'; dragSrcEl=this; e.dataTransfer.effectAllowed='move'; this.classList.add('dragging'); });
                item.addEventListener('dragover', function(e) { if(e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect='move'; return false; });
                item.addEventListener('drop', function(e) { 
                    if(e.stopPropagation) e.stopPropagation();
                    if(dragSrcEl !== this) {
                        const oldIdx = parseInt(dragSrcEl.getAttribute('data-index'));
                        const newIdx = parseInt(this.getAttribute('data-index'));
                        const moved = window.layers.splice(oldIdx, 1)[0];
                        window.layers.splice(newIdx, 0, moved);
                        window.renderList(); window.draw();
                    }
                    return false;
                });
                item.addEventListener('dragend', function() { this.style.opacity='1'; this.classList.remove('dragging'); });
                listEl.appendChild(item);
            });
        };

        // æ“ä½œå‡½æ•¸
        window.moveLayer = (i, d) => { const n = i+d; if(n<0||n>=window.layers.length)return; const t=window.layers[i]; window.layers[i]=window.layers[n]; window.layers[n]=t; window.renderList(); window.draw(); };
        window.toggleLayerCheck = (i) => { window.layers[i].checked = !window.layers[i].checked; window.renderList(); };
        window.toggleAllLayers = (cb) => { window.layers.forEach(l => l.checked = cb.checked); window.renderList(); };
        window.updateLayer = (i, k, v) => { if(k==='thickness'||k==='fontSize') v=parseFloat(v)||0; window.layers[i][k]=v; if(k==='color') window.renderList(); window.draw(); };
        window.toggleDetails = (i) => { window.layers[i].showDetails = !window.layers[i].showDetails; window.renderList(); };
        window.addLayer = () => { window.layers.unshift({ id: Date.now(), name: "New", thickness: 20, color: "#cccccc", fontSize: 0, fontStyle: 'bold', checked: true }); window.renderList(); window.draw(); };
        window.deleteLayer = (i) => { window.layers.splice(i, 1); window.renderList(); window.draw(); };

        // å°ºå¯¸æ¨™è¨»å‡½æ•¸
        window.updateDimSelects = () => {
            const s1=document.getElementById('dimStart'), s2=document.getElementById('dimEnd');
            const v1=s1.value, v2=s2.value; s1.innerHTML=''; s2.innerHTML='';
            window.layers.forEach((l,i) => { const o = `<option value="${i}">${i+1}. ${l.name}</option>`; s1.innerHTML+=o; s2.innerHTML+=o; });
            if(v1) s1.value=v1; if(v2) s2.value=v2; else if(window.layers.length>0) s2.value=window.layers.length-1;
        };
        window.addDimension = () => { 
            const s=parseInt(document.getElementById('dimStart').value), e=parseInt(document.getElementById('dimEnd').value);
            window.dimensions.push({ start: Math.min(s,e), end: Math.max(s,e), label: document.getElementById('dimLabel').value, offset: parseInt(document.getElementById('dimOffset').value)||50 });
            renderDims(); window.draw();
        };
        function renderDims() { 
            const dimListEl = document.getElementById('dim-list');
            dimListEl.innerHTML=''; window.dimensions.forEach((d,i) => { 
            const n1=window.layers[d.start]?.name, n2=window.layers[d.end]?.name; 
            dimListEl.innerHTML += `<div class="dim-item"><span>${n1}~${n2} (å${d.offset})</span><span class="btn-icon btn-del" onclick="window.deleteDim(${i})">Ã—</span></div>`; 
        }); }
        window.deleteDim = (i) => { window.dimensions.splice(i,1); renderDims(); window.draw(); };

        // ---------------------------------------------
        // â˜… ç…§ç‰‡è™•ç† (æ‰‹æ©Ÿæ‹ç…§/ä¸Šå‚³æ ¸å¿ƒ)
        // ---------------------------------------------
        window.addPhoto = function() {
            const input = document.getElementById('photoInput');
            const descInput = document.getElementById('photoDesc');
            
            if(input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                showLoading(true, "å£“ç¸®è™•ç†ä¸­...");
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // â˜… é—œéµï¼šåœ–ç‰‡å£“ç¸®é‚è¼¯ (æ‰‹æ©Ÿç…§ç‰‡é€šå¸¸å¾ˆå¤§ï¼Œå¿…é ˆå£“ç¸®)
                        const maxW = 600; // é™åˆ¶æœ€å¤§å¯¬åº¦ 600px
                        let w = img.width;
                        let h = img.height;
                        
                        if (w > maxW) {
                            h = Math.round(h * (maxW / w));
                            w = maxW;
                        }
                        
                        const cvs = document.createElement('canvas');
                        cvs.width = w; cvs.height = h;
                        const ctx = cvs.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        // è½‰æˆ JPEG æ ¼å¼ï¼Œå“è³ª 0.7ï¼Œå¤§å¹…æ¸›å°‘å®¹é‡
                        const compressedData = cvs.toDataURL('image/jpeg', 0.7); 

                        window.photos.push({
                            id: Date.now(),
                            data: compressedData, 
                            desc: descInput.value || "åœ–èªª",
                            w: w, h: h
                        });
                        
                        descInput.value = '';
                        input.value = ''; // é‡ç½® input ä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸åŒä¸€å¼µåœ–
                        window.renderPhotoList();
                        window.draw();
                        showLoading(false);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                alert("è«‹å…ˆé»æ“ŠæŒ‰éˆ•æ‹ç…§æˆ–é¸æ“‡åœ–ç‰‡");
            }
        };

        window.renderPhotoList = function() {
            const list = document.getElementById('photo-list');
            list.innerHTML = '';
            window.photos.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `
                    <img src="${p.data}" class="photo-thumb">
                    <div class="photo-info">
                        <input type="text" class="photo-desc" value="${p.desc}" oninput="window.updatePhotoDesc(${i}, this.value)">
                        <div class="btn-tiny" onclick="window.deletePhoto(${i})" style="text-align:center; background:#c62828; width:100%; cursor:pointer; padding:5px;">åˆªé™¤</div>
                    </div>
                `;
                list.appendChild(div);
            });
        };

        window.updatePhotoDesc = (i, v) => { window.photos[i].desc = v; window.draw(); };
        window.deletePhoto = (i) => { window.photos.splice(i, 1); window.renderPhotoList(); window.draw(); };

        // ---------------------------------------------
        // â˜… é›²ç«¯ç®¡ç† (æ”¯æ´æ‰‹æ©Ÿç‰ˆä»‹é¢)
        // ---------------------------------------------
        window.openCloudManager = function() {
            if(!isFirebaseReady) { alert("å°šæœªé€£ç·š"); return; }
            document.getElementById('mgrModal').style.display = 'flex'; 
            document.getElementById('mgrBackdrop').style.display = 'block';
            window.refreshCloudList();
        };
        window.closeCloudManager = function() {
            document.getElementById('mgrModal').style.display = 'none';
            document.getElementById('mgrBackdrop').style.display = 'none';
        };

        window.refreshCloudList = async function() {
            showLoading(true, "è®€å–é›²ç«¯...");
            try {
                const q = await getDocs(collection(db, COL_PROJ));
                cloudProjectsCache = [];
                q.forEach(doc => cloudProjectsCache.push({ id: doc.id, ...doc.data() }));
                // æ’åºï¼šæœ€æ–°çš„åœ¨ä¸Šé¢
                cloudProjectsCache.sort((a,b) => b.timestamp - a.timestamp);
                window.renderCloudList();
            } catch(e) { console.error(e); }
            showLoading(false);
        };

        window.renderCloudList = function() {
            const listEl = document.getElementById('cloudListEl');
            const search = document.getElementById('searchCloud').value.toLowerCase();
            listEl.innerHTML = '';

            cloudProjectsCache.forEach(p => {
                if(search && !p.id.toLowerCase().includes(search)) return;
                
                const note = p.note ? p.note : 'ç„¡å‚™è¨»';
                const date = new Date(p.timestamp || 0).toLocaleDateString();
                
                const li = document.createElement('li');
                li.className = 'cloud-item';
                li.onclick = (e) => { 
                    if(e.target.type !== 'checkbox') window.selectCloudItem(p.id); 
                };
                li.innerHTML = `
                    <input type="checkbox" class="batch-check" value="${p.id}">
                    <div class="cloud-info">
                        <div class="cloud-name">${p.id}</div>
                        <div class="cloud-meta">${date}</div>
                        <div class="cloud-note">${note}</div>
                    </div>
                `;
                listEl.appendChild(li);
            });
        };

        window.selectCloudItem = function(id) {
            currentPreviewId = id;
            document.querySelectorAll('.cloud-item').forEach(el => el.classList.remove('selected'));
            const inputs = document.querySelectorAll('.batch-check');
            inputs.forEach(inp => {
                if(inp.value === id) inp.closest('.cloud-item').classList.add('selected');
            });
            
            const p = cloudProjectsCache.find(x => x.id === id);
            const detailEl = document.getElementById('preview-details');
            if(p) {
                detailEl.innerHTML = `
                    <strong>å°ˆæ¡ˆ:</strong> ${p.id}<br>
                    <strong>å±¤æ•¸:</strong> ${p.layers?.length || 0} | 
                    <strong>é™„åœ–:</strong> ${p.photos?.length || 0} å¼µ<br>
                    <div style="font-size:11px; color:#888;">${new Date(p.timestamp).toLocaleString()}</div>
                    <div style="color:#81C784;">${p.note || ''}</div>
                `;
                window.drawPreviewCanvas(p.layers);
                document.getElementById('btn-load-preview').style.display = 'block';
                document.getElementById('btn-del-preview').style.display = 'block';
            }
        };

        // é è¦½å°åœ–ç¹ªè£½
        window.drawPreviewCanvas = function(layers) {
            const cvs = document.getElementById('previewCanvas');
            const ctx = cvs.getContext('2d');
            cvs.width = 300; cvs.height = 200; // èª¿æ•´é«˜åº¦é©åˆæ‰‹æ©Ÿ
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,300,200);

            if(!layers || layers.length === 0) return;

            const totalThick = layers.reduce((s,l) => s+(parseFloat(l.thickness)||0),0) || 1;
            const scale = 160 / totalThick; // ç¸®å°æ¯”ä¾‹
            const cx = 150; const rw = 100; let cy = 20;

            layers.forEach(l => {
                const h = (parseFloat(l.thickness)||0) * scale;
                ctx.fillStyle = l.color || "#ccc"; ctx.fillRect(cx - rw/2, cy, rw, h);
                ctx.strokeStyle = "#333"; ctx.strokeRect(cx - rw/2, cy, rw, h);
                cy += h;
            });
        };

        window.loadSelectedToWorkspace = function() {
            if(!currentPreviewId) return;
            const p = cloudProjectsCache.find(x => x.id === currentPreviewId);
            if(p) {
                window.applyConfig(p);
                document.getElementById('projName').value = p.id;
                document.getElementById('projNote').value = p.note || "";
                window.closeCloudManager();
            }
        };

        window.deleteSelectedCloud = async function() {
            if(!currentPreviewId) return;
            if(!confirm(`ç¢ºå®šåˆªé™¤ ${currentPreviewId}?`)) return;
            showLoading(true);
            try { await deleteDoc(doc(db, COL_PROJ, currentPreviewId)); await window.refreshCloudList(); currentPreviewId=null;} catch(e) {}
            showLoading(false);
        };

        // Excel åŒ¯å‡º
        window.batchExportExcel = function() {
            const checks = document.querySelectorAll('.batch-check:checked');
            if(checks.length === 0) { alert("è«‹å…ˆå‹¾é¸é …ç›®"); return; }
            
            let csv = "\uFEFF"; 
            checks.forEach(chk => {
                const id = chk.value;
                const p = cloudProjectsCache.find(x => x.id === id);
                if(p) {
                    csv += `å°ˆæ¡ˆ: ${p.id}\nå‚™è¨»: ${(p.note||"").replace(/\n/g," ")}\n`;
                    csv += `å±¤åº,åç¨±,åšåº¦\n`;
                    const layers = p.layers || [];
                    layers.forEach((l,i) => {
                          if(l.checked === false) return; 
                          csv += `${i+1},${(l.name||"").replace(/,/g," ")},${l.thickness}\n`;
                    });
                    csv += `\n`; 
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Stackups_${Date.now()}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        // ---------------------------------------------
        // è³‡æ–™å‚™ä»½ / é‚„åŸ
        // ---------------------------------------------
        window.backupAllCloudData = async function() {
            if(!isFirebaseReady) { alert("æœªé€£ç·š"); return; }
            showLoading(true, "æ‰“åŒ…ä¸­...");
            try {
                const projSnap = await getDocs(collection(db, COL_PROJ));
                const projects = {}; projSnap.forEach(d => projects[d.id] = d.data());
                const unitSnap = await getDocs(collection(db, COL_UNITS));
                const units = {}; unitSnap.forEach(d => units[d.id] = d.data());

                const str = JSON.stringify({ version: "V4", timestamp: Date.now(), projects, units }, null, 2);
                const blob = new Blob([str], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `BACKUP_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            } catch(e) { console.error(e); alert("å‚™ä»½å¤±æ•—"); }
            showLoading(false);
        };

        window.restoreAllCloudData = function(input) {
            const file = input.files[0]; if(!file) return;
            if(!confirm("âš ï¸ è­¦å‘Šï¼šé‚„åŸå°‡è¦†è“‹é›²ç«¯ç¾æœ‰åŒåè³‡æ–™ã€‚\nç¢ºå®šåŸ·è¡Œï¼Ÿ")) { input.value = ''; return; }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                showLoading(true, "é‚„åŸä¸­...");
                try {
                    const data = JSON.parse(e.target.result);
                    const batch = writeBatch(db);
                    let count = 0;
                    if(data.projects) for(const [id,v] of Object.entries(data.projects)) { batch.set(doc(db,COL_PROJ,id),v); count++; }
                    if(data.units) for(const [id,v] of Object.entries(data.units)) { batch.set(doc(db,COL_UNITS,id),v); count++; }
                    await batch.commit();
                    alert(`æˆåŠŸé‚„åŸ ${count} ç­†è³‡æ–™ã€‚`);
                    window.refreshUnitList();
                } catch(err) { alert("é‚„åŸå¤±æ•—"); }
                showLoading(false);
                input.value = '';
            };
            reader.readAsText(file);
        };

        // ---------------------------------------------
        // é€šç”¨åŠŸèƒ½
        // ---------------------------------------------
        function showLoading(show, text="è™•ç†ä¸­") {
            const ov = document.getElementById('loading-overlay');
            if(show) { document.getElementById('loading-text').innerText=text; ov.style.display='flex'; } else ov.style.display='none';
        }

        window.saveToCloud = async function() {
            if(!isFirebaseReady) return alert("æœªé€£ç·š");
            const name = document.getElementById('projName').value.trim();
            if(!name) return alert("è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±");
            
            const data = {
                layers: window.layers,
                dimensions: window.dimensions,
                photos: window.photos,
                settings: { unit: document.getElementById('unitInput').value, width: document.getElementById('canvasWidth').value },
                note: document.getElementById('projNote').value,
                timestamp: Date.now()
            };
            
            // æª¢æŸ¥å¤§å° (Firestore 1MB é™åˆ¶)
            const size = new Blob([JSON.stringify(data)]).size;
            if(size > 950000) if(!confirm(`âš ï¸ å°ˆæ¡ˆéå¤§ (${Math.round(size/1024)}KB)ã€‚\nå»ºè­°æ¸›å°‘ç…§ç‰‡æ•¸é‡ã€‚ç¢ºå®šå„²å­˜ï¼Ÿ`)) return;

            showLoading(true);
            try { await setDoc(doc(db, COL_PROJ, name), data); alert("å„²å­˜æˆåŠŸ"); } catch(e) { alert("å„²å­˜å¤±æ•— (å¯èƒ½æ˜¯ç…§ç‰‡éå¤§)"); }
            showLoading(false);
        };

        window.saveUnitToCloud = async function() {
            const name = document.getElementById('unitName').value.trim();
            const sel = window.layers.filter(l => l.checked!==false);
            if(!name || sel.length===0) return alert("è«‹è¼¸å…¥åç¨±ä¸¦å‹¾é¸å±¤æ¬¡");
            showLoading(true);
            try { await setDoc(doc(db, COL_UNITS, name), { layers: sel, timestamp: Date.now() }); alert("å·²å­˜"); window.refreshUnitList(); } catch(e) {}
            showLoading(false);
        };

        window.refreshUnitList = async function() {
            if(!isFirebaseReady) return;
            const s = document.getElementById('savedUnits');
            try {
                const q = await getDocs(collection(db, COL_UNITS));
                s.innerHTML = '<option value="">-- é¸æ“‡æ¨¡çµ„ --</option>';
                q.forEach(d => { const opt = document.createElement('option'); opt.value=d.id; opt.innerText=d.id; s.appendChild(opt); });
            } catch(e) {}
        };

        window.insertUnit = async function() {
            const n = document.getElementById('savedUnits').value;
            if(!n) return;
            showLoading(true);
            try {
                const d = await getDoc(doc(db, COL_UNITS, n));
                if(d.exists()) {
                    const ul = d.data().layers.map(l => ({...l, id:Date.now()+Math.random(), checked:true}));
                    window.layers = [...ul, ...window.layers];
                    window.renderList(); window.draw();
                }
            } catch(e) {}
            showLoading(false);
        };
        
        window.deleteUnitFromCloud = async function() {
            const n = document.getElementById('savedUnits').value;
            if(n && confirm(`åˆªé™¤æ¨¡çµ„ ${n}?`)) { await deleteDoc(doc(db, COL_UNITS, n)); window.refreshUnitList(); }
        };

        window.exportCurrentToCSV = function() {
            const sel = window.layers.filter(l => l.checked!==false);
            if(sel.length===0) return alert("ç„¡é¸å–å±¤");
            const name = document.getElementById('projName').value || "Stackup";
            const unit = document.getElementById('unitInput').value;
            
            let csv = "\uFEFFå±¤åº,åç¨±,åšåº¦,å–®ä½\n";
            let t=0;
            sel.forEach((l,i) => {
                t += (parseFloat(l.thickness)||0);
                csv += `${i+1},${(l.name||"").replace(/,/g," ")},${l.thickness},${unit}\n`;
            });
            csv += `,,${t},${unit},ç¸½åšåº¦\n`;
            const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
            const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`${name}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        window.applyConfig = (c) => { 
            window.layers=c.layers||[]; window.dimensions=c.dimensions||[]; window.photos=c.photos||[];
            if(c.settings) { document.getElementById('unitInput').value=c.settings.unit||"um"; document.getElementById('canvasWidth').value=c.settings.width||450; }
            window.renderList(); window.renderPhotoList(); window.draw();
        };
        window.downloadImage = () => { const a=document.createElement('a'); a.download='stack.png'; a.href=canvas.toDataURL(); a.click(); };
        
        // PPT è¼¸å‡º (å«åœ–ç‰‡)
        window.downloadPPT = () => {
             let pres = new PptxGenJS();
             const unit = document.getElementById('unitInput').value;
             const totalThick = window.layers.reduce((s,l)=>s+(parseFloat(l.thickness)||0),0);
             if(totalThick===0 && window.layers.length===0) return alert("ç„¡è³‡æ–™");
             
             let maxOff=20; window.dimensions.forEach(d=> {if(d.offset>maxOff)maxOff=d.offset;});
             const pl=maxOff+150, pt=50, sf=100, cw=canvas.width-(maxOff+40)-20;
             const ah = Math.max(500, window.layers.length*40);
             const sc = ah/(totalThick||1);
             
             pres.defineLayout({name:'C',width:(pl+cw+50)/sf,height:(ah+100)/sf}); pres.layout='C';
             
             let s = pres.addSlide(); let cy=pt;
             
             // ç•«ç–Šæ§‹
             window.layers.forEach(l => {
                 const h = l.thickness*sc;
                 const fc = l.color.replace('#','');
                 const tc = isColorDark(l.color)?'FFFFFF':'000000';
                 s.addShape(pres.ShapeType.rect, {x:pl/sf, y:cy/sf, w:cw/sf, h:h/sf, fill:fc, line:'333333'});
                 s.addText(`${l.name} ${l.thickness}${unit}`, {x:pl/sf, y:cy/sf, w:cw/sf, h:h/sf, color:tc, fontSize:l.fontSize||14, align:'center', valign:'middle'});
                 cy+=h;
             });

             // é™„åœ– (æ¯å¼µåœ–ä¸€é ï¼Œé¿å…æ’ç‰ˆæ··äº‚)
             window.photos.forEach(p => {
                 let ps = pres.addSlide();
                 ps.addText("é™„åœ–: " + p.desc, { x:0.5, y:0.5, fontSize:16, color:'333333' });
                 // PPT åœ–ç‰‡å¤§å°è‡ªå‹•ç¸®æ”¾
                 ps.addImage({ data:p.data, x:0.5, y:1.5, w:8, h:4.5, sizing:{type:'contain', w:8, h:4.5} });
             });

             pres.writeFile({fileName:"Stack_Report.pptx"});
        };
        
        function isColorDark(hex) { const r=parseInt(hex.substr(1,2),16),g=parseInt(hex.substr(3,2),16),b=parseInt(hex.substr(5,2),16); return ((r*299+g*587+b*114)/1000)<128; }
        window.resizeCanvas = () => { canvas.width=parseInt(document.getElementById('canvasWidth').value)||450; window.draw(); };
        function drawArrow(ctx,x,y,u) { ctx.beginPath(); const s=5; if(u){ctx.moveTo(x,y);ctx.lineTo(x-s,y+s);ctx.lineTo(x+s,y+s);}else{ctx.moveTo(x,y);ctx.lineTo(x-s,y-s);ctx.lineTo(x+s,y-s);} ctx.fill(); }

        // ---------------------------------------------
        // â˜… æœ€çµ‚ç¹ªåœ–é‚è¼¯ (æ•´åˆç–Šæ§‹ + å°ºå¯¸ + ç…§ç‰‡)
        // ---------------------------------------------
        window.draw = () => {
            const unit = document.getElementById('unitInput').value;
            const globalFS = parseInt(document.getElementById('globalFontSize').value)||14;
            const totalThick = window.layers.reduce((s,l)=>s+(parseFloat(l.thickness)||0),0);
            
            if(totalThick===0 && window.layers.length===0 && window.photos.length===0) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
            
            let maxOff = 20; window.dimensions.forEach(d => { if(d.offset>maxOff) maxOff=d.offset; });
            const pad = { t:40, b:40, l: maxOff+80, r:20 };
            const dw = canvas.width - pad.l - pad.r;
            const stackH = Math.max(500, window.layers.length*40);
            
            // è¨ˆç®—ç…§ç‰‡å€é«˜åº¦
            let photoTotalH = 0;
            window.photos.forEach(p => {
                const displayH = (dw / p.w) * p.h; // ç¶­æŒå¯¬é«˜æ¯”
                photoTotalH += displayH + 40; // 40px æ˜¯æ–‡å­—èˆ‡é–“è·
            });

            // è¨­å®šç•«å¸ƒç¸½é«˜åº¦
            canvas.height = stackH + pad.t + pad.b + (photoTotalH > 0 ? photoTotalH + 50 : 0);
            const scale = stackH / (totalThick||1);
            
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.textAlign="center"; ctx.textBaseline="middle";
            
            // 1. ç•«ç–Šæ§‹
            let cy = pad.t;
            let yPos = [];
            window.layers.forEach(l => {
                const h = (parseFloat(l.thickness)||0)*scale;
                yPos.push({t:cy, b:cy+h});
                ctx.fillStyle = l.color; ctx.fillRect(pad.l, cy, dw, h);
                ctx.strokeStyle="#333"; ctx.strokeRect(pad.l, cy, dw, h);
                if(h>12) {
                     ctx.fillStyle = isColorDark(l.color)?"white":"black"; if(l.textColor) ctx.fillStyle=l.textColor;
                     const fs = l.fontSize||globalFS; const st = l.fontStyle==='bold'?'bold':'';
                     ctx.font = `${st} ${fs}px Arial`; ctx.fillText(`${l.name} ${l.thickness}${unit}`, pad.l+dw/2, cy+h/2);
                }
                cy += h;
            });

            // 2. ç•«å°ºå¯¸
            window.dimensions.forEach(d => {
                if(!yPos[d.start] || !yPos[d.end]) return;
                const y1=yPos[d.start].t, y2=yPos[d.end].b, h=y2-y1, x=pad.l-d.offset;
                ctx.strokeStyle="#D32F2F"; ctx.fillStyle="#D32F2F"; ctx.lineWidth=2; ctx.font="bold 14px Arial";
                ctx.beginPath(); ctx.moveTo(x,y1); ctx.lineTo(x,y1+h); ctx.stroke();
                ctx.strokeStyle="#ccc"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x,y1); ctx.lineTo(x+10,y1); ctx.moveTo(x,y1+h); ctx.lineTo(x+10,y1+h); ctx.stroke();
                drawArrow(ctx,x,y1,1); drawArrow(ctx,x,y1+h,0);
                const txt = d.label || `${window.layers.slice(d.start,d.end+1).reduce((s,l)=>s+(parseFloat(l.thickness)||0),0)}${unit}`;
                ctx.textAlign="right"; ctx.fillText(txt, x-5, y1+h/2);
            });

            // 3. ç•«ç…§ç‰‡ (å¦‚æœæœ‰çš„è©±)
            if(window.photos.length > 0) {
                let py = cy + 60; // åœ¨ç–Šæ§‹åœ–ä¸‹æ–¹ 60px é–‹å§‹
                
                // åˆ†éš”ç·š
                ctx.strokeStyle="#555"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(20, py-30); ctx.lineTo(canvas.width-20, py-30); ctx.stroke();

                window.photos.forEach(p => {
                     // â˜… ä¿®æ”¹é‡é»ï¼šæª¢æŸ¥æ˜¯å¦æœ‰ã€Œå¿«å–ã€çš„åœ–ç‰‡ç‰©ä»¶ï¼Œæ²’æœ‰æ‰å»ºç«‹
                     if (!p.imgElement) {
                         p.imgElement = new Image();
                         // ç•¶åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œï¼Œè‡ªå‹•å†å‘¼å«ä¸€æ¬¡ draw() é‡ç•«
                         p.imgElement.onload = () => window.draw();
                         p.imgElement.src = p.data;
                     }

                     const displayH = (dw / p.w) * p.h;
                     
                     // åªæœ‰ç•¶åœ–ç‰‡ã€Œå®Œå…¨æº–å‚™å¥½ (complete)ã€æ™‚æ‰ç•«
                     if (p.imgElement.complete) {
                         ctx.drawImage(p.imgElement, pad.l, py, dw, displayH);
                         ctx.strokeStyle="#666"; ctx.lineWidth=1; ctx.strokeRect(pad.l, py, dw, displayH);
                         
                         // ç•«èªªæ˜æ–‡å­—
                         ctx.fillStyle="#000"; ctx.textAlign="left"; ctx.font="14px Arial";
                         ctx.fillText("â–² " + p.desc, pad.l, py + displayH + 20);
                     }
                     
                     py += displayH + 50;
                });
            }
        };

        // å•Ÿå‹•
        if(isFirebaseReady) { window.refreshUnitList(); }
        window.layers = [{name:"åŸºæ¿",thickness:100,color:"#90CAF9",checked:true}];
        window.renderList(); window.resizeCanvas();

    </script>
</body>
</html>
