<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è† é«”åˆ†æå·¥å…·ç®± (Webç‰ˆ)</title>
    <style>
        /* --- æ¨£å¼è¨­å®š (CSS) --- */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #1e1e1e;
            color: #ddd;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦å´å·¥å…·æ¬„ */
        #sidebar {
            width: 250px;
            background-color: #2b2b2b;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
        }

        /* å³å´ç•«å¸ƒå€ */
        #main-area {
            flex-grow: 1;
            position: relative;
            background-color: #333;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        h2 { margin: 0 0 15px 0; color: #4FC3F7; font-size: 18px; }
        
        button {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            background-color: #444;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            transition: 0.2s;
            text-align: left;
        }
        button:hover { background-color: #666; }
        button.active { background-color: #007bff; border-color: #007bff; }
        
        .separator { height: 1px; background: #555; margin: 5px 0; }
        
        input[type="range"] { width: 100%; }
        
        .info-box {
            background: #111;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #00ff00;
        }

        /* ç•«å¸ƒæ¨£å¼ */
        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            cursor: crosshair;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>è† é«”åˆ†æå·¥å…·ç®± Web</h2>
        
        <button onclick="document.getElementById('fileInput').click()">ğŸ“‚ è¼‰å…¥åœ–ç‰‡</button>
        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="loadImage(this)">
        
        <div class="separator"></div>
        
        <button id="btnRect" onclick="setTool('rect')">â¬œ çŸ©å½¢é¸å–</button>
        <button id="btnPoly" onclick="setTool('poly')">â¬¡ å¤šé‚Šå½¢ (é»æ“Šå¤šé»)</button>
        <button onclick="resetROI()">ğŸ”„ æ¸…é™¤é¸å–</button>
        
        <div class="separator"></div>
        
        <label>é–¾å€¼ (æ¨¡æ“¬ OTSU): <span id="threshVal">128</span></label>
        <input type="range" id="thresholdSlider" min="0" max="255" value="128" oninput="updateThreshold(this.value)">
        
        <button onclick="calculateArea()" style="background-color: #43A047;">â–¶ é–‹å§‹è¨ˆç®—é¢ç©</button>
        
        <div class="info-box" id="resultBox">
            ç­‰å¾…è¨ˆç®—...
        </div>
    </div>

    <div id="main-area">
        <canvas id="imageCanvas"></canvas>
    </div>

    <script>
        // --- ç¨‹å¼é‚è¼¯ (JavaScript) ---
        
        let canvas = document.getElementById('imageCanvas');
        let ctx = canvas.getContext('2d');
        let img = new Image();
        
        // ç‹€æ…‹è®Šæ•¸
        let currentTool = 'rect'; // rect, poly
        let isDrawing = false;
        let startX, startY;
        let polyPoints = [];
        let roiMask = null; // ç”¨ä¾†å­˜å„²é¸å–å€åŸŸ
        let threshold = 128;

        // åˆå§‹åŒ–
        canvas.width = 800;
        canvas.height = 600;
        ctx.fillStyle = "#555";
        ctx.font = "20px Arial";
        ctx.fillText("è«‹å¾å·¦å´è¼‰å…¥åœ–ç‰‡", 320, 300);

        // 1. è¼‰å…¥åœ–ç‰‡
        function loadImage(input) {
            if (input.files && input.files[0]) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        resetROI();
                        draw();
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 2. è¨­å®šå·¥å…·
        function setTool(tool) {
            currentTool = tool;
            document.getElementById('btnRect').classList.toggle('active', tool === 'rect');
            document.getElementById('btnPoly').classList.toggle('active', tool === 'poly');
            // é‡ç½®å¤šé‚Šå½¢ç‹€æ…‹
            if(tool === 'rect') polyPoints = [];
        }

        function resetROI() {
            polyPoints = [];
            roiMask = null;
            draw();
            document.getElementById('resultBox').innerText = "å€åŸŸå·²é‡ç½®";
        }

        function updateThreshold(val) {
            threshold = parseInt(val);
            document.getElementById('threshVal').innerText = val;
            // å¦‚æœå·²ç¶“æœ‰é¸å€ï¼Œå³æ™‚é è¦½æ•ˆæœå¯ä»¥åœ¨é€™è£¡åšï¼ˆç¨å¾®è¤‡é›œï¼Œå…ˆç•¥éï¼‰
        }

        // 3. ç¹ªåœ–èˆ‡æ»‘é¼ äº‹ä»¶
        function draw() {
            // æ¸…ç©ºç•«é¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ç•«åº•åœ–
            if (img.src) ctx.drawImage(img, 0, 0);

            // ç•«ç›®å‰çš„ ROI
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';

            if (currentTool === 'poly' && polyPoints.length > 0) {
                ctx.beginPath();
                ctx.moveTo(polyPoints[0].x, polyPoints[0].y);
                for (let i = 1; i < polyPoints.length; i++) {
                    ctx.lineTo(polyPoints[i].x, polyPoints[i].y);
                }
                if (isDrawing && currentTool === 'poly') {
                   // é è¦½ç·š
                } else if (roiMask && currentTool === 'poly') {
                    ctx.closePath();
                    ctx.stroke();
                    ctx.fill();
                }
                ctx.stroke();
            } else if (roiMask && currentTool === 'rect') {
                ctx.strokeRect(roiMask.x, roiMask.y, roiMask.w, roiMask.h);
                ctx.fillRect(roiMask.x, roiMask.y, roiMask.w, roiMask.h);
            }
        }

        // æ»‘é¼ ç›£è½
        canvas.addEventListener('mousedown', e => {
            if (!img.src) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (currentTool === 'rect') {
                isDrawing = true;
                startX = x;
                startY = y;
            } else if (currentTool === 'poly') {
                polyPoints.push({x, y});
                draw();
            }
        });

        canvas.addEventListener('mousemove', e => {
            if (!img.src) return;
            if (currentTool === 'rect' && isDrawing) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                draw(); // é‡ç¹ªåœ–
                // ç•«æ‹–æ›³ä¸­çš„æ¡†
                ctx.strokeStyle = '#00ff00';
                ctx.strokeRect(startX, startY, x - startX, y - startY);
            }
        });

        canvas.addEventListener('mouseup', e => {
            if (currentTool === 'rect' && isDrawing) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                isDrawing = false;
                // å„²å­˜çŸ©å½¢å€åŸŸ
                roiMask = { x: Math.min(startX, x), y: Math.min(startY, y), w: Math.abs(x - startX), h: Math.abs(y - startY) };
                draw();
            }
        });
        
        // å¤šé‚Šå½¢é›™æ“ŠçµæŸ
        canvas.addEventListener('dblclick', e => {
            if (currentTool === 'poly') {
                roiMask = true; // æ¨™è¨˜å®Œæˆ
                // é–‰åˆè·¯å¾‘
                draw();
                // é‡æ–°ç•«é–‰åˆ
                ctx.beginPath();
                ctx.moveTo(polyPoints[0].x, polyPoints[0].y);
                for (let i = 1; i < polyPoints.length; i++) {
                    ctx.lineTo(polyPoints[i].x, polyPoints[i].y);
                }
                ctx.closePath();
                ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
                ctx.fill();
                ctx.stroke();
            }
        });

        // 4. è¨ˆç®—é¢ç©é‚è¼¯ (æ¨¡æ“¬ cv2.threshold + mask)
        function calculateArea() {
            if (!img.src || !roiMask) {
                alert("è«‹å…ˆè¼‰å…¥åœ–ç‰‡ä¸¦é¸å–å€åŸŸ");
                return;
            }

            // å–å¾—ç•«å¸ƒåƒç´ æ•¸æ“š
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let gluePixels = 0;
            let totalRoiPixels = 0;

            // å»ºç«‹ä¸€å€‹è‡¨æ™‚ Canvas ä¾†ç•« Maskï¼Œç”¨æ–¼åˆ¤æ–·åƒç´ æ˜¯å¦åœ¨ ROI å…§
            const maskCanvas = document.createElement('canvas');
            maskCanvas.width = canvas.width;
            maskCanvas.height = canvas.height;
            const maskCtx = maskCanvas.getContext('2d');
            
            maskCtx.fillStyle = 'white';
            maskCtx.beginPath();
            if (currentTool === 'rect') {
                maskCtx.rect(roiMask.x, roiMask.y, roiMask.w, roiMask.h);
            } else {
                if(polyPoints.length < 3) return;
                maskCtx.moveTo(polyPoints[0].x, polyPoints[0].y);
                for (let i = 1; i < polyPoints.length; i++) {
                    maskCtx.lineTo(polyPoints[i].x, polyPoints[i].y);
                }
                maskCtx.closePath();
            }
            maskCtx.fill();
            
            const maskData = maskCtx.getImageData(0, 0, canvas.width, canvas.height).data;

            // éæ­·æ‰€æœ‰åƒç´ 
            for (let i = 0; i < data.length; i += 4) {
                // Alpha é€šé“åœ¨ maskData[i+3]
                // æª¢æŸ¥æ˜¯å¦åœ¨ ROI é®ç½©å…§ (Alpha > 0)
                if (maskData[i+3] > 0) {
                    totalRoiPixels++;
                    
                    // ç°éšåŒ– (ç°¡å–®å¹³å‡)
                    const r = data[i];
                    const g = data[i+1];
                    const b = data[i+2];
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;

                    // é–¾å€¼åˆ¤æ–· (æ¨¡æ“¬ threshold)
                    // å‡è¨­è† é«”æ˜¯æ·±è‰² (å°æ–¼é–¾å€¼)ï¼Œå¦‚æœæ˜¯äº®è‰²è† é«”è«‹æ”¹ç‚º gray > threshold
                    // é€™è£¡é è¨­è† é«”æ˜¯ "é»‘è‰²/æ·±è‰²"
                    if (gray < threshold) {
                        gluePixels++;
                        // æ¨™è¨˜åµæ¸¬åˆ°çš„éƒ¨åˆ†ç‚ºé»ƒè‰² (è¦–è¦ºåŒ–)
                        data[i] = 255;   // R
                        data[i+1] = 255; // G
                        data[i+2] = 0;   // B
                    }
                }
            }
            
            // å°‡æ¨™è¨˜å¾Œçš„çµæœç•«å›å»
            ctx.putImageData(imageData, 0, 0);

            // é¡¯ç¤ºçµæœ
            document.getElementById('resultBox').innerHTML = 
                `ROI é¢ç©: ${totalRoiPixels} px<br>` +
                `è† é«”é¢ç©: ${gluePixels} px<br>` +
                `ä½”æ¯”: ${((gluePixels/totalRoiPixels)*100).toFixed(2)}%`;
        }

    </script>
</body>
</html>
