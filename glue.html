<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è† é«”åˆ†æå·¥å…·ç®± (Webç‰ˆ)</title>
    <style>
        /* --- æ¨£å¼è¨­å®š (CSS) --- */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #1e1e1e;
            color: #ddd;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦å´å·¥å…·æ¬„ */
        #sidebar {
            width: 260px;
            background-color: #2b2b2b;
            padding: 15px;
            padding-top: 60px; /* é ç•™ç©ºé–“çµ¦å›é¦–é æŒ‰éˆ• */
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            z-index: 10;
        }

        /* å³å´ç•«å¸ƒå€ */
        #main-area {
            flex-grow: 1;
            position: relative;
            background-color: #333;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        h2 { margin: 0 0 15px 0; color: #4FC3F7; font-size: 18px; }
        
        button {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            background-color: #444;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            transition: 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button:hover { background-color: #666; }
        button.active { background-color: #007bff; border-color: #007bff; }
        
        .separator { height: 1px; background: #555; margin: 5px 0; }
        
        input[type="range"] { width: 100%; margin: 10px 0; }
        
        .info-box {
            background: #111;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #00ff00;
            line-height: 1.6;
            margin-top: auto;
        }

        /* å›é¦–é æŒ‰éˆ•æ¨£å¼ */
        .home-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            text-decoration: none;
            background: #444;
            padding: 8px 15px;
            border-radius: 20px;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid #666;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .home-btn:hover { background: #666; }

        /* ç•«å¸ƒæ¨£å¼ */
        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            cursor: crosshair;
            max-width: 100%;
            max-height: 100%;
        }
    </style>
</head>
<body>

    <a href="index.html" class="home-btn">ğŸ  å›é¦–é </a>

    <div id="sidebar">
        <h2>ğŸ§© è† é«”åˆ†æå·¥å…·</h2>
        
        <button onclick="document.getElementById('fileInput').click()">ğŸ“‚ è¼‰å…¥åœ–ç‰‡</button>
        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="loadImage(this)">
        
        <div class="separator"></div>
        
        <button id="btnRect" onclick="setTool('rect')" class="active">â¬œ çŸ©å½¢é¸å–</button>
        <button id="btnPoly" onclick="setTool('poly')">â¬¡ å¤šé‚Šå½¢ (é€£é»)</button>
        <button onclick="resetROI()">ğŸ”„ æ¸…é™¤é¸å–</button>
        
        <div class="separator"></div>
        
        <label>é–¾å€¼ (æ·±è‰²éæ¿¾): <span id="threshVal">128</span></label>
        <input type="range" id="thresholdSlider" min="0" max="255" value="128" oninput="updateThreshold(this.value)">
        <div style="font-size: 12px; color: #888;">èª¿æ•´æ»‘æ¡¿ä»¥æ”¹è®Šè­˜åˆ¥æ•æ„Ÿåº¦</div>

        <div class="separator"></div>

        <button onclick="calculateArea()" style="background-color: #43A047; border-color: #2E7D32; justify-content: center;">
            â–¶ é–‹å§‹è¨ˆç®—é¢ç©
        </button>

        <div class="separator"></div>
        <button onclick="saveAnalysis()" style="background-color: #1976D2; border-color: #1565C0;">
            ğŸ’¾ å„²å­˜åˆ†æçµæœ
        </button>    
        
        <div class="info-box" id="resultBox">
            ç­‰å¾…è¨ˆç®—...<br>
            è«‹è¼‰å…¥åœ–ç‰‡ä¸¦é¸å–ç¯„åœã€‚
        </div>
    </div>

    <div id="main-area">
        <canvas id="imageCanvas"></canvas>
    </div>

    <script>
        // --- ç¨‹å¼é‚è¼¯ (JavaScript) ---
        
        let canvas = document.getElementById('imageCanvas');
        let ctx = canvas.getContext('2d');
        let img = new Image();
        
        // ç‹€æ…‹è®Šæ•¸
        let currentTool = 'rect'; // rect, poly
        let isDrawing = false;
        let startX, startY;
        let polyPoints = [];
        let roiMask = null; // ç”¨ä¾†å­˜å„²é¸å–å€åŸŸ
        let threshold = 128;

        // åˆå§‹åŒ–ç•«å¸ƒæ–‡å­—
        canvas.width = 800;
        canvas.height = 600;
        ctx.fillStyle = "#555";
        ctx.font = "20px Microsoft JhengHei";
        ctx.textAlign = "center";
        ctx.fillText("è«‹å¾å·¦å´è¼‰å…¥åœ–ç‰‡", canvas.width/2, canvas.height/2);

        // 1. è¼‰å…¥åœ–ç‰‡
        function loadImage(input) {
            if (input.files && input.files[0]) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    img.onload = function() {
                        // èª¿æ•´ç•«å¸ƒå¤§å°ä»¥é©æ‡‰åœ–ç‰‡ï¼Œä½†ä¸è¦å¤ªå¤§ä»¥å…ç•¶æ©Ÿ
                        canvas.width = img.width;
                        canvas.height = img.height;
                        resetROI();
                        draw();
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 2. è¨­å®šå·¥å…·
        function setTool(tool) {
            currentTool = tool;
            document.getElementById('btnRect').classList.toggle('active', tool === 'rect');
            document.getElementById('btnPoly').classList.toggle('active', tool === 'poly');
            // åˆ‡æ›å·¥å…·æ™‚ä¸å¼·åˆ¶æ¸…é™¤ï¼Œä¿ç•™å½ˆæ€§
        }

        function resetROI() {
            polyPoints = [];
            roiMask = null;
            draw();
            document.getElementById('resultBox').innerHTML = "å€åŸŸå·²é‡ç½®";
        }

        function updateThreshold(val) {
            threshold = parseInt(val);
            document.getElementById('threshVal').innerText = val;
            if(roiMask) calculateArea(); // å¦‚æœæœ‰é¸å€ï¼Œç›´æ¥å³æ™‚è¨ˆç®—é è¦½
        }

        // 3. ç¹ªåœ–èˆ‡æ»‘é¼ äº‹ä»¶
        function draw() {
            // æ¸…ç©ºç•«é¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ç•«åº•åœ–
            if (img.src) ctx.drawImage(img, 0, 0);

            // è¨­å®šç¹ªåœ–æ¨£å¼
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.fillStyle = 'rgba(0, 255, 0, 0.15)';

            // ç•«å¤šé‚Šå½¢
            if (currentTool === 'poly' && polyPoints.length > 0) {
                ctx.beginPath();
                ctx.moveTo(polyPoints[0].x, polyPoints[0].y);
                for (let i = 1; i < polyPoints.length; i++) {
                    ctx.lineTo(polyPoints[i].x, polyPoints[i].y);
                }
                // å¦‚æœæ­£åœ¨ç•«ï¼Œé€£ç·šåˆ°æ»‘é¼ ä½ç½®ï¼ˆé€™è£¡ç°¡åŒ–ï¼Œç›´æ¥ç•«å‡ºå·²æœ‰é»ï¼‰
                if (roiMask && currentTool === 'poly') {
                    ctx.closePath();
                    ctx.fill();
                }
                ctx.stroke();
                
                // ç•«å‡ºé ‚é»
                ctx.fillStyle = 'yellow';
                for(let p of polyPoints){
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.fillStyle = 'rgba(0, 255, 0, 0.15)'; // é‚„åŸå¡«è‰²

            } else if (roiMask && currentTool === 'rect') {
                // ç•«çŸ©å½¢
                ctx.strokeRect(roiMask.x, roiMask.y, roiMask.w, roiMask.h);
                ctx.fillRect(roiMask.x, roiMask.y, roiMask.w, roiMask.h);
            }
        }

        // æ»‘é¼ ç›£è½
        canvas.addEventListener('mousedown', e => {
            if (!img.src) return;
            const rect = canvas.getBoundingClientRect();
            // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ (å› ç‚º CSS å¯èƒ½è®“ canvas ç¸®å°é¡¯ç¤º)
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (currentTool === 'rect') {
                isDrawing = true;
                startX = x;
                startY = y;
                roiMask = null; // é‡ç•«çŸ©å½¢æ™‚æ¸…é™¤èˆŠçš„
            } else if (currentTool === 'poly') {
                if(roiMask === true) { // å¦‚æœå·²ç¶“ç•«å®Œä¸€å€‹ï¼Œå†é»æ“Šå‰‡é‡æ–°é–‹å§‹
                    polyPoints = [];
                    roiMask = null;
                }
                polyPoints.push({x, y});
                draw();
            }
        });

        canvas.addEventListener('mousemove', e => {
            if (!img.src) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (currentTool === 'rect' && isDrawing) {
                draw(); // é‡ç¹ªåœ– (æ¸…é™¤èˆŠçš„æ‹–æ›³æ¡†)
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 3;
                ctx.strokeRect(startX, startY, x - startX, y - startY);
            }
        });

        canvas.addEventListener('mouseup', e => {
            if (currentTool === 'rect' && isDrawing) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                
                isDrawing = false;
                // ä¿®æ­£å¯¬é«˜ç‚ºè² å€¼çš„ç‹€æ³
                let w = x - startX;
                let h = y - startY;
                let rx = startX;
                let ry = startY;
                if(w < 0) { rx = x; w = Math.abs(w); }
                if(h < 0) { ry = y; h = Math.abs(h); }

                // å„²å­˜çŸ©å½¢å€åŸŸ
                roiMask = { x: rx, y: ry, w: w, h: h };
                draw();
            }
        });
        
        // å¤šé‚Šå½¢é›™æ“ŠçµæŸ
        canvas.addEventListener('dblclick', e => {
            if (currentTool === 'poly' && polyPoints.length > 2) {
                roiMask = true; // æ¨™è¨˜ç‚ºå®Œæˆç‹€æ…‹
                draw(); // æœƒè§¸ç™¼ fill()
            }
        });

        // 4. è¨ˆç®—é¢ç©é‚è¼¯
        function calculateArea() {
            if (!img.src || !roiMask) {
                alert("è«‹å…ˆè¼‰å…¥åœ–ç‰‡ä¸¦é¸å–å€åŸŸ");
                return;
            }

            // é‡æ–°ç¹ªè£½ä¹¾æ·¨çš„åœ–ç‰‡ä»¥å–å¾—æ•¸æ“š
            draw(); 
            // é€™è£¡å¿…é ˆé‡ç•«ä¸€æ¬¡ä¸å¸¶ç¶ è‰²é®ç½©çš„åŸå§‹åœ–ä¾†è¨ˆç®—åƒç´ ? 
            // ä¸ï¼ŒgetImageData æœƒæŠ“åˆ°ç¶ è‰²é®ç½©ã€‚
            // è§£æ±ºæ–¹æ³•ï¼šç”¨å¦ä¸€å€‹éš±è—çš„ canvas ç•«åŸå§‹åœ– + Maskï¼Œæˆ–è€…ç›´æ¥æ“ä½œæ•¸æ“šã€‚
            
            // ç°¡å–®è§£æ³•ï¼šå…ˆç•«åŸå§‹åœ–
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            // å–å¾—åŸå§‹åƒç´ æ•¸æ“š
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data; // R, G, B, A...
            
            // å»ºç«‹ Mask Canvas
            const maskCanvas = document.createElement('canvas');
            maskCanvas.width = canvas.width;
            maskCanvas.height = canvas.height;
            const maskCtx = maskCanvas.getContext('2d');
            
            maskCtx.fillStyle = 'white'; // Mask å€åŸŸç‚ºç™½è‰²
            maskCtx.beginPath();
            if (currentTool === 'rect') {
                maskCtx.rect(roiMask.x, roiMask.y, roiMask.w, roiMask.h);
            } else {
                if(polyPoints.length < 3) return;
                maskCtx.moveTo(polyPoints[0].x, polyPoints[0].y);
                for (let i = 1; i < polyPoints.length; i++) {
                    maskCtx.lineTo(polyPoints[i].x, polyPoints[i].y);
                }
                maskCtx.closePath();
            }
            maskCtx.fill();
            const maskData = maskCtx.getImageData(0, 0, canvas.width, canvas.height).data;

            // é–‹å§‹è¨ˆç®—
            let gluePixels = 0;
            let totalRoiPixels = 0;
            
            // è¦–è¦ºåŒ–é™£åˆ— (æœ€å¾Œè¦ç•«å›å»)
            // æˆ‘å€‘ç›´æ¥åœ¨ imageData ä¸Šä¿®æ”¹é¡è‰²ä¾†é¡¯ç¤ºçµæœ
            for (let i = 0; i < data.length; i += 4) {
                // maskData çš„ Alpha é€šé“ > 0 è¡¨ç¤ºåœ¨é¸å€å…§
                // æ³¨æ„ï¼šgetImageData çš„ Alpha åœ¨ i+3
                // maskCtx ç•«ç™½è‰²ï¼Œæ‰€ä»¥ R(i)=255, G(i+1)=255, B(i+2)=255
                if (maskData[i] > 128) { // ç°¡å–®åˆ¤æ–·æ˜¯å¦ç‚ºç™½è‰²
                    totalRoiPixels++;
                    
                    const r = data[i];
                    const g = data[i+1];
                    const b = data[i+2];
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;

                    // é–¾å€¼åˆ¤æ–· (å‡è¨­è† é«”æ¯”èƒŒæ™¯é»‘)
                    if (gray < threshold) {
                        gluePixels++;
                        // å°‡åµæ¸¬åˆ°çš„è† é«”æ¨™è¨˜ç‚ºé¡¯çœ¼çš„é»ƒè‰²
                        data[i] = 255;   
                        data[i+1] = 255; 
                        data[i+2] = 0;   
                    }
                }
            }
            
            // å°‡æ¨™è¨˜å¾Œçš„çµæœç•«å›ä¸»ç•«å¸ƒ
            ctx.putImageData(imageData, 0, 0);

            // è£œä¸Šç¶ è‰²å¤–æ¡† (å› ç‚º putImageData è“‹æ‰äº†)
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            if (currentTool === 'rect') {
                ctx.strokeRect(roiMask.x, roiMask.y, roiMask.w, roiMask.h);
            } else {
                ctx.beginPath();
                ctx.moveTo(polyPoints[0].x, polyPoints[0].y);
                for (let i = 1; i < polyPoints.length; i++) {
                    ctx.lineTo(polyPoints[i].x, polyPoints[i].y);
                }
                ctx.closePath();
                ctx.stroke();
            }

            // é¡¯ç¤ºçµæœ
            const percent = totalRoiPixels > 0 ? ((gluePixels/totalRoiPixels)*100).toFixed(2) : 0;
            document.getElementById('resultBox').innerHTML = 
                `ROI é¢ç©: ${totalRoiPixels} px<br>` +
                `è† é«”é¢ç©: ${gluePixels} px<br>` +
                `è¦†è“‹æ¯”ä¾‹: <span style="font-size:16px; color:yellow">${percent}%</span>`;
        }
    </script>
</body>
</html>
