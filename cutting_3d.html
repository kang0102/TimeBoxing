<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cutting 3D Simulator</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #121212; color: #eee; font-family: "Microsoft JhengHei", sans-serif; }
        #sidebar {
            position: absolute; top: 0; left: 0; width: 340px; height: 100vh;
            background: rgba(30, 30, 30, 0.95); overflow-y: auto; padding: 15px;
            box-sizing: border-box; border-right: 1px solid #444; backdrop-filter: blur(5px);
        }
        #canvas-container { width: 100vw; height: 100vh; }
        
        /* UI Controls */
        h2 { margin: 0 0 10px 0; color: #4FC3F7; font-size: 18px; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .group { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #444; }
        .row { display: flex; align-items: center; margin-bottom: 6px; }
        label { flex: 1; font-size: 13px; color: #aaa; }
        input[type="number"], select { 
            width: 70px; background: #333; border: 1px solid #555; color: white; 
            padding: 3px; border-radius: 4px; text-align: right;
        }
        input[type="range"] { flex: 1.5; margin: 0 8px; }
        .val-disp { width: 40px; font-size: 12px; color: #4FC3F7; text-align: right; }
        
        button { 
            width: 100%; padding: 8px; background: #00695C; color: white; 
            border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; font-weight: bold;
        }
        button:hover { background: #00897B; }
        .btn-toggle { background: #444; margin-top: 0; }
        .btn-toggle.active { background: #1976D2; }

        /* Loading Overlay */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; display: flex; justify-content: center; align-items: center;
            z-index: 9999; color: white; font-size: 20px; transition: opacity 0.5s;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "three-bvh-csg": "https://unpkg.com/three-bvh-csg@0.0.16/build/index.module.js"
            }
        }
    </script>
</head>
<body>

<div id="loader">ğŸš€ æ­£åœ¨è¼‰å…¥ 3D å¼•æ“...</div>

<div id="sidebar">
    <a href="./" style="color:#aaa; text-decoration:none; font-size:12px;">ğŸ  å›é¦–é </a>
    <h2>Cutting 3D <span style="font-size:12px;color:#888;">Boolean Ops</span></h2>
    
    <div class="group">
        <label style="color:#fff;">ğŸ¯ åˆ‡å‰²è¨­å®š (Boolean)</label>
        <div class="row" style="margin-top:5px;">
            <label>è¢«åˆ‡ç‰©ä»¶:</label>
            <select id="target-select" onchange="updateModel()">
                <option value="none">ä¸åˆ‡å‰² (é¡¯ç¤ºå…¨è²Œ)</option>
                <option value="sample" selected>Sample (æ¨£å“)</option>
                <option value="jig">Jig (æ²»å…·)</option>
            </select>
        </div>
        <div class="row">
            <button class="btn-toggle" id="btn-wireframe" onclick="toggleWireframe()">åˆ‡æ›ç¶²æ ¼ (Wireframe)</button>
        </div>
    </div>

    <div class="group">
        <label style="color:#E1BEE7;">ğŸ“ Jig (æ²»å…·)</label>
        <div class="row"><label>Height</label><input type="range" id="j_h" min="1" max="20" step="0.1" value="5"><span class="val-disp" id="v_j_h">5.0</span></div>
        <div class="row"><label>Angle</label><input type="range" id="j_a" min="10" max="89" step="1" value="45"><span class="val-disp" id="v_j_a">45</span></div>
        <div class="row"><label>Width (Z)</label><input type="range" id="j_w" min="1" max="20" step="0.1" value="10"><span class="val-disp" id="v_j_w">10.0</span></div>
    </div>

    <div class="group">
        <label style="color:#BBDEFB;">ğŸ§Š Sample (æ¨£å“)</label>
        <div class="row"><label>Pos (t)</label><input type="range" id="s_t" min="0" max="1" step="0.01" value="0.5"><span class="val-disp" id="v_s_t">0.5</span></div>
        <div class="row"><label>Length</label><input type="range" id="s_l" min="1" max="15" step="0.1" value="5"><span class="val-disp" id="v_s_l">5.0</span></div>
        <div class="row"><label>Thick</label><input type="range" id="s_th" min="0.1" max="5" step="0.1" value="0.8"><span class="val-disp" id="v_s_th">0.8</span></div>
        <div class="row"><label>Width (Z)</label><input type="range" id="s_w" min="1" max="20" step="0.1" value="8"><span class="val-disp" id="v_s_w">8.0</span></div>
    </div>

    <div class="group">
        <label style="color:#FFF9C4;">ğŸ”ª Blade (åˆ€å…·)</label>
        <div class="row"><label>Thick (X)</label><input type="range" id="b_t" min="0.01" max="2" step="0.01" value="0.2"><span class="val-disp" id="v_b_t">0.2</span></div>
        <div class="row"><label>Width (Z)</label><input type="range" id="b_w" min="1" max="20" step="0.1" value="12"><span class="val-disp" id="v_b_w">12.0</span></div>
        <div class="row"><label>Depth (Y)</label><input type="range" id="b_d" min="0" max="10" step="0.1" value="2.5"><span class="val-disp" id="v_b_d">2.5</span></div>
        <div class="row"><label>Shift X</label><input type="range" id="b_dx" min="-5" max="5" step="0.1" value="0"><span class="val-disp" id="v_b_dx">0.0</span></div>
    </div>

    <div style="font-size:12px; color:#666;">
        * å·¦éµæ—‹è½‰ / å³éµå¹³ç§» / æ»¾è¼ªç¸®æ”¾<br>
        * é‹ç®—æ¡ç”¨ CSG (Constructive Solid Geometry)
    </div>
</div>

<div id="canvas-container"></div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { SUBTRACTION, Brush, Evaluator } from 'three-bvh-csg';

    // 1. åˆå§‹åŒ–å ´æ™¯
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x222222);

    // Camera
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(15, 15, 20);
    camera.lookAt(0, 0, 0);

    // Renderer
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    container.appendChild(renderer.domElement);

    // Lights
    const ambientLight = new THREE.AmbientLight(0x404040, 1.5); // Soft white light
    scene.add(ambientLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 2);
    dirLight.position.set(10, 20, 10);
    dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 2048;
    dirLight.shadow.mapSize.height = 2048;
    scene.add(dirLight);

    const backLight = new THREE.DirectionalLight(0x445566, 1);
    backLight.position.set(-10, 5, -10);
    scene.add(backLight);

    // Helpers
    const gridHelper = new THREE.GridHelper(50, 50, 0x444444, 0x333333);
    scene.add(gridHelper);
    const axesHelper = new THREE.AxesHelper(5);
    scene.add(axesHelper);

    // Controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // CSG Evaluator
    const evaluator = new Evaluator();

    // Materials
    const matJig = new THREE.MeshStandardMaterial({ color: 0x9C27B0, roughness: 0.3, metalness: 0.1 }); // Purple
    const matSample = new THREE.MeshStandardMaterial({ color: 0x2196F3, roughness: 0.2, metalness: 0.0 }); // Blue
    const matBlade = new THREE.MeshStandardMaterial({ color: 0xFFC107, roughness: 0.1, metalness: 0.8 }); // Gold/Yellow
    const matCut = new THREE.MeshStandardMaterial({ color: 0xFF5722, roughness: 0.5 }); // Orange (Cut surface)

    let meshJig, meshSample, meshBlade, resultMesh;
    let isWireframe = false;

    // 2. å¹¾ä½•ç”Ÿæˆé‚è¼¯
    function createJigGeometry(h, angleDeg, w) {
        // å»ºç«‹ä¸€å€‹ä¸‰è§’æŸ±
        const shape = new THREE.Shape();
        const base = (angleDeg <= 0 || angleDeg >= 90) ? h : h / Math.tan(angleDeg * Math.PI / 180);
        
        // ç•«ä¸‰è§’å½¢æ–·é¢ (0,0) -> (base,0) -> (base,h)
        shape.moveTo(0, 0);
        shape.lineTo(base, 0);
        shape.lineTo(base, h);
        shape.lineTo(0, 0);

        const extrudeSettings = {
            steps: 1,
            depth: w,
            bevelEnabled: false
        };
        const geo = new THREE.ExtrudeGeometry(shape, extrudeSettings);
        geo.center(); // Center the geometry
        return { geo, base, height: h };
    }

    function updateModel() {
        // --- Get Values ---
        const p = {
            j_h: parseFloat(document.getElementById('j_h').value),
            j_a: parseFloat(document.getElementById('j_a').value),
            j_w: parseFloat(document.getElementById('j_w').value),
            s_t: parseFloat(document.getElementById('s_t').value),
            s_l: parseFloat(document.getElementById('s_l').value),
            s_th: parseFloat(document.getElementById('s_th').value),
            s_w: parseFloat(document.getElementById('s_w').value),
            b_t: parseFloat(document.getElementById('b_t').value),
            b_w: parseFloat(document.getElementById('b_w').value),
            b_d: parseFloat(document.getElementById('b_d').value),
            b_dx: parseFloat(document.getElementById('b_dx').value)
        };

        // Update Labels
        Object.keys(p).forEach(k => {
            const el = document.getElementById('v_'+k);
            if(el) el.innerText = p[k];
        });

        // --- Clean Scene ---
        if(meshJig) { scene.remove(meshJig); meshJig.geometry.dispose(); }
        if(meshSample) { scene.remove(meshSample); meshSample.geometry.dispose(); }
        if(meshBlade) { scene.remove(meshBlade); meshBlade.geometry.dispose(); }
        if(resultMesh) { scene.remove(resultMesh); resultMesh.geometry.dispose(); }

        // --- 1. Create Jig (Brush) ---
        const jigData = createJigGeometry(p.j_h, p.j_a, p.j_w);
        // CSG Brush
        const brushJig = new Brush(jigData.geo, matJig);
        // å®šä½: Jig åº•éƒ¨åˆ‡é½Š Grid
        brushJig.position.y = p.j_h / 2; 
        brushJig.updateMatrixWorld();

        // --- 2. Create Sample (Brush) ---
        // Sample æ˜¯ä¸€å€‹ Boxï¼Œä½†éœ€è¦æ—‹è½‰ä¸¦è²¼åˆ Jig æ–œé¢
        const geoSample = new THREE.BoxGeometry(p.s_l, p.s_th, p.s_w);
        const brushSample = new Brush(geoSample, matSample);

        // è¨ˆç®—æ–œé¢è³‡è¨Š
        const angleRad = p.j_a * Math.PI / 180;
        const slopeLen = p.j_h / Math.sin(angleRad); // æ–œé‚Šé•·
        
        // è®“ Sample åœ¨æ–œé¢ä¸Šæ»‘å‹• (t: 0~1)
        // ç°¡åŒ–è¨ˆç®—ï¼šæˆ‘å€‘å…ˆå°‡ Sample è½‰æ­£ï¼Œç„¶å¾Œç§»å‹•åˆ°åŸé»ä¸Šæ–¹ï¼Œå†æ—‹è½‰
        // æ–œé¢ä¸­å¿ƒé»è¨ˆç®—æœ‰é»è¤‡é›œï¼Œé€™è£¡ç”¨ç›¸å°åº§æ¨™æ³•
        // Jig çš„æ–œé¢æ˜¯ç”± (0,0) åˆ° (base, height) å½¢æˆçš„ (ä½† Extrude å¾Œ center äº†)
        
        // é‡æ–°æ€è€ƒå®šä½ï¼š
        // å‡è¨­ Jig çš„æ–œé¢é ‚é»æ˜¯ Top(0, h) å’Œ Bottom(base, 0) (ä»¥å·¦ä¸Šè§’ç‚ºåŸé»æ€è€ƒ)
        // é€™è£¡ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘ç›´æ¥ç”¨æ•¸å­¸ç®—ä½ç½®
        const base = jigData.base;
        const h = p.j_h;
        
        // æ–œé¢å‘é‡ (å¾é ‚åˆ°åº•)
        const dx = base; 
        const dy = -h;
        const len = Math.sqrt(dx*dx + dy*dy);
        const ux = dx/len; const uy = dy/len; // å–®ä½å‘é‡
        
        // æ³•å‘é‡ (æœå³ä¸Š)
        const nx = -uy; const ny = ux;

        // èµ·é» (Jig çš„é ‚é»ï¼Œéœ€è€ƒæ…® extrude center å¾Œçš„åç§»)
        // Jig Center æ˜¯ (base/2, h/2, w/2) -> (0,0,0)
        // æ‰€ä»¥ Top é»ç›¸å° Center æ˜¯ (-base/2, h/2)
        const topX = -base/2; 
        const topY = h/2;

        // æ²¿æ–œé¢ç§»å‹•è·é›¢
        const slideDist = p.s_t * len;
        
        // Sample ä¸­å¿ƒé»ä½ç½®
        let sx = topX + ux * slideDist;
        let sy = topY + uy * slideDist;
        
        // åŠ ä¸Šåšåº¦åç§» (å¾€æ³•å‘é‡æ–¹å‘ç§»å‹•ä¸€åŠåšåº¦)
        sx += nx * (p.s_th/2);
        sy += ny * (p.s_th/2);

        // é‚„æœ‰ Sample æœ¬èº«é•·åº¦çš„ä¸€åŠåç§» (æ²¿æ–œé¢æ–¹å‘)
        sx += ux * (p.s_l/2);
        sy += uy * (p.s_l/2);

        brushSample.rotation.z = -angleRad; // æ—‹è½‰
        brushSample.position.set(sx, sy + p.j_h/2, 0); // y+h/2 æ˜¯å› ç‚º Jig è¢«æŠ¬é«˜äº†
        brushSample.updateMatrixWorld();

        // --- 3. Create Blade (Brush) ---
        const geoBlade = new THREE.BoxGeometry(p.b_t, p.b_d * 2, p.b_w); // é«˜åº¦åŠ å€ç¢ºä¿åˆ‡ç©¿
        const brushBlade = new Brush(geoBlade, matBlade);
        
        // åˆ€å…·ä½ç½®ï¼šä»¥ Sample ä¸­å¿ƒç‚ºåŸºæº–ï¼ŒåŠ ä¸Šåç§»
        // æˆ‘å€‘å¸Œæœ›åˆ€å…·æ˜¯å‚ç›´è½ä¸‹çš„ (World Y axis)
        // æˆ–æ˜¯å‚ç›´æ–¼æ¨£å“è¡¨é¢çš„ï¼Ÿé€šå¸¸åˆ‡å‰²æ©Ÿæ˜¯å‚ç›´è½ä¸‹ (Z/Y axis machine)
        // é€™è£¡å‡è¨­æ˜¯å‚ç›´åœ°é¢ (Vertical Cut)
        const bladeX = sx + p.b_dx; 
        const bladeY = sy + p.j_h/2 + 2; // å…ˆæ”¾é«˜ä¸€é»
        
        // è¨­å®šåˆ‡å‰²æ·±åº¦ï¼šExposure ä»£è¡¨åˆ€å…·å°–ç«¯ åˆ‡å…¥ Z=0 (æˆ– Sample è¡¨é¢) çš„ç¨‹åº¦
        // é€™è£¡ç°¡åŒ–ï¼šä½¿ç”¨è€…è¨­å®šåˆ€å…· Y ä½ç½®
        brushBlade.position.set(bladeX, p.b_d, 0); 
        brushBlade.updateMatrixWorld();

        // --- 4. Boolean Operation ---
        const target = document.getElementById('target-select').value;
        
        if (target === 'none') {
            // é¡¯ç¤ºæ‰€æœ‰ç‰©é«”
            scene.add(brushJig); meshJig = brushJig;
            scene.add(brushSample); meshSample = brushSample;
            scene.add(brushBlade); meshBlade = brushBlade;
        } else {
            // åŸ·è¡Œåˆ‡å‰²
            let targetBrush, resultBrush;
            
            if (target === 'sample') {
                targetBrush = brushSample;
                // é¡¯ç¤ºå…¶ä»–æ²’è¢«åˆ‡çš„
                scene.add(brushJig); meshJig = brushJig;
            } else { // jig
                targetBrush = brushJig;
                // é¡¯ç¤ºå…¶ä»–æ²’è¢«åˆ‡çš„
                scene.add(brushSample); meshSample = brushSample;
            }

            // é‹ç®—ï¼š Target - Blade
            // SUBTRACTION
            resultBrush = evaluator.evaluate(targetBrush, brushBlade, SUBTRACTION);
            
            resultBrush.material = target === 'sample' ? matSample : matJig;
            resultBrush.castShadow = true;
            resultBrush.receiveShadow = true;

            scene.add(resultBrush);
            resultMesh = resultBrush;
            
            // é‚„æ˜¯è¦æŠŠåˆ€å…·é¡¯ç¤ºå‡ºä¾†(åŠé€æ˜)ï¼Œé€™æ¨£æ‰çŸ¥é“åˆ‡å“ªè£¡
            const bladeGhost = brushBlade.clone();
            bladeGhost.material = new THREE.MeshBasicMaterial({ color: 0xFFEB3B, wireframe: true, transparent: true, opacity: 0.3 });
            scene.add(bladeGhost);
            meshBlade = bladeGhost;
        }

        updateWireframe();
    }

    // Toggle Wireframe
    window.toggleWireframe = function() {
        isWireframe = !isWireframe;
        const btn = document.getElementById('btn-wireframe');
        if(isWireframe) btn.classList.add('active'); else btn.classList.remove('active');
        updateWireframe();
    }

    function updateWireframe() {
        scene.traverse((obj) => {
            if (obj.isMesh && obj.material) {
                // å¦‚æœæ˜¯ Ghost Blade å°±ä¸å‹•
                if(obj === meshBlade && document.getElementById('target-select').value !== 'none') return;
                
                obj.material.wireframe = isWireframe;
            }
        });
    }

    // Expose function to window for HTML events
    window.updateModel = updateModel;

    // Resize Handler
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // 3. Animation Loop
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    // Start
    document.getElementById('loader').style.opacity = 0;
    setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
    
    // Initial draw
    updateModel();
    animate();

</script>
</body>
</html>
