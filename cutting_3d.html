<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cutting 3D Simulator v4.5 (Gizmo Control)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #121212; color: #eee; font-family: "Microsoft JhengHei", sans-serif; }
        
        /* å·¦å´æ§åˆ¶æ¬„ */
        #sidebar {
            position: absolute; top: 0; left: 0; width: 380px; height: 100vh;
            background: rgba(30, 30, 30, 0.95); overflow-y: auto; padding: 15px;
            box-sizing: border-box; border-right: 1px solid #444; backdrop-filter: blur(5px);
            display: flex; flex-direction: column; gap: 12px; z-index: 10;
        }

        /* å³å´è¦–è§’æŒ‰éˆ• */
        #view-controls {
            position: absolute; top: 15px; right: 15px;
            display: flex; flex-direction: column; gap: 8px; z-index: 10;
        }
        .view-btn {
            width: 50px; height: 50px;
            background: rgba(50, 50, 50, 0.8); color: white;
            border: 1px solid #666; border-radius: 8px;
            cursor: pointer; font-size: 13px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            transition: 0.2s; backdrop-filter: blur(3px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .view-btn:hover { background: #4FC3F7; color: #000; border-color: #4FC3F7; }

        /* å³ä¸‹è§’ Gizmo æ§åˆ¶é¢æ¿ */
        #gizmo-panel {
            position: absolute; bottom: 20px; right: 20px;
            background: rgba(30, 30, 30, 0.9); padding: 10px;
            border-radius: 8px; border: 1px solid #555;
            display: flex; flex-direction: column; gap: 8px;
            z-index: 10; width: 160px;
        }
        .gizmo-row { display: flex; gap: 5px; }
        .gizmo-btn {
            flex: 1; padding: 6px; font-size: 12px; cursor: pointer;
            background: #444; color: #ddd; border: 1px solid #666; border-radius: 4px;
        }
        .gizmo-btn.active { background: #FF9800; color: #000; font-weight: bold; border-color: #FF9800; }
        .gizmo-label { font-size: 12px; color: #aaa; text-align: center; margin-bottom: 2px; }

        #canvas-container { width: 100vw; height: 100vh; }
        
        /* UI å…ƒä»¶ */
        h2 { margin: 0; color: #4FC3F7; font-size: 20px; border-bottom: 1px solid #555; padding-bottom: 8px; }
        .group { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; border: 1px solid #444; position: relative; }
        
        /* å¯é»æ“Šçš„æ¨™é¡Œï¼Œç”¨ä¾†åˆ‡æ› Gizmo ç›®æ¨™ */
        .group-title { 
            font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; 
            cursor: pointer; padding: 4px; border-radius: 4px; transition: 0.2s;
        }
        .group-title:hover { background: rgba(255,255,255,0.1); }
        .group-title.selected { background: rgba(0, 230, 118, 0.2); border: 1px solid #00E676; }
        .select-hint { font-size: 10px; color: #888; font-weight: normal; }

        .row { display: flex; align-items: center; margin-bottom: 5px; gap: 3px; }
        .row-rot { background: rgba(255, 235, 59, 0.08); padding: 2px 0; border-radius: 4px; }
        label { flex: 0 0 75px; font-size: 12px; color: #aaa; text-align: right; margin-right: 5px;}
        
        input[type="number"] { width: 55px; background: #222; border: 1px solid #555; color: #4FC3F7; padding: 4px; border-radius: 4px; font-size: 13px; text-align: right; }
        input[type="range"] { flex: 1; cursor: pointer; height: 10px; }
        select { background: #333; color: white; border: 1px solid #555; padding: 5px; border-radius: 4px; flex: 1; }
        
        .adj-btn {
            width: 24px; height: 24px; padding: 0; background: #444; color: #fff; border: 1px solid #555;
            border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; justify-content: center; align-items: center; font-size: 14px;
        }
        .adj-btn:hover { background: #666; }
        
        .step-container { display: flex; align-items: center; background: #222; padding: 8px; border-radius: 6px; border: 1px solid #444; }
        .step-disp { width: 60px; text-align: center; font-weight: bold; color: #00E676; background: #333; padding: 4px; border-radius: 4px; margin-left: 10px; font-size: 14px; }

        .btn-toggle { width:100%; background: #444; color:white; border:none; padding: 6px; border-radius:4px; margin-bottom: 5px; cursor:pointer;}
        .btn-toggle.active { background: #1976D2; }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; 
            display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 20px; transition: opacity 0.5s;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.160.0",
                "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
                "three-bvh-csg": "https://esm.sh/three-bvh-csg@0.0.16?deps=three@0.160.0",
                "firebase-app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase-firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
            }
        }
    </script>
</head>
<body>

<div id="loader">ğŸš€ æ­£åœ¨è¼‰å…¥ 3D å¼•æ“...</div>

<div id="view-controls">
    <div class="view-btn" onclick="setView('top')" title="Top">ä¸Š</div>
    <div class="view-btn" onclick="setView('front')" title="Front">å‰</div>
    <div class="view-btn" onclick="setView('side')" title="Right">å³</div>
    <div class="view-btn" onclick="setView('iso')" title="ISO">ISO</div>
</div>

<div id="gizmo-panel">
    <div class="gizmo-label">ğŸ® æ§åˆ¶æ¨¡å¼</div>
    <div class="gizmo-row">
        <button class="gizmo-btn" id="mode-translate" onclick="setGizmoMode('translate')">ç§»å‹•</button>
        <button class="gizmo-btn active" id="mode-rotate" onclick="setGizmoMode('rotate')">æ—‹è½‰</button>
    </div>
    <div class="gizmo-label" style="margin-top:5px;">ğŸ”’ é–å®šè»¸å‘</div>
    <div class="gizmo-row">
        <button class="gizmo-btn" onclick="setGizmoAxis('X')">X (YZ)</button>
        <button class="gizmo-btn" onclick="setGizmoAxis('Y')">Y (XZ)</button>
        <button class="gizmo-btn" onclick="setGizmoAxis('Z')">Z (XY)</button>
    </div>
    <button class="gizmo-btn" onclick="setGizmoAxis(null)" style="width:100%; margin-top:2px;">è§£é– (Free)</button>
</div>

<div id="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Cutting 3D <span style="font-size:12px;color:#888;">v4.5</span></h2>
        <a href="./" style="color:#aaa; text-decoration:none; font-size:12px;">ğŸ  å›é¦–é </a>
    </div>

    <div class="group" style="border-top: 3px solid #00E676;">
        <span class="group-title" style="color:#00E676;">ğŸ›ï¸ å¾®èª¿å€ç‡</span>
        <div class="step-container">
            <input type="range" id="step-slider" min="0" max="5" step="1" value="1" oninput="updateStepDisplay(this.value)" style="flex:1;">
            <div id="step-val" class="step-disp">0.1</div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:10px; color:#666; margin-top:2px; padding:0 5px;">
            <span>0.01</span><span>0.1</span><span>0.5</span><span>1</span><span>5</span><span>10</span>
        </div>
    </div>
    
    <div class="group" style="border-left: 3px solid #FF9800;">
        <span class="group-title" style="color:#FF9800;">â˜ï¸ è®€å–ç–Šæ§‹</span>
        <div class="row">
            <select id="project-select"><option value="">-- é€£ç·šä¸­... --</option></select>
        </div>
        <button class="btn-toggle" onclick="loadSelectedProject()">ğŸ“¥ è¼‰å…¥é¸å®šç–Šæ§‹</button>
        <button class="btn-toggle" onclick="unloadProject()">âŒ æ¸…é™¤</button>
        <div id="stack-info" style="font-size:11px; color:#aaa; margin-top:5px; display:none;">
            ç¸½åšåº¦: <span id="current-stack-th" style="color:#fff;">0</span> mm
        </div>
    </div>

    <div class="group">
        <span class="group-title" style="color:#fff;">ğŸ¯ åˆ‡å‰²æ¨¡å¼</span>
        <div class="row">
            <label>è¢«åˆ‡ç‰©ä»¶</label>
            <select id="target-select" onchange="updateModel()">
                <option value="none">ä¸åˆ‡å‰² (Preview)</option>
                <option value="sample" selected>Sample (æ¨£å“)</option>
                <option value="jig">Jig (æ²»å…·)</option>
            </select>
        </div>
        <button class="btn-toggle" id="btn-wireframe" onclick="toggleWireframe()">åˆ‡æ›ç¶²æ ¼ (Wireframe)</button>
    </div>

    <div class="group" style="border-left: 3px solid #E1BEE7;" id="group-jig">
        <div class="group-title" onclick="selectObject('jig')" id="title-jig" style="color:#E1BEE7;">
            <span>ğŸ“ Jig (æ²»å…·)</span> <span class="select-hint">é»æ“Šé¸å–</span>
        </div>
        <div class="row row-rot"><label>æ—‹è½‰Y Â°</label><input type="number" id="nb_j_r" value="0" onchange="sync('j_r',this.value)"><button class="adj-btn" onclick="adjust('j_r',-1)">-</button><input type="range" id="j_r" min="-180" max="180" step="1" value="0" oninput="sync('nb_j_r',this.value)"><button class="adj-btn" onclick="adjust('j_r',1)">+</button></div>
        <div class="row"><label>é«˜åº¦ mm</label><input type="number" id="nb_j_h" value="5" onchange="sync('j_h',this.value)"><button class="adj-btn" onclick="adjust('j_h',-1)">-</button><input type="range" id="j_h" min="1" max="50" step="0.1" value="5" oninput="sync('nb_j_h',this.value)"><button class="adj-btn" onclick="adjust('j_h',1)">+</button></div>
        <div class="row"><label>è§’åº¦ Â°</label><input type="number" id="nb_j_a" value="45" onchange="sync('j_a',this.value)"><button class="adj-btn" onclick="adjust('j_a',-1)">-</button><input type="range" id="j_a" min="5" max="85" step="1" value="45" oninput="sync('nb_j_a',this.value)"><button class="adj-btn" onclick="adjust('j_a',1)">+</button></div>
        <div class="row"><label>æ·±åº¦Z mm</label><input type="number" id="nb_j_w" value="20" onchange="sync('j_w',this.value)"><button class="adj-btn" onclick="adjust('j_w',-1)">-</button><input type="range" id="j_w" min="1" max="100" step="0.1" value="20" oninput="sync('nb_j_w',this.value)"><button class="adj-btn" onclick="adjust('j_w',1)">+</button></div>
    </div>

    <div class="group" style="border-left: 3px solid #BBDEFB;" id="group-sample">
        <div class="group-title" onclick="selectObject('sample')" id="title-sample" style="color:#BBDEFB;">
            <span>ğŸ§Š Sample (æ¨£å“)</span> <span class="select-hint">é»æ“Šé¸å–</span>
        </div>
        <div class="row row-rot"><label>è‡ªæ—‹Y Â°</label><input type="number" id="nb_s_r" value="0" onchange="sync('s_r',this.value)"><button class="adj-btn" onclick="adjust('s_r',-1)">-</button><input type="range" id="s_r" min="-180" max="180" step="1" value="0" oninput="sync('nb_s_r',this.value)"><button class="adj-btn" onclick="adjust('s_r',1)">+</button></div>
        <div class="row"><label>æ»‘å‹• 0-1</label><input type="number" id="nb_s_t" value="0.5" onchange="sync('s_t',this.value)"><button class="adj-btn" onclick="adjust('s_t',-1)">-</button><input type="range" id="s_t" min="0" max="1" step="0.01" value="0.5" oninput="sync('nb_s_t',this.value)"><button class="adj-btn" onclick="adjust('s_t',1)">+</button></div>
        <div class="row"><label>é•·åº¦ mm</label><input type="number" id="nb_s_l" value="10" onchange="sync('s_l',this.value)"><button class="adj-btn" onclick="adjust('s_l',-1)">-</button><input type="range" id="s_l" min="1" max="100" step="0.1" value="10" oninput="sync('nb_s_l',this.value)"><button class="adj-btn" onclick="adjust('s_l',1)">+</button></div>
        <div class="row" id="simple-thick-row"><label>åšåº¦ mm</label><input type="number" id="nb_s_th" value="0.8" onchange="sync('s_th',this.value)"><button class="adj-btn" onclick="adjust('s_th',-1)">-</button><input type="range" id="s_th" min="0.1" max="20" step="0.01" value="0.8" oninput="sync('nb_s_th',this.value)"><button class="adj-btn" onclick="adjust('s_th',1)">+</button></div>
        <div class="row"><label>å¯¬åº¦Z mm</label><input type="number" id="nb_s_w" value="15" onchange="sync('s_w',this.value)"><button class="adj-btn" onclick="adjust('s_w',-1)">-</button><input type="range" id="s_w" min="1" max="100" step="0.1" value="15" oninput="sync('nb_s_w',this.value)"><button class="adj-btn" onclick="adjust('s_w',1)">+</button></div>
    </div>

    <div class="group" style="border-left: 3px solid #FFF9C4;" id="group-blade">
        <div class="group-title" onclick="selectObject('blade')" id="title-blade" style="color:#FFF9C4;">
            <span>ğŸ”ª Blade (åˆ€å…·)</span> <span class="select-hint">é»æ“Šé¸å–</span>
        </div>
        <div class="row row-rot"><label>è§’åº¦Z Â°</label><input type="number" id="nb_b_a" value="0" onchange="sync('b_a',this.value)"><button class="adj-btn" onclick="adjust('b_a',-1)">-</button><input type="range" id="b_a" min="-45" max="45" step="1" value="0" oninput="sync('nb_b_a',this.value)"><button class="adj-btn" onclick="adjust('b_a',1)">+</button></div>
        <div class="row"><label>åˆ€åšX mm</label><input type="number" id="nb_b_t" value="0.5" onchange="sync('b_t',this.value)"><button class="adj-btn" onclick="adjust('b_t',-1)">-</button><input type="range" id="b_t" min="0.01" max="10" step="0.01" value="0.5" oninput="sync('nb_b_t',this.value)"><button class="adj-btn" onclick="adjust('b_t',1)">+</button></div>
        <div class="row"><label>åˆ€å¯¬Z mm</label><input type="number" id="nb_b_w" value="25" onchange="sync('b_w',this.value)"><button class="adj-btn" onclick="adjust('b_w',-1)">-</button><input type="range" id="b_w" min="1" max="100" step="0.1" value="25" oninput="sync('nb_b_w',this.value)"><button class="adj-btn" onclick="adjust('b_w',1)">+</button></div>
        <div class="row"><label>åˆ‡æ·±Y mm</label><input type="number" id="nb_b_d" value="3.0" onchange="sync('b_d',this.value)"><button class="adj-btn" onclick="adjust('b_d',-1)">-</button><input type="range" id="b_d" min="0" max="50" step="0.1" value="3.0" oninput="sync('nb_b_d',this.value)"><button class="adj-btn" onclick="adjust('b_d',1)">+</button></div>
        <div class="row"><label>åç§»X mm</label><input type="number" id="nb_b_dx" value="0" onchange="sync('b_dx',this.value)"><button class="adj-btn" onclick="adjust('b_dx',-1)">-</button><input type="range" id="b_dx" min="-50" max="50" step="0.1" value="0" oninput="sync('nb_b_dx',this.value)"><button class="adj-btn" onclick="adjust('b_dx',1)">+</button></div>
    </div>
</div>

<div id="canvas-container"></div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { TransformControls } from 'three/addons/controls/TransformControls.js';
    import { SUBTRACTION, Brush, Evaluator } from 'three-bvh-csg';
    import { initializeApp } from 'firebase-app';
    import { getFirestore, collection, getDocs, doc, getDoc } from 'firebase-firestore';

    // --- Global State ---
    const stepValues = [0.01, 0.1, 0.5, 1.0, 5.0, 10.0];
    window.currentStep = 0.1;
    window.updateStepDisplay = function(idx) {
        window.currentStep = stepValues[idx];
        document.getElementById('step-val').innerText = window.currentStep;
    }

    // --- Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyCnHhksuhJs9RdrL7DPnsAvR21ZND7kIOI",
        authDomain: "stack-diagram-db.firebaseapp.com",
        projectId: "stack-diagram-db",
        storageBucket: "stack-diagram-db.firebasestorage.app",
        messagingSenderId: "67240747982",
        appId: "1:67240747982:web:1fb065e40e936a7485419f",
        measurementId: "G-QJNE60W8BB"
    };

    let db = null, stackData = null;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        initProjectList();
    } catch(e) { console.error("Firebase Init Error", e); }

    async function initProjectList() {
        const sel = document.getElementById('project-select');
        try {
            const snapshot = await getDocs(collection(db, "projects"));
            sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ç–Šæ§‹ --</option>';
            snapshot.forEach(doc => {
                const opt = document.createElement('option');
                opt.value = doc.id; opt.innerText = doc.id; sel.appendChild(opt);
            });
        } catch(e) { console.error(e); }
    }

    window.loadSelectedProject = async function() {
        const id = document.getElementById('project-select').value;
        if(!id) return;
        const docSnap = await getDoc(doc(db, "projects", id));
        if (docSnap.exists()) {
            stackData = docSnap.data();
            let totalThickMm = 0;
            const scale = (stackData.settings?.unit === 'mm') ? 1 : 0.001;
            stackData.layers.forEach(l => { totalThickMm += l.thickness * scale; });
            document.getElementById('stack-info').style.display = 'block';
            document.getElementById('current-stack-name').innerText = id;
            document.getElementById('current-stack-th').innerText = totalThickMm.toFixed(3);
            document.getElementById('simple-thick-row').style.display = 'none';
            updateModel();
        }
    }

    window.unloadProject = function() {
        stackData = null;
        document.getElementById('stack-info').style.display = 'none';
        document.getElementById('simple-thick-row').style.display = 'flex';
        updateModel();
    }

    // --- UI Logic ---
    window.sync = function(targetId, val) {
        let sliderId, inputId;
        if(targetId.startsWith('nb_')) { inputId = targetId; sliderId = targetId.replace('nb_', ''); } 
        else { inputId = 'nb_' + targetId; sliderId = targetId; }
        document.getElementById(inputId).value = val;
        document.getElementById(sliderId).value = val;
        updateModel();
    }

    window.adjust = function(id, direction) {
        const input = document.getElementById('nb_' + id);
        let current = parseFloat(input.value);
        let next = current + (window.currentStep * direction);
        const decimals = (window.currentStep.toString().split('.')[1] || '').length;
        next = parseFloat(next.toFixed(Math.max(decimals, 2))); 
        if (!['b_dx', 'b_a', 'j_r', 's_r'].includes(id)) next = Math.max(0.01, next);
        input.value = next;
        document.getElementById(id).value = next;
        updateModel();
    }

    // --- 3D Scene ---
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x222222);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 2000);
    camera.position.set(30, 30, 40); camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    container.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 2);
    dirLight.position.set(20, 50, 20); dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048;
    scene.add(dirLight);

    const gridHelper = new THREE.GridHelper(200, 200, 0x444444, 0x333333);
    scene.add(gridHelper);
    const axesHelper = new THREE.AxesHelper(10);
    scene.add(axesHelper);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    const evaluator = new Evaluator();

    // TransformControls (Gizmo)
    const transformControl = new TransformControls(camera, renderer.domElement);
    transformControl.addEventListener('dragging-changed', function (event) {
        controls.enabled = !event.value; // Disable Orbit when dragging Gizmo
    });
    // ç•¶ Gizmo è¢«æ‹‰å‹•æ™‚ï¼ŒåŒæ­¥æ›´æ–°æ•¸å€¼
    transformControl.addEventListener('change', function () {
        if (!transformControl.object) return;
        const obj = transformControl.object;
        const mode = transformControl.getMode();
        
        if (mode === 'rotate') {
            const rotDeg = obj.rotation.y * 180 / Math.PI; // å‡è¨­ä¸»è¦æ˜¯ Y æ—‹è½‰
            // é€™è£¡ç°¡åŒ–ï¼šåªæ›´æ–°å°æ‡‰çš„ä¸»è¦æ—‹è½‰è»¸
            if (obj === jigGroup) {
                const deg = (obj.rotation.y * 180 / Math.PI).toFixed(1);
                updateUI('j_r', deg);
            } else if (obj === bladeGroup) {
                const deg = (obj.rotation.z * 180 / Math.PI).toFixed(1);
                updateUI('b_a', deg);
            }
            // Sample çš„ spin æ¯”è¼ƒç‰¹æ®Šï¼Œæ˜¯åœ¨å…§éƒ¨ mesh ä¸Šï¼Œä½†æˆ‘å€‘å¯ä»¥ç”¨ Gizmo è½‰ Group æ¨¡æ“¬
            // é€™è£¡æš«æ™‚åªåš Jig å’Œ Blade çš„å®Œç¾é€£å‹•ï¼ŒSample ç¶­æŒè¼¸å…¥æ¡†æ§åˆ¶è¼ƒç©©
        } else if (mode === 'translate') {
            if (obj === bladeGroup) {
                updateUI('b_dx', obj.position.x.toFixed(2));
                // b_d æ˜¯é«˜åº¦ï¼Œä½†æˆ‘å€‘ Blade åŸå§‹ä½ç½®æœ‰ +25ï¼Œè¦æ‰£æ‰
                updateUI('b_d', (obj.position.y - 25).toFixed(2));
            }
        }
    });
    scene.add(transformControl);

    function updateUI(id, val) {
        document.getElementById(id).value = val;
        document.getElementById('nb_' + id).value = val;
    }

    // Groups for Gizmo attachment
    const jigGroup = new THREE.Group(); scene.add(jigGroup);
    const sampleGroup = new THREE.Group(); jigGroup.add(sampleGroup); // Sample follows Jig
    const bladeGroup = new THREE.Group(); scene.add(bladeGroup);

    // Gizmo Selection Logic
    window.selectObject = function(type) {
        document.querySelectorAll('.group-title').forEach(el => el.classList.remove('selected'));
        document.getElementById('title-' + type).classList.add('selected');
        
        transformControl.detach();
        if (type === 'jig') {
            transformControl.attach(jigGroup);
            transformControl.setMode('rotate'); // æ²»å…·ä¸»è¦æ˜¯æ—‹è½‰
        } else if (type === 'blade') {
            transformControl.attach(bladeGroup);
            transformControl.setMode('translate'); // åˆ€å…·ä¸»è¦æ˜¯ç§»å‹•
        } else if (type === 'sample') {
            // Sample æ¯”è¼ƒç‰¹åˆ¥ï¼Œæˆ‘å€‘é€™è£¡å…ˆä¸åš Gizmoï¼Œå› ç‚ºä»–åœ¨ Group è£¡é¢æ¯”è¼ƒè¤‡é›œ
            // æˆ–è€…å¯ä»¥ attach åˆ° sampleGroupï¼Œä½†é‚£æ˜¯ local åº§æ¨™
            // æš«æ™‚ä¸ attachï¼Œé¿å…æ··æ·†
        }
    }

    window.setGizmoMode = function(mode) {
        transformControl.setMode(mode);
        document.getElementById('mode-translate').classList.remove('active');
        document.getElementById('mode-rotate').classList.remove('active');
        document.getElementById('mode-' + mode).classList.add('active');
    }

    window.setGizmoAxis = function(axis) {
        transformControl.showX = (axis === null || axis === 'X');
        transformControl.showY = (axis === null || axis === 'Y');
        transformControl.showZ = (axis === null || axis === 'Z');
    }

    // Materials
    const matJig = new THREE.MeshStandardMaterial({ color: 0x9C27B0, roughness: 0.3, metalness: 0.1 });
    const matBlade = new THREE.MeshStandardMaterial({ color: 0xFFC107, roughness: 0.1, metalness: 0.8 });
    const matDefaultSample = new THREE.MeshStandardMaterial({ color: 0x2196F3, roughness: 0.2, metalness: 0.0 });

    let meshJig, sampleMeshes = [], meshBlade, resultMesh;
    let isWireframe = false;

    // View Controls
    window.setView = function(type) {
        const dist = 60;
        switch(type) {
            case 'top': camera.position.set(0, dist, 0); break;
            case 'front': camera.position.set(0, 0, dist); break;
            case 'side': camera.position.set(dist, 0, 0); break;
            case 'iso': camera.position.set(30, 30, 40); break;
        }
        camera.lookAt(0,0,0);
        controls.target.set(0,0,0);
        controls.update();
    }

    function createJigGeometry(h, angleDeg, w) {
        const shape = new THREE.Shape();
        const angleRad = angleDeg * Math.PI / 180;
        const base = (angleDeg >= 89) ? 0.1 : h / Math.tan(angleRad);
        shape.moveTo(0, 0); shape.lineTo(base, 0); shape.lineTo(0, h); shape.lineTo(0, 0);
        const geo = new THREE.ExtrudeGeometry(shape, { steps: 1, depth: w, bevelEnabled: false });
        geo.center();
        return { geo, base, height: h };
    }

    function updateModel() {
        const getVal = (id) => parseFloat(document.getElementById('nb_' + id).value);
        const p = {
            j_h: getVal('j_h'), j_a: getVal('j_a'), j_w: getVal('j_w'), j_r: getVal('j_r'),
            s_t: getVal('s_t'), s_l: getVal('s_l'), s_th: getVal('s_th'), s_w: getVal('s_w'), s_r: getVal('s_r'),
            b_t: getVal('b_t'), b_w: getVal('b_w'), b_d: getVal('b_d'), b_dx: getVal('b_dx'), b_a: getVal('b_a')
        };

        // æ¸…ç† Group å…§å®¹ï¼Œä½†ä¸åˆªé™¤ Group æœ¬èº«
        jigGroup.clear(); 
        sampleGroup.clear();
        bladeGroup.clear();
        if(resultMesh) { scene.remove(resultMesh); resultMesh.geometry.dispose(); }

        // --- 1. Jig Generation ---
        const jigData = createJigGeometry(p.j_h, p.j_a, p.j_w);
        const brushJig = new Brush(jigData.geo, matJig);
        // Jig æœ¬é«”ä½ç½® (Local to Group)
        brushJig.position.y = p.j_h / 2; 
        
        // æ›´æ–° Group çš„ Transform (ç”± Gizmo/Input æ§åˆ¶)
        jigGroup.rotation.y = p.j_r * Math.PI / 180;
        jigGroup.add(brushJig);

        // --- 2. Sample Calculation (Relative to Jig) ---
        const angleRad = p.j_a * Math.PI / 180;
        const base = jigData.base;
        const h = p.j_h;
        const dx = base, dy = -h;
        const slopeLen = Math.sqrt(dx*dx + dy*dy);
        const ux = dx / slopeLen, uy = dy / slopeLen; 
        const nx = -uy, ny = ux; 
        const topX = -base / 2, topY = h / 2;
        const slideDist = p.s_t * slopeLen;
        const baseSx = topX + ux * slideDist;
        const baseSy = topY + uy * slideDist;
        const sampleSpinRad = p.s_r * Math.PI / 180;

        let sampleBrushes = [];

        const transformSample = (brush, thicknessOffset) => {
            let sx = baseSx + nx * thicknessOffset;
            let sy = baseSy + ny * thicknessOffset;
            sx += ux * (p.s_l/2); sy += uy * (p.s_l/2);

            // Sample Group Logic
            // æˆ‘å€‘æŠŠ Sample æ”¾åœ¨ sampleGroup è£¡ï¼Œä¸¦å°‡ sampleGroup æ”¾åœ¨ jigGroup è£¡
            // é€™æ¨£ Sample å°±æœƒè·Ÿè‘— Jig è½‰ã€‚
            // ä½† Sample åœ¨æ–œé¢ä¸Šçš„å®šä½æ˜¯ç›¸å°æ–¼ Jig ä¸­å¿ƒçš„ã€‚
            
            brush.rotation.set(0, 0, 0);
            brush.rotateY(sampleSpinRad); 
            brush.rotateZ(-angleRad);
            
            // ä½ç½®æ˜¯ Local to Jig
            brush.position.set(sx, sy + p.j_h/2, 0);
            brush.updateMatrixWorld();
        };

        if (stackData) {
            const unit = stackData.settings?.unit || 'um';
            const scale = (unit === 'mm') ? 1 : 0.001;
            let currentThickOffset = 0;
            const layers = [...stackData.layers].reverse();
            layers.forEach(layer => {
                const lThick = layer.thickness * scale;
                const geoLayer = new THREE.BoxGeometry(p.s_l, lThick, p.s_w);
                const matLayer = new THREE.MeshStandardMaterial({ color: layer.color || 0xcccccc, roughness: 0.2 });
                const brushLayer = new Brush(geoLayer, matLayer);
                transformSample(brushLayer, currentThickOffset + (lThick / 2));
                sampleGroup.add(brushLayer);
                sampleBrushes.push(brushLayer);
                currentThickOffset += lThick;
            });
        } else {
            const geoSample = new THREE.BoxGeometry(p.s_l, p.s_th, p.s_w);
            const brushSample = new Brush(geoSample, matDefaultSample);
            transformSample(brushSample, p.s_th / 2);
            sampleGroup.add(brushSample);
            sampleBrushes.push(brushSample);
        }

        // --- 3. Blade ---
        const geoBlade = new THREE.BoxGeometry(p.b_t, 50, p.b_w);
        const brushBlade = new Brush(geoBlade, matBlade);
        
        // Blade Group Transform
        bladeGroup.position.x = p.b_dx;
        bladeGroup.position.y = p.b_d + 25; // Height
        bladeGroup.rotation.z = p.b_a * Math.PI / 180;
        bladeGroup.add(brushBlade);
        
        // Update matrices for Boolean
        jigGroup.updateMatrixWorld(true);
        bladeGroup.updateMatrixWorld(true);

        // --- 4. Boolean (Requires World Coordinates) ---
        const target = document.getElementById('target-select').value;
        
        // ç‚ºäº†é€²è¡Œ Booleanï¼Œæˆ‘å€‘éœ€è¦è¤‡è£½ä¸€ä»½ World Space çš„ Geometry
        // é€™æ¯”è¼ƒè¤‡é›œï¼Œå› ç‚º CSG éœ€è¦çµ•å°ä½ç½®ã€‚
        // ç°¡å–®åšæ³•ï¼šå¦‚æœä¸åˆ‡å‰² (None)ï¼Œç›´æ¥é¡¯ç¤º Group
        // å¦‚æœè¦åˆ‡å‰²ï¼Œæˆ‘å€‘å¿…é ˆ "Bake" è®Šæ›ã€‚
        
        if (target === 'none') {
            // Do nothing, groups are already added to scene
        } else {
            // Hide original groups, show result
            jigGroup.visible = false;
            // Blade is ghost
            bladeGroup.visible = true; 
            // Create a ghost material for blade if cutting
            brushBlade.material = new THREE.MeshBasicMaterial({ color: 0xFFEB3B, wireframe: true, transparent: true, opacity: 0.3 });

            // Prepare Brushes with World Matrix applied
            // é€™è£¡æˆ‘å€‘éœ€è¦ clone ä¸¦ applyMatrix
            const worldJig = brushJig.clone();
            worldJig.applyMatrix4(jigGroup.matrixWorld);
            
            const worldBlade = brushBlade.clone();
            // brushBlade is inside bladeGroup, need to combine
            worldBlade.applyMatrix4(bladeGroup.matrixWorld);
            // Restore material for calculation (doesn't matter for geometry, but evaluate needs material)
            worldBlade.material = matBlade;

            if (target === 'sample') {
                jigGroup.visible = true; // Show Jig
                sampleGroup.visible = false; // Hide original Sample
                
                // Cut each sample layer
                sampleBrushes.forEach(brush => {
                    const worldBrush = brush.clone();
                    // Brush is child of SampleGroup, SampleGroup is child of JigGroup
                    // Total transform: JigGroup * SampleGroup (Identity) * Brush
                    worldBrush.applyMatrix4(brush.matrixWorld);
                    
                    const result = evaluator.evaluate(worldBrush, worldBlade, SUBTRACTION);
                    result.material = brush.material;
                    result.castShadow = true; result.receiveShadow = true;
                    scene.add(result);
                    resultMesh = result; // Keep ref to dispose later (only tracks last one, but simple enough)
                });

            } else { // Cut Jig
                jigGroup.visible = false;
                sampleGroup.visible = true; // Show Sample
                
                const result = evaluator.evaluate(worldJig, worldBlade, SUBTRACTION);
                result.material = matJig;
                result.castShadow = true; result.receiveShadow = true;
                scene.add(result);
                resultMesh = result;
            }
        }
        updateWireframe();
    }

    window.toggleWireframe = function() {
        isWireframe = !isWireframe;
        const btn = document.getElementById('btn-wireframe');
        if(isWireframe) btn.classList.add('active'); else btn.classList.remove('active');
        updateWireframe();
    }

    function updateWireframe() {
        scene.traverse((obj) => {
            if (obj.isMesh && obj.material && obj.visible) {
                // Avoid setting wireframe on Gizmo helpers
                if(obj.type === 'TransformControlsPlane') return;
                obj.material.wireframe = isWireframe;
            }
        });
    }

    window.updateModel = updateModel;
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    document.getElementById('loader').style.opacity = 0;
    setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
    
    // Initial Select
    updateModel();
    selectObject('jig'); // Default select Jig
    animate();

</script>
</body>
</html>
