<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cutting 3D Simulator v5.1 (Measure & Vis)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #121212; color: #eee; font-family: "Microsoft JhengHei", sans-serif; }
        
        /* å´æ¬„ */
        #sidebar {
            position: absolute; top: 0; left: 0; width: 380px; height: 100vh;
            background: rgba(30, 30, 30, 0.95); overflow-y: auto; padding: 0;
            box-sizing: border-box; border-right: 1px solid #444; backdrop-filter: blur(5px);
            display: flex; flex-direction: column; z-index: 20;
        }

        .header-area { padding: 12px 15px; background: #1a1a1a; border-bottom: 1px solid #444; }
        .app-title { color: #4FC3F7; font-size: 18px; margin: 0 0 8px 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        /* é¡¯ç¤ºéš±è—æ§åˆ¶åˆ— */
        .vis-bar { display: flex; gap: 5px; margin-bottom: 10px; background: #222; padding: 5px; border-radius: 4px; border: 1px solid #444; }
        .vis-btn { 
            flex: 1; padding: 4px; font-size: 16px; cursor: pointer; border: 1px solid #555; 
            background: #333; color: #666; border-radius: 3px; text-align: center; transition:0.2s;
        }
        .vis-btn:hover { background: #444; }
        .vis-btn.active { background: #00E676; color: #000; border-color: #00E676; }
        .vis-btn.active::after { content: ''; } /* Remove strikethrough logic visual, rely on color */

        .obj-select {
            width: 100%; padding: 8px; font-size: 15px; font-weight: bold;
            background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; cursor: pointer;
        }

        /* åˆ†é  */
        .tabs { display: flex; background: #222; border-bottom: 1px solid #444; }
        .tab-btn {
            flex: 1; padding: 10px 0; background: #222; color: #888; border: none;
            cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; transition: 0.2s;
        }
        .tab-btn.active { color: #fff; background: #333; border-bottom-color: #00E676; }
        .tab-content { padding: 15px; display: none; overflow-y: auto; flex: 1; }
        .tab-content.active { display: block; }

        /* UI å…ƒä»¶ */
        .group { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; border: 1px solid #444; margin-bottom: 10px; }
        .group-title { font-weight: bold; margin-bottom: 8px; display: block; font-size: 13px; color: #aaa; }
        
        .row { display: flex; align-items: center; margin-bottom: 6px; gap: 5px; }
        .row-rot { background: rgba(255, 235, 59, 0.1); padding: 3px; border-radius: 4px; border: 1px solid rgba(255, 235, 59, 0.2); }
        
        label { flex: 0 0 60px; font-size: 12px; color: #ccc; text-align: right; margin-right: 5px;}
        input[type="number"] { width: 50px; background: #111; border: 1px solid #555; color: #4FC3F7; padding: 4px; border-radius: 4px; font-size: 12px; text-align: right; }
        input[type="range"] { flex: 1; cursor: pointer; height: 6px; }
        
        button.action-btn { width: 100%; padding: 8px; background: #00695C; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; margin-top: 5px;}
        button.action-btn:hover { background: #00897B; }
        
        .tool-btn { background: #444; padding: 4px 8px; border-radius: 4px; cursor: pointer; border: 1px solid #666; color: white; font-size: 12px;}
        .tool-btn:hover { background: #666; }
        
        /* å½ˆçª—æ¨£å¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal { background: #222; width: 550px; max-height: 80vh; padding: 20px; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; gap: 10px; color: #eee; }
        .project-card { display: flex; gap: 10px; background: #333; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #444; cursor: pointer; transition: 0.2s; align-items: center;}
        .project-card:hover { border-color: #00E676; background: #3a3a3a; }
        .project-thumb { width: 80px; height: 60px; background: #000; object-fit: cover; border-radius: 4px; }
        .project-info { flex: 1; }
        .default-badge { color: #FFD700; font-size: 18px; cursor: pointer; padding: 5px; }
        .default-badge.inactive { color: #555; filter: grayscale(1); }

        /* è¦–è§’èˆ‡Gizmo */
        #view-controls { position: absolute; top: 15px; right: 15px; display: flex; flex-direction: column; gap: 5px; z-index: 10; }
        .view-btn { width: 40px; height: 40px; background: rgba(50,50,50,0.8); color: white; border: 1px solid #666; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; justify-content: center; align-items: center; }
        
        #gizmo-panel { position: absolute; bottom: 20px; right: 20px; background: rgba(30,30,30,0.9); padding: 10px; border-radius: 8px; border: 1px solid #555; width: 150px; z-index: 10;}
        .gizmo-row { display: flex; gap: 5px; margin-top: 5px;}
        .gizmo-btn { flex: 1; padding: 5px; font-size: 11px; cursor: pointer; background: #444; color: #ddd; border: 1px solid #666; border-radius: 4px; }
        .gizmo-btn.active { background: #FF9800; color: #000; border-color: #FF9800; }

        /* æµ®å‹•æç¤º */
        #snap-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 230, 118, 0.8); color: black; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; pointer-events: none; display: none; z-index: 30;
        }
        
        /* é‡æ¸¬çµæœæµ®å‹•çª— */
        #measure-box {
            position: absolute; bottom: 20px; left: 400px; 
            background: rgba(0,0,0,0.8); border: 1px solid #00E676; color: #00E676;
            padding: 10px; border-radius: 6px; font-family: monospace; display: none; z-index: 10;
        }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 20px; transition: opacity 0.5s; }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.160.0",
                "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
                "three-bvh-csg": "https://esm.sh/three-bvh-csg@0.0.16?deps=three@0.160.0",
                "firebase-app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase-firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
            }
        }
    </script>
</head>
<body>

<div id="loader">ğŸš€ ç³»çµ±å•Ÿå‹•ä¸­...</div>
<div id="snap-hint">ğŸ–±ï¸ è«‹é»æ“Šä»»æ„è¡¨é¢é€²è¡Œå¸é™„</div>

<div id="measure-box">
    <div>ğŸ“ è·é›¢: <span id="m-dist">0.00</span> mm</div>
    <hr style="border-color:#333; margin:5px 0;">
    <div>dX: <span id="m-dx">0.00</span></div>
    <div>dY: <span id="m-dy">0.00</span></div>
    <div>dZ: <span id="m-dz">0.00</span></div>
</div>

<div id="modal-save" class="modal-overlay">
    <div class="modal">
        <h3 style="margin:0;color:#4FC3F7">ğŸ’¾ å„²å­˜å°ˆæ¡ˆ</h3>
        <input type="text" id="save-name" placeholder="å°ˆæ¡ˆåç¨±" style="width:96%; padding:8px; background:#111; border:1px solid #555; color:white;">
        <textarea id="save-desc" rows="3" placeholder="æè¿°..." style="width:96%; padding:8px; background:#111; border:1px solid #555; color:white; resize:none;"></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
            <button class="tool-btn" onclick="document.getElementById('modal-save').style.display='none'">å–æ¶ˆ</button>
            <button class="action-btn" style="margin:0; width:auto;" onclick="confirmSave()">å„²å­˜</button>
        </div>
    </div>
</div>

<div id="modal-load" class="modal-overlay">
    <div class="modal" style="height: 600px;">
        <h3 style="margin:0;color:#4FC3F7">ğŸ“‚ å°ˆæ¡ˆåˆ—è¡¨ (é»æ“Šâ˜…è¨­ç‚ºé è¨­)</h3>
        <div id="project-list" style="overflow-y:auto; flex:1; padding-right:5px;"></div>
        <button class="tool-btn" onclick="document.getElementById('modal-load').style.display='none'" style="align-self:flex-end;">é—œé–‰</button>
    </div>
</div>

<div id="view-controls">
    <div class="view-btn" onclick="setView('top')">ä¸Š</div>
    <div class="view-btn" onclick="setView('front')">å‰</div>
    <div class="view-btn" onclick="setView('side')">å³</div>
    <div class="view-btn" onclick="setView('iso')">ISO</div>
</div>

<div id="gizmo-panel">
    <div style="font-size:12px;color:#aaa;text-align:center">æ»‘é¼ æ“ä½œ</div>
    <div class="gizmo-row">
        <button class="gizmo-btn" id="mode-translate" onclick="setGizmoMode('translate')">ç§»å‹• Move</button>
        <button class="gizmo-btn active" id="mode-rotate" onclick="setGizmoMode('rotate')">æ—‹è½‰ Rot</button>
    </div>
    <div style="font-size:12px;color:#aaa;text-align:center;margin-top:5px">è»¸å‘é–å®š</div>
    <div class="gizmo-row">
        <button class="gizmo-btn" onclick="setGizmoAxis('X')">X</button>
        <button class="gizmo-btn" onclick="setGizmoAxis('Y')">Y</button>
        <button class="gizmo-btn" onclick="setGizmoAxis('Z')">Z</button>
    </div>
    <button class="gizmo-btn" onclick="setGizmoAxis(null)" style="width:100%;margin-top:2px">è‡ªç”± (Free)</button>
    <div style="font-size:10px;color:#666;margin-top:5px;text-align:center">å¸é™„å¾Œè«‹åˆ‡æ› Local</div>
</div>

<div id="sidebar">
    <div class="header-area">
        <div class="app-title">
            <span>Cutting 3D v5.1</span>
            <div style="display:flex; gap:5px;">
                <button class="tool-btn" onclick="initFromDefault()" title="åˆå§‹åŒ– (è¼‰å…¥é è¨­)">ğŸ”„ åˆå§‹åŒ–</button>
                <button class="tool-btn" onclick="openLoadModal()">ğŸ“‚</button>
                <button class="tool-btn" style="background:#E65100" onclick="openSaveModal()">ğŸ’¾</button>
            </div>
        </div>
        
        <div class="vis-bar">
            <div class="vis-btn active" onclick="toggleVis('jig',this)" title="é¡¯ç¤º/éš±è— æ²»å…·">ğŸ“</div>
            <div class="vis-btn active" onclick="toggleVis('sample',this)" title="é¡¯ç¤º/éš±è— æ¨£å“">ğŸ§Š</div>
            <div class="vis-btn active" onclick="toggleVis('blade',this)" title="é¡¯ç¤º/éš±è— åˆ€å…·">ğŸ”ª</div>
            <div class="vis-btn active" onclick="toggleVis('nozzle',this)" title="é¡¯ç¤º/éš±è— å™´é ­">ğŸš¿</div>
            <div class="vis-btn active" onclick="toggleVis('water',this)" title="é¡¯ç¤º/éš±è— æ°´æµ">ğŸ’¦</div>
        </div>

        <div style="font-size:11px;color:#888;margin-bottom:5px;">ç›®å‰ç·¨è¼¯ç‰©ä»¶ï¼š</div>
        <select id="obj-selector" class="obj-select" onchange="changeSelection(this.value)">
            <option value="nozzle">ğŸš¿ Nozzle (å™´é ­)</option>
            <option value="blade">ğŸ”ª Blade (åˆ€å…·)</option>
            <option value="sample">ğŸ§Š Sample (æ¨£å“)</option>
            <option value="jig">ğŸ“ Jig (æ²»å…·)</option>
        </select>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('dims')">ğŸ“ å°ºå¯¸</button>
        <button class="tab-btn" onclick="switchTab('trans')">ğŸ”„ è®Šæ›</button>
        <button class="tab-btn" onclick="switchTab('sim')">âš™ï¸ æ¨¡æ“¬</button>
    </div>

    <div id="tab-dims" class="tab-content active">
        <div id="dims-jig" class="group" style="display:none">
            <span class="group-title">æ²»å…·åƒæ•¸</span>
            <div class="row"><label>é«˜åº¦ H</label><input type="number" id="val_j_h" onchange="updateVal('j_h',this.value)"><input type="range" id="rng_j_h" min="1" max="100" step="0.1" oninput="updateVal('j_h',this.value)"></div>
            <div class="row"><label>è§’åº¦ A</label><input type="number" id="val_j_a" onchange="updateVal('j_a',this.value)"><input type="range" id="rng_j_a" min="5" max="89" step="1" oninput="updateVal('j_a',this.value)"></div>
            <div class="row"><label>æ·±åº¦ Z</label><input type="number" id="val_j_w" onchange="updateVal('j_w',this.value)"><input type="range" id="rng_j_w" min="1" max="100" step="0.1" oninput="updateVal('j_w',this.value)"></div>
        </div>
        <div id="dims-sample" class="group" style="display:none">
            <span class="group-title">æ¨£å“åƒæ•¸</span>
            <div class="row"><label>é•·åº¦ L</label><input type="number" id="val_s_l" onchange="updateVal('s_l',this.value)"><input type="range" id="rng_s_l" min="1" max="100" step="0.1" oninput="updateVal('s_l',this.value)"></div>
            <div class="row" id="row-s-th"><label>åšåº¦ T</label><input type="number" id="val_s_th" onchange="updateVal('s_th',this.value)"><input type="range" id="rng_s_th" min="0.1" max="20" step="0.01" oninput="updateVal('s_th',this.value)"></div>
            <div class="row"><label>å¯¬åº¦ Z</label><input type="number" id="val_s_w" onchange="updateVal('s_w',this.value)"><input type="range" id="rng_s_w" min="1" max="100" step="0.1" oninput="updateVal('s_w',this.value)"></div>
            <div class="row"><label>æ»‘å‹• P</label><input type="number" id="val_s_t" onchange="updateVal('s_t',this.value)"><input type="range" id="rng_s_t" min="0" max="1" step="0.01" oninput="updateVal('s_t',this.value)"></div>
        </div>
        <div id="dims-blade" class="group" style="display:none">
            <span class="group-title">åˆ€å…·åƒæ•¸</span>
            <div class="row"><label>åˆ€åš X</label><input type="number" id="val_b_t" onchange="updateVal('b_t',this.value)"><input type="range" id="rng_b_t" min="0.01" max="10" step="0.01" oninput="updateVal('b_t',this.value)"></div>
            <div class="row"><label>åˆ€å¯¬ Z</label><input type="number" id="val_b_w" onchange="updateVal('b_w',this.value)"><input type="range" id="rng_b_w" min="1" max="100" step="0.1" oninput="updateVal('b_w',this.value)"></div>
            <div class="row"><label>åˆ‡æ·± Y</label><input type="number" id="val_b_d" onchange="updateVal('b_d',this.value)"><input type="range" id="rng_b_d" min="0" max="100" step="0.1" oninput="updateVal('b_d',this.value)"></div>
        </div>
        <div id="dims-nozzle" class="group">
            <span class="group-title">å™´é ­åƒæ•¸</span>
            <div style="font-size:12px;color:#888;">æ¨™æº–å™´é ­ï¼Œç„¡å°ºå¯¸è¨­å®šã€‚è«‹ä½¿ç”¨è®Šæ›å·¥å…·ç§»å‹•ã€‚</div>
        </div>
    </div>

    <div id="tab-trans" class="tab-content">
        <button id="btn-snap" class="action-btn" style="background:#FF9800; margin-bottom:10px;" onclick="toggleSnapMode()">ğŸ§² é–‹å•Ÿå¸é™„å°é½Š (Snap)</button>
        
        <div class="group">
            <span class="group-title" style="color:#00E676;">ä½ç½® (mm)</span>
            <div class="row"><label>X</label><input type="number" id="t_px" onchange="updateTransFromInput()"><input type="range" id="rg_px" min="-50" max="50" oninput="document.getElementById('t_px').value=this.value;updateTransFromInput()"></div>
            <div class="row"><label>Y</label><input type="number" id="t_py" onchange="updateTransFromInput()"><input type="range" id="rg_py" min="-50" max="50" oninput="document.getElementById('t_py').value=this.value;updateTransFromInput()"></div>
            <div class="row"><label>Z</label><input type="number" id="t_pz" onchange="updateTransFromInput()"><input type="range" id="rg_pz" min="-50" max="50" oninput="document.getElementById('t_pz').value=this.value;updateTransFromInput()"></div>
        </div>
        <div class="group">
            <span class="group-title" style="color:#FFC107;">æ—‹è½‰ (Â°)</span>
            <div class="row"><label>X</label><input type="number" id="t_rx" onchange="updateTransFromInput()"><input type="range" id="rg_rx" min="-180" max="180" oninput="document.getElementById('t_rx').value=this.value;updateTransFromInput()"></div>
            <div class="row"><label>Y</label><input type="number" id="t_ry" onchange="updateTransFromInput()"><input type="range" id="rg_ry" min="-180" max="180" oninput="document.getElementById('t_ry').value=this.value;updateTransFromInput()"></div>
            <div class="row"><label>Z</label><input type="number" id="t_rz" onchange="updateTransFromInput()"><input type="range" id="rg_rz" min="-180" max="180" oninput="document.getElementById('t_rz').value=this.value;updateTransFromInput()"></div>
        </div>
    </div>

    <div id="tab-sim" class="tab-content">
        <button id="btn-measure" class="action-btn" style="background:#555; border:1px solid #777; margin-bottom:10px;" onclick="toggleMeasure()">ğŸ“ é–‹å•Ÿé‡æ¸¬ (Dist)</button>

        <div class="group" style="border-left: 3px solid #00B0FF;">
            <span class="group-title" style="color:#00B0FF;">ğŸ’¦ å™´æ°´ç³»çµ±</span>
            <button id="btn-water" class="action-btn" style="background:#0277bd" onclick="toggleWater()">ON / OFF</button>
            <div class="row" style="margin-top:5px"><label>æ°´å£“</label><input type="range" id="w_pressure" min="0" max="200" value="80"></div>
            <div class="row"><label>æ“´æ•£</label><input type="range" id="w_spread" min="0" max="45" value="5" oninput="waterSpread=this.value"></div>
            <div class="row"><label>é˜»æ“‹</label><select id="water-target" style="flex:1;background:#333;color:white;"><option value="none">ç„¡ (ç©¿é€)</option><option value="sample" selected>Sample</option><option value="jig">Jig</option><option value="blade">Blade</option></select></div>
        </div>

        <div class="group" style="border-left: 3px solid #FF9800;">
            <span class="group-title" style="color:#FF9800;">â˜ï¸ é›²ç«¯ç–Šæ§‹</span>
            <select id="project-select" style="width:100%;margin-bottom:5px;background:#333;color:white;padding:5px;"><option value="">-- é€£ç·šä¸­... --</option></select>
            <button class="action-btn" onclick="loadSelectedProject()">ğŸ“¥ è¼‰å…¥ç–Šæ§‹</button>
            <button class="action-btn" style="background:#D32F2F" onclick="unloadProject()">âŒ æ¸…é™¤</button>
            <div id="stack-info" style="font-size:11px; color:#aaa; margin-top:5px; display:none;">
                åšåº¦: <span id="current-stack-th" style="color:#fff;">0</span> mm
            </div>
        </div>

        <div class="group">
            <span class="group-title">ğŸ¯ åˆ‡å‰² Boolean</span>
            <div class="row"><label>ç›®æ¨™</label><select id="target-select" onchange="updateModel()" style="flex:1;background:#333;color:white;"><option value="none">ä¸åˆ‡å‰²</option><option value="sample" selected>åˆ‡æ¨£å“</option><option value="jig">åˆ‡æ²»å…·</option></select></div>
            <button class="action-btn" style="background:#444" onclick="toggleWireframe()">åˆ‡æ›ç¶²æ ¼</button>
        </div>
    </div>
</div>

<div id="canvas-container"></div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { TransformControls } from 'three/addons/controls/TransformControls.js';
    import { SUBTRACTION, Brush, Evaluator } from 'three-bvh-csg';
    import { initializeApp } from 'firebase-app';
    import { getFirestore, collection, getDocs, doc, getDoc } from 'firebase-firestore';

    // --- State ---
    const defaultParams = {
        j_h: 5, j_a: 45, j_w: 20,
        s_t: 0.5, s_l: 10, s_th: 0.8, s_w: 15, s_r: 0,
        b_t: 0.5, b_w: 25, b_d: 3.0
    };
    const defaultTransforms = {
        jig: { px:0, py:0, pz:0, rx:0, ry:0, rz:0 },
        sample: { px:0, py:0, pz:0, rx:0, ry:0, rz:0 },
        blade: { px:0, py:20, pz:0, rx:0, ry:0, rz:0 },
        nozzle: { px:5, py:15, pz:0, rx:0, ry:0, rz:-0.78 }
    };

    let params = {...defaultParams};
    let transforms = JSON.parse(JSON.stringify(defaultTransforms));
    let currentObj = 'nozzle';
    let stackData = null;
    let waterEnabled = false;
    let waterSpread = 5;
    let snapMode = false;

    // --- Init & Persistence ---
    window.initFromDefault = () => {
        const defId = localStorage.getItem('cutting3d_default_id');
        if(defId) {
            const projects = JSON.parse(localStorage.getItem('cutting3d_projects') || '[]');
            const p = projects.find(x => x.id == defId);
            if(p) { loadProject(p); return; }
        }
        params = {...defaultParams};
        transforms = JSON.parse(JSON.stringify(defaultTransforms));
        updateAllUI();
        alert("å·²é‡ç½®ç‚ºåŸå» è¨­å®š");
    }

    window.openSaveModal = () => {
        renderer.render(scene, camera);
        window.tempThumb = renderer.domElement.toDataURL('image/jpeg', 0.5);
        document.getElementById('save-name').value = "Project " + new Date().toLocaleDateString();
        document.getElementById('modal-save').style.display='flex';
    }
    window.confirmSave = () => {
        const name = document.getElementById('save-name').value;
        const desc = document.getElementById('save-desc').value;
        const projects = JSON.parse(localStorage.getItem('cutting3d_projects') || '[]');
        projects.unshift({ id: Date.now(), name, desc, thumb: window.tempThumb, data: { params, transforms, stackData } });
        localStorage.setItem('cutting3d_projects', JSON.stringify(projects));
        document.getElementById('modal-save').style.display='none';
        alert("å„²å­˜æˆåŠŸ");
    }
    window.openLoadModal = () => {
        const list = document.getElementById('project-list'); list.innerHTML='';
        const projects = JSON.parse(localStorage.getItem('cutting3d_projects') || '[]');
        const defId = localStorage.getItem('cutting3d_default_id');
        
        projects.forEach(p => {
            const isDef = (p.id == defId);
            const div = document.createElement('div'); div.className='project-card';
            div.innerHTML = `
                <div class="default-badge ${isDef?'':'inactive'}" onclick="setDefault(${p.id}, event)" title="è¨­ç‚ºåˆå§‹åŒ–é è¨­">â˜…</div>
                <img src="${p.thumb}" class="project-thumb">
                <div class="project-info">
                    <div style="font-weight:bold;color:white">${p.name}</div>
                    <div style="font-size:12px;color:#aaa">${p.desc||''}</div>
                </div>
                <button class="tool-btn" style="background:#d32f2f" onclick="deleteProject(${p.id}, event)">ğŸ—‘ï¸</button>
            `;
            div.onclick = (e) => { if(e.target.tagName!=='BUTTON' && !e.target.classList.contains('default-badge')) loadProject(p); };
            list.appendChild(div);
        });
        document.getElementById('modal-load').style.display='flex';
    }
    window.setDefault = (id, e) => {
        e.stopPropagation();
        const curr = localStorage.getItem('cutting3d_default_id');
        if(curr == id) localStorage.removeItem('cutting3d_default_id'); 
        else localStorage.setItem('cutting3d_default_id', id);
        window.openLoadModal(); 
    }
    window.loadProject = (p) => {
        params = p.data.params; transforms = p.data.transforms; stackData = p.data.stackData;
        updateAllUI();
        document.getElementById('modal-load').style.display='none';
    }
    window.deleteProject = (id, e) => {
        e.stopPropagation();
        if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
        let projects = JSON.parse(localStorage.getItem('cutting3d_projects') || '[]');
        projects = projects.filter(x => x.id !== id);
        localStorage.setItem('cutting3d_projects', JSON.stringify(projects));
        window.openLoadModal();
    }

    function updateAllUI() {
        Object.keys(params).forEach(k => {
            const e1=document.getElementById('val_'+k), e2=document.getElementById('rng_'+k);
            if(e1) e1.value=params[k]; if(e2) e2.value=params[k];
        });
        updateTransformUI();
        updateModel();
        applyTransforms();
    }

    // --- Firebase ---
    const firebaseConfig = {apiKey: "AIzaSyCnHhksuhJs9RdrL7DPnsAvR21ZND7kIOI", authDomain: "stack-diagram-db.firebaseapp.com", projectId: "stack-diagram-db", storageBucket: "stack-diagram-db.firebasestorage.app", messagingSenderId: "67240747982", appId: "1:67240747982:web:1fb065e40e936a7485419f", measurementId: "G-QJNE60W8BB"};
    let db=null; try { const app=initializeApp(firebaseConfig); db=getFirestore(app); initProjectList(); } catch(e){}
    async function initProjectList() { /* ... same ... */ const sel = document.getElementById('project-select'); try { const snapshot = await getDocs(collection(db, "projects")); sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ç–Šæ§‹ --</option>'; snapshot.forEach(doc => { const opt=document.createElement('option'); opt.value=doc.id; opt.innerText=doc.id; sel.appendChild(opt); }); } catch(e) { sel.innerHTML = '<option>è®€å–å¤±æ•—</option>'; } }
    window.loadSelectedProject = async function() { const id = document.getElementById('project-select').value; if(!id) return; const docSnap = await getDoc(doc(db, "projects", id)); if (docSnap.exists()) { stackData = docSnap.data(); let totalThickMm=0; const scale=(stackData.settings?.unit==='mm')?1:0.001; stackData.layers.forEach(l=>{totalThickMm+=l.thickness*scale}); document.getElementById('stack-info').style.display='block'; document.getElementById('current-stack-th').innerText=totalThickMm.toFixed(3); document.getElementById('row-s-th').style.display='none'; updateModel(); } }
    window.unloadProject = function() { stackData=null; document.getElementById('stack-info').style.display='none'; document.getElementById('row-s-th').style.display='flex'; updateModel(); }

    // --- UI Logic ---
    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
    }
    window.changeSelection = (val) => {
        currentObj=val; tControls.detach();
        if(val==='jig') tControls.attach(jigGroup);
        if(val==='sample') tControls.attach(sampleGroup);
        if(val==='blade') tControls.attach(bladeGroup);
        if(val==='nozzle') tControls.attach(nozzleGroup);
        ['jig','sample','blade','nozzle'].forEach(k => document.getElementById('dims-'+k).style.display=k===val?'block':'none');
        updateTransformUI();
    }
    window.updateVal = (key, val) => { params[key]=parseFloat(val); document.getElementById(`val_${key}`).value=val; document.getElementById(`rng_${key}`).value=val; updateModel(); }
    function updateTransformUI() {
        const t=transforms[currentObj];
        document.getElementById('t_px').value=t.px.toFixed(2); document.getElementById('rg_px').value=t.px;
        document.getElementById('t_py').value=t.py.toFixed(2); document.getElementById('rg_py').value=t.py;
        document.getElementById('t_pz').value=t.pz.toFixed(2); document.getElementById('rg_pz').value=t.pz;
        const dx=t.rx*180/Math.PI, dy=t.ry*180/Math.PI, dz=t.rz*180/Math.PI;
        document.getElementById('t_rx').value=dx.toFixed(1); document.getElementById('rg_rx').value=dx;
        document.getElementById('t_ry').value=dy.toFixed(1); document.getElementById('rg_ry').value=dy;
        document.getElementById('t_rz').value=dz.toFixed(1); document.getElementById('rg_rz').value=dz;
    }
    window.updateTransFromInput = () => {
        const t=transforms[currentObj];
        t.px=parseFloat(document.getElementById('t_px').value); t.py=parseFloat(document.getElementById('t_py').value); t.pz=parseFloat(document.getElementById('t_pz').value);
        t.rx=parseFloat(document.getElementById('t_rx').value)*Math.PI/180; t.ry=parseFloat(document.getElementById('t_ry').value)*Math.PI/180; t.rz=parseFloat(document.getElementById('t_rz').value)*Math.PI/180;
        applyTransforms();
    }
    window.toggleVis = (name, btn) => {
        let grp = null;
        if(name==='jig') grp=jigGroup; if(name==='sample') grp=sampleGroup;
        if(name==='blade') grp=bladeGroup; if(name==='nozzle') grp=nozzleGroup;
        if(name==='water') grp=waterSystem;
        if(grp) {
            grp.visible = !grp.visible;
            if(grp.visible) btn.classList.add('active'); else btn.classList.remove('active');
        }
    }

    // --- 3D Scene ---
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0x222222);
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 2000);
    camera.position.set(35,35,45); camera.lookAt(0,0,0);
    const renderer = new THREE.WebGLRenderer({antialias:true, preserveDrawingBuffer:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true; renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    container.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0x404040, 1.5));
    const dirLight = new THREE.DirectionalLight(0xffffff, 2); dirLight.position.set(20,50,20); 
    dirLight.castShadow=true; dirLight.shadow.mapSize.set(2048,2048); scene.add(dirLight);
    scene.add(new THREE.GridHelper(200, 200, 0x444444, 0x333333));
    scene.add(new THREE.AxesHelper(10));

    const controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping=true;
    const tControls = new TransformControls(camera, renderer.domElement);
    tControls.addEventListener('dragging-changed', e => controls.enabled = !e.value);
    tControls.addEventListener('change', () => {
        if(!tControls.object) return;
        const o=tControls.object; const k=currentObj;
        transforms[k].px=o.position.x; transforms[k].py=o.position.y; transforms[k].pz=o.position.z;
        transforms[k].rx=o.rotation.x; transforms[k].ry=o.rotation.y; transforms[k].rz=o.rotation.z;
        updateTransformUI();
        if(k!=='nozzle' && document.getElementById('target-select').value!=='none') updateModel(); 
    });
    scene.add(tControls);

    const jigGroup=new THREE.Group(); scene.add(jigGroup);
    const sampleGroup=new THREE.Group(); jigGroup.add(sampleGroup); 
    const bladeGroup=new THREE.Group(); scene.add(bladeGroup);
    const nozzleGroup=new THREE.Group(); scene.add(nozzleGroup);

    // Materials
    const matJig=new THREE.MeshStandardMaterial({color:0x9C27B0, roughness:0.3});
    const matSample=new THREE.MeshStandardMaterial({color:0x2196F3, roughness:0.2});
    const matBlade=new THREE.MeshStandardMaterial({color:0xFFC107, roughness:0.1, metalness:0.8});
    const matNozzle=new THREE.MeshStandardMaterial({color:0x9E9E9E});

    // Nozzle
    const nCyl = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,2), matNozzle); nCyl.position.y=1.5;
    const nCone = new THREE.Mesh(new THREE.ConeGeometry(0.5,1,32,1,true), matNozzle); nCone.rotation.x=Math.PI; nCone.position.y=0.5;
    const nozMesh = new THREE.Group(); nozMesh.add(nCyl,nCone); nozzleGroup.add(nozMesh);

    let brushJig, brushBlade, sampleBrushes=[], resultMesh, isWireframe=false;
    const evaluator = new Evaluator();

    // Measurement
    let measureMode = false;
    let measurePoints = [];
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let measureMarkers = []; 
    let measureLine = null;

    window.toggleMeasure = () => {
        measureMode = !measureMode;
        const btn = document.getElementById('btn-measure');
        if(measureMode) {
            btn.style.background = '#00E676';
            btn.innerText = 'ğŸ“ é»æ“Šå…©é»é‡æ¸¬';
            container.style.cursor = 'crosshair';
            tControls.visible = false;
        } else {
            btn.style.background = '#555';
            btn.innerText = 'ğŸ“ é–‹å•Ÿé‡æ¸¬ (Dist)';
            container.style.cursor = 'default';
            tControls.visible = true;
            clearMeasure();
        }
    }

    function clearMeasure() {
        measurePoints = [];
        measureMarkers.forEach(m => scene.remove(m)); measureMarkers = [];
        if(measureLine) scene.remove(measureLine); measureLine = null;
        document.getElementById('measure-box').style.display = 'none';
    }

    // --- Snapping Logic ---
    let snapArrow = new THREE.ArrowHelper(new THREE.Vector3(0,1,0), new THREE.Vector3(0,0,0), 5, 0x00E676);
    snapArrow.visible = false; scene.add(snapArrow);

    window.toggleSnapMode = () => {
        snapMode = !snapMode;
        const btn = document.getElementById('btn-snap');
        if(snapMode) {
            btn.style.background = '#00E676';
            btn.innerText = 'é»æ“Šè¡¨é¢ä»¥å¸é™„';
            document.getElementById('snap-hint').style.display='block';
            container.style.cursor = 'crosshair';
            tControls.visible = false;
        } else {
            btn.style.background = '#FF9800';
            btn.innerText = 'ğŸ§² é–‹å•Ÿå¸é™„å°é½Š (Snap)';
            document.getElementById('snap-hint').style.display='none';
            snapArrow.visible = false;
            container.style.cursor = 'default';
            tControls.visible = true;
        }
    }

    container.addEventListener('mousemove', e => {
        updateRaycaster(e);
        const intersects = raycaster.intersectObjects(scene.children, true);
        if(snapMode) {
            const targetGroup = (currentObj==='nozzle')?nozzleGroup : (currentObj==='blade')?bladeGroup : null;
            const hit = intersects.find(i => i.object.type==='Mesh' && i.object.visible && 
                (!targetGroup || !targetGroup.children.includes(i.object) && !i.object.isTransformControlsPlane));
            if(hit) {
                snapArrow.visible = true;
                snapArrow.position.copy(hit.point);
                snapArrow.setDirection(hit.face.normal.clone().transformDirection(hit.object.matrixWorld).normalize());
            } else { snapArrow.visible = false; }
        }
    });

    container.addEventListener('mousedown', e => {
        if(e.button !== 0) return;
        updateRaycaster(e);
        const intersects = raycaster.intersectObjects(scene.children, true);
        
        // Measure Logic
        if(measureMode) {
            const hit = intersects.find(i => i.object.type === 'Mesh' && i.object.visible);
            if(hit) {
                if(measurePoints.length >= 2) clearMeasure();
                measurePoints.push(hit.point);
                const marker = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({color:0xFF0000}));
                marker.position.copy(hit.point); scene.add(marker); measureMarkers.push(marker);

                if(measurePoints.length === 2) {
                    const geo = new THREE.BufferGeometry().setFromPoints(measurePoints);
                    measureLine = new THREE.Line(geo, new THREE.LineBasicMaterial({color:0xFF0000, linewidth:2}));
                    scene.add(measureLine);
                    const p1 = measurePoints[0], p2 = measurePoints[1];
                    const dist = p1.distanceTo(p2);
                    document.getElementById('measure-box').style.display = 'block';
                    document.getElementById('m-dist').innerText = dist.toFixed(3);
                    document.getElementById('m-dx').innerText = Math.abs(p2.x - p1.x).toFixed(3);
                    document.getElementById('m-dy').innerText = Math.abs(p2.y - p1.y).toFixed(3);
                    document.getElementById('m-dz').innerText = Math.abs(p2.z - p1.z).toFixed(3);
                }
            }
            return;
        }

        // Snap Logic
        if(snapMode) {
            const targetGroup = (currentObj==='nozzle')?nozzleGroup : (currentObj==='blade')?bladeGroup : (currentObj==='sample')?sampleGroup : null;
            if(!targetGroup) { alert("æ­¤ç‰©ä»¶ä¸æ”¯æ´å¸é™„"); toggleSnapMode(); return; }
            const hit = intersects.find(i => i.object.type==='Mesh' && i.object.visible && !targetGroup.children.some(c=>c===i.object||c.children?.includes(i.object)));
            if(hit) {
                targetGroup.position.copy(hit.point);
                const up = new THREE.Vector3(0,1,0);
                const normal = hit.face.normal.clone().transformDirection(hit.object.matrixWorld).normalize();
                const q = new THREE.Quaternion().setFromUnitVectors(up, normal);
                targetGroup.quaternion.copy(q);
                targetGroup.updateMatrixWorld();
                
                const t = transforms[currentObj];
                t.px=targetGroup.position.x; t.py=targetGroup.position.y; t.pz=targetGroup.position.z;
                const euler = new THREE.Euler().setFromQuaternion(targetGroup.quaternion);
                t.rx=euler.x*180/Math.PI; t.ry=euler.y*180/Math.PI; t.rz=euler.z*180/Math.PI;
                updateTransformUI();
                toggleSnapMode();
                window.setGizmoAxis(null); // Unlock
            }
        }
    });

    function updateRaycaster(e) {
        const rect = renderer.domElement.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
        const y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
        raycaster.setFromCamera({x,y}, camera);
    }

    // Water System (Fix Visibility)
    const particleCount=3000, waterGeo=new THREE.BufferGeometry(), waterPos=new Float32Array(particleCount*3), waterVel=[];
    for(let i=0;i<particleCount;i++){waterPos[i*3+1]=-999;waterVel.push({x:0,y:0,z:0});}
    waterGeo.setAttribute('position',new THREE.BufferAttribute(waterPos,3));
    const waterMat=new THREE.PointsMaterial({color:0x00FFFF,size:0.2,transparent:true,opacity:0.8,depthWrite:false});
    const waterSystem=new THREE.Points(waterGeo, waterMat);
    waterSystem.frustumCulled = false; // Important fix!
    scene.add(waterSystem);

    function applyTransforms() {
        const setT = (grp, t) => { grp.position.set(t.px, t.py, t.pz); grp.rotation.set(t.rx*Math.PI/180, t.ry*Math.PI/180, t.rz*Math.PI/180); grp.updateMatrixWorld(); }
        setT(jigGroup, transforms.jig); setT(sampleGroup, transforms.sample); setT(bladeGroup, transforms.blade); setT(nozzleGroup, transforms.nozzle);
    }

    function createJigGeometry() {
        const h=params.j_h, w=params.j_w, angleRad=params.j_a*Math.PI/180;
        const base=(params.j_a>=89)?0.1:h/Math.tan(angleRad);
        const s=new THREE.Shape(); s.moveTo(0,0); s.lineTo(base,0); s.lineTo(0,h); s.lineTo(0,0);
        const g=new THREE.ExtrudeGeometry(s,{steps:1,depth:w,bevelEnabled:false}); g.center(); g.translate(0,h/2,0);
        return {geo:g, base, h};
    }

    function updateModel() {
        if(brushJig) brushJig.geometry.dispose(); if(brushBlade) brushBlade.geometry.dispose();
        sampleBrushes.forEach(b=>b.geometry.dispose()); sampleBrushes=[];
        if(resultMesh) { scene.remove(resultMesh); resultMesh.geometry.dispose(); }
        
        jigGroup.clear(); sampleGroup.clear(); bladeGroup.clear();
        jigGroup.add(sampleGroup); 

        const jData = createJigGeometry();
        brushJig = new Brush(jData.geo, matJig); jigGroup.add(brushJig);

        const dx=jData.base, dy=-jData.h; const slopeLen=Math.sqrt(dx*dx+dy*dy);
        const ux=dx/slopeLen, uy=dy/slopeLen; const nx=-uy, ny=ux; 
        const topX=-jData.base/2, topY=jData.h/2;
        const slideDist = params.s_t * slopeLen;
        const baseSx=topX+ux*slideDist, baseSy=topY+uy*slideDist;
        const angleRad=params.j_a*Math.PI/180;

        const buildSampleLayer = (th, color, offset) => {
            const g = new THREE.BoxGeometry(params.s_l, th, params.s_w);
            const m = new THREE.MeshStandardMaterial({color});
            const b = new Brush(g, m);
            b.rotation.set(0,0,0); b.rotateY(params.s_r*Math.PI/180); b.rotateZ(-angleRad);
            const sx = baseSx + nx*(offset+th/2) + ux*(params.s_l/2);
            const sy = baseSy + ny*(offset+th/2) + uy*(params.s_l/2);
            b.position.set(sx, sy, 0); b.updateMatrixWorld();
            return b;
        }

        if(stackData) {
            const scale=(stackData.settings?.unit==='mm')?1:0.001; let curOff=0;
            [...stackData.layers].reverse().forEach(l=>{
                const th=l.thickness*scale; const b=buildSampleLayer(th, l.color||0xcccccc, curOff);
                sampleBrushes.push(b); sampleGroup.add(b); curOff+=th;
            });
        } else {
            const b=buildSampleLayer(params.s_th, 0x2196F3, 0); sampleBrushes.push(b); sampleGroup.add(b);
        }

        applyTransforms();

        const gBlade = new THREE.BoxGeometry(params.b_t, 50, params.b_w); gBlade.translate(0, 25, 0); 
        brushBlade = new Brush(gBlade, matBlade); bladeGroup.add(brushBlade);

        const target = document.getElementById('target-select').value;
        jigGroup.updateMatrixWorld(true); sampleGroup.updateMatrixWorld(true); bladeGroup.updateMatrixWorld(true);

        if(target!=='none') {
            const worldBlade = brushBlade.clone(); worldBlade.applyMatrix4(bladeGroup.matrixWorld); worldBlade.material = matBlade;
            if(target==='jig') {
                brushJig.visible=false; 
                const wJig=brushJig.clone(); wJig.applyMatrix4(jigGroup.matrixWorld);
                const res=evaluator.evaluate(wJig, worldBlade, SUBTRACTION);
                res.material=matJig; res.castShadow=true; res.receiveShadow=true; scene.add(res); resultMesh=res;
            } else {
                sampleBrushes.forEach(b=>{
                    b.visible=false; 
                    const wb=b.clone(); wb.applyMatrix4(sampleGroup.matrix); wb.applyMatrix4(jigGroup.matrixWorld);
                    const res=evaluator.evaluate(wb, worldBlade, SUBTRACTION);
                    res.material=b.material; res.castShadow=true; res.receiveShadow=true; scene.add(res); resultMesh=res;
                });
            }
            const ghost = brushBlade.clone(); ghost.material = new THREE.MeshBasicMaterial({color:0xFFEB3B, wireframe:true, opacity:0.3, transparent:true});
            bladeGroup.add(ghost); brushBlade.visible=false;
        }
        updateWireframe();
    }

    window.toggleWireframe = () => { isWireframe=!isWireframe; updateWireframe(); }
    function updateWireframe() { scene.traverse(o => { if(o.isMesh && o.material && o.visible && o.name!=='ghost') o.material.wireframe=isWireframe; }); }
    window.setView = (v) => {
        const d=60; 
        if(v==='top') camera.position.set(0,d,0); if(v==='front') camera.position.set(0,0,d);
        if(v==='side') camera.position.set(d,0,0); if(v==='iso') camera.position.set(30,30,40);
        camera.lookAt(0,0,0); controls.target.set(0,0,0);
    }
    window.toggleWater = () => { waterEnabled=!waterEnabled; document.getElementById('btn-water').style.background=waterEnabled?'#00bcd4':'#0277bd'; waterSystem.visible=waterEnabled; }
    window.setGizmoMode = (m) => { tControls.setMode(m); document.querySelectorAll('.gizmo-btn').forEach(b=>b.classList.remove('active')); document.getElementById('mode-'+m).classList.add('active'); }
    window.setGizmoAxis = (a) => { tControls.showX=!a||a==='X'; tControls.showY=!a||a==='Y'; tControls.showZ=!a||a==='Z'; }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        
        if(waterEnabled) {
            const positions = waterGeo.attributes.position.array;
            const pressure = document.getElementById('w_pressure').value;
            const targetType = document.getElementById('water-target').value;
            
            // Tip world pos
            const tipWorld = new THREE.Vector3(0,0,0).applyMatrix4(nozzleGroup.children[0].matrixWorld);
            // Direction (local -Y of nozzle group is standard, but check geometry orientation)
            // Cylinder is 0 to 2 Y. Cone is 0 to 1 Y. We want water out of Cone tip at 0.
            // Cone rotation is PI (upside down). So tip is at bottom.
            // Vector (0,-1,0) in Nozzle Group Space should work.
            const dirWorld = new THREE.Vector3(0,-1,0).transformDirection(nozzleGroup.matrixWorld).normalize();

            let box=null;
            if(targetType!=='none') {
                const targetObj = (targetType==='sample')?sampleGroup : (targetType==='jig')?jigGroup : bladeGroup;
                box = new THREE.Box3().setFromObject(targetObj);
            }

            for(let i=0; i<particleCount; i++) {
                if(waterPos[i*3+1] < -20 || Math.random()<0.005) {
                    waterPos[i*3] = tipWorld.x + (Math.random()-0.5)*0.1;
                    waterPos[i*3+1] = tipWorld.y;
                    waterPos[i*3+2] = tipWorld.z + (Math.random()-0.5)*0.1;
                    const spd = 0.5 + (pressure/100)*1.0;
                    const spreadRad = (waterSpread||5) * Math.PI / 180;
                    const r1=(Math.random()-0.5)*spreadRad, r2=(Math.random()-0.5)*spreadRad;
                    const vel = dirWorld.clone().applyEuler(new THREE.Euler(r1, 0, r2)).multiplyScalar(spd);
                    waterVel[i].x=vel.x; waterVel[i].y=vel.y; waterVel[i].z=vel.z;
                } else {
                    const ox=waterPos[i*3], oy=waterPos[i*3+1], oz=waterPos[i*3+2];
                    waterPos[i*3]+=waterVel[i].x; waterPos[i*3+1]+=waterVel[i].y; waterPos[i*3+2]+=waterVel[i].z;
                    if(pressure<100) waterVel[i].y -= 0.02; 
                    if(box && box.containsPoint(new THREE.Vector3(waterPos[i*3], waterPos[i*3+1], waterPos[i*3+2]))) {
                        waterVel[i].x = (Math.random()-0.5)*0.5; waterVel[i].y = (Math.random())*0.5; waterVel[i].z = (Math.random()-0.5)*0.5;
                        waterPos[i*3]=ox; waterPos[i*3+1]=oy; waterPos[i*3+2]=oz;
                    }
                }
            }
            waterGeo.attributes.position.needsUpdate = true;
        }
        renderer.render(scene, camera);
    }
    
    // Init
    document.getElementById('loader').style.display='none';
    changeSelection('nozzle');
    initFromDefault();
    animate();

</script>
</body>
</html>
